<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SISTEMA DE ORGANIZAÇÃO DE TRANSPORTE - SAÍDAS DE AMBULÂNCIAS</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<style>
:root {
--primary-blue: #4a69bd;
--secondary-blue: #6c88c9;
--gray: #dcdcdc;
--dark-gray: #333d47;
--white: #ffffff;
--light-gray-bg: #f9f9f9;
--delete-red: #dc3545;
--edit-green: #28a745;
--warning-orange: #ffc107;
--orange: #fd7e14;
}
body { font-family: 'Arial', sans-serif; margin: 0; padding: 0; background-color: var(--light-gray-bg); }
main { margin: 20px 10px; }
.tab-content { display: block; background-color: var(--white); padding: 20px; border-radius: 8px; border: 1px solid #dee2e6; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
.table-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
.table-title { font-size: 22px; color: var(--primary-blue); font-weight: bold; margin: 0; text-shadow: 0 2px 4px rgba(0,0,0,0.35), 0 4px 14px rgba(0,0,0,0.22), 0 4px 16px rgba(74,105,189,0.4); }
.counter { font-size: 18px; font-weight: bold; color: var(--primary-blue); }

/* Barra de ações moderna - botões à esquerda do contador */
.toolbar-actions {
  display: flex;
  align-items: center;
  gap: 0;
  background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
  padding: 6px 6px 6px 14px;
  border-radius: 14px;
  border: 1px solid rgba(74, 105, 189, 0.12);
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02);
}
.btn-action {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  min-width: 130px;
  padding: 10px 18px;
  border: none;
  border-radius: 10px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
  color: #fff;
  letter-spacing: 0.01em;
}
.btn-action i { font-size: 15px; opacity: 0.95; }
.btn-action:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}
.btn-action:active { transform: translateY(0); }
/* Progressão de azuis: Baixar (1) → Imprimir (2) → Assinar (3) */
.btn-action.btn-pdf {
  background: linear-gradient(135deg, #2a5a9e 0%, #1e4d8c 100%);
  box-shadow: 0 2px 8px rgba(42, 90, 158, 0.4);
}
.btn-action.btn-pdf:hover { background: linear-gradient(135deg, #3668b0 0%, #2a5a9e 100%); }
.btn-action.btn-print {
  background: linear-gradient(135deg, #4a69bd 0%, #3668b0 100%);
  box-shadow: 0 2px 8px rgba(74, 105, 189, 0.4);
}
.btn-action.btn-print:hover { background: linear-gradient(135deg, #5a79cd 0%, #4a69bd 100%); }
.btn-action.btn-sign {
  background: linear-gradient(135deg, #6c8fd4 0%, #5b7dc9 100%);
  box-shadow: 0 2px 8px rgba(108, 143, 212, 0.4);
}
.btn-action.btn-sign:hover { background: linear-gradient(135deg, #7da1e0 0%, #6c8fd4 100%); }
.counter-badge {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  margin-left: 10px;
  padding: 10px 20px;
  background: linear-gradient(135deg, #4a69bd 0%, #3d5a9e 100%);
  color: #fff;
  border-radius: 10px;
  font-size: 15px;
  font-weight: 700;
  letter-spacing: 0.02em;
  box-shadow: 0 2px 8px rgba(74, 105, 189, 0.3);
  border: 1px solid rgba(255, 255, 255, 0.15);
}
.counter-badge::before {
  content: '';
  width: 8px;
  height: 8px;
  background: rgba(255, 255, 255, 0.9);
  border-radius: 50%;
  animation: pulse-dot 2s ease-in-out infinite;
}
@keyframes pulse-dot {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.6; transform: scale(0.9); }
}
.date-filter-container { display: flex; align-items: center; gap: 15px; padding: 15px; border: 1px solid var(--gray); border-radius: 8px; background-color: var(--light-gray-bg); flex-wrap: wrap; justify-content: space-between; }
.date-filter-container label { font-weight: bold; }
.date-filter-container input[type="date"] { padding: 8px 12px; border: 1px solid #ced4da; border-radius: 5px; font-size: 16px; font-weight: bold; max-width: 180px; }
.table-container { overflow-x: auto; border: 1px solid var(--gray); border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); background-color: var(--white); }
table { width: 100%; border-collapse: collapse; min-width: 1000px; }
th, td { border: 1px solid #e9ecef; padding: 10px; text-align: left; white-space: nowrap; font-size: 14px; }
thead th { background-color: var(--primary-blue); color: var(--white); font-weight: bold; text-transform: uppercase; font-size: 12px; }
tbody tr:nth-child(even) { background-color: #f8f9fa; }
td[contenteditable="true"]:focus { outline: 2px solid var(--primary-blue); }
.motorista-cell { cursor: pointer; }
.motorista-cell:hover { background-color: #e9f7fe; }
.action-buttons { display: flex; gap: 5px; justify-content: center; }
.action-buttons button, .action-buttons label { background-color: var(--primary-blue); color: var(--white); border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 14px; transition: background-color 0.3s ease; }
.action-buttons button:hover, .action-buttons label:hover { background-color: var(--secondary-blue); }
.action-buttons .delete-row-btn { background-color: var(--delete-red); }
.action-buttons .view-row-btn { background-color: #6c757d; }
.action-buttons .view-row-btn:hover { background-color: #5a6268; }
.action-buttons .edit-row-btn { background-color: var(--edit-green); }
.obs-btn { background-color: #007bff; }
.obs-modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
.obs-modal-content { background-color: var(--white); padding: 30px; border-radius: 10px; width: 90%; max-width: 500px; position: relative; }
/* Estilos específicos para o modal de impressão */
#printModal { z-index: 10000; }
/* Estilos do calendário - igual ao Cadastro de Saídas */
.calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}
.calendar-header button {
    background: none;
    border: 1px solid var(--primary-blue);
    color: var(--primary-blue);
    cursor: pointer;
    padding: 5px 10px;
    border-radius: 4px;
    font-weight: bold;
    font-size: 16px;
}
.calendar-header button:hover {
    background-color: var(--primary-blue);
    color: white;
}
#currentMonthYear {
    font-size: 18px;
    font-weight: bold;
    color: var(--primary-blue);
}
.calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 5px;
}
.calendar-grid div {
    padding: 10px 5px;
    text-align: center;
    cursor: pointer;
    border-radius: 4px;
    transition: background-color 0.2s;
}
.calendar-weekday {
    font-weight: bold;
    color: var(--dark-gray);
    cursor: default !important;
}
.calendar-day {
    border: 1px solid #eee;
}
.calendar-day:hover {
    background-color: #f0f0f0;
}
.calendar-day.other-month {
    color: #ccc;
    cursor: default;
}
.calendar-day.has-data {
    background-color: #fff3cd;
    font-weight: bold;
}
.calendar-day.selected {
    background-color: var(--primary-blue);
    color: var(--white);
    border-color: var(--primary-blue);
}
.calendar-day.has-motoristas {
    background-color: #28a745;
    color: white;
    border-color: #28a745;
}
.calendar-day.today {
    border: 2px solid var(--primary-blue);
}
/* Modal de motoristas deve ficar na frente do modal de impressão */
#motoristasModal { z-index: 10001 !important; }
#printModal .obs-modal-content { overflow: visible !important; max-height: none !important; position: relative; }
#printDateList { overflow-x: visible !important; overflow-y: auto !important; max-height: 600px !important; position: relative; }
/* Garantir que os selects possam expandir */
#printModal .date-container { overflow: visible !important; position: relative; }
#printModal .motoristas-container { overflow: visible !important; position: relative; z-index: 10002; }
#printModal .motorista-select { 
    z-index: 10003 !important; 
    position: relative !important;
    background-color: white !important;
}
/* Quando o select está aberto, garantir que as opções sejam visíveis */
#printModal select:focus { 
    z-index: 10004 !important; 
    position: relative !important;
}
/* Garantir que o dropdown não seja cortado */
#printModal select option {
    background-color: white !important;
    z-index: 10005 !important;
}
#printModal .obs-modal-content { overflow: visible; }
#printModal .motorista-select { z-index: 1001; position: relative; }
#printDateList { overflow: visible !important; }
.close-button { position: absolute; top: 10px; right: 15px; font-size: 30px; color: #aaa; cursor: pointer; }
.modal-buttons { display: flex; justify-content: center; margin-top: 20px; gap: 10px; }
.modal-buttons .save-obs-btn { background-color: var(--primary-blue); color: var(--white); }
/* Modal de alerta de quilometragem */
#kmAlertModal { display: none; position: fixed; z-index: 10002; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: flex-start; padding-top: 100px; }
#kmAlertModal.show { display: flex; }
.km-alert-modal-content { background-color: var(--white); padding: 30px; border-radius: 10px; width: 90%; max-width: 500px; position: relative; box-shadow: 0 4px 20px rgba(0,0,0,0.3); text-align: center; margin-top: 0; }
.km-alert-modal-content h3 { margin-top: 0; margin-bottom: 20px; color: var(--dark-gray); font-size: 20px; }
.km-alert-modal-content p { margin-bottom: 25px; color: #666; font-size: 16px; line-height: 1.5; }
.km-alert-modal-buttons { display: flex; justify-content: center; gap: 10px; }
.km-alert-modal-buttons button { padding: 12px 30px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; transition: background-color 0.3s; }
.km-alert-confirm-btn { background-color: var(--primary-blue); color: var(--white); }
.km-alert-confirm-btn:hover { background-color: var(--secondary-blue); }
.km-alert-cancel-btn { background-color: #6c757d; color: var(--white); }
.km-alert-cancel-btn:hover { background-color: #5a6268; }
.modal-buttons .cancel-obs-btn { background-color: var(--gray); }
textarea#obsTextarea {
width: 100%; height: 150px; box-sizing: border-box;
padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;
}
.saida-realizada { background-color: #dbe4ff !important; }
@keyframes piscarVermelho { 0% { background-color: inherit; } 50% { background-color: rgba(255, 0, 0, 0.2); } 100% { background-color: inherit; } }
.alarme-oleo-piscando { animation: piscarVermelho 1.5s infinite; }
.assinaturas-container-geral { display: none; flex-direction: column; align-items: center; gap: 20px; margin-top: 25px; padding: 20px; background-color: var(--light-gray-bg); border: 1px solid var(--gray); border-radius: 8px; }
.assinaturas-container-topo { display: flex; justify-content: center; width: 100%; gap: 120px; }
.assinatura-container-base { margin-top: 20px; }
.assinatura-box { display: flex; flex-direction: column; align-items: center; gap: 8px; }
.assinatura-box select { width: 250px; padding: 8px; border: 1px solid #ccc; border-radius: 5px; font-size: 14px; }
.assinatura-box label { font-weight: bold; font-size: 14px; color: var(--dark-gray); }
#choiceModalContent { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
.choice-btn {
background-color: var(--primary-blue); color: var(--white); border: none;
padding: 12px; border-radius: 5px; cursor: pointer;
font-size: 16px; font-weight: bold; text-align: center;
transition: background-color 0.3s;
}
.choice-btn:hover { background-color: var(--secondary-blue); }

/* NOVOS ESTILOS PARA VIATURAS COM PROBLEMAS */
.viatura-com-problema {
color: var(--orange) !important;
font-weight: bold !important;
cursor: pointer !important;
text-decoration: underline;
transition: color 0.3s;
}
.viatura-com-problema:hover {
color: #e8590c !important;
}
#problemasModal .obs-modal-content {
max-width: 600px;
}
#problemasModal h2 {
color: var(--orange);
margin-bottom: 20px;
}
.problema-item {
background-color: #fff3cd;
border-left: 4px solid var(--orange);
padding: 12px;
margin-bottom: 10px;
border-radius: 4px;
}
.problema-item strong {
color: var(--dark-gray);
display: block;
margin-bottom: 5px;
}
.problema-item p {
margin: 0;
color: #856404;
}
/* Modo Escuro */
body[data-theme="dark"],
body[data-theme="dark"] * {
transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
}
body[data-theme="dark"] {
background-color: #1a1a1a !important;
color: #e0e0e0 !important;
}
body[data-theme="dark"] main,
body[data-theme="dark"] .tab-content {
background-color: #1a1a1a !important;
color: #e0e0e0 !important;
}
body[data-theme="dark"] .table-container,
body[data-theme="dark"] .form-container {
background-color: #2d2d2d !important;
color: #e0e0e0 !important;
border-color: #444 !important;
}
body[data-theme="dark"] table {
background-color: #2d2d2d !important;
color: #e0e0e0 !important;
}
body[data-theme="dark"] table th {
background-color: #3d3d3d !important;
color: #e0e0e0 !important;
border-color: #555 !important;
}
body[data-theme="dark"] table td {
background-color: #2d2d2d !important;
color: #e0e0e0 !important;
border-color: #555 !important;
}
body[data-theme="dark"] input,
body[data-theme="dark"] select,
body[data-theme="dark"] textarea {
background-color: #1a1a1a !important;
color: #e0e0e0 !important;
border-color: #555 !important;
}
body[data-theme="dark"] label {
color: #e0e0e0 !important;
}
body[data-theme="dark"] h1,
body[data-theme="dark"] h2,
body[data-theme="dark"] h3 {
color: #e0e0e0 !important;
}
body[data-theme="dark"] button,
body[data-theme="dark"] .btn {
background-color: #4a69bd !important;
color: #ffffff !important;
}
body[data-theme="dark"] button:hover,
body[data-theme="dark"] .btn:hover {
background-color: #6c88c9 !important;
}
body[data-theme="dark"] .toolbar-actions {
  background: linear-gradient(135deg, #2d2d2d 0%, #252525 100%);
  border-color: rgba(74, 105, 189, 0.25);
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.3);
}
body[data-theme="dark"] .btn-action.btn-pdf { background: linear-gradient(135deg, #2a5a9e 0%, #1e4d8c 100%); }
body[data-theme="dark"] .btn-action.btn-print { background: linear-gradient(135deg, #4a69bd 0%, #3668b0 100%); }
body[data-theme="dark"] .btn-action.btn-sign { background: linear-gradient(135deg, #6c8fd4 0%, #5b7dc9 100%); }
body[data-theme="dark"] .counter-badge {
  background: linear-gradient(135deg, #3d5a9e 0%, #4a69bd 100%);
  border-color: rgba(255, 255, 255, 0.2);
}
</style>
</head>
<body>
<main>
<div id="saidasAmbulanciasSection" class="tab-content active">
<div class="table-controls">
<h2 class="table-title">SAÍDAS DE AMBULÂNCIAS</h2>
<div class="toolbar-actions">
<button type="button" id="downloadPdfBtn" class="btn-action btn-pdf" title="Baixar PDF"><i class="fas fa-file-pdf"></i> Baixar</button>
<button type="button" id="printBtn" class="btn-action btn-print" title="Imprimir"><i class="fas fa-print"></i> Imprimir</button>
<button type="button" id="toggleSignaturesBtn" class="btn-action btn-sign" title="Exibir assinaturas"><i class="fas fa-signature"></i> Assinar</button>
<div class="counter-badge counter" id="ambulanciasCounter">Número de Saídas: 0</div>
</div>
</div>
<div class="date-filter-container">
<label for="filterDateAmb">Filtrar por Data:</label>
<input type="date" id="filterDateAmb">
</div>
<div class="table-container">
<table id="ambulanciasTable">
<thead>
<tr>
<th>VIATURA</th> <th>MOTORISTA</th> <th>SAÍDA</th> <th>DESTINO</th>
<th>KM SAÍDA</th> <th>KM CHEGADA</th> <th>CHEGADA</th> <th>SETOR</th> <th>OM</th> <th>AÇÕES</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
<div class="assinaturas-container-geral" style="display: none;">
<div class="assinaturas-container-topo">
<div class="assinatura-box">
<select id="motorista1Select"><option value="">Selecione um motorista...</option></select>
<label for="motorista1Select">Motorista 1</label>
</div>
<div class="assinatura-box">
<select id="motorista2Select"><option value="">Selecione um motorista...</option></select>
<label for="motorista2Select">Motorista 2</label>
</div>
</div>
<div class="assinatura-container-base">
<div class="assinatura-box">
<select id="divisaoTransporteSelect"><option value="">Selecione um responsável...</option></select>
<label for="divisaoTransporteSelect">Divisão de Transporte</label>
</div>
</div>
</div>
</div>

<script src="theme-listener.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
let saidasAmbulancias = [];
let frotaData = [];
let motoristasCadastrados = [];
let viaturasComProblemas = {};

const ambulanciasTableBody = document.querySelector('#ambulanciasTable tbody');
const filterDateAmbInput = document.getElementById('filterDateAmb');
const ambulanciasCounter = document.getElementById('ambulanciasCounter');
const obsModal = document.getElementById('obsModal');
const obsTextarea = document.getElementById('obsTextarea');
const saveObsBtn = document.getElementById('saveObsBtn');
const cancelObsBtn = document.getElementById('cancelObsBtn');
const closeObsModal = document.getElementById('closeObsModal');
let currentObsContext = null;
const choiceModal = document.getElementById('choiceModal');
const choiceModalContent = document.getElementById('choiceModalContent');
const choiceModalTitle = document.getElementById('choiceModalTitle');
const motorista1Select = document.getElementById('motorista1Select');
const motorista2Select = document.getElementById('motorista2Select');
const divisaoTransporteSelect = document.getElementById('divisaoTransporteSelect');
const toggleSignaturesBtn = document.getElementById('toggleSignaturesBtn');
const signaturesContainer = document.querySelector('.assinaturas-container-geral');
const speechSynthesizer = window.speechSynthesis;
let isSpeaking = false;
let alertedVehicles = new Set();

// NOVOS ELEMENTOS PARA MODAL DE PROBLEMAS
const problemasModal = document.getElementById('problemasModal');
const problemasPlaca = document.getElementById('problemasPlaca');
const problemasLista = document.getElementById('problemasLista');
const closeProblemasBtn = document.getElementById('closeProblemasBtn');

// FUNÇÃO PARA CARREGAR VIATURAS COM PROBLEMAS
function loadViaturasComProblemas() {
viaturasComProblemas = JSON.parse(localStorage.getItem('viaturasComProblemas') || '{}');
}

// FUNÇÃO PARA EXIBIR MODAL DE PROBLEMAS
function showProblemasModal(placa) {
const problemas = viaturasComProblemas[placa];
if (!problemas || problemas.length === 0) return;

problemasPlaca.textContent = placa;
problemasLista.innerHTML = '';

problemas.forEach(problema => {
const div = document.createElement('div');
div.className = 'problema-item';
div.innerHTML = `
<strong><i class="fas fa-tools"></i> ${problema.item}</strong>
<p>${problema.nota}</p>
`;
problemasLista.appendChild(div);
});

problemasModal.style.display = 'flex';
}

// FUNÇÃO PARA FECHAR MODAL DE PROBLEMAS
function closeProblemasModal() {
problemasModal.style.display = 'none';
}

function speakAlert(text) {
if (!speechSynthesizer || isSpeaking) return;
const utterance = new SpeechSynthesisUtterance(text);
utterance.lang = 'pt-BR';
utterance.rate = 1;
utterance.pitch = 1;
utterance.onstart = () => isSpeaking = true;
utterance.onend = () => isSpeaking = false;
speechSynthesizer.speak(utterance);
}
function playOilChangeAlert(viatura) {
const alertText = `Atenção, troca de óleo necessária da viatura ${viatura}.`;
speakAlert(alertText);
}
function setDateToToday() {
const today = new Date();
const year = today.getFullYear();
const month = String(today.getMonth() + 1).padStart(2, '0');
const day = String(today.getDate()).padStart(2, '0');
const todayFormatted = `${year}-${month}-${day}`;
filterDateAmbInput.value = todayFormatted;
}
function loadAllData() {
try {
const storedSaidas = localStorage.getItem('saidasAmbulancias');
const storedFrota = localStorage.getItem('viaturasCadastradas');
const storedMotoristas = localStorage.getItem('motoristasCadastrados');
saidasAmbulancias = storedSaidas ? JSON.parse(storedSaidas) : [];
frotaData = storedFrota ? JSON.parse(storedFrota) : [];
motoristasCadastrados = storedMotoristas ? JSON.parse(storedMotoristas) : [];
if (!Array.isArray(saidasAmbulancias)) saidasAmbulancias = [];
if (!Array.isArray(frotaData)) frotaData = [];
if (!Array.isArray(motoristasCadastrados)) motoristasCadastrados = [];
loadViaturasComProblemas();
console.log('Dados carregados:', { saidasAmbulancias: saidasAmbulancias.length, frotaData: frotaData.length, motoristasCadastrados: motoristasCadastrados.length });
} catch (error) {
console.error('Erro ao carregar dados:', error);
saidasAmbulancias = [];
frotaData = [];
motoristasCadastrados = [];
}
}
function saveData() {
try {
localStorage.setItem('saidasAmbulancias', JSON.stringify(saidasAmbulancias));
return true;
} catch (error) {
console.error('Erro ao salvar dados:', error);
alert('Erro ao salvar dados. Verifique o espaço de armazenamento do navegador.');
return false;
}
}
function populateMotoristaSelects(motoristas) {
const selects = [
{ el: motorista1Select, selected: motorista1Select.value, default: "Selecione um motorista..." },
{ el: motorista2Select, selected: motorista2Select.value, default: "Selecione um motorista..." },
{ el: divisaoTransporteSelect, selected: divisaoTransporteSelect.value, default: "Selecione um responsável..." }
];
selects.forEach(selectInfo => {
selectInfo.el.innerHTML = `<option value="">${selectInfo.default}</option>`;
motoristas.forEach(motorista => {
if (motorista.nome) {
const option = new Option(motorista.nome, motorista.nome);
selectInfo.el.add(option);
}
});
selectInfo.el.value = selectInfo.selected;
});
}
function atualizarEstiloDaLinha(row) {
const ids = row.dataset.id.split(',');
if (!ids[0]) return;
const saidaPrincipal = saidasAmbulancias.find(s => s.id === ids[0]);
if (!saidaPrincipal) return;
const placa = saidaPrincipal.viatura;
const kmChegada = parseFloat(saidaPrincipal.kmChegada);
let alarmeAtivo = false;
if (placa && !isNaN(kmChegada) && frotaData.length > 0) {
const dadosViatura = frotaData.find(v => v.placa === placa);
if (dadosViatura) {
const proxTrocaKm = parseFloat(dadosViatura.proxTrocaKm);
if (!isNaN(proxTrocaKm) && kmChegada >= proxTrocaKm && !dadosViatura.confirma) {
alarmeAtivo = true;
if (!alertedVehicles.has(placa)) {
playOilChangeAlert(placa);
alertedVehicles.add(placa);
}
}
}
}
row.classList.toggle('alarme-oleo-piscando', alarmeAtivo);
if (!alarmeAtivo) {
row.classList.toggle('saida-realizada', !!(saidaPrincipal.kmSaida && saidaPrincipal.kmChegada && saidaPrincipal.chegada));
}
}
/**
 * Extrai apenas o bairro do destino, removendo a cidade se presente
 * @param {string} destino - String do destino (pode ser "Cidade - Bairro" ou apenas "Bairro")
 * @returns {string} - Apenas o bairro
 */
function extrairBairroDoDestino(destino) {
    if (!destino || !destino.trim()) return '';
    // Se contém " - ", pega apenas a parte após o " - " (bairro)
    if (destino.includes(' - ')) {
        return destino.split(' - ').slice(-1)[0].trim();
    }
    // Se não contém, já é só o bairro
    return destino.trim();
}

function groupSaidas(saidas) {
if (!saidas || saidas.length === 0) return [];
const groups = new Map();
saidas.forEach(saida => {
const groupKey = `${saida.dataSaida}-${saida.viatura}-${saida.motorista}-${saida.saida}`;
if (!groups.has(groupKey)) {
groups.set(groupKey, { isGroup: true, ids: [], ...saida, destinos: [], setores: [] });
}
const group = groups.get(groupKey);
group.ids.push(saida.id);
group.destinos.push(saida.destino);
group.setores.push(saida.setor);
});
return Array.from(groups.values()).map(group => {
if (group.ids.length === 1) {
return saidas.find(s => s.id === group.ids[0]);
}
group.tipo = 'Ambulância';
return group;
});
}
function getLastKmChegadaAmb(placa) {
    console.log('Getting last KM for placa:', placa);
    const allSaidas = [...saidasAmbulancias].filter(s => s.viatura === placa);
    console.log('Filtered saidas:', allSaidas.length);
    allSaidas.sort((a, b) => {
        const dateA = new Date(a.dataSaida + 'T' + (a.saida || '00:00'));
        const dateB = new Date(b.dataSaida + 'T' + (b.saida || '00:00'));
        return dateB - dateA;
    });
    // Primeiro, tenta encontrar o último KM CHEGADA válido
    for (let s of allSaidas) {
        console.log('Checking kmChegada:', s.kmChegada, s.kmChegada && s.kmChegada.trim() !== '');
        if (s.kmChegada && s.kmChegada.trim() !== '') return s.kmChegada;
    }
    // Se não encontrou, usa o último KM SAÍDA válido
    for (let s of allSaidas) {
        console.log('Checking kmSaida:', s.kmSaida, s.kmSaida && s.kmSaida.trim() !== '');
        if (s.kmSaida && s.kmSaida.trim() !== '') return s.kmSaida;
    }
    console.log('No last KM found');
    return '';
}
function populateTables() {
alertedVehicles.clear();
loadAllData();
const filterDateAmb = filterDateAmbInput.value;
let filteredSaidasAmb = filterDateAmb ? saidasAmbulancias.filter(s => s.dataSaida === filterDateAmb) : saidasAmbulancias;
filteredSaidasAmb.sort((a, b) => (a.saida || '').localeCompare(b.saida || ''));
const groupedAmbSaidas = groupSaidas(filteredSaidasAmb);
ambulanciasTableBody.innerHTML = '';
groupedAmbSaidas.forEach(item => {
const row = document.createElement('tr');
const uniqueId = item.isGroup ? item.ids.join(',') : item.id;
row.dataset.id = uniqueId;

// VERIFICA SE A VIATURA TEM PROBLEMAS
const temProblema = viaturasComProblemas[item.viatura] && viaturasComProblemas[item.viatura].length > 0;
const classeViatura = temProblema ? 'viatura-com-problema' : '';

row.innerHTML = `
<td class="${classeViatura}" data-placa="${item.viatura || ''}">${item.viatura || ''}</td>
<td class="motorista-cell" data-original-value="${item.motorista || ''}">${item.motorista || ''}</td>
<td>${item.saida || ''}</td>
<td>${item.isGroup ? item.destinos.map(d => extrairBairroDoDestino(d)).join(', ') : extrairBairroDoDestino(item.destino || '')}</td>
<td contenteditable="true" data-key="kmSaida">${item.kmSaida || ''}</td>
<td contenteditable="true" data-key="kmChegada">${item.kmChegada || ''}</td>
<td><input type="time" data-key="chegada" value="${item.chegada || ''}" style="border: none; background: transparent; width: 100%; font-size: 14px;"></td>
<td>${item.isGroup ? [...new Set(item.setores)].join(', ') : item.setor || ''}</td>
<td>${item.om || (item.isGroup ? [...new Set(item.ids.map(id => {
    const saida = saidasAmbulancias.find(s => s.id === id);
    return saida ? saida.om : '';
}).filter(om => om))].join(', ') : '')}</td>
<td class="action-buttons">
<button class="view-row-btn" title="Visualizar"><i class="fas fa-eye"></i></button>
<button class="edit-row-btn" title="Editar"><i class="fas fa-edit"></i></button>
<button class="obs-btn" title="Observações"><i class="fas fa-comment"></i></button>
<button class="delete-row-btn" title="Excluir"><i class="fas fa-trash-alt"></i></button>
</td>
`;
ambulanciasTableBody.appendChild(row);
attachEventListenersToRow(row);
atualizarEstiloDaLinha(row);
});
ambulanciasCounter.textContent = `Número de Saídas: ${filteredSaidasAmb.length}`;
}
function attachEventListenersToRow(row) {
row.querySelector('.view-row-btn')?.addEventListener('click', handleViewRow);
row.querySelector('.edit-row-btn')?.addEventListener('click', handleEditRow);
row.querySelector('.obs-btn')?.addEventListener('click', handleObsButtonClick);
row.querySelector('.delete-row-btn')?.addEventListener('click', handleDeleteRow);

// ADICIONA LISTENER PARA DUPLO CLIQUE NA CÉLULA DO MOTORISTA
const motoristaCell = row.querySelector('.motorista-cell');
if (motoristaCell) {
motoristaCell.addEventListener('dblclick', handleMotoristaEdit);
}

// ADICIONA LISTENER PARA CLIQUE NA PLACA COM PROBLEMA
const viaturaCell = row.querySelector('.viatura-com-problema');
if (viaturaCell) {
viaturaCell.addEventListener('click', (e) => {
e.stopPropagation();
const placa = viaturaCell.dataset.placa;
showProblemasModal(placa);
});
}

row.querySelectorAll('td[contenteditable="true"]').forEach(cell => {
cell.addEventListener('blur', handleCellEdit);
});
const timeInput = row.querySelector('input[type="time"]');
if (timeInput) {
timeInput.addEventListener('change', handleTimeInputChange);
}
row.querySelector('td[contenteditable="true"][data-key="kmSaida"]')?.addEventListener('focus', (e) => {
    console.log('Focus on KM SAÍDA triggered');
    if (e.target.textContent.trim() === '') {
        console.log('KM SAÍDA is empty');
        const placa = row.querySelector('td').textContent.trim();
        console.log('Placa:', placa);
        const lastKm = getLastKmChegadaAmb(placa);
        console.log('Last KM:', lastKm);
        e.target.textContent = lastKm;
    } else {
        console.log('KM SAÍDA is not empty');
    }
});
}

// Função para manipular a edição de motorista com senha
function handleMotoristaEdit(event) {
const cell = event.target;
const row = cell.closest('tr');
const ids = row.dataset.id.split(',');
const originalValue = cell.dataset.originalValue;

// Verifica se o valor original era "ASD" ou se a célula está vazia
if (originalValue === 'ASD' || originalValue === '') {
// Solicita a senha antes de permitir a edição
const senha = prompt('Digite a senha para editar o motorista:');
    
// Verifica se a senha está correta
const senhaCorreta = localStorage.getItem('adminPassword') || '1234';
    
if (senha === senhaCorreta) {
// Permite a edição
cell.contentEditable = 'true';
        
// Aguarda um momento para garantir que a célula está editável
setTimeout(() => {
cell.focus();
        
// Seleciona todo o texto para facilitar a edição
const range = document.createRange();
range.selectNodeContents(cell);
const sel = window.getSelection();
sel.removeAllRanges();
sel.addRange(range);
}, 10);
        
// Adiciona event listener para salvar quando perder o foco
const saveEdit = () => {
cell.contentEditable = 'false';
const newValue = cell.textContent.trim();
            
// Atualiza o valor original
cell.dataset.originalValue = newValue;
            
// Salva no localStorage
ids.forEach(id => {
const index = saidasAmbulancias.findIndex(item => item.id === id);
if (index !== -1) {
saidasAmbulancias[index].motorista = newValue;
}
});
            
saveData();
window.parent.postMessage({ type: 'refresh_all_data' }, '*');
            
// Remove o event listener
cell.removeEventListener('blur', saveEdit);
cell.removeEventListener('keydown', handleKeyDown);
};
        
// Adiciona event listener para salvar ao pressionar Enter
const handleKeyDown = (e) => {
if (e.key === 'Enter') {
e.preventDefault();
saveEdit();
}
};
        
cell.addEventListener('blur', saveEdit);
cell.addEventListener('keydown', handleKeyDown);
} else if (senha !== null) {
// Se a senha foi digitada e está incorreta
alert('Senha incorreta!');
}
}
}

function handleTimeInputChange(event) {
const input = event.target;
const row = input.closest('tr');
const ids = row.dataset.id.split(',');
const keyToUpdate = input.dataset.key;
const valueToSave = input.value;
let updated = false;
ids.forEach(id => {
const index = saidasAmbulancias.findIndex(item => item.id === id);
if (index !== -1) {
saidasAmbulancias[index][keyToUpdate] = valueToSave;
updated = true;
}
});
if (updated && saveData()) {
atualizarEstiloDaLinha(row);
window.parent.postMessage({ type: 'refresh_all_data' }, '*');
}
}
function handleViewRow(event) {
event.stopPropagation();
const row = event.target.closest('tr');
const ids = row.dataset.id.split(',');
if (ids.length > 1) {
choiceModalTitle.textContent = "Escolha a Saída para Visualizar";
choiceModalContent.innerHTML = '';
const departuresInGroup = ids.map(id => saidasAmbulancias.find(s => s.id === id)).filter(Boolean);
departuresInGroup.forEach(saida => {
const btn = document.createElement('button');
btn.className = 'choice-btn';
btn.textContent = `Setor: ${saida.setor || 'N/A'} - Destino: ${saida.destino || 'N/A'}`;
btn.onclick = () => {
showViewSaidaModal(saida);
choiceModal.style.display = 'none';
};
choiceModalContent.appendChild(btn);
});
choiceModal.style.display = 'flex';
} else {
const saidaData = saidasAmbulancias.find(item => item.id === ids[0]);
if (saidaData) {
showViewSaidaModal(saidaData);
}
}
}
function showViewSaidaModal(saidaData) {
const modal = document.getElementById('viewSaidaModal');
const content = document.getElementById('viewSaidaContent');
if (!modal || !content || !saidaData) return;
const formatDate = (dateStr) => {
if (!dateStr) return 'N/A';
try {
const date = new Date(dateStr + 'T00:00:00');
return date.toLocaleDateString('pt-BR');
} catch {
return dateStr;
}
};
const formatTime = (timeStr) => timeStr || 'N/A';
content.innerHTML = `
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
<div><strong>Tipo de Saída:</strong> ${saidaData.tipo || 'N/A'}</div>
<div><strong>Data do Pedido:</strong> ${formatDate(saidaData.dataPedido)}</div>
<div><strong>Hora do Pedido:</strong> ${formatTime(saidaData.horaPedido)}</div>
<div><strong>Data da Saída:</strong> ${formatDate(saidaData.dataSaida)}</div>
<div><strong>Hora da Saída:</strong> ${formatTime(saidaData.horaSaida || saidaData.saida)}</div>
<div><strong>Setor:</strong> ${saidaData.setor || 'N/A'}</div>
<div><strong>Ramal:</strong> ${saidaData.ramal || 'N/A'}</div>
<div><strong>Cidade:</strong> ${saidaData.cidade || 'N/A'}</div>
<div><strong>Bairro:</strong> ${saidaData.bairro || 'N/A'}</div>
<div><strong>Destino:</strong> ${saidaData.destino || 'N/A'}</div>
<div><strong>Objetivo:</strong> ${saidaData.objetivo || 'N/A'}</div>
<div><strong>Número de Passageiros:</strong> ${saidaData.numPassageiros || 'N/A'}</div>
<div><strong>Responsável pelo Pedido:</strong> ${saidaData.responsavelPedido || 'N/A'}</div>
<div><strong>Viatura:</strong> ${saidaData.viatura || 'N/A'}</div>
<div><strong>Motorista:</strong> ${saidaData.motorista || 'N/A'}</div>
<div><strong>KM Saída:</strong> ${saidaData.kmSaida || 'N/A'}</div>
<div><strong>KM Chegada:</strong> ${saidaData.kmChegada || 'N/A'}</div>
<div><strong>Chegada:</strong> ${formatTime(saidaData.chegada)}</div>
${saidaData.hospital ? `<div><strong>Hospital:</strong> ${saidaData.hospital}</div>` : ''}
</div>
${saidaData.observacoes ? `<div style="margin-top: 15px; padding: 15px; background-color: #f8f9fa; border-radius: 5px; border-left: 4px solid var(--primary-blue);">
<strong>Observações:</strong><br>
<div style="margin-top: 10px; white-space: pre-wrap;">${saidaData.observacoes}</div>
</div>` : ''}
`;
modal.style.display = 'flex';
}
function closeViewSaidaModal() {
const modal = document.getElementById('viewSaidaModal');
if (modal) {
modal.style.display = 'none';
}
}
// Fechar modal ao clicar fora dele
const viewSaidaModalClick = document.getElementById('viewSaidaModal');
if (viewSaidaModalClick) {
viewSaidaModalClick.addEventListener('click', function(e) {
if (e.target === viewSaidaModalClick) {
closeViewSaidaModal();
}
});
}
function handleEditRow(event) {
event.stopPropagation();
const row = event.target.closest('tr');
const ids = row.dataset.id.split(',');
if (ids.length > 1) {
choiceModalTitle.textContent = "Escolha a Saída para Editar";
choiceModalContent.innerHTML = '';
const departuresInGroup = ids.map(id => saidasAmbulancias.find(s => s.id === id)).filter(Boolean);
departuresInGroup.forEach(saida => {
const btn = document.createElement('button');
btn.className = 'choice-btn';
btn.textContent = `Setor: ${saida.setor || 'N/A'} - Destino: ${saida.destino || 'N/A'}`;
btn.onclick = () => {
window.parent.postMessage({ type: 'edit_saida', data: saida }, '*');
choiceModal.style.display = 'none';
};
choiceModalContent.appendChild(btn);
});
choiceModal.style.display = 'flex';
} else {
const saidaData = saidasAmbulancias.find(item => item.id === ids[0]);
if (saidaData) {
window.parent.postMessage({ type: 'edit_saida', data: saidaData }, '*');
}
}
}
function formatKm(value) {
    let num = value.replace(/,/g, '').replace(/\./g, '');
    return num.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
}

function handleCellEdit(event) {
const cell = event.target;
const row = cell.closest('tr');
const ids = row.dataset.id.split(',');
const keyToUpdate = cell.dataset.key;
let valueToSave = cell.textContent.trim();

// Formatar KM se for kmSaida ou kmChegada
if (keyToUpdate === 'kmSaida' || keyToUpdate === 'kmChegada') {
    valueToSave = formatKm(valueToSave);
    cell.textContent = valueToSave; // Atualizar a célula também
}

// Validação de quilometragem ANTES de salvar
if (keyToUpdate === 'kmChegada' && valueToSave !== '') {
    const saidaData = saidasAmbulancias.find(item => item.id === ids[0]);
    if (saidaData) {
        const kmSaidaStr = saidaData.kmSaida ? saidaData.kmSaida.replace(/\./g, '') : '';
        const kmChegadaStr = valueToSave.replace(/\./g, '');
        
        if (kmSaidaStr && kmChegadaStr) {
            const kmSaida = parseFloat(kmSaidaStr);
            const kmChegada = parseFloat(kmChegadaStr);
            
            if (!isNaN(kmSaida) && !isNaN(kmChegada)) {
                // Verificar se KM chegada <= KM saída
                if (kmChegada <= kmSaida) {
                    showKmAlertModal('Quilometragem de chegada incorreta, verifique o preenchimento novamente.');
                    // Reverter o valor
                    const oldValue = saidaData.kmChegada || '';
                    cell.textContent = oldValue ? formatKm(oldValue) : '';
                    return; // Não salvar se a validação falhar
                }
                
                // Verificar se a distância percorrida é maior que 110km
                const distancia = kmChegada - kmSaida;
                if (distancia > 110) {
                    showKmAlertModal('Quilometragem alta, está certo desse preenchimento?', cell, row, ids, true);
                }
            }
        }
    }
}

let updated = false;
ids.forEach(id => {
const index = saidasAmbulancias.findIndex(item => item.id === id);
if (index !== -1) {
saidasAmbulancias[index][keyToUpdate] = valueToSave;
updated = true;
}
});
if (updated && saveData()) {
atualizarEstiloDaLinha(row);
window.parent.postMessage({ type: 'refresh_all_data' }, '*');
}

// Novo: Preencher CHEGADA automaticamente se KM CHEGADA foi preenchido
if (keyToUpdate === 'kmChegada' && valueToSave !== '') {
    const timeInput = row.querySelector('input[data-key="chegada"]');
    if (timeInput && !timeInput.value) {
        const now = new Date();
        const currentTime = now.toTimeString().slice(0, 5); // HH:MM
        if (confirm(`Confirmar hora de chegada: ${currentTime}?`)) {
            timeInput.value = currentTime;
            // Salvar também a chegada
            ids.forEach(id => {
                const index = saidasAmbulancias.findIndex(item => item.id === id);
                if (index !== -1) saidasAmbulancias[index].chegada = currentTime;
            });
            saveData();
            atualizarEstiloDaLinha(row);
        }
    }
}
}
function handleDeleteRow(event) {
const row = event.target.closest('tr');
if (!row) return;
if (confirm('Tem certeza que deseja excluir esta(s) linha(s)?')) {
const idsToRemove = row.dataset.id.split(',');
saidasAmbulancias = saidasAmbulancias.filter(item => !idsToRemove.includes(item.id));
if (saveData()) {
populateTables();
window.parent.postMessage({ type: 'refresh_all_data' }, '*');
}
}
}
function handleObsButtonClick(event) {
event.stopPropagation();
const row = event.target.closest('tr');
const ids = row.dataset.id.split(',');
const openObsModalForId = (id) => {
currentObsContext = { ids: [id] };
const saida = saidasAmbulancias.find(s => s.id === id);
obsTextarea.value = saida ? saida.observacoes || '' : '';
obsModal.style.display = 'flex';
};
if (ids.length > 1) {
choiceModalTitle.textContent = "Escolha para qual Saída é a Ocorrência";
choiceModalContent.innerHTML = '';
const departuresInGroup = ids.map(id => saidasAmbulancias.find(s => s.id === id)).filter(Boolean);
departuresInGroup.forEach(saida => {
const btn = document.createElement('button');
btn.className = 'choice-btn';
btn.textContent = `Setor: ${saida.setor || 'N/A'} - Destino: ${saida.destino || 'N/A'}`;
btn.onclick = () => {
choiceModal.style.display = 'none';
openObsModalForId(saida.id);
};
choiceModalContent.appendChild(btn);
});
choiceModal.style.display = 'flex';
} else {
openObsModalForId(ids[0]);
}
}
function closeAndResetObsModal() {
obsModal.style.display = 'none';
obsTextarea.value = '';
currentObsContext = null;
}
function formatDateToDDMMYYYY(dateString) {
if (!dateString || dateString === '') return '';
const [year, month, day] = dateString.split('-');
return `${day}/${month}/${year}`;
}

// FUNÇÃO CORRIGIDA DO PDF
function downloadSaidasTableAsPdf() {
const { jsPDF } = window.jspdf;
const doc = new jsPDF({ orientation: 'landscape' });
const filterDateAmb = filterDateAmbInput.value;
let filteredSaidasAmb = filterDateAmb ? saidasAmbulancias.filter(s => s.dataSaida === filterDateAmb) : saidasAmbulancias;
filteredSaidasAmb.sort((a, b) => (a.saida || '').localeCompare(b.saida || ''));
const groupedAmbSaidas = groupSaidas(filteredSaidasAmb);
const title = 'Relatório de Saídas de Ambulâncias';
const date = filterDateAmb ? `Data: ${formatDateToDDMMYYYY(filterDateAmb)}` : 'Todas as Datas';
const count = ambulanciasCounter.textContent;
doc.setFontSize(16); doc.text(title, 14, 20);
doc.setFontSize(12); doc.text(date, 14, 28); doc.text(count, 14, 34);
const tableHeaders = [
'VIATURA', 'MOTORISTA', 'SAÍDA', 'DESTINO',
'KM SAÍDA', 'KM CHEGADA', 'CHEGADA', 'SETOR', 'OM'
];

// CORRIGIDO: Busca o valor do input de chegada da tela
const tableBody = groupedAmbSaidas.map((item, index) => {
const rowElement = ambulanciasTableBody.children[index];
let chegadaValue = item.chegada || '';
if (rowElement) {
const chegadaInput = rowElement.querySelector('input[data-key="chegada"]');
if (chegadaInput) {
chegadaValue = chegadaInput.value || '';
}
}

return [
item.viatura || '',
item.motorista || '',
item.saida || '',
item.isGroup ? item.destinos.map(d => extrairBairroDoDestino(d)).join(', ') : extrairBairroDoDestino(item.destino || ''),
item.kmSaida || '',
item.kmChegada || '',
chegadaValue,
item.isGroup ? [...new Set(item.setores)].join(', ') : item.setor || '',
item.om || (item.isGroup ? [...new Set(item.ids.map(id => {
    const saida = saidasAmbulancias.find(s => s.id === id);
    return saida ? saida.om : '';
}).filter(om => om))].join(', ') : '')
];
});

doc.autoTable({
head: [tableHeaders],
body: tableBody,
startY: 40,
theme: 'grid',
styles: { fontSize: 8, cellPadding: 2, overflow: 'linebreak' },
headStyles: { fillColor: [74, 105, 189], textColor: 255 },
alternateRowStyles: { fillColor: [248, 249, 250] },
didDrawPage: function(data) {
let finalY = data.cursor.y + 20;
const pageWidth = doc.internal.pageSize.getWidth();
const lineLength = 80; const textYOffset = 5;
if (finalY + 60 > doc.internal.pageSize.getHeight()) { doc.addPage(); finalY = 20; }
const x1_start = (pageWidth / 2) - lineLength - 20;
const x2_start = (pageWidth / 2) + 20;
const motorista1 = motorista1Select.value || '__________________________________';
const motorista2 = motorista2Select.value || '__________________________________';
const divisaoTransporte = divisaoTransporteSelect.value || '__________________________________';
doc.setFontSize(10); doc.text(motorista1, x1_start + (lineLength / 2), finalY + textYOffset - 2, { align: 'center' });
doc.setFontSize(8); doc.text('Motorista 1', x1_start + (lineLength / 2), finalY + textYOffset + 4, { align: 'center' });
doc.setFontSize(10); doc.text(motorista2, x2_start + (lineLength / 2), finalY + textYOffset - 2, { align: 'center' });
doc.setFontSize(8); doc.text('Motorista 2', x2_start + (lineLength / 2), finalY + textYOffset + 4, { align: 'center' });
finalY += 30;
const x3_start = (pageWidth / 2) - (lineLength / 2);
doc.setFontSize(10); doc.text(divisaoTransporte, x3_start + (lineLength / 2), finalY + textYOffset -2, { align: 'center' });
doc.setFontSize(8); doc.text('Divisão de Transporte', x3_start + (lineLength / 2), finalY + textYOffset + 4, { align: 'center' });
}
});
doc.save(`Relatorio_Saidas_Ambulancias_${filterDateAmbInput.value || 'Geral'}.pdf`);
}

toggleSignaturesBtn.addEventListener('click', () => {
signaturesContainer.style.display = signaturesContainer.style.display === 'none' ? 'flex' : 'none';
});
saveObsBtn.addEventListener('click', () => {
if (currentObsContext && currentObsContext.ids.length > 0) {
const newObs = obsTextarea.value.trim();
const idToUpdate = currentObsContext.ids[0];
const index = saidasAmbulancias.findIndex(item => item.id === idToUpdate);
if (index !== -1) {
saidasAmbulancias[index].observacoes = newObs;
}
if (saveData()) {
populateTables();
closeAndResetObsModal();
window.parent.postMessage({ type: 'refresh_all_data' }, '*');
}
}
});
cancelObsBtn.addEventListener('click', closeAndResetObsModal);
closeObsModal.addEventListener('click', closeAndResetObsModal);
choiceModal.querySelector('.close-button').onclick = () => choiceModal.style.display = 'none';
choiceModal.querySelector('#cancelChoiceBtn').onclick = () => choiceModal.style.display = 'none';
const viewSaidaModal = document.getElementById('viewSaidaModal');
if (viewSaidaModal) {
viewSaidaModal.querySelector('.close-button').onclick = () => closeViewSaidaModal();
const closeBtn = viewSaidaModal.querySelector('.cancel-obs-btn');
if (closeBtn) {
closeBtn.onclick = () => closeViewSaidaModal();
}
}

// EVENT LISTENERS PARA MODAL DE PROBLEMAS
closeProblemasBtn.addEventListener('click', closeProblemasModal);
problemasModal.querySelector('.close-button').addEventListener('click', closeProblemasModal);

window.addEventListener('message', (event) => {
if (event.data?.type === 'refresh_data' || event.data.type === 'refresh_all_data') {
setDateToToday();
loadAllData();
populateTables();
populateMotoristaSelects(motoristasCadastrados);
}
// NOVO: LISTENER PARA ATUALIZAÇÃO DE VIATURAS COM PROBLEMAS
else if (event.data?.type === 'viaturas_problemas_update') {
loadViaturasComProblemas();
populateTables();
}
});
filterDateAmbInput.addEventListener('change', populateTables);
document.getElementById('downloadPdfBtn').addEventListener('click', downloadSaidasTableAsPdf);

// FUNCIONALIDADE DE IMPRESSÃO
const printModal = document.getElementById('printModal');
const calendarContainer = document.getElementById('calendarContainer');
const currentMonthYear = document.getElementById('currentMonthYear');
const prevMonthBtn = document.getElementById('prevMonthBtn');
const nextMonthBtn = document.getElementById('nextMonthBtn');
const selectedDatesSummary = document.getElementById('selectedDatesSummary');
const selectedDatesCount = document.getElementById('selectedDatesCount');
const confirmPrintBtn = document.getElementById('confirmPrintBtn');
const cancelPrintBtn = document.getElementById('cancelPrintBtn');
const closePrintModal = document.getElementById('closePrintModal');
const motoristasModal = document.getElementById('motoristasModal');
const motoristasModalDate = document.getElementById('motoristasModalDate');
const motoristasModalContent = document.getElementById('motoristasModalContent');
const confirmMotoristasBtn = document.getElementById('confirmMotoristasBtn');
const cancelMotoristasBtn = document.getElementById('cancelMotoristasBtn');
const closeMotoristasModal = document.getElementById('closeMotoristasModal');

// Armazenar motoristas selecionados por data
let motoristasSelecionados = {};
let selectedDatesSet = new Set();
let currentCalendarDate = new Date();
let datesWithData = new Set();

let currentDateBeingEdited = null;

function openPrintModal() {
    // Obter todas as datas únicas das saídas
    const allDates = [...new Set(saidasAmbulancias.map(s => s.dataSaida).filter(Boolean))];
    
    if (allDates.length === 0) {
        alert('Não há saídas cadastradas para imprimir.');
        return;
    }
    
    // Armazenar datas que têm saídas
    datesWithData = new Set(allDates);
    
    // Resetar calendário para o mês atual
    currentCalendarDate = new Date();
    currentCalendarDate.setDate(1); // Primeiro dia do mês
    
    // Resetar seleções
    motoristasSelecionados = {};
    selectedDatesSet = new Set();
    
    // Renderizar calendário
    renderCalendar();
    updateSelectedDatesSummary();
    
    printModal.style.display = 'flex';
}

function renderCalendar() {
    calendarContainer.innerHTML = '';
    const year = currentCalendarDate.getFullYear();
    const month = currentCalendarDate.getMonth();
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    // Atualizar cabeçalho
    currentMonthYear.textContent = `${new Date(year, month).toLocaleString('pt-BR', { month: 'long' })} ${year}`;
    
    // Adicionar dias da semana
    ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'].forEach(day => {
        const weekdayDiv = document.createElement('div');
        weekdayDiv.className = 'calendar-weekday';
        weekdayDiv.textContent = day;
        calendarContainer.appendChild(weekdayDiv);
    });
    
    // Primeiro dia do mês
    const firstDay = new Date(year, month, 1);
    const firstDayOfWeek = firstDay.getDay();
    
    // Preencher células vazias antes do primeiro dia
    for (let i = 0; i < firstDayOfWeek; i++) {
        const emptyDiv = document.createElement('div');
        calendarContainer.appendChild(emptyDiv);
    }
    
    // Último dia do mês
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    
    // Preencher os dias do mês
    for (let day = 1; day <= daysInMonth; day++) {
        const currentDate = new Date(year, month, day);
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const hasData = datesWithData.has(dateStr);
        const isSelected = selectedDatesSet.has(dateStr);
        const hasMotoristas = motoristasSelecionados[dateStr] && motoristasSelecionados[dateStr].motorista1 && motoristasSelecionados[dateStr].motorista2;
        const isToday = currentDate.getTime() === today.getTime();
        
        let classes = 'calendar-day';
        if (hasData) classes += ' has-data';
        if (isSelected) classes += ' selected';
        if (hasMotoristas) classes += ' has-motoristas';
        if (isToday) classes += ' today';
        
        const dayDiv = document.createElement('div');
        dayDiv.className = classes;
        dayDiv.dataset.date = dateStr;
        dayDiv.textContent = day;
        
        // Adicionar event listener
        if (hasData) {
            dayDiv.addEventListener('click', () => {
                selectedDatesSet.add(dateStr);
                openMotoristasModal(dateStr);
            });
        }
        
        calendarContainer.appendChild(dayDiv);
    }
}

function updateSelectedDatesSummary() {
    const count = selectedDatesSet.size;
    if (count > 0) {
        selectedDatesSummary.style.display = 'block';
        selectedDatesCount.textContent = count;
    } else {
        selectedDatesSummary.style.display = 'none';
    }
}

function openMotoristasModal(date) {
    currentDateBeingEdited = date;
    
    // Garantir que os motoristas estejam carregados
    loadAllData();
    
    // Obter TODOS os motoristas cadastrados (não apenas os da data)
    const todosMotoristas = motoristasCadastrados
        .filter(m => m && m.nome)
        .map(m => m.nome)
        .sort();
    
    const dateFormatted = new Date(date + 'T00:00:00').toLocaleDateString('pt-BR');
    motoristasModalDate.textContent = `Data: ${dateFormatted}`;
    
    // Limpar conteúdo anterior
    motoristasModalContent.innerHTML = '';
    
    // Obter valores já selecionados (se houver)
    const selecionados = motoristasSelecionados[date] || { motorista1: '', motorista2: '' };
    
    // Criar selects de motoristas com TODOS os motoristas cadastrados
    const div1 = document.createElement('div');
    div1.innerHTML = `
        <label style="font-weight: bold; display: block; margin-bottom: 5px;">Motorista 1:</label>
        <select id="modal_motorista1_${date}" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;">
            <option value="">Selecione o Motorista 1...</option>
            ${todosMotoristas.map(m => `<option value="${m}" ${selecionados.motorista1 === m ? 'selected' : ''}>${m}</option>`).join('')}
        </select>
    `;
    
    const div2 = document.createElement('div');
    div2.innerHTML = `
        <label style="font-weight: bold; display: block; margin-bottom: 5px;">Motorista 2:</label>
        <select id="modal_motorista2_${date}" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;">
            <option value="">Selecione o Motorista 2...</option>
            ${todosMotoristas.map(m => `<option value="${m}" ${selecionados.motorista2 === m ? 'selected' : ''}>${m}</option>`).join('')}
        </select>
    `;
    
    motoristasModalContent.appendChild(div1);
    motoristasModalContent.appendChild(div2);
    
    motoristasModal.style.display = 'flex';
}

function confirmMotoristasSelection() {
    if (!currentDateBeingEdited) return;
    
    const motorista1Select = document.getElementById(`modal_motorista1_${currentDateBeingEdited}`);
    const motorista2Select = document.getElementById(`modal_motorista2_${currentDateBeingEdited}`);
    
    const motorista1 = motorista1Select ? motorista1Select.value : '';
    const motorista2 = motorista2Select ? motorista2Select.value : '';
    
    if (!motorista1 || !motorista2) {
        alert('Por favor, selecione os dois motoristas.');
        return;
    }
    
    // Salvar seleção
    motoristasSelecionados[currentDateBeingEdited] = {
        motorista1: motorista1,
        motorista2: motorista2
    };
    
    // Adicionar à lista de datas selecionadas se ainda não estiver
    selectedDatesSet.add(currentDateBeingEdited);
    
    // Re-renderizar calendário para atualizar indicadores visuais
    renderCalendar();
    updateSelectedDatesSummary();
    
    // Fechar modal de motoristas
    motoristasModal.style.display = 'none';
    currentDateBeingEdited = null;
}

function generatePrintHTML(selectedDates, motoristasPorData) {
    const currentDivisaoTransporte = divisaoTransporteSelect.value || '__________________________________';
    
    let printHTML = `
        <!DOCTYPE html>
        <html lang="pt-BR">
        <head>
            <meta charset="UTF-8">
            <title>Relatório de Saídas de Ambulâncias</title>
            <style>
                @media print {
                    @page { margin: 1cm; size: landscape; }
                    body { margin: 0; }
                }
                body { font-family: Arial, sans-serif; margin: 20px; }
                h1 { color: #4a69bd; font-size: 20px; margin-bottom: 5px; }
                h2 { color: #333; font-size: 14px; margin-bottom: 10px; }
                table { width: 100%; border-collapse: collapse; margin-bottom: 120px; page-break-inside: auto; }
                th, td { border: 1px solid #e9ecef; padding: 6px; text-align: left; font-size: 10px; }
                thead th { background-color: #4a69bd; color: white; font-weight: bold; text-transform: uppercase; }
                tbody tr:nth-child(even) { background-color: #f8f9fa; }
                .signature { text-align: center; margin-top: 120px; page-break-inside: avoid; }
                .signature-line { border-top: 1px solid #000; width: 300px; margin: 0 auto; padding-top: 5px; }
                .signatures-top { display: flex; justify-content: space-around; margin-bottom: 30px; }
            </style>
        </head>
        <body>
    `;
    
    selectedDates.forEach((date, index) => {
        const filteredSaidas = saidasAmbulancias.filter(s => s.dataSaida === date);
        if (filteredSaidas.length === 0) return;
        
        filteredSaidas.sort((a, b) => (a.saida || '').localeCompare(b.saida || ''));
        const groupedAmbSaidas = groupSaidas(filteredSaidas);
        const dateFormatted = new Date(date + 'T00:00:00').toLocaleDateString('pt-BR');
        
        printHTML += `
            <h1>Relatório de Saídas de Ambulâncias</h1>
            <h2>Data: ${dateFormatted}</h2>
            <h2>Total de Saídas: ${filteredSaidas.length}</h2>
            <table>
                <thead>
                    <tr>
                        <th>VIATURA</th>
                        <th>MOTORISTA</th>
                        <th>SAÍDA</th>
                        <th>DESTINO</th>
                        <th>KM SAÍDA</th>
                        <th>KM CHEGADA</th>
                        <th>CHEGADA</th>
                        <th>SETOR</th>
                        <th>OM</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        groupedAmbSaidas.forEach(item => {
            printHTML += `
                <tr>
                    <td>${item.viatura || ''}</td>
                    <td>${item.motorista || ''}</td>
                    <td>${item.saida || ''}</td>
                    <td>${item.isGroup ? item.destinos.map(d => extrairBairroDoDestino(d)).join(', ') : extrairBairroDoDestino(item.destino || '')}</td>
                    <td>${item.kmSaida || ''}</td>
                    <td>${item.kmChegada || ''}</td>
                    <td>${item.chegada || ''}</td>
                    <td>${item.isGroup ? [...new Set(item.setores)].join(', ') : item.setor || ''}</td>
                    <td>${item.om || (item.isGroup ? [...new Set(item.ids.map(id => {
                        const saida = saidasAmbulancias.find(s => s.id === id);
                        return saida ? saida.om : '';
                    }).filter(om => om))].join(', ') : '')}</td>
                </tr>
            `;
        });
        
        // Obter motoristas selecionados para esta data
        const motoristasData = motoristasPorData[date] || {};
        const motorista1 = motoristasData.motorista1 || '__________________________________';
        const motorista2 = motoristasData.motorista2 || '__________________________________';
        
        printHTML += `
                </tbody>
            </table>
            <div class="signature">
                <div class="signatures-top">
                    <div style="flex: 1; margin-right: 20px;">
                        <div class="signature-line">${motorista1}</div>
                        <div style="margin-top: 5px;">Motorista 1</div>
                    </div>
                    <div style="flex: 1; margin-left: 20px;">
                        <div class="signature-line">${motorista2}</div>
                        <div style="margin-top: 5px;">Motorista 2</div>
                    </div>
                </div>
                <div style="margin-top: 30px;">
                    <div class="signature-line" style="margin: 0 auto;">${currentDivisaoTransporte}</div>
                    <div style="margin-top: 5px;">Divisão de Transporte</div>
                </div>
            </div>
        `;
        
        // Adicionar quebra de página se não for a última data
        if (index < selectedDates.length - 1) {
            printHTML += '<div style="page-break-after: always;"></div>';
        }
    });
    
    printHTML += `
        </body>
        </html>
    `;
    
    return printHTML;
}

function printSelectedDates() {
    if (selectedDatesSet.size === 0) {
        alert('Selecione pelo menos uma data para imprimir.');
        return;
    }
    
    const selectedDates = Array.from(selectedDatesSet).sort();
    const datasIncompletas = [];
    
    // Verificar se todas as datas têm motoristas selecionados
    selectedDates.forEach(date => {
        if (!motoristasSelecionados[date] || !motoristasSelecionados[date].motorista1 || !motoristasSelecionados[date].motorista2) {
            const dateFormatted = new Date(date + 'T00:00:00').toLocaleDateString('pt-BR');
            datasIncompletas.push(dateFormatted);
        }
    });
    
    // Validar se todas as datas têm motoristas selecionados
    if (datasIncompletas.length > 0) {
        alert(`Por favor, selecione os dois motoristas para as seguintes datas:\n${datasIncompletas.join('\n')}`);
        return;
    }
    
    // Gerar HTML de impressão usando motoristasSelecionados
    const printHTML = generatePrintHTML(selectedDates, motoristasSelecionados);
    
    // Criar janela de impressão
    const printWindow = window.open('', '_blank');
    printWindow.document.write(printHTML);
    printWindow.document.close();
    
    // Aguardar o carregamento e abrir diálogo de impressão
    printWindow.onload = () => {
        setTimeout(() => {
            printWindow.print();
        }, 250);
    };
    
    // Fechar modal
    printModal.style.display = 'none';
}

document.getElementById('printBtn').addEventListener('click', openPrintModal);
confirmPrintBtn.addEventListener('click', printSelectedDates);
cancelPrintBtn.addEventListener('click', () => { printModal.style.display = 'none'; });
closePrintModal.addEventListener('click', () => { printModal.style.display = 'none'; });
printModal.addEventListener('click', (e) => {
    if (e.target === printModal) {
        printModal.style.display = 'none';
    }
});

// Navegação do calendário
prevMonthBtn.addEventListener('click', () => {
    currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
    renderCalendar();
    updateSelectedDatesSummary();
});

nextMonthBtn.addEventListener('click', () => {
    currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
    renderCalendar();
    updateSelectedDatesSummary();
});

// Event listeners do modal de motoristas
confirmMotoristasBtn.addEventListener('click', confirmMotoristasSelection);
cancelMotoristasBtn.addEventListener('click', () => { 
    motoristasModal.style.display = 'none'; 
    currentDateBeingEdited = null;
});
closeMotoristasModal.addEventListener('click', () => { 
    motoristasModal.style.display = 'none'; 
    currentDateBeingEdited = null;
});
motoristasModal.addEventListener('click', (e) => {
    if (e.target === motoristasModal) {
        motoristasModal.style.display = 'none';
        currentDateBeingEdited = null;
    }
});

// Função para inicializar e atualizar dados
let refreshTimeout = null;
function initializeAndRefresh() {
setDateToToday();
loadAllData();
populateTables();
populateMotoristaSelects(motoristasCadastrados);
}

// Função com debounce para evitar múltiplas chamadas
function debouncedRefresh() {
if (refreshTimeout) {
clearTimeout(refreshTimeout);
}
refreshTimeout = setTimeout(() => {
initializeAndRefresh();
refreshTimeout = null;
}, 100);
}

// Inicializar ao carregar
initializeAndRefresh();

// Atualizar quando a página se torna visível (quando a aba é aberta)
document.addEventListener('visibilitychange', () => {
if (!document.hidden) {
debouncedRefresh();
}
});

// Também atualizar quando a janela recebe foco (mas apenas se estiver visível)
window.addEventListener('focus', () => {
if (!document.hidden) {
debouncedRefresh();
}
});
});
</script>

<!-- Modais -->
<div id="obsModal" class="obs-modal">
<div class="obs-modal-content">
<span class="close-button" id="closeObsModal">&times;</span>
<h2>Observações / Ocorrências</h2>
<textarea id="obsTextarea"></textarea>
<div class="modal-buttons">
<button id="saveObsBtn" class="save-obs-btn">Salvar</button>
<button id="cancelObsBtn" class="cancel-obs-btn">Cancelar</button>
</div>
</div>
</div>

<div id="viewSaidaModal" class="obs-modal">
<div class="obs-modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
<span class="close-button">&times;</span>
<h2>Detalhes da Saída</h2>
<div id="viewSaidaContent" style="margin-top: 20px;"></div>
<div class="modal-buttons">
<button class="cancel-obs-btn">Fechar</button>
</div>
</div>
</div>
<div id="choiceModal" class="obs-modal">
<div class="obs-modal-content">
<span class="close-button">&times;</span>
<h2 id="choiceModalTitle">Escolha a Saída</h2>
<div id="choiceModalContent"></div>
<div class="modal-buttons">
<button id="cancelChoiceBtn" class="cancel-obs-btn">Cancelar</button>
</div>
</div>
</div>

<div id="problemasModal" class="obs-modal">
<div class="obs-modal-content">
<span class="close-button">&times;</span>
<h2><i class="fas fa-exclamation-triangle"></i> Problemas da Viatura <span id="problemasPlaca"></span></h2>
<div id="problemasLista"></div>
<div class="modal-buttons">
<button class="cancel-obs-btn" id="closeProblemasBtn">Fechar</button>
</div>
</div>
</div>

<!-- MODAL DE IMPRESSÃO -->
<div id="printModal" class="obs-modal">
<div class="obs-modal-content" style="max-width: 700px;">
<span class="close-button" id="closePrintModal">&times;</span>
<h2>Selecione as Datas para Imprimir</h2>
<div class="calendar-header">
<button id="prevMonthBtn">&lt;</button>
<span id="currentMonthYear"></span>
<button id="nextMonthBtn">&gt;</button>
</div>
<div class="calendar-grid" id="calendarContainer"></div>
<div id="selectedDatesSummary" style="margin-top: 15px; padding: 10px; background-color: #e8f4f8; border-radius: 5px; display: none;">
<p style="margin: 0; font-weight: bold; color: var(--dark-gray);">Datas selecionadas: <span id="selectedDatesCount">0</span></p>
</div>
<div class="modal-buttons">
<button id="confirmPrintBtn" class="save-obs-btn"><i class="fas fa-print"></i> Imprimir</button>
<button id="cancelPrintBtn" class="cancel-obs-btn">Cancelar</button>
</div>
</div>
</div>

<!-- MODAL DE SELEÇÃO DE MOTORISTAS -->
<div id="motoristasModal" class="obs-modal">
<div class="obs-modal-content" style="max-width: 500px;">
<span class="close-button" id="closeMotoristasModal">&times;</span>
<h2><i class="fas fa-user"></i> Selecionar Motoristas</h2>
<div style="margin: 20px 0;">
<p id="motoristasModalDate" style="margin-bottom: 15px; color: var(--primary-blue); font-weight: bold; font-size: 16px;"></p>
<div id="motoristasModalContent" style="display: flex; flex-direction: column; gap: 15px;">
<!-- Motoristas selects will be populated here -->
</div>
</div>
<div class="modal-buttons">
<button id="confirmMotoristasBtn" class="save-obs-btn">Confirmar</button>
<button id="cancelMotoristasBtn" class="cancel-obs-btn">Cancelar</button>
</div>
</div>
</div>

<script>
const userActivityEvents = ['mousemove', 'mousedown', 'keypress', 'scroll', 'touchstart'];
function notifyParentOfActivity() {
window.parent.postMessage({ type: 'user_activity' }, '*');
}
userActivityEvents.forEach(eventName => {
document.addEventListener(eventName, notifyParentOfActivity, { passive: true });
});

// Variáveis globais para armazenar contexto do modal
let kmAlertCell = null;
let kmAlertRow = null;
let kmAlertIds = null;
let kmAlertCanClear = false; // Flag para indicar se pode apagar o valor

// Modal de alerta de quilometragem
function showKmAlertModal(message, cell, row, ids, canClear = false) {
    const modal = document.getElementById('kmAlertModal');
    const messageElement = document.getElementById('kmAlertMessage');
    if (modal && messageElement) {
        messageElement.textContent = message;
        modal.classList.add('show');
        // Armazenar contexto para poder apagar o valor se necessário
        kmAlertCell = cell;
        kmAlertRow = row;
        kmAlertIds = ids;
        kmAlertCanClear = canClear;
    }
}

function closeKmAlertModal() {
    const modal = document.getElementById('kmAlertModal');
    if (modal) {
        modal.classList.remove('show');
    }
    // Limpar variáveis ao fechar
    kmAlertCell = null;
    kmAlertRow = null;
    kmAlertIds = null;
    kmAlertCanClear = false;
}

// Função para apagar KM CHEGADA
function clearKmChegada() {
    if (!kmAlertCanClear) {
        return;
    }
    
    if (!kmAlertCell || !kmAlertRow || !kmAlertIds || !kmAlertIds.length) {
        return;
    }
    
    try {
        // Limpar o valor na célula
        if (kmAlertCell) {
            kmAlertCell.textContent = '';
        }
        
        // Limpar o valor nos dados
        let updated = false;
        kmAlertIds.forEach(id => {
            const index = saidasAmbulancias.findIndex(item => item.id === id);
            if (index !== -1) {
                saidasAmbulancias[index].kmChegada = '';
                updated = true;
            }
        });
        
        // Salvar os dados se houver atualização
        if (updated) {
            if (typeof saveData === 'function') {
                saveData();
            }
            if (typeof atualizarEstiloDaLinha === 'function') {
                atualizarEstiloDaLinha(kmAlertRow);
            }
            if (window.parent && window.parent.postMessage) {
                window.parent.postMessage({ type: 'refresh_all_data' }, '*');
            }
        }
    } catch (error) {
        console.error('Erro ao apagar KM CHEGADA:', error);
    }
}

// Event listeners para o modal - usando delegação de eventos para garantir que funcione
document.addEventListener('click', function(e) {
    // Verificar se o clique foi em algum elemento do modal
    const modal = document.getElementById('kmAlertModal');
    if (!modal || !modal.classList.contains('show')) {
        return; // Modal não está aberto
    }
    
    // Botão "Sim"
    if (e.target && (e.target.id === 'kmAlertConfirmBtn' || e.target.closest('#kmAlertConfirmBtn'))) {
        e.preventDefault();
        e.stopPropagation();
        closeKmAlertModal();
        return false;
    }
    
    // Botão "Não"
    if (e.target && (e.target.id === 'kmAlertCancelBtn' || e.target.closest('#kmAlertCancelBtn'))) {
        e.preventDefault();
        e.stopPropagation();
        clearKmChegada();
        closeKmAlertModal();
        return false;
    }
    
    // Botão fechar (X)
    if (e.target && (e.target.id === 'kmAlertCloseBtn' || e.target.closest('#kmAlertCloseBtn'))) {
        e.preventDefault();
        e.stopPropagation();
        closeKmAlertModal();
        return false;
    }
    
    // Clicar fora do modal (no overlay)
    if (e.target && e.target.id === 'kmAlertModal') {
        e.preventDefault();
        e.stopPropagation();
        closeKmAlertModal();
        return false;
    }
}, true); // Usar capture phase para garantir que seja executado primeiro
</script>

<!-- Modal de Alerta de Quilometragem -->
<div id="kmAlertModal" class="km-alert-modal">
    <div class="km-alert-modal-content">
        <span id="kmAlertCloseBtn" class="close-button">&times;</span>
        <h3>⚠️ Alerta de Quilometragem</h3>
        <p id="kmAlertMessage"></p>
        <div class="km-alert-modal-buttons">
            <button id="kmAlertConfirmBtn" class="km-alert-confirm-btn">Sim</button>
            <button id="kmAlertCancelBtn" class="km-alert-cancel-btn">Não</button>
        </div>
    </div>
</div>

</body>
</html>