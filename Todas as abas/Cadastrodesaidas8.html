<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SISTEMA DE ORGANIZAÇÃO DE TRANSPORTE - CADASTRO DE SAÍDAS</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
<!-- Versão mais recente e otimizada para melhor performance -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<!-- Biblioteca Tesseract.js para OCR -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
<script src="theme-listener.js"></script>
<script src="api-service.js"></script>
<script src="data-service.js"></script>
<script src="junta-saidas-service.js"></script>
<style>
:root {
--primary-blue: #4a69bd;
--secondary-blue: #6c88c9;
--gray: #dcdcdc;
--dark-gray: #333d47;
--white: #ffffff;
--light-gray-bg: #f9f9f9;
--tab-inactive-bg: #e9ecef;
--tab-active-bg: var(--white);
--tab-border: 1px solid #dee2e6;
--delete-red: #dc3545;
--blink-red: #ff0000;
--success-green: #28a745;
--warning-orange: #ffc107;
--export-excel: #21a221;
--import-blue: #007bff;
--tab-text-color: var(--dark-gray);
--tab-text-color-active: var(--primary-blue);
--tab-text-color-hover: var(--tab-text-color);
--tab-hover-bg: #dcdcdc;
--tab-border-color: #ccc;
--tab-border-color-active: var(--primary-blue);
}
body {
font-family: 'Arial', sans-serif;
margin: 0;
padding: 0;
background-color: var(--light-gray-bg);
color: var(--dark-gray);
font-weight: 500;
min-height: 100vh;
}
header {
background-color: var(--white);
padding: 20px 20px;
display: flex;
justify-content: center;
align-items: center;
border-bottom: 1px solid var(--gray);
box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}
.main-title {
font-size: 28px;
color: var(--primary-blue);
font-weight: bold;
text-align: center;
text-shadow: 0 2px 4px rgba(0,0,0,0.35), 0 4px 18px rgba(0,0,0,0.25), 0 4px 20px rgba(74,105,189,0.4), 0 1px 3px rgba(255,255,255,0.5);
}
main {
margin: 20px 10px;
padding: 0;
box-sizing: border-box;
}
.tab-content {
display: none;
background-color: var(--white);
padding: 20px;
border-radius: 8px;
border: var(--tab-border);
box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}
.tab-content.active {
display: block;
}
.sub-tabs {
display: flex;
justify-content: center;
border-bottom: 1px solid #ccc;
margin-bottom: 20px;
flex-wrap: wrap;
}
.sub-tab-button {
background-color: #e9e9e9;
color: var(--dark-gray);
border: 1px solid #ccc;
border-bottom: none;
padding: 10px 15px;
border-radius: 6px 6px 0 0;
cursor: pointer;
font-size: 14px;
font-weight: bold;
margin-right: 3px;
transition: background-color 0.3s ease;
text-shadow: 0 2px 4px rgba(0,0,0,0.22);
}
.sub-tab-button:hover {
background-color: #dcdcdc;
text-shadow: 0 2px 6px rgba(0,0,0,0.28);
}
.sub-tab-button.active {
background-color: var(--white);
border-color: var(--primary-blue);
border-bottom: 1px solid var(--white);
position: relative;
z-index: 1;
color: var(--primary-blue);
text-shadow: 0 2px 4px rgba(0,0,0,0.3), 0 4px 12px rgba(74,105,189,0.45);
}
.sub-tab-content {
display: none;
padding: 10px 0;
}
.sub-tab-content.active {
display: block;
}
.table-controls {
display: flex;
justify-content: space-between;
align-items: center;
flex-wrap: wrap;
gap: 10px;
margin-bottom: 15px;
flex-wrap: wrap;
gap: 10px;
}
.table-title {
font-size: 22px;
color: var(--primary-blue);
font-weight: bold;
margin: 0;
text-shadow: 0 2px 4px rgba(0,0,0,0.35), 0 4px 14px rgba(0,0,0,0.22), 0 4px 16px rgba(74,105,189,0.4);
}
.icon-btn-teste {
display: inline-flex;
align-items: center;
justify-content: center;
width: 36px;
height: 36px;
padding: 0;
border: 1px solid var(--gray);
border-radius: 8px;
background: #f1f3f5;
color: var(--primary-blue);
cursor: pointer;
transition: background 0.2s, color 0.2s;
}
.icon-btn-teste:hover {
background: var(--primary-blue);
color: var(--white);
}
.icon-btn-teste i { font-size: 16px; }
.table-controls-title-row { display: flex; align-items: center; gap: 10px; }
.counters-container {
display: flex;
flex-direction: column;
align-items: flex-end;
gap: 5px;
}
.counter {
font-size: 18px;
font-weight: bold;
color: var(--primary-blue);
}
.register-exit-form {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
gap: 20px;
background-color: var(--light-gray-bg);
padding: 20px;
border-radius: 8px;
border: 1px solid var(--gray);
}
.form-group {
display: flex;
flex-direction: column;
position: relative;
}
.form-group i {
position: absolute;
left: 15px;
top: 45px;
color: #b0b0b0;
font-size: 16px;
z-index: 1;
}
.form-group > div > i {
position: static;
margin-right: 5px;
}
.form-group label {
font-weight: bold;
margin-bottom: 8px;
color: var(--dark-gray);
}
.register-exit-form input,
.register-exit-form select {
width: 100%;
padding: 10px 15px 10px 40px;
border: 1px solid #ced4da;
border-radius: 5px;
font-size: 16px;
transition: border-color 0.3s ease, box-shadow 0.3s ease;
box-sizing: border-box;
-webkit-appearance: none;
-moz-appearance: none;
appearance: none;
}
.register-exit-form .form-group > div > input,
.register-exit-form .form-group > div > select {
padding: 10px 15px 10px 40px;
}
.register-exit-form select {
background-color: var(--white);
}
.register-exit-form input:focus,
.register-exit-form select:focus {
outline: none;
border-color: var(--primary-blue);
box-shadow: 0 0 0 2px rgba(74, 105, 189, 0.25);
}
.register-exit-form-buttons {
grid-column: 1 / -1;
display: flex;
flex-wrap: wrap;
gap: 10px;
margin-top: 10px;
}
.register-exit-form button {
background-color: var(--primary-blue);
color: var(--white);
border: none;
padding: 12px 25px;
border-radius: 5px;
cursor: pointer;
font-size: 16px;
font-weight: bold;
transition: background-color 0.3s ease, transform 0.2s ease;
flex-grow: 1;
box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}
.register-exit-form button:hover {
background-color: var(--secondary-blue);
transform: translateY(-2px);
}
#serialRegisterBtn {
background-color: var(--success-green);
}
#serialRegisterBtn:hover {
background-color: #218838;
}
#multiSaidaBtn {
background-color: var(--warning-orange);
}
#multiSaidaBtn:hover {
background-color: #e0a800;
}
#loadDocumentBtn {
background-color: #6c5ce7;
}
#loadDocumentBtn:hover {
background-color: #5f4fd4;
}
#loadDocumentBtn i {
margin-right: 8px;
}
.hidden-load-btn {
display: none !important;
}
.register-exit-form .message {
grid-column: 1 / -1;
text-align: center;
font-weight: bold;
padding: 10px;
border-radius: 5px;
margin-top: 10px;
}
.add-item-btn {
background: none;
background-color: transparent;
color: var(--primary-blue);
border: none;
outline: none;
padding: 0;
margin: 0;
cursor: pointer;
font-size: 14px;
transition: all 0.3s ease;
display: inline-flex;
align-items: center;
justify-content: center;
opacity: 0.6;
-webkit-appearance: none;
-moz-appearance: none;
appearance: none;
}
.add-item-btn:hover {
opacity: 1;
color: var(--success-green);
}
.add-item-btn:focus {
outline: none;
border: none;
box-shadow: none;
}
.add-item-btn i {
font-size: 16px;
}
.register-exit-form .success {
color: #155724;
background-color: #d4edda;
border: 1px solid #c3e6cb;
}
.register-exit-form .error {
color: #721c24;
background-color: #f8d7da;
border: 1px solid #f5c6cb;
}
.config-section {
background-color: var(--white);
padding: 20px;
border-radius: 8px;
border: 1px solid var(--gray);
margin-bottom: 20px;
}
.config-section h3 {
font-size: 18px;
color: var(--primary-blue);
margin: 0 0 15px 0;
padding-bottom: 10px;
border-bottom: 2px solid var(--primary-blue);
}
.config-section table {
width: 100%;
border-collapse: collapse;
margin-top: 10px;
}
.config-section table thead th {
background-color: var(--primary-blue);
color: white;
padding: 10px;
text-align: left;
font-weight: bold;
}
.config-section table tbody td {
padding: 10px;
border-bottom: 1px solid #e9ecef;
}
.config-section table tbody tr:hover {
background-color: #f8f9fa;
}
.config-section .success {
background-color: var(--success-green);
color: white;
border: none;
padding: 8px 16px;
border-radius: 4px;
cursor: pointer;
font-weight: bold;
}
.config-section .success:hover {
background-color: #218838;
}
.config-section .delete-btn {
background-color: var(--error-red);
color: white;
border: none;
padding: 6px 12px;
border-radius: 4px;
cursor: pointer;
font-size: 12px;
}
.config-section .delete-btn:hover {
background-color: #c82333;
}
.editable-cell {
cursor: text;
transition: background-color 0.2s;
}
.editable-cell:hover {
background-color: #f0f8ff;
}
.editable-cell:focus {
background-color: #e3f2fd;
outline: 2px solid var(--primary-blue);
outline-offset: -2px;
}
.itens-tabs-container {
width: 100%;
}
.itens-tabs {
display: flex;
flex-wrap: wrap;
gap: 5px;
border-bottom: 2px solid var(--primary-blue);
margin-bottom: 20px;
}
.itens-tab-button {
padding: 12px 20px;
background-color: #f0f0f0;
border: none;
border-bottom: 3px solid transparent;
cursor: pointer;
font-size: 14px;
font-weight: 500;
color: #666;
transition: all 0.3s ease;
display: flex;
align-items: center;
gap: 8px;
}
.itens-tab-button:hover {
background-color: #e0e0e0;
color: var(--primary-blue);
}
.itens-tab-button.active {
background-color: white;
color: var(--primary-blue);
border-bottom-color: var(--primary-blue);
font-weight: 600;
}
.itens-tab-content {
display: none;
padding: 20px 0;
}
.itens-tab-content.active {
display: block;
}
.bairros-cidades-tabs-container {
width: 100%;
margin-top: 20px;
}
.bairros-cidades-tabs {
display: flex;
flex-wrap: wrap;
gap: 5px;
border-bottom: 2px solid var(--primary-blue);
margin-bottom: 20px;
}
.bairros-cidade-tab-button {
padding: 10px 18px;
background-color: #f0f0f0;
border: none;
border-bottom: 3px solid transparent;
cursor: pointer;
font-size: 13px;
font-weight: 500;
color: #666;
transition: all 0.3s ease;
}
.bairros-cidade-tab-button:hover {
background-color: #e0e0e0;
color: var(--primary-blue);
}
.bairros-cidade-tab-button.active {
background-color: white;
color: var(--primary-blue);
border-bottom-color: var(--primary-blue);
font-weight: 600;
}
.bairros-cidade-content {
display: none;
padding: 15px 0;
}
.bairros-cidade-content.active {
display: block;
}
@keyframes blinker {
50% { opacity: 0; }
}
.flash-red {
animation: blinker 1s linear infinite;
border-color: var(--blink-red) !important;
box-shadow: 0 0 0 2px rgba(255, 0, 0, 0.25);
}
.date-filter-container {
display: flex;
align-items: center;
gap: 15px;
padding: 15px;
border: 1px solid var(--gray);
border-radius: 8px;
background-color: var(--light-gray-bg);
flex-wrap: wrap;
justify-content: flex-start;
}
.date-filter-container label, .filter-group label {
font-weight: bold;
}
.date-filter-container input[type="date"],
.date-filter-container select {
padding: 8px 12px;
border: 1px solid #ced4da;
border-radius: 5px;
font-size: 16px;
font-weight: bold;
}
.filter-group {
display: flex;
align-items: center;
gap: 20px;
flex-wrap: wrap;
}
.filter-group > div {
display: flex;
align-items: center;
gap: 5px;
}
.filter-group input {
transform: scale(1.2);
cursor: pointer;
}
.action-buttons {
display: flex;
gap: 5px;
justify-content: center;
}
.action-buttons button {
color: var(--white);
border: none;
padding: 8px 12px;
border-radius: 4px;
cursor: pointer;
font-size: 14px;
transition: background-color 0.3s ease;
}
.action-buttons button:hover {
opacity: 0.8;
}
.action-buttons .delete-row-btn { background-color: var(--delete-red); }
.action-buttons .edit-row-btn { background-color: var(--primary-blue); }
.table-buttons {
display: flex;
flex-wrap: wrap;
gap: 10px;
margin-bottom: 10px;
}
.table-buttons button, .table-buttons label {
border: none;
padding: 8px 12px;
border-radius: 4px;
cursor: pointer;
font-size: 14px;
font-weight: bold;
}
.table-buttons .pdf-btn {
background-color: var(--primary-blue);
color: var(--white);
}
.table-buttons .excel-export-btn {
background-color: var(--success-green);
color: var(--white);
}
.table-buttons .csv-import-label {
background-color: var(--import-blue);
color: var(--white);
padding: 8px 12px;
border-radius: 4px;
cursor: pointer;
}
.delete-all-btn {
background-color: #dc3545;
color: var(--white);
}
.delete-all-btn:hover {
background-color: #c82333;
}
table {
width: 100%;
border-collapse: collapse;
background-color: var(--white);
box-shadow: 0 2px 5px rgba(0,0,0,0.05);
border-radius: 8px;
overflow: hidden;
min-width: 1000px;
}
th, td {
border: 1px solid #e9e9e9;
padding: 10px;
text-align: left;
font-size: 14px;
}
.ocorrencia-cell {
white-space: normal;
word-wrap: break-word;
max-width: 250px;
vertical-align: top;
}
thead th {
background-color: var(--primary-blue);
color: var(--white);
font-weight: bold;
text-transform: uppercase;
font-size: 12px;
}
tbody tr:nth-child(even) {
background-color: #f8f9fa;
}
.table-container {
overflow-x: auto;
}
#unplannedExitsTable {
width: 100%;
min-width: 800px;
margin: 0 auto;
}
#unplannedExitsTable th, #unplannedExitsTable td {
text-align: center;
}
#unplannedExitsTable tfoot tr {
background-color: var(--primary-blue);
color: var(--white);
font-weight: bold;
}
#unplannedExitsTotalText {
margin-top: 20px;
font-size: 18px;
color: var(--primary-blue);
text-align: center;
font-weight: bold;
}
.obs-modal {
display: none;
position: fixed;
z-index: 1000;
left: 0;
top: 0;
width: 100%;
height: 100%;
background-color: rgba(0,0,0,0.5);
justify-content: center;
align-items: center;
}
#addItemModal {
position: fixed;
inset: 0;
align-items: flex-start;
justify-content: center;
padding: 32px;
padding-top: 80px;
background: radial-gradient(circle at top, rgba(74,105,189,0.28), rgba(23,32,42,0.88));
backdrop-filter: blur(6px);
z-index: 99999;
display: none;
}
#addItemModal[style*="display: flex"] {
display: flex !important;
}
#addItemModal .obs-modal-content {
max-width: 420px;
width: 100%;
padding: 32px 28px;
border-radius: 24px;
background: rgba(255,255,255,0.92);
box-shadow: 0 24px 50px rgba(16,24,40,0.22);
transform: translateY(32px) scale(0.96);
opacity: 0;
animation: cardPop 0.6s cubic-bezier(.16,1,.3,1) forwards 0.2s;
}
@keyframes cardPop {
0% { opacity: 0; transform: translateY(32px) scale(0.96); }
100% { opacity: 1; transform: translateY(0) scale(1); }
}
.obs-modal-content {
background-color: var(--white);
padding: 30px;
border-radius: 10px;
box-shadow: 0 5px 15px rgba(0,0,0,0.3);
width: 90%;
max-width: 500px;
position: relative;
}
.close-button {
position: absolute;
top: 10px;
right: 15px;
font-size: 30px;
color: #aaa;
cursor: pointer;
}
.modal-buttons {
display: flex;
justify-content: center;
margin-top: 20px;
gap: 10px;
}
.modal-buttons button {
padding: 10px 20px;
border-radius: 5px;
cursor: pointer;
font-weight: bold;
border: none;
}
.modal-buttons .save-obs-btn {
background-color: var(--primary-blue);
color: var(--white);
}
.modal-buttons .cancel-obs-btn {
background-color: var(--gray);
color: var(--dark-gray);
}
/* Modal de alerta de quilometragem */
#kmAlertModal { display: none; position: fixed; z-index: 10002; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: flex-start; padding-top: 100px; }
#kmAlertModal.show { display: flex; }
.km-alert-modal-content { background-color: var(--white); padding: 30px; border-radius: 10px; width: 90%; max-width: 500px; position: relative; box-shadow: 0 4px 20px rgba(0,0,0,0.3); text-align: center; margin-top: 0; }
.km-alert-modal-content h3 { margin-top: 0; margin-bottom: 20px; color: var(--dark-gray); font-size: 20px; }
.km-alert-modal-content p { margin-bottom: 25px; color: #666; font-size: 16px; line-height: 1.5; }
.km-alert-modal-buttons { display: flex; justify-content: center; gap: 10px; }
.km-alert-modal-buttons button { padding: 12px 30px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; transition: background-color 0.3s; }
.km-alert-confirm-btn { background-color: var(--primary-blue); color: var(--white); }
.km-alert-confirm-btn:hover { background-color: var(--secondary-blue); }
.km-alert-cancel-btn { background-color: #6c757d; color: var(--white); }
.km-alert-cancel-btn:hover { background-color: #5a6268; }
/* Modal de limite de saídas excedido */
#limiteSaidasModal { display: none; position: fixed; z-index: 10003; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.45); backdrop-filter: blur(4px); justify-content: center; align-items: center; }
#limiteSaidasModal.show { display: flex; }
.limite-saidas-modal-content {
    background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
    padding: 32px 36px;
    border-radius: 16px;
    width: 90%;
    max-width: 420px;
    text-align: center;
    box-shadow: 0 25px 50px rgba(0,0,0,0.15), 0 10px 20px rgba(0,0,0,0.08), 0 0 0 1px rgba(74,105,189,0.08);
    transform: translateY(-10cm);
    border: 1px solid rgba(74,105,189,0.12);
}
.limite-saidas-modal-content h3 {
    margin: 0 0 12px 0;
    color: var(--primary-blue);
    font-size: 20px;
    font-weight: 700;
    letter-spacing: 0.02em;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
}
.limite-saidas-modal-content h3::before {
    content: '';
    display: inline-block;
    width: 24px;
    height: 24px;
    background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%234a69bd' viewBox='0 0 24 24'%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z'/%3E%3C/svg%3E") no-repeat center;
    background-size: contain;
}
.limite-saidas-modal-content p {
    margin: 0 0 28px 0;
    color: #475569;
    font-size: 15px;
    line-height: 1.6;
}
.limite-saidas-modal-content .limite-saidas-ok {
    padding: 12px 44px;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    font-size: 15px;
    font-weight: 600;
    background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-blue) 100%);
    color: var(--white);
    box-shadow: 0 4px 14px rgba(74,105,189,0.35);
    transition: transform 0.2s, box-shadow 0.2s;
}
.limite-saidas-modal-content .limite-saidas-ok:hover {
    transform: translateY(-1px);
    box-shadow: 0 6px 20px rgba(74,105,189,0.4);
}
.limite-saidas-modal-content .limite-saidas-ok:active {
    transform: translateY(0);
}
/* Modal de dados extraídos */
#extractedDataModal { display: none !important; position: fixed; z-index: 10004; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
#extractedDataModal.show { display: flex !important; }
.extracted-data-modal-content { background-color: var(--white); padding: 30px; border-radius: 10px; width: 90%; max-width: 700px; max-height: 80vh; overflow-y: auto; position: relative; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
.extracted-data-modal-content h3 { margin-top: 0; margin-bottom: 20px; color: var(--dark-gray); font-size: 20px; text-align: center; }
.extracted-data-list { margin: 20px 0; }
.extracted-data-item { display: flex; justify-content: space-between; padding: 12px; margin: 8px 0; background: #f8f9fa; border-radius: 5px; border-left: 4px solid var(--primary-blue); }
.extracted-data-label { font-weight: bold; color: var(--primary-blue); font-size: 14px; flex: 1; }
.extracted-data-value { color: #333; font-size: 14px; flex: 2; text-align: right; }
.extracted-data-buttons { display: flex; justify-content: center; gap: 15px; margin-top: 25px; }
.extracted-data-btn { padding: 12px 30px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; transition: background-color 0.3s; }
.extracted-data-load-btn { background-color: var(--primary-blue); color: var(--white); }
.extracted-data-load-btn:hover { background-color: var(--secondary-blue); }
.extracted-data-cancel-btn { background-color: #6c757d; color: var(--white); }
.extracted-data-cancel-btn:hover { background-color: #5a6268; }
.calendar-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 15px;
}
.calendar-header button {
background: none;
border: 1px solid var(--primary-blue);
color: var(--primary-blue);
cursor: pointer;
padding: 5px 10px;
border-radius: 4px;
font-weight: bold;
}
#calendarMonthYear {
font-size: 18px;
font-weight: bold;
color: var(--primary-blue);
}
.calendar-grid {
display: grid;
grid-template-columns: repeat(7, 1fr);
gap: 5px;
}
.calendar-grid div {
padding: 10px 5px;
text-align: center;
cursor: pointer;
border-radius: 4px;
transition: background-color 0.2s;
}
.calendar-weekday {
font-weight: bold;
color: var(--dark-gray);
cursor: default !important;
}
.calendar-day {
border: 1px solid #eee;
}
.calendar-day:hover {
background-color: #f0f0f0;
}
.calendar-day.other-month {
color: #ccc;
cursor: default;
}
.calendar-day.selected {
background-color: var(--primary-blue);
color: var(--white);
border-color: var(--primary-blue);
}
.calendar-day.today {
border: 2px solid var(--primary-blue);
}
.hidden {
display: none !important;
}
.incomplete-row {
background-color: #fff3cd !important;
}
@keyframes piscarBotaoVermelho {
50% {
background-color: #dc3545;
box-shadow: 0 0 10px #dc3545;
}
}
.blink-red-button {
animation: piscarBotaoVermelho 1s infinite;
}
/* Tooltip personalizado para campos editáveis */
#registerCidade, #registerBairro, #registerObjetivoSelect {
position: relative;
cursor: pointer;
}
#registerCidade:hover::after, #registerBairro:hover::after, #registerObjetivoSelect:hover::after {
content: "DUPLO CLIQUE PARA EDITAR MANUALMENTE";
position: absolute;
bottom: 100%;
left: 50%;
transform: translateX(-50%);
background: linear-gradient(135deg, #4a69bd 0%, #3a5aa0 100%);
color: white;
padding: 12px 20px;
border-radius: 8px;
font-size: 16px;
font-weight: bold;
white-space: nowrap;
z-index: 10000;
box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
margin-bottom: 8px;
animation: tooltipFadeIn 0.3s ease-in-out;
pointer-events: none;
letter-spacing: 0.5px;
}
#registerCidade:hover::before, #registerBairro:hover::before, #registerObjetivoSelect:hover::before {
content: "";
position: absolute;
bottom: 100%;
left: 50%;
transform: translateX(-50%);
border: 8px solid transparent;
border-top-color: #3a5aa0;
z-index: 10000;
margin-bottom: -8px;
pointer-events: none;
}
@keyframes tooltipFadeIn {
from {
opacity: 0;
transform: translateX(-50%) translateY(-5px);
}
to {
opacity: 1;
transform: translateX(-50%) translateY(0);
}
}
.tab-button {
 background-color: var(--tab-inactive-bg);
 color: var(--tab-text-color);
 border: 1px solid var(--tab-border-color);
 border-bottom: none;
 padding: 10px 15px;
 border-radius: 6px 6px 0 0;
 cursor: pointer;
 font-size: 14px;
 font-weight: bold;
 margin-right: 3px;
 transition: background-color 0.3s ease, color 0.3s ease;
}
.tab-button:hover {
 background-color: var(--tab-hover-bg);
 color: var(--tab-text-color-hover);
}
.tab-button.active {
 background-color: var(--tab-active-bg);
 border-color: var(--tab-border-color-active);
 border-bottom: 1px solid var(--tab-active-bg);
 color: var(--tab-text-color-active);
}
/* Modo Escuro */
body[data-theme="dark"],
body[data-theme="dark"] * {
 transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
}
body[data-theme="dark"] {
 background-color: #1a1a1a !important;
 color: #e0e0e0 !important;
}
body[data-theme="dark"] .container,
body[data-theme="dark"] main,
body[data-theme="dark"] .content-wrapper {
 background-color: #1a1a1a !important;
 color: #e0e0e0 !important;
}
body[data-theme="dark"] .tab-content,
body[data-theme="dark"] .form-container,
body[data-theme="dark"] .card {
 background-color: #2d2d2d !important;
 color: #e0e0e0 !important;
 border-color: #444 !important;
}
body[data-theme="dark"] .tab-button {
 background-color: #2d2d2d !important;
 color: #e0e0e0 !important;
 border-color: #444 !important;
}
body[data-theme="dark"] .tab-button:hover {
 background-color: #3d3d3d !important;
 color: #6c88c9 !important;
}
body[data-theme="dark"] .tab-button.active {
 background-color: #2d2d2d !important;
 color: #6c88c9 !important;
 border-color: #6c88c9 !important;
}
body[data-theme="dark"] input,
body[data-theme="dark"] select,
body[data-theme="dark"] textarea {
 background-color: #1a1a1a !important;
 color: #e0e0e0 !important;
 border-color: #555 !important;
}
body[data-theme="dark"] label {
 color: #e0e0e0 !important;
}
body[data-theme="dark"] table {
 background-color: #2d2d2d !important;
 color: #e0e0e0 !important;
}
body[data-theme="dark"] table th {
 background-color: #3d3d3d !important;
 color: #e0e0e0 !important;
 border-color: #555 !important;
}
body[data-theme="dark"] table td {
 background-color: #2d2d2d !important;
 color: #e0e0e0 !important;
 border-color: #555 !important;
}
body[data-theme="dark"] .header-title,
body[data-theme="dark"] h1,
body[data-theme="dark"] h2,
body[data-theme="dark"] h3 {
 color: #e0e0e0 !important;
}
body[data-theme="dark"] .btn-primary,
body[data-theme="dark"] button[class*="btn"] {
 background-color: #4a69bd !important;
 color: #ffffff !important;
}
body[data-theme="dark"] .btn-primary:hover,
body[data-theme="dark"] button[class*="btn"]:hover {
 background-color: #6c88c9 !important;
}
</style>
</head>
<body>
<header>
<h1 class="main-title">CADASTRO E CONTROLE DE SAÍDAS</h1>
</header>
<main>
<div id="registerSaidaSection" class="tab-content active">
<div class="sub-tabs">
<button class="sub-tab-button active" data-sub-tab="registerFormContent">Cadastrar Nova Saída</button>
<button class="sub-tab-button" data-sub-tab="todasSaidasContent">Saídas Cadastradas</button>
<button class="sub-tab-button" data-sub-tab="cadastrarItensContent">Cadastrar Itens</button>
<button class="sub-tab-button" data-sub-tab="unplannedExitsContent">Saídas não Programadas</button>
</div>
<div id="registerFormContent" class="sub-tab-content active">
<div class="table-controls">
<div class="table-controls-title-row">
<h2 class="table-title" id="registerFormTitleRow">CADASTRAR NOVA SAÍDA</h2>
<button type="button" id="btnPreencherTeste" class="icon-btn-teste" title="Preencher formulário com dados aleatórios para teste (Data e Hora da Saída não são preenchidos)">
<i class="fas fa-flask"></i>
</button>
</div>
</div>
<div class="register-exit-form">
<input type="hidden" id="saida-id-hidden">
<div class="form-group">
<label for="registerTipoSaida">Tipo de Saída:</label>
<i class="fas fa-route"></i>
<select id="registerTipoSaida">
<option value="Administrativa">Administrativa</option>
<option value="Ambulância">Ambulância</option>
</select>
</div>


<div class="form-group">
<label for="registerDataPedido">Data do Pedido:</label>
<i class="fas fa-calendar-alt"></i>
<input type="date" id="registerDataPedido">
</div>
<div class="form-group">
<label for="registerHoraPedido">Hora do Pedido:</label>
<i class="fas fa-clock"></i>
<input type="time" id="registerHoraPedido">
</div>
<div class="form-group">
<label for="registerDataSaida">Data da Saída:</label>
<i class="fas fa-calendar-check"></i>
<input type="date" id="registerDataSaida">
</div>
<div class="form-group">
<label for="registerHoraSaida">Hora da Saída:</label>
<i class="fas fa-clock"></i>
<input type="time" id="registerHoraSaida">
</div>
<div class="form-group">
<label for="registerSetor">Setor:</label>
<div style="display: flex; align-items: center; gap: 5px;">
<i class="fas fa-building"></i>
<input type="text" id="registerSetor" list="setorList" autocomplete="off" style="flex: 1;">
<span class="add-item-btn" onclick="openAddItemModal('setor')" title="Cadastrar novo setor" style="cursor: pointer;">
<i class="fas fa-plus"></i>
</span>
</div>
<datalist id="setorList"></datalist>
</div>
<div class="form-group">
<label for="registerRamal">Ramal:</label>
<i class="fas fa-phone"></i>
<input type="text" id="registerRamal">
</div>
<div class="form-group">
<label for="registerCidade">Cidade:</label>
<i class="fas fa-city"></i>
<select id="registerCidade" title="Duplo clique para editar manualmente">
<option value="">Selecione a cidade</option>
<option value="Rio de Janeiro">Rio de Janeiro</option>
<option value="Belford Roxo">Belford Roxo</option>
<option value="Duque de Caxias">Duque de Caxias</option>
<option value="Guapimirim">Guapimirim</option>
<option value="Itaboraí">Itaboraí</option>
<option value="Japeri">Japeri</option>
<option value="Magé">Magé</option>
<option value="Maricá">Maricá</option>
<option value="Mesquita">Mesquita</option>
<option value="Nilópolis">Nilópolis</option>
<option value="Niterói">Niterói</option>
<option value="Nova Iguaçu">Nova Iguaçu</option>
<option value="Paracambi">Paracambi</option>
<option value="Queimados">Queimados</option>
<option value="São Gonçalo">São Gonçalo</option>
<option value="São João de Meriti">São João de Meriti</option>
<option value="Seropédica">Seropédica</option>
<option value="Tanguá">Tanguá</option>
</select>
<input type="text" id="registerCidadeInput" placeholder="Digite a cidade" style="display: none;">
</div>
<div class="form-group">
<label for="registerBairro">Bairro:</label>
<i class="fas fa-map-signs"></i>
<select id="registerBairro" disabled title="Duplo clique para editar manualmente">
<option value="">Selecione primeiro a cidade</option>
</select>
<input type="text" id="registerBairroInput" placeholder="Digite o bairro" style="display: none;">
</div>
<div class="form-group">
<label for="registerObjetivo">Objetivo da Saída:</label>
<i class="fas fa-clipboard-list"></i>
<select id="registerObjetivoSelect" style="display: none;" title="Duplo clique para editar manualmente">
<option value="">Selecione o objetivo</option>
<option value="Inter Hospitalar">Inter Hospitalar</option>
<option value="APH">APH</option>
<option value="Exame">Exame</option>
<option value="Aeroporto">Aeroporto</option>
<option value="Alta">Alta</option>
</select>
<input type="text" id="registerObjetivo">
<input type="text" id="registerObjetivoInput" placeholder="Digite o objetivo" style="display: none;">
</div>
<div class="form-group">
<label for="registerNumPassageiros">Nº de Passageiros:</label>
<i class="fas fa-users"></i>
<input type="number" id="registerNumPassageiros" min="0">
</div>
<div class="form-group">
<label for="registerResponsavelPedido">Responsável pelo Pedido:</label>
<div style="display: flex; align-items: center; gap: 5px;">
<i class="fas fa-user-tie"></i>
<input type="text" id="registerResponsavelPedido" list="responsavelList" autocomplete="off" style="flex: 1;">
<span class="add-item-btn" onclick="openAddItemModal('responsavel')" title="Cadastrar novo responsável" style="cursor: pointer;">
<i class="fas fa-plus"></i>
</span>
</div>
<datalist id="responsavelList"></datalist>
</div>
<div class="form-group">
<label for="registerOM">OM:</label>
<div style="display: flex; align-items: center; gap: 5px;">
<i class="fas fa-flag"></i>
<input type="text" id="registerOM" list="omList" autocomplete="off" style="flex: 1;" placeholder="Digite ou selecione a OM">
<datalist id="omList"></datalist>
<span class="add-item-btn" onclick="openAddItemModal('om')" title="Cadastrar nova OM" style="cursor: pointer;">
<i class="fas fa-plus"></i>
</span>
</div>
</div>
<div class="form-group" id="registerViaturaGroup">
<label for="registerViatura">Viatura:</label>
<i class="fas fa-car"></i>
<select id="registerViatura"></select>
</div>
<div class="form-group" id="registerMotoristaGroup">
<label for="registerMotorista">Motorista:</label>
<i class="fas fa-user"></i>
<select id="registerMotorista"></select>
</div>
<div class="form-group" id="registerHospitalGroup" style="display: none;">
<label for="registerHospital">Hospital de Destino:</label>
<div style="display: flex; align-items: center; gap: 5px;">
<i class="fas fa-hospital"></i>
<input type="text" id="registerHospital" list="hospitalList" placeholder="Digite para buscar o hospital (opcional)" autocomplete="off" style="flex: 1;">
<span class="add-item-btn" onclick="openAddItemModal('hospital')" title="Cadastrar novo hospital" style="cursor: pointer;">
<i class="fas fa-plus"></i>
</span>
</div>
<datalist id="hospitalList">
<option value="Adão Pereira Nunes">
<option value="Albert Schweitzer">
<option value="Alberto Torres">
<option value="Alexander Fleming (Maternidade)">
<option value="Andaraí">
<option value="Antônio Pedro">
<option value="Azevedo Lima">
<option value="Badim">
<option value="Barata Ribeiro">
<option value="Barra D'Or">
<option value="Belford Roxo">
<option value="Bonsucesso">
<option value="Cardoso Fontes">
<option value="Carlos Tortelly">
<option value="Carmela Dutra">
<option value="Casa de Saúde São José">
<option value="Caxias D'Or">
<option value="Clementino Fraga Filho">
<option value="Clínica da Família">
<option value="Copa D'Or">
<option value="Copa Star">
<option value="Duque de Caxias">
<option value="Evandro Freire">
<option value="Fernando Magalhães (Maternidade)">
<option value="Francisco da Silva Telles">
<option value="Francisco Xavier">
<option value="Gaffrée e Guinle">
<option value="Getúlio Vargas">
<option value="Herculano Pinheiro (Maternidade)">
<option value="INCA">
<option value="INC">
<option value="INTO">
<option value="Itaboraí">
<option value="Japeri">
<option value="Jesus">
<option value="Lagoa">
<option value="Leila Diniz (Maternidade)">
<option value="Lourenço Jorge">
<option value="Magé">
<option value="Maricá">
<option value="Mesquita">
<option value="Miguel Couto">
<option value="Moacyr do Carmo">
<option value="Nilópolis">
<option value="Niterói D'Or">
<option value="Norte D'Or">
<option value="Nova Iguaçu">
<option value="Oeste D'Or">
<option value="Outro">
<option value="Paulino Werneck">
<option value="Pedro Ernesto">
<option value="Pedro II">
<option value="Piedade">
<option value="Posse">
<option value="Pró-Cardíaco">
<option value="Queimados">
<option value="Quinta D'Or">
<option value="Raphael de Paula Souza">
<option value="Rocha Faria">
<option value="Rocha Maia">
<option value="Ronaldo Gazolla">
<option value="Salgado Filho">
<option value="Samaritano">
<option value="São Gonçalo">
<option value="São Lucas">
<option value="São Vicente de Paulo">
<option value="Seropédica">
<option value="Servidores do Estado">
<option value="Silvestre">
<option value="Souza Aguiar">
<option value="UPA 24h">
<option value="Vitória">
</datalist>
</div>
<div class="form-group" id="registerKmSaidaGroup" style="display: none;">
<label for="registerKmSaida">KM SAÍDA:</label>
<input type="text" id="registerKmSaida" placeholder="Auto" autocomplete="off" style="width: 100%;">
</div>
<div class="form-group" id="registerKmChegadaGroup" style="display: none;">
<label for="registerKmChegada">KM CHEGADA:</label>
<input type="text" id="registerKmChegada" placeholder="Digite" autocomplete="off" style="width: 100%;">
</div>
<div class="form-group" id="registerChegadaGroup" style="display: none;">
<label for="registerChegada">CHEGADA:</label>
<input type="time" id="registerChegada" style="width: 100%;">
</div>
<div class="register-exit-form-buttons">
<button id="submitNewSaida">Cadastrar Saída</button>
<button id="serialRegisterBtn">Cadastro em Série</button>
<button id="multiSaidaBtn">Cadastrar Múltiplas Saídas</button>
<button id="loadDocumentBtn" class="hidden-load-btn"><i class="fas fa-file-upload"></i> Carregar Nova Saída</button>
</div>
<div id="registerMessage" class="message"></div>
</div>
</div>
<div id="todasSaidasContent" class="sub-tab-content">
<div class="table-controls">
<h2 class="table-title">TODAS AS SAÍDAS CADASTRADAS</h2>
<div class="counters-container">
<div class="counter" id="todasSaidasCounter">Saídas Realizadas: 0</div>
<div class="counter" id="futurasSaidasCounter">Saídas Futuras: 0</div>
<div class="counter" id="incompletosCounter" style="cursor: pointer;" title="Clique para mostrar/ocultar apenas os lançamentos incompletos">Lançamentos Incompletos: 0</div>
</div>
</div>
<div class="date-filter-container">
<div>
<label for="filterTodasSaidasDate">Data Específica:</label>
<input type="date" id="filterTodasSaidasDate">
</div>
<div>
<label for="filterTodasSaidasMonth">Mês:</label>
<select id="filterTodasSaidasMonth">
<option value="">Todos</option>
<option value="1">Janeiro</option><option value="2">Fevereiro</option><option value="3">Março</option><option value="4">Abril</option><option value="5">Maio</option><option value="6">Junho</option><option value="7">Julho</option><option value="8">Agosto</option><option value="9">Setembro</option><option value="10">Outubro</option><option value="11">Novembro</option><option value="12">Dezembro</option>
</select>
</div>
<div>
<label for="filterTodasSaidasYear">Ano:</label>
<select id="filterTodasSaidasYear"></select>
</div>
<div>
<label for="filterTodasSaidasCidade">Cidade:</label>
<select id="filterTodasSaidasCidade"></select>
</div>
<div>
<label for="filterTodasSaidasBairro">Bairro:</label>
<select id="filterTodasSaidasBairro"></select>
</div>
<div>
<label for="filterTodasSaidasMotorista">Motorista:</label>
<select id="filterTodasSaidasMotorista"></select>
</div>
<div>
<label for="filterTodasSaidasViatura">Viatura:</label>
<select id="filterTodasSaidasViatura"></select>
</div>
<div>
<label for="filterTodasSaidasOM">OM:</label>
<select id="filterTodasSaidasOM"></select>
</div>
<div>
<label for="filterTodasSaidasHospital">Hospital de Destino:</label>
<select id="filterTodasSaidasHospital"></select>
</div>
<div class="filter-group">
<label>Tipo de Saída:</label>
<div>
<input type="checkbox" id="filterTypeAdm" value="Administrativa" checked>
<label for="filterTypeAdm">Administrativas</label>
</div>
<div>
<input type="checkbox" id="filterTypeAmb" value="Ambulância" checked>
<label for="filterTypeAmb">Ambulâncias</label>
</div>
</div>
</div>
<div class="table-buttons">
<button class="pdf-btn" id="todasSaidasPdfBtn"><i class="fas fa-file-pdf"></i> Baixar PDF</button>
<button class="excel-export-btn" id="todasSaidasExcelBtn"><i class="fas fa-file-excel"></i> Exportar CSV</button>
<label class="csv-import-label" for="todasSaidasImportInput"><i class="fas fa-upload"></i> Importar CSV</label>
<input type="file" id="todasSaidasImportInput" accept=".csv" style="display: none;">
<button class="action-buttons delete-all-btn" id="deleteAllBtn"><i class="fas fa-trash-alt"></i> Excluir Tudo</button>
</div>
<div class="table-container">
<table id="todasSaidasTable">
<thead>
<tr>
<th>TIPO</th>
<th>DATA PEDIDO</th>
<th>HORA PEDIDO</th>
<th>DATA SAÍDA</th>
<th>HORA SAÍDA</th>
<th>SETOR</th>
<th>RAMAL</th>
<th>DESTINO</th>
<th>OBJETIVO</th>
<th>Nº PASS.</th>
<th>RESPONSÁVEL</th>
<th>OM</th>
<th>HOSPITAL DE DESTINO</th>
<th>VIATURA</th>
<th>MOTORISTA</th>
<th>KM SAÍDA</th>
<th>KM CHEGADA</th>
<th>CHEGADA</th>
<th>OCORRÊNCIAS</th>
<th>AÇÕES</th>
</tr>
</thead>
<tbody>
</tbody>
</table>
</div>
</div>
<div id="cadastrarItensContent" class="sub-tab-content">
<div class="table-controls">
<h2 class="table-title">CADASTRAR ITENS</h2>
<p style="margin-top: 10px; color: #666; font-size: 14px;">Gerencie os itens disponíveis nos campos do formulário de cadastro. Clique nas células para editar. Use o botão "+" para adicionar novas linhas. Estes itens terão prioridade sobre os dados automáticos.</p>
</div>

<!-- Abas para os itens -->
<div class="itens-tabs-container" style="margin-top: 20px;">
<div class="itens-tabs">
<button class="itens-tab-button active" data-itens-tab="setoresTab">
<i class="fas fa-building"></i> Setores
</button>
<button class="itens-tab-button" data-itens-tab="responsaveisTab">
<i class="fas fa-user-tie"></i> Responsáveis
</button>
<button class="itens-tab-button" data-itens-tab="cidadesTab">
<i class="fas fa-city"></i> Cidades
</button>
<button class="itens-tab-button" data-itens-tab="bairrosTab">
<i class="fas fa-map-signs"></i> Bairros
</button>
<button class="itens-tab-button" data-itens-tab="objetivosTab">
<i class="fas fa-clipboard-list"></i> Objetivos
</button>
<button class="itens-tab-button" data-itens-tab="hospitaisTab">
<i class="fas fa-hospital"></i> Hospitais
</button>
<button class="itens-tab-button" data-itens-tab="omsTab">
<i class="fas fa-flag"></i> OM
</button>
</div>

<!-- Conteúdo da aba Setores -->
<div id="setoresTab" class="itens-tab-content active">
<div class="config-section">
<h3 class="section-title"><i class="fas fa-building"></i> Setores</h3>
<table style="width: 100%; border-collapse: collapse;">
<thead>
<tr style="background-color: var(--primary-blue); color: white;">
<th style="padding: 10px; text-align: left;">Setor</th>
<th style="padding: 10px; text-align: center; width: 120px;">Ações</th>
</tr>
</thead>
<tbody id="setoresTableBody">
</tbody>
</table>
<button class="success" onclick="addSetorRow()" style="margin-top: 10px; padding: 8px 16px;"><i class="fas fa-plus"></i> Adicionar Linha</button>
</div>
</div>

<!-- Conteúdo da aba Responsáveis -->
<div id="responsaveisTab" class="itens-tab-content">
<div class="config-section">
<h3 class="section-title"><i class="fas fa-user-tie"></i> Responsáveis pelo Pedido</h3>
<table style="width: 100%; border-collapse: collapse;">
<thead>
<tr style="background-color: var(--primary-blue); color: white;">
<th style="padding: 10px; text-align: left;">Responsável</th>
<th style="padding: 10px; text-align: center; width: 120px;">Ações</th>
</tr>
</thead>
<tbody id="responsaveisTableBody">
</tbody>
</table>
<button class="success" onclick="addResponsavelRow()" style="margin-top: 10px; padding: 8px 16px;"><i class="fas fa-plus"></i> Adicionar Linha</button>
</div>
</div>

<!-- Conteúdo da aba Cidades -->
<div id="cidadesTab" class="itens-tab-content">
<div class="config-section">
<h3 class="section-title"><i class="fas fa-city"></i> Cidades</h3>
<table style="width: 100%; border-collapse: collapse;">
<thead>
<tr style="background-color: var(--primary-blue); color: white;">
<th style="padding: 10px; text-align: left;">Cidade</th>
<th style="padding: 10px; text-align: center; width: 120px;">Ações</th>
</tr>
</thead>
<tbody id="cidadesTableBody">
</tbody>
</table>
<button class="success" onclick="addCidadeRow()" style="margin-top: 10px; padding: 8px 16px;"><i class="fas fa-plus"></i> Adicionar Linha</button>
</div>
</div>

<!-- Conteúdo da aba Bairros -->
<div id="bairrosTab" class="itens-tab-content">
<div class="config-section">
<h3 class="section-title"><i class="fas fa-map-signs"></i> Bairros</h3>
<!-- Abas de cidades para bairros -->
<div class="bairros-cidades-tabs-container">
<div class="bairros-cidades-tabs" id="bairrosCidadesTabs">
<!-- As abas serão criadas dinamicamente -->
</div>
<div id="bairrosCidadesContent">
<!-- O conteúdo será criado dinamicamente -->
</div>
</div>
</div>
</div>

<!-- Conteúdo da aba Objetivos -->
<div id="objetivosTab" class="itens-tab-content">
<div class="config-section">
<h3 class="section-title"><i class="fas fa-clipboard-list"></i> Objetivos para Ambulância</h3>
<table style="width: 100%; border-collapse: collapse;">
<thead>
<tr style="background-color: var(--primary-blue); color: white;">
<th style="padding: 10px; text-align: left;">Objetivo</th>
<th style="padding: 10px; text-align: center; width: 120px;">Ações</th>
</tr>
</thead>
<tbody id="objetivosTableBody">
</tbody>
</table>
<button class="success" onclick="addObjetivoRow()" style="margin-top: 10px; padding: 8px 16px;"><i class="fas fa-plus"></i> Adicionar Linha</button>
</div>
</div>

<!-- Conteúdo da aba Hospitais -->
<div id="hospitaisTab" class="itens-tab-content">
<div class="config-section">
<h3 class="section-title"><i class="fas fa-hospital"></i> Hospitais</h3>
<table style="width: 100%; border-collapse: collapse;">
<thead>
<tr style="background-color: var(--primary-blue); color: white;">
<th style="padding: 10px; text-align: left;">Hospital</th>
<th style="padding: 10px; text-align: center; width: 120px;">Ações</th>
</tr>
</thead>
<tbody id="hospitaisTableBody">
</tbody>
</table>
<button class="success" onclick="addHospitalRow()" style="margin-top: 10px; padding: 8px 16px;"><i class="fas fa-plus"></i> Adicionar Linha</button>
</div>
</div>

<!-- Conteúdo da aba OM -->
<div id="omsTab" class="itens-tab-content">
<div class="config-section">
<h3 class="section-title"><i class="fas fa-flag"></i> OM</h3>
<table style="width: 100%; border-collapse: collapse;">
<thead>
<tr style="background-color: var(--primary-blue); color: white;">
<th style="padding: 10px; text-align: left;">OM</th>
<th style="padding: 10px; text-align: center; width: 120px;">Ações</th>
</tr>
</thead>
<tbody id="omsTableBody">
</tbody>
</table>
<button class="success" onclick="addOMRow()" style="margin-top: 10px; padding: 8px 16px;"><i class="fas fa-plus"></i> Adicionar Linha</button>
</div>
</div>
</div>
</div>
<div id="unplannedExitsContent" class="sub-tab-content">
<div class="table-controls">
<h2 class="table-title">SAÍDAS NÃO PROGRAMADAS</h2>
</div>
<div class="filter-container">
<label for="filterUnplannedMonth">Mês:</label>
<select id="filterUnplannedMonth">
<option value="">Todos os Meses</option>
<option value="1">Janeiro</option><option value="2">Fevereiro</option><option value="3">Março</option><option value="4">Abril</option><option value="5">Maio</option><option value="6">Junho</option><option value="7">Julho</option><option value="8">Agosto</option><option value="9">Setembro</option><option value="10">Outubro</option><option value="11">Novembro</option><option value="12">Dezembro</option>
</select>
<label for="filterUnplannedYear">Ano:</label>
<select id="filterUnplannedYear"></select>
</div>
<div class="table-buttons">
<button class="pdf-btn" id="unplannedExitsPdfBtn"><i class="fas fa-file-pdf"></i> Baixar PDF</button>
</div>
<div class="table-container" style="max-width: fit-content; margin: 0 auto;">
<table id="unplannedExitsTable">
<thead>
<tr>
<th>SETOR SOLICITANTE</th>
<th>JAN</th><th>FEV</th><th>MAR</th><th>ABR</th><th>MAI</th><th>JUN</th>
<th>JUL</th><th>AGO</th><th>SET</th><th>OUT</th><th>NOV</th><th>DEZ</th>
</tr>
</thead>
<tbody>
<tr><td colspan="13">Nenhum dado</td></tr>
</tbody>
<tfoot>
<tr>
<td>Total por Mês:</td>
<td id="unplannedTotalJan">0</td><td id="unplannedTotalFev">0</td><td id="unplannedTotalMar">0</td><td id="unplannedTotalAbr">0</td><td id="unplannedTotalMai">0</td><td id="unplannedTotalJun">0</td>
<td id="unplannedTotalJul">0</td><td id="unplannedTotalAgo">0</td><td id="unplannedTotalSet">0</td><td id="unplannedTotalOut">0</td><td id="unplannedTotalNov">0</td><td id="unplannedTotalDez">0</td>
</tr>
</tfoot>
</table>
</div>
<p id="unplannedExitsTotalText">Total Geral de Saídas não Programadas: 0</p>
</div>
</div>
</main>
<!-- Modal de confirmação para adicionar item -->
<div id="addItemModal" class="obs-modal" style="display: none;">
<div class="obs-modal-content" style="max-width: 400px;">
<h3 style="margin-top: 0; color: var(--primary-blue);">Cadastrar Item</h3>
<p id="addItemModalMessage" style="margin: 15px 0; font-size: 16px;">Gostaria de cadastrar esse item?</p>
<div class="modal-buttons" style="justify-content: center; gap: 10px;">
<button class="save-obs-btn" onclick="confirmAddItem()">Sim</button>
<button class="cancel-obs-btn" onclick="closeAddItemModal()">Não</button>
</div>
</div>
</div>

<div id="calendarModal" class="obs-modal">
<div class="obs-modal-content">
<span class="close-button" id="closeCalendarModal">&times;</span>
<h2>Selecione as Datas para Cadastro em Série</h2>
<div class="calendar-header">
<button id="prevMonthBtn">&lt;</button>
<span id="calendarMonthYear"></span>
<button id="nextMonthBtn">&gt;</button>
</div>
<div class="calendar-grid" id="calendarGrid"></div>
<div class="modal-buttons">
<button class="save-obs-btn" id="confirmSerialRegisterBtn">Cadastrar</button>
<button class="cancel-obs-btn" id="cancelSerialRegisterBtn">Cancelar</button>
</div>
</div>
</div>
<script>
document.addEventListener('DOMContentLoaded', () => {
// Carregar itens personalizados primeiro
loadItensData();
// Atualizar campos do formulário com os itens carregados (com pequeno delay para garantir que o DOM está pronto)
setTimeout(() => {
    updateFormFields();
    
    // Preencher automaticamente data e hora do pedido com valores atuais
    const dataPedidoInput = document.getElementById('registerDataPedido');
    const horaPedidoInput = document.getElementById('registerHoraPedido');
    
    if (dataPedidoInput && !dataPedidoInput.value) {
        const hoje = new Date();
        const ano = hoje.getFullYear();
        const mes = String(hoje.getMonth() + 1).padStart(2, '0');
        const dia = String(hoje.getDate()).padStart(2, '0');
        dataPedidoInput.value = `${ano}-${mes}-${dia}`;
    }
    
    if (horaPedidoInput && !horaPedidoInput.value) {
        const agora = new Date();
        const horas = String(agora.getHours()).padStart(2, '0');
        const minutos = String(agora.getMinutes()).padStart(2, '0');
        horaPedidoInput.value = `${horas}:${minutos}`;
    }
    
    // Garantir que o botão de carregar documento apareça se tipo for Ambulância
    adjustRegisterFormFields();
}, 100);

let viaturasCadastradas = JSON.parse(localStorage.getItem('viaturasCadastradas')) || [];
let motoristasCadastrados = JSON.parse(localStorage.getItem('motoristasCadastrados')) || [];
let saidasAdministrativas = JSON.parse(localStorage.getItem('saidasAdministrativas')) || [];
let saidasAmbulancias = JSON.parse(localStorage.getItem('saidasAmbulancias')) || [];
const subTabButtons = document.querySelectorAll('#registerSaidaSection .sub-tab-button');
const subTabContents = document.querySelectorAll('#registerSaidaSection .sub-tab-content');
const registerTipoSaidaSelect = document.getElementById('registerTipoSaida');
const registerViaturaSelect = document.getElementById('registerViatura');
const registerMotoristaSelect = document.getElementById('registerMotorista');
const submitNewSaidaBtn = document.getElementById('submitNewSaida');
const serialRegisterBtn = document.getElementById('serialRegisterBtn');
const multiSaidaBtn = document.getElementById('multiSaidaBtn');
const registerMessage = document.getElementById('registerMessage');
const todasSaidasTableBody = document.querySelector('#todasSaidasTable tbody');
const filterTodasSaidasDateInput = document.getElementById('filterTodasSaidasDate');
const filterTodasSaidasMonthSelect = document.getElementById('filterTodasSaidasMonth');
const filterTodasSaidasYearSelect = document.getElementById('filterTodasSaidasYear');
const filterTodasSaidasCidade = document.getElementById('filterTodasSaidasCidade');
const filterTodasSaidasBairro = document.getElementById('filterTodasSaidasBairro');
const filterTodasSaidasMotorista = document.getElementById('filterTodasSaidasMotorista');
const filterTodasSaidasViatura = document.getElementById('filterTodasSaidasViatura');
const filterTypeAdmCheckbox = document.getElementById('filterTypeAdm');
const filterTypeAmbCheckbox = document.getElementById('filterTypeAmb');
const unplannedExitsTableBody = document.querySelector('#unplannedExitsTable tbody');
const filterUnplannedMonthSelect = document.getElementById('filterUnplannedMonth');
const filterUnplannedYearSelect = document.getElementById('filterUnplannedYear');
const todasSaidasCounter = document.getElementById('todasSaidasCounter');
const futurasSaidasCounter = document.getElementById('futurasSaidasCounter');
const incompletosCounter = document.getElementById('incompletosCounter');
const todasSaidasPdfBtn = document.getElementById('todasSaidasPdfBtn');
const todasSaidasExcelBtn = document.getElementById('todasSaidasExcelBtn');
const todasSaidasImportInput = document.getElementById('todasSaidasImportInput');
const unplannedExitsPdfBtn = document.getElementById('unplannedExitsPdfBtn');
const deleteAllBtn = document.getElementById('deleteAllBtn');
const saidaIdHiddenInput = document.getElementById('saida-id-hidden');
const formTitle = document.querySelector('#registerFormContent .table-title');
const calendarModal = document.getElementById('calendarModal');
const closeCalendarModal = document.getElementById('closeCalendarModal');
const prevMonthBtn = document.getElementById('prevMonthBtn');
const nextMonthBtn = document.getElementById('nextMonthBtn');
const calendarMonthYear = document.getElementById('calendarMonthYear');
const calendarGrid = document.getElementById('calendarGrid');
const confirmSerialRegisterBtn = document.getElementById('confirmSerialRegisterBtn');
const cancelSerialRegisterBtn = document.getElementById('cancelSerialRegisterBtn');
let calendarDate = new Date();
let selectedDates = new Set();
let showingOnlyIncomplete = false;
function downloadPdfTable(tableId, filename, titleText, dateInfo) {
const { jsPDF } = window.jspdf;
const doc = new jsPDF({ orientation: 'landscape' });
doc.setFontSize(16);
doc.text(titleText, 14, 20);
doc.setFontSize(12);
doc.text(dateInfo, 14, 28);
const table = document.getElementById(tableId);
const head = Array.from(table.tHead.rows[0].cells).slice(0, -1).map(th => th.textContent);
const body = [];
table.querySelectorAll('tbody tr').forEach(tr => {
if (tr.style.display !== 'none') {
const rowData = Array.from(tr.cells).slice(0, -1).map(td => td.textContent);
body.push(rowData);
}
});
doc.autoTable({
startY: 35,
head: [head],
body: body,
theme: 'grid',
styles: { fontSize: 7, cellPadding: 2, overflow: 'linebreak' },
headStyles: { fillColor: [74, 105, 189], textColor: 255 },
alternateRowStyles: { fillColor: [248, 249, 250] },
});
doc.save(`${filename}_${new Date().toLocaleDateString('pt-BR').replace(/\//g, '-')}.pdf`);
}
function exportTableToCSV(tableId, filename) {
const table = document.getElementById(tableId);
let csv = [];
const header = Array.from(table.tHead.rows[0].cells).slice(0, -1).map(th => `"${th.textContent.replace(/"/g, '""')}"`);
csv.push(header.join(';'));
table.querySelectorAll('tbody tr').forEach(row => {
if (row.style.display !== 'none') {
const rowData = Array.from(row.cells).slice(0, -1).map(td => `"${td.textContent.replace(/"/g, '""')}"`);
csv.push(rowData.join(';'));
}
});
const csvFile = new Blob(["\uFEFF" + csv.join('\n')], { type: "text/csv;charset=utf-8;" });
const link = document.createElement("a");
link.href = URL.createObjectURL(csvFile);
link.download = filename;
link.click();
}
function importCsvData(event) {
const file = event.target.files[0];
if (!file) return;
const reader = new FileReader();
reader.onload = function(e) {
const text = e.target.result;
const lines = text.split(/[\r\n]+/).filter(line => line.trim() !== '');
if (lines.length <= 1) return alert("Arquivo CSV vazio ou inválido.");
const dataLines = lines.slice(1);
const newSaidas = [];
dataLines.forEach(line => {
const values = line.split(';').map(v => v.replace(/"/g, '').trim());
// Verificar se tem pelo menos 16 campos (formato antigo) ou 18 campos (formato novo com OM e Hospital)
if (values.length >= 16) {
const parseDate = (dateStr) => {
if (!dateStr || !dateStr.includes('/')) return dateStr;
const parts = dateStr.split('/');
if (parts.length === 3) return `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
return dateStr;
};
// Detectar formato: novo formato tem 19 colunas (incluindo AÇÕES), antigo tem 17
const isNewFormat = values.length >= 18;
const saidaImportada = {
id: `import-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
tipo: values[0] || '',
dataPedido: parseDate(values[1]) || '',
horaPedido: values[2] || '',
dataSaida: parseDate(values[3]) || '',
horaSaida: values[4] || '',
saida: values[4] || '',
setor: values[5] || '',
ramal: values[6] || '',
destino: values[7] || '',
objetivo: values[8] || '',
numPassageiros: values[9] || '',
responsavelPedido: values[10] || '',
om: isNewFormat ? (values[11] || '') : '',
hospital: isNewFormat ? (values[12] || '') : '',
viatura: isNewFormat ? (values[13] || '') : (values[11] || ''),
motorista: isNewFormat ? (values[14] || '') : (values[12] || ''),
kmSaida: isNewFormat ? (values[15] || '') : (values[13] || ''),
kmChegada: isNewFormat ? (values[16] || '') : (values[14] || ''),
chegada: isNewFormat ? (values[17] || '') : (values[15] || ''),
observacoes: isNewFormat ? (values[18] || '') : (values[16] || ''),
realizada: false,
preSaidaAlarmDismissed: false,
saidaAlarmDismissed: false
};
saidaImportada.realizada = !!(saidaImportada.kmSaida && saidaImportada.kmChegada && saidaImportada.chegada);
let isUnplannedCalc = false;
if (saidaImportada.tipo !== 'Ambulância' && saidaImportada.dataPedido && saidaImportada.horaPedido && saidaImportada.dataSaida) {
const pedidoDateTime = new Date(`${saidaImportada.dataPedido}T${saidaImportada.horaPedido}`);
const saidaDate = new Date(saidaImportada.dataSaida + 'T00:00:00');
const diaAnterior = new Date(saidaDate);
diaAnterior.setDate(saidaDate.getDate() - 1);
const horaLimitePedido = new Date(`${diaAnterior.toISOString().split('T')[0]}T09:59:00`);
if (pedidoDateTime.getTime() > horaLimitePedido.getTime()) {
isUnplannedCalc = true;
}
}
saidaImportada.isUnplanned = isUnplannedCalc;
newSaidas.push(saidaImportada);
}
});
newSaidas.forEach(saida => {
if (saida.tipo === 'Administrativa') {
saidasAdministrativas.push(saida);
} else if (saida.tipo === 'Ambulância') {
saidasAmbulancias.push(saida);
}
});
localStorage.setItem('saidasAdministrativas', JSON.stringify(saidasAdministrativas));
localStorage.setItem('saidasAmbulancias', JSON.stringify(saidasAmbulancias));
loadDataAndPopulateTables();
alert(`Importação concluída! ${newSaidas.length} registros foram adicionados.`);
window.parent.postMessage({ type: 'refresh_all_data' }, '*');
};
reader.readAsText(file, 'UTF-8');
event.target.value = '';
}
function attachEventListenersToRow(row) {
row.querySelector('.delete-row-btn')?.addEventListener('click', handleDeleteRow);
row.querySelector('.edit-row-btn')?.addEventListener('click', handleEditRow);
}
function isRowIncomplete(saida) {
const fieldsToCheck = ['tipo', 'dataPedido', 'horaPedido', 'dataSaida', 'horaSaida', 'setor', 'destino', 'objetivo', 'viatura', 'motorista', 'kmSaida', 'kmChegada', 'chegada'];
return fieldsToCheck.some(field => !saida[field]);
}
function handleDeleteRow(event) {
const row = event.target.closest('tr');
if (!row) return;
const idToDelete = row.dataset.id;
const tipoSaida = row.dataset.tipo;
if (confirm('Tem certeza que deseja excluir esta saída?')) {
if (tipoSaida === 'Administrativa') {
saidasAdministrativas = saidasAdministrativas.filter(i => i.id !== idToDelete);
localStorage.setItem('saidasAdministrativas', JSON.stringify(saidasAdministrativas));
} else if (tipoSaida === 'Ambulância') {
saidasAmbulancias = saidasAmbulancias.filter(i => i.id !== idToDelete);
localStorage.setItem('saidasAmbulancias', JSON.stringify(saidasAmbulancias));
}
loadDataAndPopulateTables();
window.parent.postMessage({ type: 'refresh_all_data' }, '*');
}
}
function populateFormForEdit(saidaData) {
if (saidaData) {
showSubTab('registerFormContent');
formTitle.textContent = 'EDITAR SAÍDA';
submitNewSaidaBtn.textContent = 'Atualizar Saída';
saidaIdHiddenInput.value = saidaData.id;

// Preencher todos os campos com os dados da saída
// Tipo de Saída
if (document.getElementById('registerTipoSaida')) {
    document.getElementById('registerTipoSaida').value = saidaData.tipo || 'Administrativa';
}

// Data e Hora do Pedido
if (document.getElementById('registerDataPedido')) {
    document.getElementById('registerDataPedido').value = saidaData.dataPedido || saidaData.data || '';
}
if (document.getElementById('registerHoraPedido')) {
    document.getElementById('registerHoraPedido').value = saidaData.horaPedido || saidaData.hora || '';
}

// Data e Hora da Saída
if (document.getElementById('registerDataSaida')) {
    document.getElementById('registerDataSaida').value = saidaData.dataSaida || saidaData.data || '';
}
if (document.getElementById('registerHoraSaida')) {
    document.getElementById('registerHoraSaida').value = saidaData.horaSaida || saidaData.saida || saidaData.horario || saidaData.hora || '';
}

// Setor e Ramal
if (document.getElementById('registerSetor')) {
    document.getElementById('registerSetor').value = saidaData.setor || '';
}
if (document.getElementById('registerRamal')) {
    document.getElementById('registerRamal').value = saidaData.ramal || '';
}

// Cidade e Bairro
if (document.getElementById('registerCidade')) {
    const cidadeValue = saidaData.cidade || saidaData.endereco_cidade || '';
    document.getElementById('registerCidade').value = cidadeValue;
    if (cidadeValue) {
        document.getElementById('registerCidade').dispatchEvent(new Event('change'));
    }
}
if (document.getElementById('registerBairro')) {
    const bairroValue = saidaData.bairro || saidaData.endereco_bairro || '';
    // Aguardar um pouco para que o evento change da cidade processe
    setTimeout(() => {
        if (document.getElementById('registerBairro')) {
            document.getElementById('registerBairro').value = bairroValue;
        }
    }, 200);
}

// Objetivo/Motivo
if (saidaData.tipo === 'Ambulância') {
    if (document.getElementById('registerObjetivoSelect')) {
        document.getElementById('registerObjetivoSelect').value = saidaData.objetivo || saidaData.motivo || '';
    }
} else {
    if (document.getElementById('registerObjetivo')) {
        document.getElementById('registerObjetivo').value = saidaData.objetivo || saidaData.motivo || '';
    }
}

// Número de Passageiros
if (document.getElementById('registerNumPassageiros')) {
    document.getElementById('registerNumPassageiros').value = saidaData.numPassageiros || '';
}

// Responsável pelo Pedido
if (document.getElementById('registerResponsavelPedido')) {
    document.getElementById('registerResponsavelPedido').value = saidaData.responsavelPedido || '';
}

// OM
if (document.getElementById('registerOM')) {
    document.getElementById('registerOM').value = saidaData.om || '';
}

// Ajustar campos do formulário baseado no tipo
adjustRegisterFormFields();

// Preencher campos que dependem de selects carregados (aguardar um pouco)
setTimeout(() => {
    // Viatura
    if (document.getElementById('registerViatura')) {
        const viaturaValue = saidaData.viatura || saidaData.viatura_id || '';
        document.getElementById('registerViatura').value = viaturaValue;
    }
    
    // Motorista
    if (document.getElementById('registerMotorista')) {
        const motoristaValue = saidaData.motorista || saidaData.motorista_id || '';
        document.getElementById('registerMotorista').value = motoristaValue;
    }
    
    // Hospital (para ambulâncias)
    if (document.getElementById('registerHospital')) {
        document.getElementById('registerHospital').value = saidaData.hospital || '';
    }
    
    // KM SAÍDA, KM CHEGADA e CHEGADA (para ambulâncias)
    if (document.getElementById('registerKmSaida')) {
        const kmSaidaValue = saidaData.kmSaida || '';
        document.getElementById('registerKmSaida').value = formatKm(kmSaidaValue);
    }
    if (document.getElementById('registerKmChegada')) {
        const kmChegadaValue = saidaData.kmChegada || '';
        document.getElementById('registerKmChegada').value = formatKm(kmChegadaValue);
    }
    if (document.getElementById('registerChegada')) {
        document.getElementById('registerChegada').value = saidaData.chegada || '';
    }
}, 300);
}
}
function handleEditRow(event) {
const row = event.target.closest('tr');
if (!row) return;
const idToEdit = row.dataset.id;
const tipoSaida = row.dataset.tipo;
let saidaData = (tipoSaida === 'Administrativa')
? saidasAdministrativas.find(s => s.id === idToEdit)
: saidasAmbulancias.find(s => s.id === idToEdit);
if (saidaData) {
populateFormForEdit(saidaData);
}
}
// Retorna um Set com as placas marcadas como Inoperantes no RDV (Relatório Diário de Viaturas)
function getPlacasInoperantesRDV() {
    const placas = new Set();
    try {
        const hoje = new Date();
        const ano = hoje.getFullYear();
        const mes = String(hoje.getMonth() + 1).padStart(2, '0');
        const dia = String(hoje.getDate()).padStart(2, '0');
        const dataHoje = `${ano}-${mes}-${dia}`;
        let rdv = localStorage.getItem('sot_rdv_data_' + dataHoje) || localStorage.getItem('sot_rdv_data');
        if (!rdv) return placas;
        const dados = JSON.parse(rdv);
        const addInoperantes = (lista) => {
            if (!Array.isArray(lista)) return;
            lista.forEach(v => {
                if (v && v.situacao === 'Inoperante' && v.placa) placas.add(v.placa);
            });
        };
        addInoperantes(dados.ambulancias);
        addInoperantes(dados.administrativas);
    } catch (e) {
        console.warn('getPlacasInoperantesRDV:', e);
    }
    return placas;
}

function populateRegisterSaidaSelects() {
    registerViaturaSelect.innerHTML = '<option value="">-- Selecione a Viatura --</option>';
    registerMotoristaSelect.innerHTML = '<option value="">-- Selecione o Motorista --</option>';
    const selectedType = registerTipoSaidaSelect.value;
    const placasInoperantesRDV = getPlacasInoperantesRDV();
    viaturasCadastradas.forEach(vtr => {
        const option = document.createElement('option');
        option.value = vtr.placa;
        let optionText = vtr.placa;
        if (vtr.modelo) {
            optionText += ` (${vtr.modelo})`;
        } else if (vtr.tipo) {
            optionText += ` (${vtr.tipo})`;
        }
        option.textContent = optionText;
        const inoperanteFrota = !!vtr.inoperante;
        const inoperanteRDV = placasInoperantesRDV.has(vtr.placa);
        const tipoNaoAmb = selectedType === 'Ambulância' && vtr.tipo !== 'Ambulância';
        if (inoperanteFrota || inoperanteRDV || tipoNaoAmb) {
            option.disabled = true;
            option.style.color = 'red';
            if (inoperanteFrota || inoperanteRDV) {
                option.textContent = (optionText.trim()) + ' (Inoperante)';
            }
        }
        registerViaturaSelect.appendChild(option);
    });
    motoristasCadastrados.forEach(mot => {
        registerMotoristaSelect.add(new Option(mot.nome, mot.nome));
    });
}
// Função para obter a última quilometragem de chegada de uma ambulância
function getLastKmChegadaAmb(placa) {
    if (!placa) return '';
    const saidasAmbulancias = JSON.parse(localStorage.getItem('saidasAmbulancias') || '[]');
    const allSaidas = saidasAmbulancias.filter(s => s.viatura === placa);
    if (allSaidas.length === 0) return '';
    
    allSaidas.sort((a, b) => {
        const dateA = new Date(a.dataSaida + 'T' + (a.saida || '00:00'));
        const dateB = new Date(b.dataSaida + 'T' + (b.saida || '00:00'));
        return dateB - dateA;
    });
    
    // Primeiro, tenta encontrar o último KM CHEGADA válido
    for (let s of allSaidas) {
        if (s.kmChegada && s.kmChegada.trim() !== '') return s.kmChegada;
    }
    // Se não encontrou, usa o último KM SAÍDA válido
    for (let s of allSaidas) {
        if (s.kmSaida && s.kmSaida.trim() !== '') return s.kmSaida;
    }
    return '';
}

// Função para formatar números de KM com pontos separadores de milhares
function formatKm(value) {
    if (!value) return '';
    // Remove vírgulas e pontos existentes
    let num = value.toString().replace(/,/g, '').replace(/\./g, '');
    // Remove caracteres não numéricos (exceto se for vazio)
    num = num.replace(/[^\d]/g, '');
    // Adiciona pontos a cada 3 dígitos da direita para a esquerda
    return num.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
}

// Função para atualizar automaticamente o KM SAÍDA
function updateKmSaidaAuto() {
    const kmSaidaInput = document.getElementById('registerKmSaida');
    const viaturaSelect = document.getElementById('registerViatura');
    const tipoSaidaSelect = document.getElementById('registerTipoSaida');
    
    if (!kmSaidaInput || !viaturaSelect || !tipoSaidaSelect) return;
    
    // Só atualizar se for tipo Ambulância
    if (tipoSaidaSelect.value !== 'Ambulância') return;
    
    // Se o campo KM SAÍDA já estiver preenchido, não sobrescrever
    if (kmSaidaInput.value.trim() !== '') return;
    
    const placa = viaturaSelect.value;
    if (placa) {
        const lastKm = getLastKmChegadaAmb(placa);
        if (lastKm) {
            // Formatar o valor antes de inserir
            kmSaidaInput.value = formatKm(lastKm);
        }
    }
}

function adjustRegisterFormFields() {
populateRegisterSaidaSelects();
updateFormFields(); // Atualizar campos com itens personalizados
const tipoSaida = registerTipoSaidaSelect ? registerTipoSaidaSelect.value : '';
const hospitalGroup = document.getElementById('registerHospitalGroup');
const kmSaidaGroup = document.getElementById('registerKmSaidaGroup');
const kmChegadaGroup = document.getElementById('registerKmChegadaGroup');
const chegadaGroup = document.getElementById('registerChegadaGroup');
const objetivoInput = document.getElementById('registerObjetivo');
const objetivoSelect = document.getElementById('registerObjetivoSelect');
const loadDocumentBtn = document.getElementById('loadDocumentBtn');
if (tipoSaida === 'Ambulância') {
hospitalGroup.style.display = 'block';
kmSaidaGroup.style.display = 'block';
kmChegadaGroup.style.display = 'block';
chegadaGroup.style.display = 'block';
objetivoInput.style.display = 'none';
objetivoSelect.style.display = 'block';
if (loadDocumentBtn) {
    loadDocumentBtn.classList.remove('hidden-load-btn');
    loadDocumentBtn.style.display = 'inline-block';
}
// Preencher KM SAÍDA automaticamente se viatura estiver selecionada
// Usar setTimeout para garantir que os selects estejam populados
setTimeout(() => {
    updateKmSaidaAuto();
}, 100);
} else {
hospitalGroup.style.display = 'none';
kmSaidaGroup.style.display = 'none';
kmChegadaGroup.style.display = 'none';
chegadaGroup.style.display = 'none';
document.getElementById('registerHospital').value = '';
document.getElementById('registerKmSaida').value = '';
document.getElementById('registerKmChegada').value = '';
document.getElementById('registerChegada').value = '';
objetivoInput.style.display = 'block';
objetivoSelect.style.display = 'none';
if (loadDocumentBtn) {
    loadDocumentBtn.classList.add('hidden-load-btn');
    loadDocumentBtn.style.display = 'none';
}
}
}
function validateAndGetFormData(isSerial = false) {
const tipoSaida = document.getElementById('registerTipoSaida').value;
const fieldsToValidate = [
{ id: 'registerTipoSaida' }, { id: 'registerDataPedido' }, { id: 'registerHoraPedido' },
{ id: 'registerHoraSaida' }, { id: 'registerSetor' }, { id: 'registerCidade' },
{ id: 'registerBairro' }
];
if (tipoSaida === 'Ambulância') {
fieldsToValidate.push({ id: 'registerObjetivoSelect' });
} else {
fieldsToValidate.push({ id: 'registerObjetivo' });
}
if (!isSerial) {
fieldsToValidate.push({ id: 'registerDataSaida' });
}
document.querySelectorAll('.form-group input, .form-group select').forEach(input => input.classList.remove('flash-red'));
let isValid = true;
fieldsToValidate.forEach(field => {
const inputElement = document.getElementById(field.id);
if (!inputElement.value.trim()) {
isValid = false;
inputElement.classList.add('flash-red');
}
});
if (!isValid) {
displayMessage('PREENCHA OS CAMPOS OBRIGATÓRIOS!', 'error');
return null;
}

// Validar que Setor e Responsável pelo Pedido estão nos datalists
const setorInput = document.getElementById('registerSetor');
const setorValue = setorInput ? setorInput.value.trim() : '';
if (setorValue) {
    const setorList = document.getElementById('setorList');
    const setorOptions = setorList ? Array.from(setorList.querySelectorAll('option')).map(opt => opt.value.trim()) : [];
    if (!setorOptions.includes(setorValue)) {
        setorInput.classList.add('flash-red');
        displayMessage('O Setor deve ser selecionado da lista de setores cadastrados!', 'error');
        return null;
    }
}

const responsavelInput = document.getElementById('registerResponsavelPedido');
const responsavelValue = responsavelInput ? responsavelInput.value.trim() : '';
if (responsavelValue) {
    const responsavelList = document.getElementById('responsavelList');
    const responsavelOptions = responsavelList ? Array.from(responsavelList.querySelectorAll('option')).map(opt => opt.value.trim()) : [];
    if (!responsavelOptions.includes(responsavelValue)) {
        responsavelInput.classList.add('flash-red');
        displayMessage('O Responsável pelo Pedido deve ser selecionado da lista de responsáveis cadastrados!', 'error');
        return null;
    }
}

const omInput = document.getElementById('registerOM');
const omValue = omInput ? omInput.value.trim() : '';
if (omValue) {
    const omList = document.getElementById('omList');
    const omOptions = omList ? Array.from(omList.querySelectorAll('option')).map(opt => opt.value.trim()) : [];
    if (!omOptions.includes(omValue)) {
        omInput.classList.add('flash-red');
        displayMessage('A OM deve ser selecionada da lista de OMs cadastradas!', 'error');
        return null;
    }
}

const objetivoValue = tipoSaida === 'Ambulância' 
? document.getElementById('registerObjetivoSelect').value 
: document.getElementById('registerObjetivo').value;
return {
tipo: tipoSaida,
dataPedido: document.getElementById('registerDataPedido').value,
horaPedido: document.getElementById('registerHoraPedido').value,
dataSaida: document.getElementById('registerDataSaida').value,
horaSaida: document.getElementById('registerHoraSaida').value,
setor: document.getElementById('registerSetor').value,
ramal: document.getElementById('registerRamal').value,
cidade: document.getElementById('registerCidade').value,
bairro: document.getElementById('registerBairro').value,
destino: document.getElementById('registerBairro').value,
objetivo: objetivoValue,
numPassageiros: document.getElementById('registerNumPassageiros').value,
responsavelPedido: document.getElementById('registerResponsavelPedido').value,
om: document.getElementById('registerOM').value,
viatura: registerViaturaSelect.value,
motorista: registerMotoristaSelect.value,
hospital: document.getElementById('registerHospital').value,
kmSaida: document.getElementById('registerKmSaida') ? document.getElementById('registerKmSaida').value : '',
kmChegada: document.getElementById('registerKmChegada') ? document.getElementById('registerKmChegada').value : '',
chegada: document.getElementById('registerChegada') ? document.getElementById('registerChegada').value : ''
};
}
async function saveNewSaida(formData, dateToUse = formData.dataSaida, forceCreate = false) {
let isUnplanned = false;
if (formData.tipo !== 'Ambulância' && formData.dataPedido && formData.horaPedido && dateToUse) {
const pedidoDateTime = new Date(`${formData.dataPedido}T${formData.horaPedido}`);
const saidaDate = new Date(dateToUse + 'T00:00:00');
const diaAnterior = new Date(saidaDate);
diaAnterior.setDate(saidaDate.getDate() - 1);
const horaLimitePedido = new Date(`${diaAnterior.toISOString().split('T')[0]}T09:59:00`);
if (pedidoDateTime.getTime() > horaLimitePedido.getTime()) {
isUnplanned = true;
}
}
const idToSave = saidaIdHiddenInput.value;
const targetArrayName = formData.tipo === 'Administrativa' ? 'saidasAdministrativas' : 'saidasAmbulancias';
let targetArray = JSON.parse(localStorage.getItem(targetArrayName)) || [];
const existingIndex = (!forceCreate && idToSave) ? targetArray.findIndex(s => s.id === idToSave) : -1;
let newSaida = null;

if (existingIndex !== -1) {
    // Atualizar saída editada (a desagrupamento já foi feito antes na seleção do modal)
    const saidaExistente = targetArray[existingIndex];
    const saidaAtualizada = { 
        ...saidaExistente, 
        ...formData, 
        dataSaida: dateToUse, 
        saida: formData.horaSaida, 
        horario: formData.horaSaida,
        hora: formData.horaSaida,
        kmSaida: formData.kmSaida || saidaExistente.kmSaida || '',
        kmChegada: formData.kmChegada || saidaExistente.kmChegada || '',
        chegada: formData.chegada || saidaExistente.chegada || '',
        isUnplanned,
        juntada: false // Garantir que não é mais juntada
    };
    
    // Remover propriedades relacionadas à junção (caso ainda existam)
    delete saidaAtualizada.setores_multiplos;
    delete saidaAtualizada.destinos_multiplos;
    delete saidaAtualizada.saidas_originais;
    delete saidaAtualizada.saidaJuntadaOriginal;
    
    targetArray[existingIndex] = saidaAtualizada;
} else {
newSaida = {
id: `saida_${Date.now()}_${Math.random()}`,
...formData, dataSaida: dateToUse, saida: formData.horaSaida,
kmSaida: formData.kmSaida || '', kmChegada: formData.kmChegada || '', chegada: formData.chegada || '', observacoes: '',
isUnplanned, realizada: false,
preSaidaAlarmDismissed: false,
saidaAlarmDismissed: false,
// Campos para verificação de junção
cidade: formData.cidade,
bairro: formData.bairro,
motorista_id: formData.motorista,
viatura_id: formData.viatura,
data: dateToUse,
horario: formData.horaSaida,
motivo: formData.objetivo
};
targetArray.push(newSaida);
}
localStorage.setItem(targetArrayName, JSON.stringify(targetArray));

// Verificar se há saídas para juntar (para novas saídas administrativas ou após edição)
if (formData.tipo === 'Administrativa' && typeof juntaSaidasService !== 'undefined' && juntaSaidasService) {
setTimeout(async () => {
try {
// Carregar todas as saídas atualizadas
const todasSaidas = JSON.parse(localStorage.getItem('saidasAdministrativas')) || [];

// Determinar qual saída foi salva (nova ou editada)
let saidaSalva = null;
if (existingIndex !== -1) {
    // Saída editada - buscar a versão atualizada
    saidaSalva = targetArray[existingIndex];
} else if (newSaida) {
    // Nova saída
    saidaSalva = newSaida;
}

if (saidaSalva) {
    console.log('🔍 Verificando junção de saídas após salvar...');
    console.log('📋 Saída salva:', saidaSalva);
    console.log('📋 Total de saídas:', todasSaidas.length);

    // Garantir que a saída salva tenha os campos necessários para verificação
    if (!saidaSalva.cidade && formData.cidade) {
        saidaSalva.cidade = formData.cidade;
    }
    if (!saidaSalva.bairro && formData.bairro) {
        saidaSalva.bairro = formData.bairro;
    }
    if (!saidaSalva.motorista_id && formData.motorista) {
        saidaSalva.motorista_id = formData.motorista;
    }
    if (!saidaSalva.viatura_id && formData.viatura) {
        saidaSalva.viatura_id = formData.viatura;
    }
    if (!saidaSalva.data && dateToUse) {
        saidaSalva.data = dateToUse;
    }
    if (!saidaSalva.horario && formData.horaSaida) {
        saidaSalva.horario = formData.horaSaida;
    }
    if (!saidaSalva.motivo && formData.objetivo) {
        saidaSalva.motivo = formData.objetivo;
    }
    
    // Marcar que não é juntada para permitir verificação
    saidaSalva.juntada = false;

    // MODAL DE JUNÇÃO DESABILITADO: A funcionalidade foi substituída por aviso abaixo da tabela
    // A verificação de proximidade agora é feita apenas na tabela de saídas administrativas
    // const resultado = await juntaSaidasService.verificarAposCadastro(saidaSalva, todasSaidas);
    // console.log('📋 Resultado da verificação:', resultado);

    // if (resultado.aceitar && resultado.sugestao) {
    //     console.log('✅ Usuário aceitou juntar as saídas com horário:', resultado.horario);
    //     
    //     // Juntar as saídas com o horário selecionado
    //     const saidaJunta = juntaSaidasService.juntarSaidas(
    //         resultado.sugestao.saida1,
    //         resultado.sugestao.saida2,
    //         resultado.horario
    //     );
    //     
    //     // Remover saídas originais e adicionar a saída juntada
    //     const todasSaidasAtual = JSON.parse(localStorage.getItem('saidasAdministrativas')) || [];
    //     const idsParaRemover = saidaJunta.saidas_originais || [];
    //     
    //     // Filtrar saídas originais
    //     const saidasFiltradas = todasSaidasAtual.filter(s => !idsParaRemover.includes(s.id));
    //     
    //     // Adicionar saída juntada
    //     saidasFiltradas.push(saidaJunta);
    //     
    //     // Salvar
    //     localStorage.setItem('saidasAdministrativas', JSON.stringify(saidasFiltradas));
    //     
    //     // Salvar via dataService também
    //     if (typeof dataService !== 'undefined') {
    //         try {
    //             await dataService.saveSaidaAdministrativa(saidaJunta);
    //         } catch (error) {
    //             console.warn('Erro ao salvar saída juntada via dataService:', error);
    //         }
    //     }
    //     
    //     // Notificar parent para atualizar
    //     window.parent.postMessage({ type: 'refresh_all_data' }, '*');
    //     
    //     displayMessage('SAÍDAS JUNTADAS COM SUCESSO!', 'success');
    // }
}
} catch (error) {
console.error('❌ Erro ao verificar junção de saídas:', error);
}
}, 200);
}
}
// Limite de saídas: automático (RO no dia + 2) ou manual (aba Saídas Administrativas)
function getRoCountForDateCadastro(dateStr) {
    if (!dateStr || typeof dateStr !== 'string') return 0;
    var parts = dateStr.split('-');
    if (parts.length < 3) return 0;
    var year = parts[0], month = parts[1], day = parseInt(parts[2], 10);
    if (!day || day < 1) return 0;
    var keyPadded = year + '-' + (month.length === 1 ? '0' + month : month);
    var keyUnpadded = year + '-' + parseInt(month, 10);
    var raw = localStorage.getItem(keyPadded) || localStorage.getItem(keyUnpadded);
    if (!raw) return 0;
    try {
        var data = JSON.parse(raw);
        if (!data || !Array.isArray(data.members)) return 0;
        var count = 0;
        data.members.forEach(function(member) {
            if (!Array.isArray(member)) return;
            var val = (member[day] || '').toString().toUpperCase().trim();
            if (val === 'RO') count++;
        });
        return count;
    } catch (e) { return 0; }
}
function getUseAutoLimitsCadastro() {
    return localStorage.getItem('useAutoLimits') !== 'false';
}
function getEffectiveThresholdsCadastro(dateStr) {
    if (getUseAutoLimitsCadastro()) {
        var L = getRoCountForDateCadastro(dateStr) + 2;
        var green = Math.max(0, L - 1);
        return { manha: { green: green, orange: L }, tarde: { green: green, orange: L } };
    }
    try {
        var saved = localStorage.getItem('statusThresholds');
        if (saved) {
            var parsed = JSON.parse(saved);
            return {
                manha: { green: parseInt(parsed.manha?.green, 10) || 1, orange: parseInt(parsed.manha?.orange, 10) || 2 },
                tarde: { green: parseInt(parsed.tarde?.green, 10) || 1, orange: parseInt(parsed.tarde?.orange, 10) || 2 }
            };
        }
    } catch (e) {}
    return { manha: { green: 1, orange: 2 }, tarde: { green: 1, orange: 2 } };
}
function checkLimiteSaidasExcedido() {
    const tipoSelect = document.getElementById('registerTipoSaida');
    if (!tipoSelect || tipoSelect.value !== 'Administrativa') return;
    const dataInput = document.getElementById('registerDataSaida');
    const horaInput = document.getElementById('registerHoraSaida');
    if (!dataInput || !horaInput) return;
    const dataSaida = (dataInput.value || '').trim();
    const horaSaida = (horaInput.value || '').trim();
    if (!dataSaida || !horaSaida) return;
    const saidas = JSON.parse(localStorage.getItem('saidasAdministrativas') || '[]');
    const doDia = saidas.filter(s => (s.dataSaida || s.data || '') === dataSaida);
    let manhaCount = 0, tardeCount = 0;
    doDia.forEach(s => {
        const h = (s.saida || s.horaSaida || s.hora || s.horario || '').trim();
        if (!h) return;
        if (h >= '00:00' && h <= '12:00') manhaCount++;
        else if (h > '12:00' && h <= '23:59') tardeCount++;
    });
    const thresholds = getEffectiveThresholdsCadastro(dataSaida);
    const isManha = horaSaida >= '00:00' && horaSaida <= '12:00';
    const isTarde = horaSaida > '12:00' && horaSaida <= '23:59';
    const limiteExcedido = (isManha && manhaCount > thresholds.manha.orange) || (isTarde && tardeCount > thresholds.tarde.orange);
    if (limiteExcedido) {
        const modal = document.getElementById('limiteSaidasModal');
        if (modal) modal.classList.add('show');
    }
}
function closeLimiteSaidasModal() {
    const modal = document.getElementById('limiteSaidasModal');
    if (modal) modal.classList.remove('show');
    if (document.activeElement && document.activeElement.closest && document.activeElement.closest('#limiteSaidasModal')) {
        document.body.focus();
    }
}
document.addEventListener('click', function(e) {
    var modal = document.getElementById('limiteSaidasModal');
    if (!modal || !modal.classList.contains('show')) return;
    if (e.target.id === 'limiteSaidasModalOk' || (e.target.closest && e.target.closest('#limiteSaidasModalOk'))) {
        e.preventDefault();
        e.stopPropagation();
        closeLimiteSaidasModal();
        return;
    }
    if (e.target === modal) {
        e.preventDefault();
        e.stopPropagation();
        closeLimiteSaidasModal();
    }
});
const regDataSaida = document.getElementById('registerDataSaida');
const regHoraSaida = document.getElementById('registerHoraSaida');
if (regDataSaida) regDataSaida.addEventListener('change', checkLimiteSaidasExcedido);
if (regHoraSaida) regHoraSaida.addEventListener('change', checkLimiteSaidasExcedido);

function pickRandom(arr) {
    return arr[Math.floor(Math.random() * arr.length)];
}
function preencherFormularioTeste() {
    const hoje = new Date();
    const dataPedido = new Date(hoje);
    dataPedido.setDate(dataPedido.getDate() - Math.floor(Math.random() * 5));
    const dataPedidoStr = dataPedido.toISOString().slice(0, 10);
    const horaPedido = String(Math.floor(Math.random() * 12) + 8).padStart(2, '0') + ':' + String(Math.floor(Math.random() * 60)).padStart(2, '0');
    const setores = ['Administrativo', 'Enfermagem', 'Farmácia', 'Laboratório', 'Emergência', 'Ambulatório', 'Setor Teste'];
    const ramais = ['1234', '2345', '3456', '4567', '5678', '6789'];
    const cidades = ['Rio de Janeiro', 'Niterói', 'São Gonçalo', 'Duque de Caxias', 'Nova Iguaçu', 'Belford Roxo', 'Nilópolis', 'Mesquita'];
    const bairrosPorCidade = {
        'Rio de Janeiro': ['Centro', 'Copacabana', 'Tijuca', 'Botafogo', 'Barra da Tijuca'],
        'Niterói': ['Centro', 'Icaraí', 'São Francisco'],
        'São Gonçalo': ['Centro', 'Alcântara', 'Neves'],
        'Duque de Caxias': ['Centro', 'Xerém', 'Imbariê'],
        'Nova Iguaçu': ['Centro', 'Austin', 'Comendador Soares'],
        'Belford Roxo': ['Centro', 'Heliópolis', 'Wona'],
        'Nilópolis': ['Centro', 'Olinda', 'Cabuis'],
        'Mesquita': ['Centro', 'Chatuba', 'Edgar Werneck']
    };
    const objetivos = ['Inter Hospitalar', 'APH', 'Exame', 'Aeroporto', 'Alta', 'Transferência de paciente', 'Coleta'];
    const responsaveis = ['Dr. Silva', 'Dra. Santos', 'Enf. Oliveira', 'Sra. Costa', 'Teste Usuário'];
    const oms = ['OM Teste 1', 'HNMD', 'Marinha do Brasil'];
    const tipo = pickRandom(['Administrativa', 'Ambulância']);
    const cidade = pickRandom(cidades);
    const bairros = bairrosPorCidade[cidade] || ['Centro'];
    const setData = (id, val) => { const el = document.getElementById(id); if (el) el.value = val; };
    const setSelect = (id, val) => { const el = document.getElementById(id); if (el) { el.value = val; if (el.dispatchEvent) el.dispatchEvent(new Event('change', { bubbles: true })); } };
    setSelect('registerTipoSaida', tipo);
    setData('registerDataPedido', dataPedidoStr);
    setData('registerHoraPedido', horaPedido);
    setData('registerSetor', pickRandom(setores));
    setData('registerRamal', pickRandom(ramais));
    setSelect('registerCidade', cidade);
    setTimeout(function() {
        const bairroSelect = document.getElementById('registerBairro');
        if (bairroSelect && bairroSelect.options.length) {
            const opts = [].slice.call(bairroSelect.options).filter(o => o.value);
            if (opts.length) bairroSelect.value = opts[Math.floor(Math.random() * opts.length)].value;
        } else setData('registerBairro', pickRandom(bairros));
        const objInput = document.getElementById('registerObjetivo');
        const objSelect = document.getElementById('registerObjetivoSelect');
        if (objSelect && objSelect.options.length > 1) {
            const o = [].slice.call(objSelect.options).filter(opt => opt.value);
            if (o.length) objSelect.value = o[Math.floor(Math.random() * o.length)].value;
        } else if (objInput) objInput.value = pickRandom(objetivos);
        setData('registerNumPassageiros', String(Math.floor(Math.random() * 6)));
        setData('registerResponsavelPedido', pickRandom(responsaveis));
        setData('registerOM', pickRandom(oms));
        const viaturaSel = document.getElementById('registerViatura');
        const motoristaSel = document.getElementById('registerMotorista');
        if (viaturaSel && viaturaSel.options.length > 0) {
            const vopts = [].slice.call(viaturaSel.options).filter(o => o.value);
            if (vopts.length) viaturaSel.value = vopts[Math.floor(Math.random() * vopts.length)].value;
        }
        if (motoristaSel && motoristaSel.options.length > 0) {
            const mopts = [].slice.call(motoristaSel.options).filter(o => o.value);
            if (mopts.length) motoristaSel.value = mopts[Math.floor(Math.random() * mopts.length)].value;
        }
        if (tipo === 'Ambulância') {
            const hosp = document.getElementById('registerHospital');
            if (hosp) {
                const list = hosp.list;
                const opts = list ? [].slice.call(document.querySelectorAll('datalist#hospitalList option')).map(o => o.value).filter(Boolean) : [];
                hosp.value = opts.length ? pickRandom(opts) : 'Hospital Teste';
            }
        }
        if (typeof adjustRegisterFormFields === 'function') adjustRegisterFormFields();
    }, 100);
}
const btnPreencherTeste = document.getElementById('btnPreencherTeste');
if (btnPreencherTeste) btnPreencherTeste.addEventListener('click', preencherFormularioTeste);

submitNewSaidaBtn.addEventListener('click', async () => {
const formData = validateAndGetFormData();
if (!formData) return;
const isEditing = !!saidaIdHiddenInput.value;
await saveNewSaida(formData);
populateSetorList();
populateResponsavelList();
updateFormFields(); // Atualizar campos com itens personalizados
displayMessage(isEditing ? 'SAÍDA ATUALIZADA COM SUCESSO!' : 'SAÍDA CADASTRADA COM SUCESSO!', 'success');
clearRegisterForm();
window.parent.postMessage({ type: 'refresh_all_data' }, '*');
});
multiSaidaBtn.addEventListener('click', () => {
const formData = validateAndGetFormData();
if (!formData) return;
saveNewSaida(formData, formData.dataSaida, true);
populateSetorList();
populateResponsavelList();
displayMessage(`Saída para '${formData.cidade} - ${formData.bairro}' cadastrada. Insira o próximo.`, 'success');
document.getElementById('registerCidade').value = '';
document.getElementById('registerBairro').value = '';
document.getElementById('registerBairro').disabled = true;
document.getElementById('registerCidade').focus();
window.parent.postMessage({ type: 'refresh_all_data' }, '*');
});
function clearRegisterForm() {
saidaIdHiddenInput.value = '';
formTitle.textContent = 'CADASTRAR NOVA SAÍDA';
submitNewSaidaBtn.textContent = 'Cadastrar Saída';
const form = document.querySelector('.register-exit-form');
form.querySelectorAll('input, select').forEach(el => {
if (el.type === 'checkbox' || el.type === 'radio') {
} else if (el.id !== 'registerTipoSaida') {
el.value = '';
}
});
adjustRegisterFormFields();
}
function displayMessage(message, type) {
registerMessage.textContent = message;
registerMessage.className = `message ${type}`;
setTimeout(() => { registerMessage.textContent = ''; registerMessage.className = 'message'; }, 5000);
}
function formatDateToDDMMYYYY(dateString) {
if (!dateString) return '';
const [year, month, day] = dateString.split('-');
return `${day}/${month}/${year}`;
}
function populateTodasSaidasTable() {
const allSaidas = [...saidasAdministrativas.map(s => ({ ...s, tipo: 'Administrativa' })), ...saidasAmbulancias.map(s => ({ ...s, tipo: 'Ambulância' }))];
allSaidas.sort((a, b) => {
const dateA = new Date(`${a.dataSaida || a.dataPedido}T${a.horaSaida || a.saida || '00:00'}`);
const dateB = new Date(`${b.dataSaida || b.dataPedido}T${b.horaSaida || a.saida || '00:00'}`);
return dateB - dateA;
});
todasSaidasTableBody.innerHTML = '';
allSaidas.forEach(saida => {
const row = todasSaidasTableBody.insertRow();
row.dataset.id = saida.id;
row.dataset.tipo = saida.tipo;
if (isRowIncomplete(saida)) row.classList.add('incomplete-row');
row.innerHTML = `
<td>${saida.tipo || ''}</td>
<td>${formatDateToDDMMYYYY(saida.dataPedido) || ''}</td>
<td>${saida.horaPedido || ''}</td>
<td>${formatDateToDDMMYYYY(saida.dataSaida) || ''}</td>
<td>${saida.horaSaida || saida.saida || ''}</td>
<td>${saida.setor || ''}</td>
<td>${saida.ramal || ''}</td>
<td>${saida.destino || saida.bairro || ''}</td>
<td>${saida.objetivo || ''}</td>
<td>${saida.numPassageiros || ''}</td>
<td>${saida.responsavelPedido || ''}</td>
<td>${saida.om || ''}</td>
<td>${saida.hospital || ''}</td>
<td>${saida.viatura || ''}</td>
<td>${saida.motorista || ''}</td>
<td>${saida.kmSaida || ''}</td>
<td>${saida.kmChegada || ''}</td>
<td>${saida.chegada || ''}</td>
<td class="ocorrencia-cell">${saida.observacoes || ''}</td>
<td class="action-buttons">
<button class="edit-row-btn" title="Editar"><i class="fas fa-edit"></i></button>
<button class="delete-row-btn" title="Excluir"><i class="fas fa-trash-alt"></i></button>
</td>
`;
attachEventListenersToRow(row);
});
}
function filterTodasSaidasTable() {
const dateFilter = filterTodasSaidasDateInput.value;
const monthFilter = filterTodasSaidasMonthSelect.value;
const yearFilter = filterTodasSaidasYearSelect.value;
const cidadeFilter = filterTodasSaidasCidade.value;
const bairroFilter = filterTodasSaidasBairro.value;
const motoristaFilter = filterTodasSaidasMotorista.value;
const viaturaFilter = filterTodasSaidasViatura.value;
const showAdm = filterTypeAdmCheckbox.checked;
const showAmb = filterTypeAmbCheckbox.checked;
const rows = document.querySelectorAll('#todasSaidasTable tbody tr');
const today = new Date();
const year = today.getFullYear();
const month = String(today.getMonth() + 1).padStart(2, '0');
const day = String(today.getDate()).padStart(2, '0');
const todayString = `${year}-${month}-${day}`;
const allSaidas = [...saidasAdministrativas, ...saidasAmbulancias];
if (incompletosCounter) {
const totalIncompletePast = allSaidas.filter(saida => {
const now = new Date();
const currentDateTime = now.toISOString().slice(0, 16);
let isPastOrPresent = false;
if (saida.dataSaida && saida.horaSaida) {
const saidaDateTime = `${saida.dataSaida}T${saida.horaSaida}`;
isPastOrPresent = saidaDateTime <= currentDateTime;
} else if (saida.dataSaida) {
isPastOrPresent = saida.dataSaida <= todayString;
} else {
isPastOrPresent = true;
}
return isRowIncomplete(saida) && isPastOrPresent;
}).length;
incompletosCounter.textContent = `Lançamentos Incompletos: ${totalIncompletePast}`;
if (totalIncompletePast === 0) {
incompletosCounter.style.color = 'var(--primary-blue)';
} else {
incompletosCounter.style.color = 'var(--warning-orange)';
}
}
let count = 0;
let futureCount = 0;
rows.forEach(row => {
const saida = allSaidas.find(s => s.id === row.dataset.id);
if (!saida) {
row.style.display = 'none';
return;
}
if (showingOnlyIncomplete && !isRowIncomplete(saida)) {
row.style.display = 'none';
return;
}
if (showingOnlyIncomplete && isRowIncomplete(saida)) {
const now = new Date();
const currentDateTime = now.toISOString().slice(0, 16);
let isPastOrPresent = false;
if (saida.dataSaida && saida.horaSaida) {
const saidaDateTime = `${saida.dataSaida}T${saida.horaSaida}`;
isPastOrPresent = saidaDateTime <= currentDateTime;
} else if (saida.dataSaida) {
isPastOrPresent = saida.dataSaida <= todayString;
} else {
isPastOrPresent = true;
}
if (!isPastOrPresent) {
row.style.display = 'none';
return;
}
}
const hasDateInfo = saida.dataSaida && saida.dataSaida.length > 0;
let rowDateObj = null;
if (hasDateInfo) {
rowDateObj = new Date(saida.dataSaida + 'T00:00:00');
}
if((dateFilter || monthFilter || yearFilter) && !hasDateInfo){
row.style.display = 'none';
return;
}
const matchesDate = !dateFilter || (hasDateInfo && saida.dataSaida === dateFilter);
const matchesMonth = !monthFilter || (hasDateInfo && (rowDateObj.getMonth() + 1) == monthFilter);
const matchesYear = !yearFilter || (hasDateInfo && rowDateObj.getFullYear() == yearFilter);
const matchesCidade = !cidadeFilter || saida.cidade === cidadeFilter;
const matchesBairro = !bairroFilter || saida.bairro === bairroFilter;
const matchesMotorista = !motoristaFilter || saida.motorista === motoristaFilter;
const matchesViatura = !viaturaFilter || saida.viatura === viaturaFilter;
const omFilter = document.getElementById('filterTodasSaidasOM')?.value || '';
const hospitalFilter = document.getElementById('filterTodasSaidasHospital')?.value || '';
const matchesOM = !omFilter || saida.om === omFilter;
const matchesHospital = !hospitalFilter || saida.hospital === hospitalFilter;
const matchesType = (showAdm && saida.tipo === 'Administrativa') || (showAmb && saida.tipo === 'Ambulância');
if (matchesDate && matchesMonth && matchesYear && matchesCidade && matchesBairro && matchesMotorista && matchesViatura && matchesOM && matchesHospital && matchesType) {
row.style.display = '';
if (hasDateInfo) {
if (saida.dataSaida <= todayString) {
count++;
} else {
futureCount++;
}
}
} else {
row.style.display = 'none';
}
});
todasSaidasCounter.textContent = `Saídas Realizadas: ${count}`;
if (futurasSaidasCounter) {
futurasSaidasCounter.textContent = `Saídas Futuras: ${futureCount}`;
}
}
function updateUnplannedExitsTable() {
unplannedExitsTableBody.innerHTML = '';
const filterMonth = filterUnplannedMonthSelect.value;
const filterYear = filterUnplannedYearSelect.value;
const allSaidas = [...saidasAdministrativas, ...saidasAmbulancias];
const allUnplannedSaidas = allSaidas.filter(saida => {
if (saida.isUnplanned && saida.dataSaida) {
const exitDate = new Date(saida.dataSaida + 'T00:00:00');
return (!filterMonth || (exitDate.getMonth() + 1) == filterMonth) &&
(!filterYear || exitDate.getFullYear() == filterYear);
}
return false;
});
const sectorMonthlyCounts = {};
allUnplannedSaidas.forEach(saida => {
const setor = saida.setor || 'Não Informado';
const month = new Date(saida.dataSaida).getMonth() + 1;
if (!sectorMonthlyCounts[setor]) sectorMonthlyCounts[setor] = Array(13).fill(0);
sectorMonthlyCounts[setor][month]++;
});
const sortedSectors = Object.keys(sectorMonthlyCounts).sort();
if (sortedSectors.length === 0) {
unplannedExitsTableBody.innerHTML = `<tr><td colspan="13">Nenhum dado para o período.</td></tr>`;
} else {
sortedSectors.forEach(setor => {
const row = unplannedExitsTableBody.insertRow();
row.innerHTML = `<td>${setor}</td>` + sectorMonthlyCounts[setor].slice(1).map(count => `<td>${count}</td>`).join('');
});
}
let totalGeneralUnplanned = 0;
for (let i = 1; i <= 12; i++) {
const total = sortedSectors.reduce((acc, setor) => acc + (sectorMonthlyCounts[setor]?.[i] || 0), 0);
document.getElementById(`unplannedTotal${['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'][i-1]}`).textContent = total;
totalGeneralUnplanned += total;
}
document.getElementById('unplannedExitsTotalText').textContent = `Total Geral: ${totalGeneralUnplanned}`;
}
function populateCidadeFilter() {
const allSaidas = [...saidasAdministrativas, ...saidasAmbulancias];
const cidades = [...new Set(allSaidas.map(s => s.cidade).filter(d => d))].sort();
const currentVal = filterTodasSaidasCidade.value;
filterTodasSaidasCidade.innerHTML = `<option value="">Todas</option>`;
cidades.forEach(cidade => {
filterTodasSaidasCidade.innerHTML += `<option value="${cidade}">${cidade}</option>`;
});
filterTodasSaidasCidade.value = currentVal;
}
function populateBairroFilter() {
const allSaidas = [...saidasAdministrativas, ...saidasAmbulancias];
const bairros = [...new Set(allSaidas.map(s => s.bairro).filter(d => d))].sort();
const currentVal = filterTodasSaidasBairro.value;
filterTodasSaidasBairro.innerHTML = `<option value="">Todos</option>`;
bairros.forEach(bairro => {
filterTodasSaidasBairro.innerHTML += `<option value="${bairro}">${bairro}</option>`;
});
filterTodasSaidasBairro.value = currentVal;
}
function populateMotoristaFilter() {
const motoristas = [...new Set(motoristasCadastrados.map(m => m.nome))].sort();
const currentVal = filterTodasSaidasMotorista.value;
filterTodasSaidasMotorista.innerHTML = `<option value="">Todos</option>`;
motoristas.forEach(motorista => {
filterTodasSaidasMotorista.innerHTML += `<option value="${motorista}">${motorista}</option>`;
});
filterTodasSaidasMotorista.value = currentVal;
}
function populateViaturaFilter() {
const viaturas = [...new Set(viaturasCadastradas.map(v => v.placa))].sort();
const currentVal = filterTodasSaidasViatura.value;
filterTodasSaidasViatura.innerHTML = `<option value="">Todas</option>`;
viaturas.forEach(viatura => {
filterTodasSaidasViatura.innerHTML += `<option value="${viatura}">${viatura}</option>`;
});
filterTodasSaidasViatura.value = currentVal;
}
function populateOMFilter() {
const allSaidas = [...saidasAdministrativas, ...saidasAmbulancias];
const oms = [...new Set(allSaidas.map(s => s.om).filter(d => d))].sort();
const filterElement = document.getElementById('filterTodasSaidasOM');
if (!filterElement) return;
const currentVal = filterElement.value;
filterElement.innerHTML = `<option value="">Todas</option>`;
oms.forEach(om => {
filterElement.innerHTML += `<option value="${om}">${om}</option>`;
});
filterElement.value = currentVal;
}
function populateHospitalFilter() {
const allSaidas = [...saidasAdministrativas, ...saidasAmbulancias];
const hospitais = [...new Set(allSaidas.map(s => s.hospital).filter(d => d))].sort();
const filterElement = document.getElementById('filterTodasSaidasHospital');
if (!filterElement) return;
const currentVal = filterElement.value;
filterElement.innerHTML = `<option value="">Todos</option>`;
hospitais.forEach(hospital => {
filterElement.innerHTML += `<option value="${hospital}">${hospital}</option>`;
});
filterElement.value = currentVal;
}
function populateAllYearFilters() {
const years = new Set();
[...saidasAdministrativas, ...saidasAmbulancias].forEach(saida => {
if (saida.dataSaida) years.add(new Date(saida.dataSaida + 'T00:00:00').getFullYear());
});
if (years.size === 0) years.add(new Date().getFullYear());
const sortedYears = Array.from(years).sort((a, b) => b - a);
[filterTodasSaidasYearSelect, filterUnplannedYearSelect].forEach(select => {
const currentVal = select.value;
select.innerHTML = `<option value="">Todos</option>`;
sortedYears.forEach(year => select.innerHTML += `<option value="${year}">${year}</option>`);
select.value = currentVal;
});
}
function populateSetorList() {
const setorList = document.getElementById('setorList');
if (!setorList) return;
setorList.innerHTML = '';
// Usar APENAS itens cadastrados na aba "Cadastrar Itens"
const setores = (itensPersonalizados && itensPersonalizados.setores ? itensPersonalizados.setores : []).filter(s => s && s.trim() !== '').sort();
setores.forEach(setor => {
const option = document.createElement('option');
option.value = setor;
setorList.appendChild(option);
});

// Configurar validação em tempo real para o campo Setor
const setorInput = document.getElementById('registerSetor');
if (setorInput) {
    // Remover listeners anteriores para evitar duplicatas
    const newSetorInput = setorInput.cloneNode(true);
    setorInput.parentNode.replaceChild(newSetorInput, setorInput);
    
    newSetorInput.addEventListener('blur', function() {
        const value = this.value.trim();
        if (value) {
            const options = Array.from(setorList.querySelectorAll('option')).map(opt => opt.value.trim());
            if (!options.includes(value)) {
                this.classList.add('flash-red');
                this.title = 'Este setor não está cadastrado. Use o botão "+" para cadastrar.';
            } else {
                this.classList.remove('flash-red');
                this.title = '';
            }
        } else {
            this.classList.remove('flash-red');
            this.title = '';
        }
    });
}
}
function populateResponsavelList() {
const responsavelList = document.getElementById('responsavelList');
if (!responsavelList) return;
responsavelList.innerHTML = '';
// Usar APENAS itens cadastrados na aba "Cadastrar Itens"
const responsaveis = (itensPersonalizados && itensPersonalizados.responsaveis ? itensPersonalizados.responsaveis : []).filter(r => r && r.trim() !== '').sort();
responsaveis.forEach(responsavel => {
const option = document.createElement('option');
option.value = responsavel;
responsavelList.appendChild(option);
});

// Configurar validação em tempo real para o campo Responsável pelo Pedido
const responsavelInput = document.getElementById('registerResponsavelPedido');
if (responsavelInput) {
    // Remover listeners anteriores para evitar duplicatas
    const newResponsavelInput = responsavelInput.cloneNode(true);
    responsavelInput.parentNode.replaceChild(newResponsavelInput, responsavelInput);
    
    newResponsavelInput.addEventListener('blur', function() {
        const value = this.value.trim();
        if (value) {
            const options = Array.from(responsavelList.querySelectorAll('option')).map(opt => opt.value.trim());
            if (!options.includes(value)) {
                this.classList.add('flash-red');
                this.title = 'Este responsável não está cadastrado. Use o botão "+" para cadastrar.';
            } else {
                this.classList.remove('flash-red');
                this.title = '';
            }
        } else {
            this.classList.remove('flash-red');
            this.title = '';
        }
    });
}
}
function loadDataAndPopulateTables() {
saidasAdministrativas = JSON.parse(localStorage.getItem('saidasAdministrativas')) || [];
saidasAmbulancias = JSON.parse(localStorage.getItem('saidasAmbulancias')) || [];
viaturasCadastradas = JSON.parse(localStorage.getItem('viaturasCadastradas')) || [];
motoristasCadastrados = JSON.parse(localStorage.getItem('motoristasCadastrados')) || [];
loadItensData(); // Carregar itens personalizados
populateAllYearFilters();
populateCidadeFilter();
populateBairroFilter();
populateMotoristaFilter();
populateViaturaFilter();
populateOMFilter();
populateHospitalFilter();
populateSetorList();
populateResponsavelList();
populateTodasSaidasTable();
filterTodasSaidasTable();
updateUnplannedExitsTable();
populateRegisterSaidaSelects();
updateFormFields(); // Atualizar campos com itens personalizados
}
function showSubTab(tabIdToShow) {
subTabButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.subTab === tabIdToShow));
subTabContents.forEach(content => content.classList.toggle('active', content.id === tabIdToShow));
}
subTabButtons.forEach(button => {
button.addEventListener('click', () => {
const tabId = button.dataset.subTab;
showSubTab(tabId);
if (tabId === 'todasSaidasContent') {
loadDataAndPopulateTables();
} else if (tabId === 'cadastrarItensContent') {
// Recarregar dados existentes e atualizar tabelas
loadItensData();
renderItensTables(); // Renderizar todas as tabelas
// Atualizar campos do formulário e inicializar abas após um delay maior
setTimeout(() => {
    updateFormFields();
    // Garantir que os elementos estão no DOM antes de inicializar
    if (document.getElementById('cadastrarItensContent') && document.querySelector('.itens-tabs-container')) {
        initItensTabs();
    } else {
        // Tentar novamente após mais um delay
        setTimeout(() => {
            initItensTabs();
        }, 200);
    }
}, 200);
}
});
});
const filterTodasSaidasOM = document.getElementById('filterTodasSaidasOM');
const filterTodasSaidasHospital = document.getElementById('filterTodasSaidasHospital');
[filterTodasSaidasDateInput, filterTodasSaidasMonthSelect, filterTodasSaidasYearSelect, filterTodasSaidasCidade, filterTodasSaidasBairro, filterTodasSaidasMotorista, filterTodasSaidasViatura, filterTypeAdmCheckbox, filterTypeAmbCheckbox].forEach(el => el && el.addEventListener('change', filterTodasSaidasTable));
if (filterTodasSaidasOM) filterTodasSaidasOM.addEventListener('change', filterTodasSaidasTable);
if (filterTodasSaidasHospital) filterTodasSaidasHospital.addEventListener('change', filterTodasSaidasTable);
[filterUnplannedMonthSelect, filterUnplannedYearSelect].forEach(el => el.addEventListener('change', updateUnplannedExitsTable));
registerTipoSaidaSelect.addEventListener('change', adjustRegisterFormFields);
// Garantir que o botão apareça na inicialização se tipo for Ambulância
setTimeout(() => {
    adjustRegisterFormFields();
}, 200);
registerViaturaSelect.addEventListener('change', () => {
    // Atualizar KM SAÍDA automaticamente quando viatura for selecionada (apenas para Ambulância)
    if (registerTipoSaidaSelect.value === 'Ambulância') {
        updateKmSaidaAuto();
    }
});

// Adicionar formatação automática para campos KM SAÍDA e KM CHEGADA
const kmSaidaInput = document.getElementById('registerKmSaida');
const kmChegadaInput = document.getElementById('registerKmChegada');

if (kmSaidaInput) {
    kmSaidaInput.addEventListener('input', (e) => {
        const cursorPosition = e.target.selectionStart;
        const value = e.target.value;
        const formatted = formatKm(value);
        e.target.value = formatted;
        // Restaurar posição do cursor (ajustada para a formatação)
        const diff = formatted.length - value.length;
        e.target.setSelectionRange(cursorPosition + diff, cursorPosition + diff);
    });
    
    kmSaidaInput.addEventListener('blur', (e) => {
        e.target.value = formatKm(e.target.value);
    });
}

if (kmChegadaInput) {
    kmChegadaInput.addEventListener('input', (e) => {
        const cursorPosition = e.target.selectionStart;
        const value = e.target.value;
        const formatted = formatKm(value);
        e.target.value = formatted;
        // Restaurar posição do cursor (ajustada para a formatação)
        const diff = formatted.length - value.length;
        e.target.setSelectionRange(cursorPosition + diff, cursorPosition + diff);
    });
    
    kmChegadaInput.addEventListener('blur', (e) => {
        e.target.value = formatKm(e.target.value);
        
        // Validação de quilometragem
        const kmChegadaValue = e.target.value.trim();
        const kmSaidaValue = document.getElementById('registerKmSaida') ? document.getElementById('registerKmSaida').value.trim() : '';
        
        if (kmChegadaValue && kmSaidaValue) {
            const kmSaidaStr = kmSaidaValue.replace(/\./g, '');
            const kmChegadaStr = kmChegadaValue.replace(/\./g, '');
            
            if (kmSaidaStr && kmChegadaStr) {
                const kmSaida = parseFloat(kmSaidaStr);
                const kmChegada = parseFloat(kmChegadaStr);
                
                if (!isNaN(kmSaida) && !isNaN(kmChegada)) {
                    // Verificar se KM chegada <= KM saída
                    if (kmChegada <= kmSaida) {
                        showKmAlertModal('Quilometragem de chegada incorreta, verifique o preenchimento novamente.');
                        // Reverter o valor
                        e.target.value = '';
                        return;
                    }
                    
                    // Verificar se a distância percorrida é maior que 110km
                    const distancia = kmChegada - kmSaida;
                    if (distancia > 110) {
                        showKmAlertModal('Quilometragem alta, está certo desse preenchimento?', e.target, true);
                    }
                }
            }
        }
    });
}
incompletosCounter.addEventListener('click', () => {
showingOnlyIncomplete = !showingOnlyIncomplete;
incompletosCounter.style.textDecoration = showingOnlyIncomplete ? 'underline' : 'none';
incompletosCounter.style.fontWeight = showingOnlyIncomplete ? 'bold' : 'normal';
filterTodasSaidasTable();
});
todasSaidasPdfBtn.addEventListener('click', () => {
const dateInfo = filterTodasSaidasDateInput.value ? `Data: ${formatDateToDDMMYYYY(filterTodasSaidasDateInput.value)}` : 'Todas as Datas';
downloadPdfTable('todasSaidasTable', 'Relatorio_Saidas_Cadastradas', 'Relatório de Saídas Cadastradas', dateInfo);
});
todasSaidasExcelBtn.addEventListener('click', () => {
exportTableToCSV('todasSaidasTable', `Relatorio_Saidas_Cadastradas.csv`);
});
todasSaidasImportInput.addEventListener('change', importCsvData);
unplannedExitsPdfBtn.addEventListener('click', () => {
const month = filterUnplannedMonthSelect.options[filterUnplannedMonthSelect.selectedIndex].text;
const year = filterUnplannedYearSelect.value;
downloadPdfTable('unplannedExitsTable', 'Relatorio_Saidas_Nao_Programadas', 'Relatório de Saídas Não Programadas', `Período: ${month} / ${year}`);
});
deleteAllBtn.addEventListener('click', () => {
if (confirm("Tem certeza que deseja EXCLUIR TODOS os registros de saídas? Esta ação não pode ser desfeita.")) {
localStorage.removeItem('saidasAdministrativas');
localStorage.removeItem('saidasAmbulancias');
loadDataAndPopulateTables();
window.parent.postMessage({ type: 'refresh_all_data' }, '*');
alert("Todos os dados foram excluídos.");
}
});
function generateCalendar(year, month) {
calendarGrid.innerHTML = '';
const today = new Date(); today.setHours(0, 0, 0, 0);
calendarMonthYear.textContent = `${new Date(year, month).toLocaleString('pt-BR', { month: 'long' })} ${year}`;
['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'].forEach(day => calendarGrid.innerHTML += `<div class="calendar-weekday">${day}</div>`);
const firstDay = new Date(year, month, 1);
for (let i = 0; i < firstDay.getDay(); i++) calendarGrid.innerHTML += `<div></div>`;
for (let i = 1; i <= new Date(year, month + 1, 0).getDate(); i++) {
const currentDate = new Date(year, month, i);
const dateString = currentDate.toISOString().split('T')[0];
let classes = 'calendar-day';
if (currentDate < today) classes += ' other-month';
if (currentDate.getTime() === today.getTime()) classes += ' today';
if (selectedDates.has(dateString)) classes += ' selected';
calendarGrid.innerHTML += `<div class="${classes}" data-date="${dateString}">${i}</div>`;
}
calendarGrid.querySelectorAll('.calendar-day:not(.other-month)').forEach(day => {
day.addEventListener('click', () => {
const dateString = day.dataset.date;
if (selectedDates.has(dateString)) selectedDates.delete(dateString); else selectedDates.add(dateString);
day.classList.toggle('selected');
});
});
}
serialRegisterBtn.addEventListener('click', () => {
selectedDates.clear();
const initialDateValue = document.getElementById('registerDataSaida').value;
calendarDate = initialDateValue ? new Date(initialDateValue + 'T00:00:00') : new Date();
if(initialDateValue) selectedDates.add(initialDateValue);
calendarModal.style.display = 'flex';
generateCalendar(calendarDate.getFullYear(), calendarDate.getMonth());
});
prevMonthBtn.addEventListener('click', () => {
calendarDate.setMonth(calendarDate.getMonth() - 1);
generateCalendar(calendarDate.getFullYear(), calendarDate.getMonth());
});
nextMonthBtn.addEventListener('click', () => {
calendarDate.setMonth(calendarDate.getMonth() + 1);
generateCalendar(calendarDate.getFullYear(), calendarDate.getMonth());
});
cancelSerialRegisterBtn.addEventListener('click', () => calendarModal.style.display = 'none');
closeCalendarModal.addEventListener('click', () => calendarModal.style.display = 'none');
confirmSerialRegisterBtn.addEventListener('click', () => {
if (selectedDates.size === 0) return alert('Nenhuma data selecionada!');
const formData = validateAndGetFormData(true);
if (!formData) return calendarModal.style.display = 'none';
Array.from(selectedDates).sort().forEach(dateString => saveNewSaida(formData, dateString, true));
calendarModal.style.display = 'none';
displayMessage(`${selectedDates.size} SAÍDA(S) CADASTRADA(S)!`, 'success');
clearRegisterForm();
window.parent.postMessage({ type: 'refresh_all_data' }, '*');
});
window.addEventListener('message', function(event) {
const { type, data, id } = event.data || {};
if (type === 'populate_form_for_edit' || type === 'edit_saida') {
populateFormForEdit(data);
} else if (type === 'locate_saida') {
locateAndHighlightButton(id);
} else if (type === 'refresh_data' || type === 'refresh_all_data') {
loadDataAndPopulateTables();
}
});
function locateAndHighlightButton(id) {
if (!id) return;
showSubTab('todasSaidasContent');
setTimeout(() => {
const targetRow = todasSaidasTableBody.querySelector(`tr[data-id="${id}"]`);
if (targetRow) {
targetRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
const editButton = targetRow.querySelector('.edit-row-btn');
if (editButton) {
editButton.classList.add('blink-red-button');
editButton.addEventListener('click', function stopBlinking() {
editButton.classList.remove('blink-red-button');
editButton.removeEventListener('click', stopBlinking);
});
}
}
}, 100);
}
loadDataAndPopulateTables();

// Inicializar abas dos itens se a aba já estiver ativa
if (document.getElementById('cadastrarItensContent') && document.getElementById('cadastrarItensContent').classList.contains('active')) {
setTimeout(() => {
initItensTabs();
}, 200);
}
});

// Função global para inicializar as abas dos itens
function initItensTabs() {
    // Verificar se estamos na aba correta
    const cadastrarItensContent = document.getElementById('cadastrarItensContent');
    if (!cadastrarItensContent) {
        return;
    }
    
    // Buscar elementos dentro do container correto
    const itensTabsContainer = cadastrarItensContent.querySelector('.itens-tabs-container');
    if (!itensTabsContainer) {
        return;
    }
    
    const itensTabButtons = itensTabsContainer.querySelectorAll('.itens-tab-button');
    const itensTabContents = itensTabsContainer.querySelectorAll('.itens-tab-content');
    
    if (itensTabButtons.length === 0 || itensTabContents.length === 0) {
        return; // Elementos ainda não estão disponíveis
    }

    // Remover listeners anteriores para evitar duplicação
    itensTabButtons.forEach(btn => {
        const newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);
    });

    // Re-selecionar após clonar
    const freshButtons = itensTabsContainer.querySelectorAll('.itens-tab-button');
    const freshContents = itensTabsContainer.querySelectorAll('.itens-tab-content');

    freshButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            const targetTab = this.dataset.itensTab;
            if (!targetTab) {
                return;
            }
            // Remover active de todos os botões e conteúdos
            freshButtons.forEach(btn => btn.classList.remove('active'));
            freshContents.forEach(content => content.classList.remove('active'));
            // Adicionar active ao botão e conteúdo selecionados
            this.classList.add('active');
            const targetContent = document.getElementById(targetTab);
            if (targetContent) {
                targetContent.classList.add('active');
            }
        });
    });
}
</script>
<script>
// ========== LÓGICA DE CIDADE E BAIRRO ==========
document.addEventListener('DOMContentLoaded', function() {
const bairrosPorCidade = {
    "Rio de Janeiro": ["Abolição", "Acari", "Água Santa", "Alto da Boa Vista", "Anchieta", "Andaraí", "Anil", "Bancários", "Bangu", "Barros Filho", "Barra da Tijuca", "Barra de Guaratiba", "Benfica", "Bento Ribeiro", "Bonsucesso", "Botafogo", "Brás de Pina", "Cachambi", "Cacuia", "Caju", "Camorim", "Campinho", "Campo dos Afonsos", "Campo Grande", "Cascadura", "Catete", "Catumbi", "Cavalcanti", "Centro", "Cidade de Deus", "Cidade Nova", "Cidade Universitária", "Cocotá", "Coelho Neto", "Colégio", "Complexo do Alemão", "Copacabana", "Cordovil", "Cosme Velho", "Cosmos", "Costa Barros", "Curicica", "Del Castilho", "Deodoro", "Encantado", "Engenheiro Leal", "Engenho da Rainha", "Engenho de Dentro", "Engenho Novo", "Estácio", "Flamengo", "Freguesia (Ilha)", "Freguesia (Jacarepaguá)", "Galeão", "Gamboa", "Gardênia Azul", "Gávea", "Glória", "Grajau", "Grumari", "Guadalupe", "Guaratiba", "Higienópolis", "Honório Gurgel", "Humaitá", "Inhaúma", "Inhoaíba", "Ipanema", "Irajá", "Itanhangá", "Jacaré", "Jacarepaguá", "Jardim América", "Jardim Botânico", "Jardim Carioca", "Jardim Guanabara", "Jardim Sulacap", "Joá", "Lagoa", "Laranjeiras", "Leblon", "Leme", "Lins de Vasconcelos", "Madureira", "Magalhães Bastos", "Mangueira", "Manguinhos", "Maracanã", "Maré", "Marechal Hermes", "Maria da Graça", "Meier", "Méier", "Moneró", "Olaria", "Oswaldo Cruz", "Padre Miguel", "Parada de Lucas", "Parque Anchieta", "Parque Columbia", "Pavuna", "Pechincha", "Pedra de Guaratiba", "Penha", "Penha Circular", "Piedade", "Pilares", "Pitangueiras", "Portuguesa", "Praia da Bandeira", "Praça da Bandeira", "Praça Seca", "Quintino Bocaiúva", "Ramos", "Realengo", "Recreio dos Bandeirantes", "Riachuelo", "Ribeira", "Ricardo de Albuquerque", "Rio Comprido", "Rocha", "Rocha Miranda", "Rocinha", "Santa Cruz", "Santa Teresa", "Santíssimo", "Santo Cristo", "São Conrado", "São Cristóvão", "São Francisco Xavier", "Saúde", "Senador Camará", "Senador Vasconcelos", "Sepetiba", "Taquara", "Tijuca", "Todos os Santos", "Tomás Coelho", "Turiaçu", "Urca", "Vargem Grande", "Vargem Pequena", "Vasco da Gama", "Várzea", "Vicente de Carvalho", "Vigário Geral", "Vila da Penha", "Vila Isabel", "Vila Kennedy", "Vila Kosmos", "Vila Militar", "Vila Valqueire", "Vista Alegre", "Zumbi"],
    "Belford Roxo": ["Areia Branca", "Belford Roxo (Centro)", "Bom Pastor", "Heliópolis", "Lote XV", "Nova Aurora", "Parque Amorim", "Parque Esperança", "Parque Flora", "Parque São José", "Piam", "Santa Amélia", "Santa Tereza", "São Bernardo", "São Leopoldo", "Shangri-lá", "Vila Pauline", "Wona"],
    "Duque de Caxias": ["Amapá", "Bar dos Cavaleiros", "Campos Elíseos", "Centro", "Cidade Parque Paulista", "Copacabana", "Doutor Laureano", "Figueira", "Gramacho", "Imbariê", "Jardim 25 de Agosto", "Jardim Anhangá", "Jardim Primavera", "Lamarão", "Olavo Bilac", "Parque Duque", "Parque Eldorado", "Parque Equitativa", "Parque Fluminense", "Periquitos", "Pilar", "Saracuruna", "Sarapuí", "Santa Cruz da Serra", "Santa Lúcia", "Santo Antônio", "São Bento", "Taquara", "Tiradentes", "Xerém", "Vila São Luís"],
    "Guapimirim": ["Centro", "Cotia", "Garrafão", "Parada Modelo", "Parada Sapucaia", "Vale das Pedrinhas", "Vila Olímpia"],
    "Itaboraí": ["Aldeia da Prata", "Areal", "Cabuçu", "Centro", "Cidade Nova", "Esperança", "Granjas Cabuçu", "Itambi", "Jardim Imperial", "Manilha", "Marambaia", "Nancilândia", "Outeiro das Pedras", "Pacheco", "Pachecos", "Pista", "Porto das Caixas", "Reta Velha", "Rio Várzea", "Sambaetiba", "São Joaquim", "Sapê", "Venda das Pedras", "Vila Progresso"],
    "Japeri": ["Alecrim", "Belo Horizonte", "Boqueirão", "Centro", "Citrópolis", "Delamare", "Engenheiro Pedreira", "Guandu", "Jardim Marajoara", "Jardim Nova Belém", "Lagoa", "Mucajá", "Nova Belém", "Parque Alvorada", "Rio d'Ouro", "Santa Amélia", "Santa Inês", "Santo Antônio", "São Jorge", "Vila Canaã", "Vila Central"],
    "Magé": ["Barbuda", "Bongaba", "Centro", "Fragoso", "Guia de Pacobaíba", "Imburo", "Inhomirim", "Iriri", "Maurimárcia", "Mauá", "Parada Modelo", "Pau Grande", "Piabetá", "Praia das Gaivotas", "Raiz da Serra", "Santo Aleixo", "Suruí", "Vila Inhomirim"],
    "Maricá": ["Araçatiba", "Barra de Maricá", "Boqueirão", "Centro", "Condado de Maricá", "Cordeirinho", "Flamengo", "Guaratiba", "Inoã", "Itaipuaçu", "Jardim Atlântico", "Ponta Negra", "Saquarema", "São José do Imbassaí", "Ubatiba", "Pindobas", "Retiro", "Santa Rita", "Silvado", "Bambuí", "Espraiado"],
    "Mesquita": ["Banco de Areia", "BNH", "Centro", "Chatuba", "Cosmorama", "Edson Passos", "Juscelino", "Nova Cidade", "Rocha Sobrinho", "Santa Terezinha", "Santo Elias", "Vila Emil"],
    "Nilópolis": ["Cabuis", "Centro", "Chatuba", "Frigorífico", "Manoel Reis", "Mirandela", "Nova Cidade", "Olinda", "Paiol de Pólvora", "São Mateus"],
    "Niterói": ["Barreto", "Boa Viagem", "Cachoeiras", "Cafubá", "Camboinhas", "Cantagalo", "Centro", "Charitas", "Engenhoca", "Engenho do Mato", "Fátima", "Fonseca", "Gragoatá", "Icaraí", "Ingá", "Itacoatiara", "Itaipu", "Jacaré", "Jardim Icaraí", "Jurujuba", "Largo da Batalha", "Maceió", "Maria Paula", "Matapaca", "Muriqui", "Pendotiba", "Pé Pequeno", "Piratininga", "Ponta d'Areia", "Rio do Ouro", "Santa Bárbara", "Santa Rosa", "Santana", "Santo Antônio", "São Domingos", "São Francisco", "São Lourenço", "Sapê", "Serra Grande", "Tenente Jardim", "Várzea das Moças", "Vila Progresso", "Viradouro"],
    "Nova Iguaçu": ["Austin", "Bairro da Luz", "Bela Vista", "Botafogo", "Cabuçu", "Califórnia", "Carlos Sampaio", "Centro", "Cerâmica", "Comendador Soares", "Danon", "Geneciano", "Grama", "Inconfidência", "Jardim Alvorada", "Jardim Iguaçu", "Jardim Nova Era", "Jardim Pernambuco", "K11", "Km 32", "Marapicu", "Mesquita", "Miguel Couto", "Moquetá", "Ouro Verde", "Parque Ambaí", "Parque Flora", "Parque Estoril", "Patis", "Posse", "Rancho Novo", "Santa Eugênia", "São Benedito", "Tinguá", "Três Corações", "Valverde", "Vila de Cava", "Vila Operária", "Vila Iguaçuana"],
    "Paracambi": ["Barra do Pirai", "Cascata", "Centro", "Fábrica", "Lages", "Morro Grande", "Ribeirão das Lajes", "Salgueiro"],
    "Queimados": ["Centro", "Eldorado", "Fanchem", "Inconfidência", "Jardim Novo Horizonte", "Luiz de Camões", "Marajoara", "Paraíso", "Parque Avenida", "Parque Estrela Dalva", "Parque Felicidade", "Parque Floresta", "Parque São José", "São Roque", "Valdariosa", "Vila Camarim", "Vila Central", "Vila do Tinguá", "Vila Pacaembu", "Vila São João"],
    "São Gonçalo": ["Alcântara", "Amendoeira", "Antonina", "Arsenal", "Barro Vermelho", "Boa Vista", "Boaçu", "Brasilândia", "Centro", "Colubandê", "Coelho", "Engenho Pequeno", "Estrela do Norte", "Fazenda dos Mineiros", "Galo Branco", "Gradim", "Guarani", "Ieda", "Ipiíba", "Itaoca", "Itaúna", "Jardim Alcântara", "Jardim Amendoeira", "Jardim Califórnia", "Jardim Catarina", "Jardim Miriambi", "Jardim Nova República", "Jardim Tiradentes", "Jóquei Clube", "Lagoinha", "Laranjal", "Luiz Caçador", "Marambaia", "Maria Paula", "Miriambi", "Monjolos", "Morro do Castro", "Mutuá", "Mutuaguaçu", "Mutuapira", "Neves", "Nova Cidade", "Novo México", "Pacheco", "Paiva", "Palmeiras", "Paraíso", "Patronato", "Porto da Madama", "Porto da Pedra", "Porto do Rosa", "Porto Novo", "Porto Velho", "Raul Veiga", "Recanto das Acácias", "Rio do Ouro", "Rocha", "Rosane", "Salgueiro", "Santa Catarina", "Santa Isabel", "Santa Luzia", "São Miguel", "Tribobó", "Trindade", "Várzea das Moças", "Vila Iara", "Vista Alegre", "Zé Garoto"],
    "São João de Meriti": ["Agostinho Porto", "Baixada Campista", "Centro", "Coelho da Rocha", "Éden", "Engenheiro Belford", "Jardim Meriti", "Jardim Metrópole", "Parque Alian", "Parque Araruama", "Parque Barreto", "Parque São Nicolau", "São Mateus", "Tomazinho", "Venda Velha", "Vilar dos Teles", "Vila Rosali", "Vila Tiradentes"],
    "Seropédica": ["Boa Esperança", "Campo Lindo", "Centro", "Dom Rodrigo", "Fazenda Caxias", "Piranema", "Santa Alice", "Santa Sofia", "Seropédica (Centro)"],
    "Tanguá": ["Adrianópolis", "Cachoeiras de Macacu", "Centro", "Mutuá", "Outeiro", "Rio Bonito", "Sambaê", "Sobradinho"]
};

const cidadeSelect = document.getElementById('registerCidade');
const cidadeInput = document.getElementById('registerCidadeInput');
const bairroSelect = document.getElementById('registerBairro');
const bairroInput = document.getElementById('registerBairroInput');

if (cidadeSelect && cidadeInput) {
    cidadeSelect.addEventListener('dblclick', function() {
        const valorAtual = this.value;
        cidadeSelect.style.display = 'none';
        cidadeInput.style.display = 'block';
        cidadeInput.value = valorAtual;
        cidadeInput.focus();
    });
    
    cidadeInput.addEventListener('blur', function() {
        const valorDigitado = this.value.trim();
        if (valorDigitado) {
            const opcaoExistente = Array.from(cidadeSelect.options).find(
                opt => opt.value.toLowerCase() === valorDigitado.toLowerCase()
            );
            if (opcaoExistente) {
                cidadeSelect.value = opcaoExistente.value;
            } else {
                const novaOpcao = document.createElement('option');
                novaOpcao.value = valorDigitado;
                novaOpcao.textContent = valorDigitado;
                cidadeSelect.appendChild(novaOpcao);
                cidadeSelect.value = valorDigitado;
            }
            cidadeSelect.dispatchEvent(new Event('change'));
        }
        cidadeInput.style.display = 'none';
        cidadeSelect.style.display = 'block';
    });
    
    cidadeInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') this.blur();
    });
}

if (bairroSelect && bairroInput) {
    bairroSelect.addEventListener('dblclick', function() {
        if (!this.disabled) {
            const valorAtual = this.value;
            bairroSelect.style.display = 'none';
            bairroInput.style.display = 'block';
            bairroInput.value = valorAtual;
            bairroInput.focus();
        }
    });
    
    bairroInput.addEventListener('blur', function() {
        const valorDigitado = this.value.trim();
        if (valorDigitado) {
            const opcaoExistente = Array.from(bairroSelect.options).find(
                opt => opt.value.toLowerCase() === valorDigitado.toLowerCase()
            );
            if (opcaoExistente) {
                bairroSelect.value = opcaoExistente.value;
            } else {
                const novaOpcao = document.createElement('option');
                novaOpcao.value = valorDigitado;
                novaOpcao.textContent = valorDigitado;
                bairroSelect.appendChild(novaOpcao);
                bairroSelect.value = valorDigitado;
            }
        }
        bairroInput.style.display = 'none';
        bairroSelect.style.display = 'block';
    });
    
    bairroInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') this.blur();
    });
}

// Campo OM agora é um input com autocomplete (datalist), não precisa de lógica especial

if (cidadeSelect && bairroSelect) {
    cidadeSelect.addEventListener('change', function() {
        const cidadeSelecionada = this.value;
        bairroSelect.innerHTML = '<option value="">Selecione o bairro</option>';
        
        if (cidadeSelecionada) {
            bairroSelect.disabled = false;
            
            // Usar APENAS bairros cadastrados na aba "Cadastrar Itens"
            if (itensPersonalizados && itensPersonalizados.bairros && itensPersonalizados.bairros[cidadeSelecionada] && itensPersonalizados.bairros[cidadeSelecionada].length > 0) {
                const bairros = itensPersonalizados.bairros[cidadeSelecionada].filter(b => b && b.trim() !== '').sort();
                bairros.forEach(function(bairro) {
                    const option = document.createElement('option');
                    option.value = bairro;
                    option.textContent = bairro;
                    bairroSelect.appendChild(option);
                });
            }
            
            if (bairroSelect.options.length === 1) {
                bairroSelect.innerHTML = '<option value="">Digite o bairro (duplo clique)</option>';
            }
        } else {
            bairroSelect.disabled = true;
            bairroSelect.innerHTML = '<option value="">Selecione primeiro a cidade</option>';
        }
    });
}

// Duplo clique no objetivo (para ambulância)
const objetivoSelect = document.getElementById('registerObjetivoSelect');
const objetivoInput = document.getElementById('registerObjetivoInput');

if (objetivoSelect && objetivoInput) {
    objetivoSelect.addEventListener('dblclick', function() {
        const valorAtual = this.value;
        objetivoSelect.style.display = 'none';
        objetivoInput.style.display = 'block';
        objetivoInput.value = valorAtual;
        objetivoInput.focus();
    });
    
    objetivoInput.addEventListener('blur', function() {
        const valorDigitado = this.value.trim();
        const objetivosFixos = ['Inter Hospitalar', 'APH', 'Exame', 'Aeroporto', 'Alta'];
        if (valorDigitado) {
            const opcaoExistente = objetivosFixos.find(
                opt => opt.toLowerCase() === valorDigitado.toLowerCase()
            );
            if (opcaoExistente) {
                objetivoSelect.value = opcaoExistente;
            } else {
                // Valor não corresponde às opções fixas, manter valor anterior ou limpar
                const valorAnterior = objetivoSelect.value;
                objetivoSelect.value = valorAnterior;
            }
        }
        objetivoInput.style.display = 'none';
        objetivoSelect.style.display = 'block';
    });
    
    objetivoInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') this.blur();
    });
}


});

// ==================== GERENCIAMENTO DE ITENS PERSONALIZADOS ====================

const ITENS_STORAGE_KEY = 'cadastroItensPersonalizados';

// Estrutura de dados para itens personalizados
let itensPersonalizados = {
    setores: [],
    responsaveis: [],
    cidades: [],
    bairros: {}, // { cidade: [bairros] }
    objetivos: [],
    hospitais: [],
    oms: []
};

// Carregar itens do localStorage e dados existentes
function loadItensData() {
    const saved = localStorage.getItem(ITENS_STORAGE_KEY);
    if (saved) {
        try {
            itensPersonalizados = JSON.parse(saved);
        } catch (e) {
            console.error('Erro ao carregar itens personalizados:', e);
        }
    }
    
    // Carregar valores padrão se não existirem
    if (!itensPersonalizados.setores) itensPersonalizados.setores = [];
    if (!itensPersonalizados.responsaveis) itensPersonalizados.responsaveis = [];
    if (!itensPersonalizados.cidades) itensPersonalizados.cidades = [];
    if (!itensPersonalizados.bairros) itensPersonalizados.bairros = {};
    if (!itensPersonalizados.objetivos) itensPersonalizados.objetivos = ['Inter Hospitalar', 'APH', 'Exame', 'Aeroporto', 'Alta'];
    if (!itensPersonalizados.hospitais) itensPersonalizados.hospitais = [];
    if (!itensPersonalizados.oms) itensPersonalizados.oms = [];
    
    // Adicionar cidades metropolitanas do Rio de Janeiro se não existirem
    const cidadesMetropolitanas = [
        'Rio de Janeiro',
        'Belford Roxo',
        'Duque de Caxias',
        'Guapimirim',
        'Itaboraí',
        'Japeri',
        'Magé',
        'Maricá',
        'Mesquita',
        'Nilópolis',
        'Niterói',
        'Nova Iguaçu',
        'Paracambi',
        'Queimados',
        'São Gonçalo',
        'São João de Meriti',
        'Seropédica',
        'Tanguá'
    ];
    
    cidadesMetropolitanas.forEach(cidade => {
        if (!itensPersonalizados.cidades.includes(cidade)) {
            itensPersonalizados.cidades.push(cidade);
        }
    });
    
    // Adicionar bairros pré-cadastrados para cada cidade (apenas se não existirem)
    if (!itensPersonalizados.bairros['Rio de Janeiro']) {
        itensPersonalizados.bairros['Rio de Janeiro'] = ["Abolição", "Acari", "Água Santa", "Alto da Boa Vista", "Anchieta", "Andaraí", "Anil", "Bancários", "Bangu", "Barros Filho", "Barra da Tijuca", "Barra de Guaratiba", "Benfica", "Bento Ribeiro", "Bonsucesso", "Botafogo", "Brás de Pina", "Cachambi", "Cacuia", "Caju", "Camorim", "Campinho", "Campo dos Afonsos", "Campo Grande", "Cascadura", "Catete", "Catumbi", "Cavalcanti", "Centro", "Cidade de Deus", "Cidade Nova", "Cidade Universitária", "Cocotá", "Coelho Neto", "Colégio", "Complexo do Alemão", "Copacabana", "Cordovil", "Cosme Velho", "Cosmos", "Costa Barros", "Curicica", "Del Castilho", "Deodoro", "Encantado", "Engenheiro Leal", "Engenho da Rainha", "Engenho de Dentro", "Engenho Novo", "Estácio", "Flamengo", "Freguesia (Ilha)", "Freguesia (Jacarepaguá)", "Galeão", "Gamboa", "Gardênia Azul", "Gávea", "Glória", "Grajau", "Grumari", "Guadalupe", "Guaratiba", "Higienópolis", "Honório Gurgel", "Humaitá", "Inhaúma", "Inhoaíba", "Ipanema", "Irajá", "Itanhangá", "Jacaré", "Jacarepaguá", "Jardim América", "Jardim Botânico", "Jardim Carioca", "Jardim Guanabara", "Jardim Sulacap", "Joá", "Lagoa", "Laranjeiras", "Leblon", "Leme", "Lins de Vasconcelos", "Madureira", "Magalhães Bastos", "Mangueira", "Manguinhos", "Maracanã", "Maré", "Marechal Hermes", "Maria da Graça", "Meier", "Méier", "Moneró", "Olaria", "Oswaldo Cruz", "Padre Miguel", "Parada de Lucas", "Parque Anchieta", "Parque Columbia", "Pavuna", "Pechincha", "Pedra de Guaratiba", "Penha", "Penha Circular", "Piedade", "Pilares", "Pitangueiras", "Portuguesa", "Praia da Bandeira", "Praça da Bandeira", "Praça Seca", "Quintino Bocaiúva", "Ramos", "Realengo", "Recreio dos Bandeirantes", "Riachuelo", "Ribeira", "Ricardo de Albuquerque", "Rio Comprido", "Rocha", "Rocha Miranda", "Rocinha", "Santa Cruz", "Santa Teresa", "Santíssimo", "Santo Cristo", "São Conrado", "São Cristóvão", "São Francisco Xavier", "Saúde", "Senador Camará", "Senador Vasconcelos", "Sepetiba", "Taquara", "Tijuca", "Todos os Santos", "Tomás Coelho", "Turiaçu", "Urca", "Vargem Grande", "Vargem Pequena", "Vasco da Gama", "Várzea", "Vicente de Carvalho", "Vigário Geral", "Vila da Penha", "Vila Isabel", "Vila Kennedy", "Vila Kosmos", "Vila Militar", "Vila Valqueire", "Vista Alegre", "Zumbi"];
    }
    if (!itensPersonalizados.bairros['Belford Roxo']) {
        itensPersonalizados.bairros['Belford Roxo'] = ["Areia Branca", "Belford Roxo (Centro)", "Bom Pastor", "Heliópolis", "Lote XV", "Nova Aurora", "Parque Amorim", "Parque Esperança", "Parque Flora", "Parque São José", "Piam", "Santa Amélia", "Santa Tereza", "São Bernardo", "São Leopoldo", "Shangri-lá", "Vila Pauline", "Wona"];
    }
    if (!itensPersonalizados.bairros['Duque de Caxias']) {
        itensPersonalizados.bairros['Duque de Caxias'] = ["Amapá", "Bar dos Cavaleiros", "Campos Elíseos", "Centro", "Cidade Parque Paulista", "Copacabana", "Doutor Laureano", "Figueira", "Gramacho", "Imbariê", "Jardim 25 de Agosto", "Jardim Anhangá", "Jardim Primavera", "Lamarão", "Olavo Bilac", "Parque Duque", "Parque Eldorado", "Parque Equitativa", "Parque Fluminense", "Periquitos", "Pilar", "Saracuruna", "Sarapuí", "Santa Cruz da Serra", "Santa Lúcia", "Santo Antônio", "São Bento", "Taquara", "Tiradentes", "Xerém", "Vila São Luís"];
    }
    if (!itensPersonalizados.bairros['Guapimirim']) {
        itensPersonalizados.bairros['Guapimirim'] = ["Centro", "Cotia", "Garrafão", "Parada Modelo", "Parada Sapucaia", "Vale das Pedrinhas", "Vila Olímpia"];
    }
    if (!itensPersonalizados.bairros['Itaboraí']) {
        itensPersonalizados.bairros['Itaboraí'] = ["Aldeia da Prata", "Areal", "Cabuçu", "Centro", "Cidade Nova", "Esperança", "Granjas Cabuçu", "Itambi", "Jardim Imperial", "Manilha", "Marambaia", "Nancilândia", "Outeiro das Pedras", "Pacheco", "Pachecos", "Pista", "Porto das Caixas", "Reta Velha", "Rio Várzea", "Sambaetiba", "São Joaquim", "Sapê", "Venda das Pedras", "Vila Progresso"];
    }
    if (!itensPersonalizados.bairros['Japeri']) {
        itensPersonalizados.bairros['Japeri'] = ["Alecrim", "Belo Horizonte", "Boqueirão", "Centro", "Citrópolis", "Delamare", "Engenheiro Pedreira", "Guandu", "Jardim Marajoara", "Jardim Nova Belém", "Lagoa", "Mucajá", "Nova Belém", "Parque Alvorada", "Rio d'Ouro", "Santa Amélia", "Santa Inês", "Santo Antônio", "São Jorge", "Vila Canaã", "Vila Central"];
    }
    if (!itensPersonalizados.bairros['Magé']) {
        itensPersonalizados.bairros['Magé'] = ["Barbuda", "Bongaba", "Centro", "Fragoso", "Guia de Pacobaíba", "Imburo", "Inhomirim", "Iriri", "Maurimárcia", "Mauá", "Parada Modelo", "Pau Grande", "Piabetá", "Praia das Gaivotas", "Raiz da Serra", "Santo Aleixo", "Suruí", "Vila Inhomirim"];
    }
    if (!itensPersonalizados.bairros['Maricá']) {
        itensPersonalizados.bairros['Maricá'] = ["Araçatiba", "Barra de Maricá", "Boqueirão", "Centro", "Condado de Maricá", "Cordeirinho", "Flamengo", "Guaratiba", "Inoã", "Itaipuaçu", "Jardim Atlântico", "Ponta Negra", "Saquarema", "São José do Imbassaí", "Ubatiba", "Pindobas", "Retiro", "Santa Rita", "Silvado", "Bambuí", "Espraiado"];
    }
    if (!itensPersonalizados.bairros['Mesquita']) {
        itensPersonalizados.bairros['Mesquita'] = ["Banco de Areia", "BNH", "Centro", "Chatuba", "Cosmorama", "Edson Passos", "Juscelino", "Nova Cidade", "Rocha Sobrinho", "Santa Terezinha", "Santo Elias", "Vila Emil"];
    }
    if (!itensPersonalizados.bairros['Nilópolis']) {
        itensPersonalizados.bairros['Nilópolis'] = ["Cabuis", "Centro", "Chatuba", "Frigorífico", "Manoel Reis", "Mirandela", "Nova Cidade", "Olinda", "Paiol de Pólvora", "São Mateus"];
    }
    if (!itensPersonalizados.bairros['Niterói']) {
        itensPersonalizados.bairros['Niterói'] = ["Barreto", "Boa Viagem", "Cachoeiras", "Cafubá", "Camboinhas", "Cantagalo", "Centro", "Charitas", "Engenhoca", "Engenho do Mato", "Fátima", "Fonseca", "Gragoatá", "Icaraí", "Ingá", "Itacoatiara", "Itaipu", "Jacaré", "Jardim Icaraí", "Jurujuba", "Largo da Batalha", "Maceió", "Maria Paula", "Matapaca", "Muriqui", "Pendotiba", "Pé Pequeno", "Piratininga", "Ponta d'Areia", "Rio do Ouro", "Santa Bárbara", "Santa Rosa", "Santana", "Santo Antônio", "São Domingos", "São Francisco", "São Lourenço", "Sapê", "Serra Grande", "Tenente Jardim", "Várzea das Moças", "Vila Progresso", "Viradouro"];
    }
    if (!itensPersonalizados.bairros['Nova Iguaçu']) {
        itensPersonalizados.bairros['Nova Iguaçu'] = ["Austin", "Bairro da Luz", "Bela Vista", "Botafogo", "Cabuçu", "Califórnia", "Carlos Sampaio", "Centro", "Cerâmica", "Comendador Soares", "Danon", "Geneciano", "Grama", "Inconfidência", "Jardim Alvorada", "Jardim Iguaçu", "Jardim Nova Era", "Jardim Pernambuco", "K11", "Km 32", "Marapicu", "Mesquita", "Miguel Couto", "Moquetá", "Ouro Verde", "Parque Ambaí", "Parque Flora", "Parque Estoril", "Patis", "Posse", "Rancho Novo", "Santa Eugênia", "São Benedito", "Tinguá", "Três Corações", "Valverde", "Vila de Cava", "Vila Operária", "Vila Iguaçuana"];
    }
    if (!itensPersonalizados.bairros['Paracambi']) {
        itensPersonalizados.bairros['Paracambi'] = ["Barra do Pirai", "Cascata", "Centro", "Fábrica", "Lages", "Morro Grande", "Ribeirão das Lajes", "Salgueiro"];
    }
    if (!itensPersonalizados.bairros['Queimados']) {
        itensPersonalizados.bairros['Queimados'] = ["Centro", "Eldorado", "Fanchem", "Inconfidência", "Jardim Novo Horizonte", "Luiz de Camões", "Marajoara", "Paraíso", "Parque Avenida", "Parque Estrela Dalva", "Parque Felicidade", "Parque Floresta", "Parque São José", "São Roque", "Valdariosa", "Vila Camarim", "Vila Central", "Vila do Tinguá", "Vila Pacaembu", "Vila São João"];
    }
    if (!itensPersonalizados.bairros['São Gonçalo']) {
        itensPersonalizados.bairros['São Gonçalo'] = ["Alcântara", "Amendoeira", "Antonina", "Arsenal", "Barro Vermelho", "Boa Vista", "Boaçu", "Brasilândia", "Centro", "Colubandê", "Coelho", "Engenho Pequeno", "Estrela do Norte", "Fazenda dos Mineiros", "Galo Branco", "Gradim", "Guarani", "Ieda", "Ipiíba", "Itaoca", "Itaúna", "Jardim Alcântara", "Jardim Amendoeira", "Jardim Califórnia", "Jardim Catarina", "Jardim Miriambi", "Jardim Nova República", "Jardim Tiradentes", "Jóquei Clube", "Lagoinha", "Laranjal", "Luiz Caçador", "Marambaia", "Maria Paula", "Miriambi", "Monjolos", "Morro do Castro", "Mutuá", "Mutuaguaçu", "Mutuapira", "Neves", "Nova Cidade", "Novo México", "Pacheco", "Paiva", "Palmeiras", "Paraíso", "Patronato", "Porto da Madama", "Porto da Pedra", "Porto do Rosa", "Porto Novo", "Porto Velho", "Raul Veiga", "Recanto das Acácias", "Rio do Ouro", "Rocha", "Rosane", "Salgueiro", "Santa Catarina", "Santa Isabel", "Santa Luzia", "São Miguel", "Tribobó", "Trindade", "Várzea das Moças", "Vila Iara", "Vista Alegre", "Zé Garoto"];
    }
    if (!itensPersonalizados.bairros['São João de Meriti']) {
        itensPersonalizados.bairros['São João de Meriti'] = ["Agostinho Porto", "Baixada Campista", "Centro", "Coelho da Rocha", "Éden", "Engenheiro Belford", "Jardim Meriti", "Jardim Metrópole", "Parque Alian", "Parque Araruama", "Parque Barreto", "Parque São Nicolau", "São Mateus", "Tomazinho", "Venda Velha", "Vilar dos Teles", "Vila Rosali", "Vila Tiradentes"];
    }
    if (!itensPersonalizados.bairros['Seropédica']) {
        itensPersonalizados.bairros['Seropédica'] = ["Boa Esperança", "Campo Lindo", "Centro", "Dom Rodrigo", "Fazenda Caxias", "Piranema", "Santa Alice", "Santa Sofia", "Seropédica (Centro)"];
    }
    if (!itensPersonalizados.bairros['Tanguá']) {
        itensPersonalizados.bairros['Tanguá'] = ["Adrianópolis", "Cachoeiras de Macacu", "Centro", "Mutuá", "Outeiro", "Rio Bonito", "Sambaê", "Sobradinho"];
    }
    
    // COLETA AUTOMÁTICA DESABILITADA: Apenas itens adicionados pelo modal "Cadastrar Item" 
    // serão incluídos nas tabelas. Itens apagados não retornarão automaticamente.
    // collectSetoresFromSaidas();
    // collectResponsaveisFromSaidas();
    
    renderItensTables();
}

// Coletar todos os setores das saídas cadastradas
function collectSetoresFromSaidas() {
    const allSetores = new Set();
    
    // Adicionar setores já cadastrados
    if (itensPersonalizados.setores && Array.isArray(itensPersonalizados.setores)) {
        itensPersonalizados.setores.forEach(setor => {
            if (setor && setor.trim()) {
                allSetores.add(setor.trim());
            }
        });
    }
    
    // Coletar setores das saídas administrativas
    try {
        const saidasAdm = JSON.parse(localStorage.getItem('saidasAdministrativas') || '[]');
        saidasAdm.forEach(saida => {
            if (saida.setor && saida.setor.trim()) {
                allSetores.add(saida.setor.trim());
            }
        });
    } catch (e) {
        console.warn('Erro ao coletar setores de saídas administrativas:', e);
    }
    
    // Coletar setores das saídas de ambulâncias
    try {
        const saidasAmb = JSON.parse(localStorage.getItem('saidasAmbulancias') || '[]');
        saidasAmb.forEach(saida => {
            if (saida.setor && saida.setor.trim()) {
                allSetores.add(saida.setor.trim());
            }
        });
    } catch (e) {
        console.warn('Erro ao coletar setores de saídas de ambulâncias:', e);
    }
    
    // Coletar setores das saídas cadastradas
    try {
        const saidasCad = JSON.parse(localStorage.getItem('saidasCadastradas') || '[]');
        saidasCad.forEach(saida => {
            if (saida.setor && saida.setor.trim()) {
                allSetores.add(saida.setor.trim());
            }
        });
    } catch (e) {
        console.warn('Erro ao coletar setores de saídas cadastradas:', e);
    }
    
    // Atualizar lista de setores
    itensPersonalizados.setores = Array.from(allSetores).sort((a, b) => {
        return a.localeCompare(b, 'pt-BR');
    });
    
    // Salvar dados atualizados
    saveItensData();
    
    console.log('Setores coletados:', itensPersonalizados.setores.length);
}

// Coletar todos os responsáveis das saídas cadastradas
function collectResponsaveisFromSaidas() {
    const allResponsaveis = new Set();
    
    // Adicionar responsáveis já cadastrados
    if (itensPersonalizados.responsaveis && Array.isArray(itensPersonalizados.responsaveis)) {
        itensPersonalizados.responsaveis.forEach(resp => {
            if (resp && resp.trim()) {
                allResponsaveis.add(resp.trim());
            }
        });
    }
    
    // Coletar responsáveis das saídas administrativas
    try {
        const saidasAdm = JSON.parse(localStorage.getItem('saidasAdministrativas') || '[]');
        saidasAdm.forEach(saida => {
            if (saida.responsavel && saida.responsavel.trim()) {
                allResponsaveis.add(saida.responsavel.trim());
            }
            if (saida.responsavelPedido && saida.responsavelPedido.trim()) {
                allResponsaveis.add(saida.responsavelPedido.trim());
            }
        });
    } catch (e) {
        console.warn('Erro ao coletar responsáveis de saídas administrativas:', e);
    }
    
    // Coletar responsáveis das saídas de ambulâncias
    try {
        const saidasAmb = JSON.parse(localStorage.getItem('saidasAmbulancias') || '[]');
        saidasAmb.forEach(saida => {
            if (saida.responsavel && saida.responsavel.trim()) {
                allResponsaveis.add(saida.responsavel.trim());
            }
            if (saida.responsavelPedido && saida.responsavelPedido.trim()) {
                allResponsaveis.add(saida.responsavelPedido.trim());
            }
        });
    } catch (e) {
        console.warn('Erro ao coletar responsáveis de saídas de ambulâncias:', e);
    }
    
    // Coletar responsáveis das saídas cadastradas
    try {
        const saidasCad = JSON.parse(localStorage.getItem('saidasCadastradas') || '[]');
        saidasCad.forEach(saida => {
            if (saida.responsavel && saida.responsavel.trim()) {
                allResponsaveis.add(saida.responsavel.trim());
            }
            if (saida.responsavelPedido && saida.responsavelPedido.trim()) {
                allResponsaveis.add(saida.responsavelPedido.trim());
            }
        });
    } catch (e) {
        console.warn('Erro ao coletar responsáveis de saídas cadastradas:', e);
    }
    
    // Atualizar lista de responsáveis
    itensPersonalizados.responsaveis = Array.from(allResponsaveis).sort((a, b) => {
        return a.localeCompare(b, 'pt-BR');
    });
    
    // Salvar dados atualizados
    saveItensData();
    
    console.log('Responsáveis coletados:', itensPersonalizados.responsaveis.length);
}

// Salvar itens no localStorage
function saveItensData() {
    localStorage.setItem(ITENS_STORAGE_KEY, JSON.stringify(itensPersonalizados));
}

// Renderizar todas as tabelas de itens
function renderItensTables() {
    renderSetoresTable();
    renderResponsaveisTable();
    renderCidadesTable();
    renderBairrosTable();
    renderObjetivosTable();
    renderHospitaisTable();
    renderOMsTable();
}

// Renderizar tabela de setores
function renderSetoresTable() {
    const tbody = document.getElementById('setoresTableBody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    // Ordenar setores alfabeticamente
    const setoresOrdenados = [...itensPersonalizados.setores].sort((a, b) => {
        const aStr = (a || '').trim().toLowerCase();
        const bStr = (b || '').trim().toLowerCase();
        return aStr.localeCompare(bStr, 'pt-BR');
    });
    
    setoresOrdenados.forEach((setor, sortedIndex) => {
        // Encontrar o índice original no array não ordenado
        const originalIndex = itensPersonalizados.setores.indexOf(setor);
        const row = tbody.insertRow();
        row.innerHTML = `
            <td contenteditable="true" class="editable-cell" data-index="${originalIndex}" data-type="setor" style="padding: 8px; border: 1px solid #ddd; min-height: 20px;">${setor || ''}</td>
            <td style="text-align: center; padding: 8px;">
                <button class="delete-btn" onclick="removeSetor(${originalIndex})" title="Remover">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
    });
    attachEditableListeners('setor');
}

// Renderizar tabela de responsáveis
function renderResponsaveisTable() {
    const tbody = document.getElementById('responsaveisTableBody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    // Ordenar responsáveis alfabeticamente
    const responsaveisOrdenados = [...itensPersonalizados.responsaveis].sort((a, b) => {
        const aStr = (a || '').trim().toLowerCase();
        const bStr = (b || '').trim().toLowerCase();
        return aStr.localeCompare(bStr, 'pt-BR');
    });
    
    responsaveisOrdenados.forEach((responsavel, sortedIndex) => {
        // Encontrar o índice original no array não ordenado
        const originalIndex = itensPersonalizados.responsaveis.indexOf(responsavel);
        const row = tbody.insertRow();
        row.innerHTML = `
            <td contenteditable="true" class="editable-cell" data-index="${originalIndex}" data-type="responsavel" style="padding: 8px; border: 1px solid #ddd; min-height: 20px;">${responsavel || ''}</td>
            <td style="text-align: center; padding: 8px;">
                <button class="delete-btn" onclick="removeResponsavel(${originalIndex})" title="Remover">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
    });
    attachEditableListeners('responsavel');
}

// Renderizar tabela de cidades
function renderCidadesTable() {
    const tbody = document.getElementById('cidadesTableBody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    // Ordenar cidades alfabeticamente
    const cidadesOrdenadas = [...itensPersonalizados.cidades].sort((a, b) => {
        const aStr = (a || '').trim().toLowerCase();
        const bStr = (b || '').trim().toLowerCase();
        return aStr.localeCompare(bStr, 'pt-BR');
    });
    
    cidadesOrdenadas.forEach((cidade, sortedIndex) => {
        // Encontrar o índice original no array não ordenado
        const originalIndex = itensPersonalizados.cidades.indexOf(cidade);
        const row = tbody.insertRow();
        row.innerHTML = `
            <td contenteditable="true" class="editable-cell" data-index="${originalIndex}" data-type="cidade" style="padding: 8px; border: 1px solid #ddd; min-height: 20px;">${cidade || ''}</td>
            <td style="text-align: center; padding: 8px;">
                <button class="delete-btn" onclick="removeCidade(${originalIndex})" title="Remover">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
    });
    attachEditableListeners('cidade');
}

// Renderizar tabela de bairros com abas por cidade
function renderBairrosTable() {
    const tabsContainer = document.getElementById('bairrosCidadesTabs');
    const contentContainer = document.getElementById('bairrosCidadesContent');
    if (!tabsContainer || !contentContainer) return;
    
    // Limpar conteúdo anterior
    tabsContainer.innerHTML = '';
    contentContainer.innerHTML = '';
    
    // Usar TODAS as cidades cadastradas, não apenas as que têm bairros
    const todasCidades = [...new Set(itensPersonalizados.cidades)].filter(c => c && c.trim() !== '').sort();
    
    if (todasCidades.length === 0) {
        contentContainer.innerHTML = '<p style="padding: 20px; color: #666; text-align: center;">Nenhuma cidade cadastrada. Adicione cidades primeiro na aba Cidades.</p>';
        return;
    }
    
    // Criar abas e conteúdos para cada cidade
    todasCidades.forEach((cidade, cidadeIndex) => {
        const cidadeEscaped = cidade.replace(/'/g, "\\'").replace(/"/g, '&quot;');
        const cidadeId = 'bairros_' + cidade.replace(/[^a-zA-Z0-9]/g, '_');
        
        // Verificar se a cidade tem bairros cadastrados
        const bairrosDaCidade = itensPersonalizados.bairros[cidade] || [];
        
        // Criar botão da aba (sem contador)
        const tabButton = document.createElement('button');
        tabButton.className = 'bairros-cidade-tab-button' + (cidadeIndex === 0 ? ' active' : '');
        tabButton.dataset.cidadeTab = cidadeId;
        tabButton.textContent = cidade;
        tabsContainer.appendChild(tabButton);
        
        // Criar conteúdo da aba
        const tabContent = document.createElement('div');
        tabContent.id = cidadeId;
        tabContent.className = 'bairros-cidade-content' + (cidadeIndex === 0 ? ' active' : '');
        
        // Criar tabela para os bairros desta cidade
        const table = document.createElement('table');
        table.style.width = '100%';
        table.style.borderCollapse = 'collapse';
        table.innerHTML = `
            <thead>
                <tr style="background-color: var(--primary-blue); color: white;">
                    <th style="padding: 10px; text-align: left;">Bairro</th>
                    <th style="padding: 10px; text-align: center; width: 120px;">Ações</th>
                </tr>
            </thead>
            <tbody id="bairrosTableBody_${cidadeId}">
            </tbody>
        `;
        
        // Adicionar linhas da tabela com TODOS os bairros
        const tbody = table.querySelector('tbody');
        if (bairrosDaCidade.length === 0) {
            // Se não houver bairros, mostrar mensagem
            const row = tbody.insertRow();
            row.innerHTML = `
                <td colspan="2" style="padding: 20px; text-align: center; color: #666;">
                    Nenhum bairro cadastrado para esta cidade.
                </td>
            `;
        } else {
            // Ordenar bairros alfabeticamente
            const bairrosOrdenados = [...bairrosDaCidade].sort((a, b) => {
                const aStr = (a || '').trim().toLowerCase();
                const bStr = (b || '').trim().toLowerCase();
                return aStr.localeCompare(bStr, 'pt-BR');
            });
            
            // Mostrar TODOS os bairros da cidade ordenados
            bairrosOrdenados.forEach((bairro) => {
                // Encontrar o índice original no array não ordenado
                const bairroIndex = bairrosDaCidade.indexOf(bairro);
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td contenteditable="true" class="editable-cell" data-cidade="${cidadeEscaped}" data-bairro-index="${bairroIndex}" data-type="bairro-nome" style="padding: 8px; border: 1px solid #ddd; min-height: 20px;">${bairro || ''}</td>
                    <td style="text-align: center; padding: 8px;">
                        <button class="delete-btn" onclick="removeBairro('${cidadeEscaped}', ${bairroIndex})" title="Remover">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
            });
        }
        
        tabContent.appendChild(table);
        
        // Adicionar botão de adicionar bairro dentro de cada aba
        const addButtonContainer = document.createElement('div');
        addButtonContainer.style.marginTop = '15px';
        addButtonContainer.innerHTML = `
            <button class="success" onclick="addBairroToCity('${cidadeEscaped}')" style="padding: 8px 16px;">
                <i class="fas fa-plus"></i> Adicionar Bairro
            </button>
        `;
        tabContent.appendChild(addButtonContainer);
        
        contentContainer.appendChild(tabContent);
    });
    
    // Inicializar listeners das abas de cidades
    initBairrosCidadesTabs();
    
    // Anexar listeners para células editáveis
    attachEditableListeners('bairro');
}

// Inicializar abas de cidades para bairros
function initBairrosCidadesTabs() {
    const tabButtons = document.querySelectorAll('.bairros-cidade-tab-button');
    const tabContents = document.querySelectorAll('.bairros-cidade-content');
    
    tabButtons.forEach(button => {
        // Remover listeners anteriores
        const newButton = button.cloneNode(true);
        button.parentNode.replaceChild(newButton, button);
    });
    
    const freshButtons = document.querySelectorAll('.bairros-cidade-tab-button');
    const freshContents = document.querySelectorAll('.bairros-cidade-content');
    
    freshButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            const targetTab = this.dataset.cidadeTab;
            if (!targetTab) return;
            
            // Remover active de todos
            freshButtons.forEach(btn => btn.classList.remove('active'));
            freshContents.forEach(content => content.classList.remove('active'));
            
            // Adicionar active ao selecionado
            this.classList.add('active');
            const targetContent = document.getElementById(targetTab);
            if (targetContent) {
                targetContent.classList.add('active');
            }
        });
    });
}


// Renderizar tabela de objetivos
function renderObjetivosTable() {
    const tbody = document.getElementById('objetivosTableBody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    // Ordenar objetivos alfabeticamente
    const objetivosOrdenados = [...itensPersonalizados.objetivos].sort((a, b) => {
        const aStr = (a || '').trim().toLowerCase();
        const bStr = (b || '').trim().toLowerCase();
        return aStr.localeCompare(bStr, 'pt-BR');
    });
    
    objetivosOrdenados.forEach((objetivo, sortedIndex) => {
        // Encontrar o índice original no array não ordenado
        const originalIndex = itensPersonalizados.objetivos.indexOf(objetivo);
        const row = tbody.insertRow();
        row.innerHTML = `
            <td contenteditable="true" class="editable-cell" data-index="${originalIndex}" data-type="objetivo" style="padding: 8px; border: 1px solid #ddd; min-height: 20px;">${objetivo || ''}</td>
            <td style="text-align: center; padding: 8px;">
                <button class="delete-btn" onclick="removeObjetivo(${originalIndex})" title="Remover">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
    });
    attachEditableListeners('objetivo');
}

// Renderizar tabela de hospitais
function renderHospitaisTable() {
    const tbody = document.getElementById('hospitaisTableBody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    // Ordenar hospitais alfabeticamente
    const hospitaisOrdenados = [...itensPersonalizados.hospitais].sort((a, b) => {
        const aStr = (a || '').trim().toLowerCase();
        const bStr = (b || '').trim().toLowerCase();
        return aStr.localeCompare(bStr, 'pt-BR');
    });
    
    hospitaisOrdenados.forEach((hospital, sortedIndex) => {
        // Encontrar o índice original no array não ordenado
        const originalIndex = itensPersonalizados.hospitais.indexOf(hospital);
        const row = tbody.insertRow();
        row.innerHTML = `
            <td contenteditable="true" class="editable-cell" data-index="${originalIndex}" data-type="hospital" style="padding: 8px; border: 1px solid #ddd; min-height: 20px;">${hospital || ''}</td>
            <td style="text-align: center; padding: 8px;">
                <button class="delete-btn" onclick="removeHospital(${originalIndex})" title="Remover">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
    });
    attachEditableListeners('hospital');
}

// Renderizar tabela de OMs
function renderOMsTable() {
    const tbody = document.getElementById('omsTableBody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    // Ordenar OMs alfabeticamente
    const omsOrdenadas = [...itensPersonalizados.oms].sort((a, b) => {
        const aStr = (a || '').trim().toLowerCase();
        const bStr = (b || '').trim().toLowerCase();
        return aStr.localeCompare(bStr, 'pt-BR');
    });
    
    omsOrdenadas.forEach((om, sortedIndex) => {
        // Encontrar o índice original no array não ordenado
        const originalIndex = itensPersonalizados.oms.indexOf(om);
        const row = tbody.insertRow();
        row.innerHTML = `
            <td contenteditable="true" class="editable-cell" data-index="${originalIndex}" data-type="om" style="padding: 8px; border: 1px solid #ddd; min-height: 20px;">${om || ''}</td>
            <td style="text-align: center; padding: 8px;">
                <button class="delete-btn" onclick="removeOM(${originalIndex})" title="Remover">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
    });
    attachEditableListeners('om');
}

// Anexar listeners para células editáveis
function attachEditableListeners(type) {
    const cells = document.querySelectorAll(`.editable-cell[data-type="${type}"], .editable-cell[data-type^="${type}-"]`);
    cells.forEach(cell => {
        // Remover listeners anteriores para evitar duplicatas
        const newCell = cell.cloneNode(true);
        cell.parentNode.replaceChild(newCell, cell);
        
        newCell.addEventListener('blur', function() {
            const index = this.dataset.index !== undefined ? parseInt(this.dataset.index) : undefined;
            const cidade = this.dataset.cidade;
            const bairroIndex = this.dataset.bairroIndex !== undefined ? parseInt(this.dataset.bairroIndex) : null;
            const value = this.textContent.trim();
            
            if (type === 'setor' && index !== undefined && !isNaN(index)) {
                itensPersonalizados.setores[index] = value;
            } else if (type === 'responsavel' && index !== undefined && !isNaN(index)) {
                itensPersonalizados.responsaveis[index] = value;
            } else if (type === 'cidade' && index !== undefined && !isNaN(index)) {
                const oldCidade = itensPersonalizados.cidades[index];
                itensPersonalizados.cidades[index] = value;
                // Atualizar bairros se a cidade mudou
                if (oldCidade && oldCidade !== value && itensPersonalizados.bairros[oldCidade]) {
                    itensPersonalizados.bairros[value] = itensPersonalizados.bairros[oldCidade];
                    delete itensPersonalizados.bairros[oldCidade];
                }
            } else if (type === 'objetivo' && index !== undefined && !isNaN(index)) {
                itensPersonalizados.objetivos[index] = value;
            } else if (type === 'hospital' && index !== undefined && !isNaN(index)) {
                itensPersonalizados.hospitais[index] = value;
            } else if (type === 'om' && index !== undefined && !isNaN(index)) {
                itensPersonalizados.oms[index] = value;
            } else if (type === 'bairro') {
                if (this.dataset.type === 'bairro-cidade' && cidade && bairroIndex !== null && !isNaN(bairroIndex)) {
                    const oldCidade = cidade;
                    const newCidade = value;
                    if (oldCidade !== newCidade && itensPersonalizados.bairros[oldCidade] && itensPersonalizados.bairros[oldCidade][bairroIndex] !== undefined) {
                        const bairro = itensPersonalizados.bairros[oldCidade][bairroIndex];
                        if (bairro !== undefined) {
                            if (!itensPersonalizados.bairros[newCidade]) {
                                itensPersonalizados.bairros[newCidade] = [];
                            }
                            itensPersonalizados.bairros[newCidade].push(bairro);
                            itensPersonalizados.bairros[oldCidade].splice(bairroIndex, 1);
                            if (itensPersonalizados.bairros[oldCidade].length === 0) {
                                delete itensPersonalizados.bairros[oldCidade];
                            }
                            // Atualizar cidade na lista se não existir
                            if (newCidade && !itensPersonalizados.cidades.includes(newCidade)) {
                                itensPersonalizados.cidades.push(newCidade);
                                renderCidadesTable();
                            }
                            renderBairrosTable();
                        }
                    }
                } else if (this.dataset.type === 'bairro-nome' && cidade && bairroIndex !== null && !isNaN(bairroIndex)) {
                    if (itensPersonalizados.bairros[cidade] && itensPersonalizados.bairros[cidade][bairroIndex] !== undefined) {
                        itensPersonalizados.bairros[cidade][bairroIndex] = value;
                    }
                }
            }
            
            saveItensData();
            if (type === 'cidade') {
                renderBairrosTable();
            }
            if (type === 'om') {
                populateOMList(); // Atualizar campo OM especificamente
            } else if (type === 'hospital') {
                populateHospitalList(); // Atualizar campo Hospital de Destino especificamente
            } else {
                updateFormFields(); // Atualizar todos os campos
            }
        });
        
        newCell.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                this.blur();
            }
        });
    });
}

// Funções para adicionar novas linhas
function addSetorRow() {
    itensPersonalizados.setores.push('');
    saveItensData();
    renderSetoresTable();
}

function addResponsavelRow() {
    itensPersonalizados.responsaveis.push('');
    saveItensData();
    renderResponsaveisTable();
}

function addCidadeRow() {
    itensPersonalizados.cidades.push('');
    saveItensData();
    renderCidadesTable();
}

// Função para adicionar bairro a uma cidade específica
function addBairroToCity(cidade) {
    if (!cidade) return;
    
    // Garantir que a cidade existe no objeto de bairros
    if (!itensPersonalizados.bairros[cidade]) {
        itensPersonalizados.bairros[cidade] = [];
    }
    
    // Adicionar novo bairro vazio
    itensPersonalizados.bairros[cidade].push('');
    saveItensData();
    renderBairrosTable();
    
    // Ativar a aba da cidade adicionada
    setTimeout(() => {
        const cidadeId = 'bairros_' + cidade.replace(/[^a-zA-Z0-9]/g, '_');
        const tabButton = document.querySelector(`[data-cidade-tab="${cidadeId}"]`);
        if (tabButton) {
            tabButton.click();
        }
    }, 100);
}

function addObjetivoRow() {
    itensPersonalizados.objetivos.push('');
    saveItensData();
    renderObjetivosTable();
}

function addHospitalRow() {
    itensPersonalizados.hospitais.push('');
    saveItensData();
    renderHospitaisTable();
    populateHospitalList(); // Atualizar campo Hospital de Destino no formulário
}

function addOMRow() {
    itensPersonalizados.oms.push('');
    saveItensData();
    renderOMsTable();
    populateOMList(); // Atualizar campo OM no formulário
}


// Funções para remover itens
function removeSetor(index) {
    if (confirm('Deseja realmente remover este setor?')) {
        itensPersonalizados.setores.splice(index, 1);
        saveItensData();
        renderSetoresTable();
        updateFormFields();
    }
}

function removeResponsavel(index) {
    if (confirm('Deseja realmente remover este responsável?')) {
        itensPersonalizados.responsaveis.splice(index, 1);
        saveItensData();
        renderResponsaveisTable();
        updateFormFields();
    }
}

function removeCidade(index) {
    const cidade = itensPersonalizados.cidades[index];
    if (confirm(`Deseja realmente remover a cidade "${cidade}"? Isso também removerá todos os bairros associados.`)) {
        delete itensPersonalizados.bairros[cidade];
        itensPersonalizados.cidades.splice(index, 1);
        saveItensData();
        renderCidadesTable();
        renderBairrosTable();
        updateFormFields();
    }
}

function removeBairro(cidade, index) {
    if (confirm('Deseja realmente remover este bairro?')) {
        itensPersonalizados.bairros[cidade].splice(index, 1);
        if (itensPersonalizados.bairros[cidade].length === 0) {
            delete itensPersonalizados.bairros[cidade];
        }
        saveItensData();
        renderBairrosTable();
        updateFormFields();
    }
}

function removeObjetivo(index) {
    if (confirm('Deseja realmente remover este objetivo?')) {
        itensPersonalizados.objetivos.splice(index, 1);
        saveItensData();
        renderObjetivosTable();
        updateFormFields();
    }
}

function removeHospital(index) {
    if (confirm('Deseja realmente remover este hospital?')) {
        itensPersonalizados.hospitais.splice(index, 1);
        saveItensData();
        renderHospitaisTable();
        populateHospitalList(); // Atualizar campo Hospital de Destino no formulário
    }
}

function removeOM(index) {
    if (confirm('Deseja realmente remover esta OM?')) {
        itensPersonalizados.oms.splice(index, 1);
        saveItensData();
        renderOMsTable();
        populateOMList(); // Atualizar campo OM no formulário
    }
}

// Função específica para popular o campo OM (datalist)
function populateOMList() {
    const omList = document.getElementById('omList');
    if (!omList) return;
    
    // Garantir que itensPersonalizados está carregado
    if (!itensPersonalizados || !itensPersonalizados.oms) {
        loadItensData();
    }
    
    omList.innerHTML = '';
    const oms = (itensPersonalizados && itensPersonalizados.oms ? itensPersonalizados.oms : []).filter(om => om && om.trim() !== '').sort();
    oms.forEach(om => {
        const option = document.createElement('option');
        option.value = om;
        omList.appendChild(option);
    });

    // Configurar validação em tempo real para o campo OM
    const omInput = document.getElementById('registerOM');
    if (omInput) {
        // Remover listeners anteriores para evitar duplicatas
        const newOMInput = omInput.cloneNode(true);
        omInput.parentNode.replaceChild(newOMInput, omInput);
        
        newOMInput.addEventListener('blur', function() {
            const value = this.value.trim();
            if (value) {
                const options = Array.from(omList.querySelectorAll('option')).map(opt => opt.value.trim());
                if (!options.includes(value)) {
                    this.classList.add('flash-red');
                    this.title = 'Esta OM não está cadastrada. Use o botão "+" para cadastrar.';
                } else {
                    this.classList.remove('flash-red');
                    this.title = '';
                }
            } else {
                this.classList.remove('flash-red');
                this.title = '';
            }
        });
    }
}

// Função específica para popular o campo Hospital de Destino (datalist)
function populateHospitalList() {
    const hospitalList = document.getElementById('hospitalList');
    if (!hospitalList) return;
    
    // Garantir que itensPersonalizados está carregado
    if (!itensPersonalizados || !itensPersonalizados.hospitais) {
        loadItensData();
    }
    
    hospitalList.innerHTML = '';
    const hospitais = (itensPersonalizados && itensPersonalizados.hospitais ? itensPersonalizados.hospitais : []).filter(hospital => hospital && hospital.trim() !== '').sort();
    hospitais.forEach(hospital => {
        const option = document.createElement('option');
        option.value = hospital;
        hospitalList.appendChild(option);
    });
}

// Atualizar campos do formulário com itens personalizados (APENAS itens cadastrados)
function updateFormFields() {
    // Verificar se as funções estão disponíveis antes de chamá-las
    if (typeof populateSetorList === 'function') {
        populateSetorList();
    } else {
        // Fallback: popular diretamente se a função não estiver disponível
        const setorList = document.getElementById('setorList');
        if (setorList) {
            setorList.innerHTML = '';
            const setores = (itensPersonalizados && itensPersonalizados.setores ? itensPersonalizados.setores : []).filter(s => s && s.trim() !== '').sort();
            setores.forEach(setor => {
                const option = document.createElement('option');
                option.value = setor;
                setorList.appendChild(option);
            });
        }
    }
    
    if (typeof populateResponsavelList === 'function') {
        populateResponsavelList();
    } else {
        // Fallback: popular diretamente se a função não estiver disponível
        const responsavelList = document.getElementById('responsavelList');
        if (responsavelList) {
            responsavelList.innerHTML = '';
            const responsaveis = (itensPersonalizados && itensPersonalizados.responsaveis ? itensPersonalizados.responsaveis : []).filter(r => r && r.trim() !== '').sort();
            responsaveis.forEach(responsavel => {
                const option = document.createElement('option');
                option.value = responsavel;
                responsavelList.appendChild(option);
            });
        }
    }
    
    // Atualizar cidades no select - APENAS itens cadastrados
    const cidadeSelect = document.getElementById('registerCidade');
    if (cidadeSelect) {
        const currentValue = cidadeSelect.value;
        cidadeSelect.innerHTML = '<option value="">Selecione a cidade</option>';
        // Usar APENAS cidades cadastradas na aba "Cadastrar Itens"
        const cidades = (itensPersonalizados && itensPersonalizados.cidades ? itensPersonalizados.cidades : []).filter(c => c && c.trim() !== '').sort();
        cidades.forEach(cidade => {
            const option = document.createElement('option');
            option.value = cidade;
            option.textContent = cidade;
            cidadeSelect.appendChild(option);
        });
        if (currentValue && cidades.includes(currentValue)) {
            cidadeSelect.value = currentValue;
        }
    }
    
    // Atualizar objetivos para ambulância - APENAS opções fixas
    const objetivoSelect = document.getElementById('registerObjetivoSelect');
    if (objetivoSelect) {
        const currentValue = objetivoSelect.value;
        // Opções fixas para Ambulância
        const objetivosFixos = ['Inter Hospitalar', 'APH', 'Exame', 'Aeroporto', 'Alta'];
        objetivoSelect.innerHTML = '<option value="">Selecione o objetivo</option>';
        objetivosFixos.forEach(objetivo => {
            const option = document.createElement('option');
            option.value = objetivo;
            option.textContent = objetivo;
            objetivoSelect.appendChild(option);
        });
        if (currentValue && objetivosFixos.includes(currentValue)) {
            objetivoSelect.value = currentValue;
        }
    }
    
    // Atualizar hospitais - usar função populateHospitalList para manter consistência
    populateHospitalList();
    
    // Atualizar OM - usar função populateOMList para manter consistência
    populateOMList();
}

// Variáveis globais para o modal de adicionar item
let pendingItemType = null;
let pendingItemValue = '';

// Abrir modal para adicionar item
function openAddItemModal(type) {
    pendingItemType = type;
    
    // Obter o valor do campo correspondente
    let fieldValue = '';
    let fieldLabel = '';
    
    if (type === 'setor') {
        const field = document.getElementById('registerSetor');
        fieldValue = field ? field.value.trim() : '';
        fieldLabel = 'Setor';
    } else if (type === 'responsavel') {
        const field = document.getElementById('registerResponsavelPedido');
        fieldValue = field ? field.value.trim() : '';
        fieldLabel = 'Responsável pelo Pedido';
    } else if (type === 'om') {
        const field = document.getElementById('registerOM');
        fieldValue = field ? field.value.trim() : '';
        fieldLabel = 'OM';
    } else if (type === 'hospital') {
        const field = document.getElementById('registerHospital');
        fieldValue = field ? field.value.trim() : '';
        fieldLabel = 'Hospital de Destino';
    }
    
    // Verificar se há valor no campo
    if (!fieldValue) {
        alert(`Por favor, preencha o campo ${fieldLabel} antes de cadastrar.`);
        return;
    }
    
    // Garantir que itensPersonalizados está carregado
    if (!itensPersonalizados) {
        loadItensData();
    }
    
    // Verificar se o item já existe
    if (type === 'setor') {
        if (itensPersonalizados && itensPersonalizados.setores && itensPersonalizados.setores.includes(fieldValue)) {
            alert('Este setor já está cadastrado.');
            return;
        }
    } else if (type === 'responsavel') {
        if (itensPersonalizados && itensPersonalizados.responsaveis && itensPersonalizados.responsaveis.includes(fieldValue)) {
            alert('Este responsável já está cadastrado.');
            return;
        }
    } else if (type === 'om') {
        if (itensPersonalizados && itensPersonalizados.oms && itensPersonalizados.oms.includes(fieldValue)) {
            alert('Esta OM já está cadastrada.');
            return;
        }
    } else if (type === 'hospital') {
        if (itensPersonalizados && itensPersonalizados.hospitais && itensPersonalizados.hospitais.includes(fieldValue)) {
            alert('Este hospital já está cadastrado.');
            return;
        }
    }
    
    pendingItemValue = fieldValue;
    const modal = document.getElementById('addItemModal');
    const message = document.getElementById('addItemModalMessage');
    const modalContent = modal.querySelector('.obs-modal-content');
    message.textContent = `Gostaria de cadastrar "${fieldValue}" na tabela de ${fieldLabel}?`;
    
    // Resetar animação
    if (modalContent) {
        modalContent.style.animation = 'none';
        void modalContent.offsetWidth; // Força reflow
        modalContent.style.animation = '';
    }
    
    modal.style.display = 'flex';
}

// Fechar modal de adicionar item
function closeAddItemModal() {
    const modal = document.getElementById('addItemModal');
    modal.style.display = 'none';
    pendingItemType = null;
    pendingItemValue = '';
}

// Confirmar e adicionar item
function confirmAddItem() {
    if (!pendingItemType || !pendingItemValue) {
        closeAddItemModal();
        return;
    }
    
    // Garantir que itensPersonalizados está carregado
    if (!itensPersonalizados) {
        loadItensData();
    }
    
    // Adicionar o item à lista correspondente
    if (pendingItemType === 'setor') {
        if (!itensPersonalizados.setores) {
            itensPersonalizados.setores = [];
        }
        if (!itensPersonalizados.setores.includes(pendingItemValue)) {
            itensPersonalizados.setores.push(pendingItemValue);
            saveItensData();
            renderSetoresTable();
            if (typeof populateSetorList === 'function') {
                populateSetorList();
            }
            updateFormFields();
            alert('Setor cadastrado com sucesso!');
        }
    } else if (pendingItemType === 'responsavel') {
        if (!itensPersonalizados.responsaveis) {
            itensPersonalizados.responsaveis = [];
        }
        if (!itensPersonalizados.responsaveis.includes(pendingItemValue)) {
            itensPersonalizados.responsaveis.push(pendingItemValue);
            saveItensData();
            renderResponsaveisTable();
            if (typeof populateResponsavelList === 'function') {
                populateResponsavelList();
            }
            updateFormFields();
            alert('Responsável cadastrado com sucesso!');
        }
    } else if (pendingItemType === 'om') {
        if (!itensPersonalizados.oms) {
            itensPersonalizados.oms = [];
        }
        if (!itensPersonalizados.oms.includes(pendingItemValue)) {
            itensPersonalizados.oms.push(pendingItemValue);
            saveItensData();
            renderOMsTable();
            if (typeof populateOMList === 'function') {
                populateOMList();
            }
            updateFormFields();
            alert('OM cadastrada com sucesso!');
        }
    } else if (pendingItemType === 'hospital') {
        if (!itensPersonalizados.hospitais) {
            itensPersonalizados.hospitais = [];
        }
        if (!itensPersonalizados.hospitais.includes(pendingItemValue)) {
            itensPersonalizados.hospitais.push(pendingItemValue);
            saveItensData();
            renderHospitaisTable();
            populateHospitalList(); // Atualizar campo Hospital de Destino no formulário
            alert('Hospital cadastrado com sucesso!');
        }
    }
    
    closeAddItemModal();
}

// Fechar modal ao clicar fora dele
document.addEventListener('DOMContentLoaded', function() {
    const addItemModal = document.getElementById('addItemModal');
    if (addItemModal) {
        addItemModal.addEventListener('click', function(e) {
            if (e.target === addItemModal) {
                closeAddItemModal();
            }
        });
    }
});

</script>
<script>
const userActivityEvents = ['mousemove', 'mousedown', 'keypress', 'scroll', 'touchstart'];
function notifyParentOfActivity() {
    window.parent.postMessage({ type: 'user_activity' }, '*');
}
userActivityEvents.forEach(eventName => {
    document.addEventListener(eventName, notifyParentOfActivity, { passive: true });
});

// Variáveis globais para armazenar contexto do modal
let kmAlertInput = null;
let kmAlertCanClear = false;

// Modal de alerta de quilometragem
function showKmAlertModal(message, input, canClear = false) {
    const modal = document.getElementById('kmAlertModal');
    const messageElement = document.getElementById('kmAlertMessage');
    if (modal && messageElement) {
        messageElement.textContent = message;
        modal.classList.add('show');
        // Armazenar contexto para poder apagar o valor se necessário
        kmAlertInput = input;
        kmAlertCanClear = canClear;
    }
}

function closeKmAlertModal() {
    const modal = document.getElementById('kmAlertModal');
    if (modal) {
        modal.classList.remove('show');
    }
    // Limpar variáveis ao fechar
    kmAlertInput = null;
    kmAlertCanClear = false;
}

// Função para apagar KM CHEGADA
function clearKmChegada() {
    if (!kmAlertCanClear) {
        return;
    }
    
    if (!kmAlertInput) {
        return;
    }
    
    try {
        // Limpar o valor no input
        if (kmAlertInput) {
            kmAlertInput.value = '';
        }
    } catch (error) {
        console.error('Erro ao apagar KM CHEGADA:', error);
    }
}

// Event listeners para o modal - usando delegação de eventos
document.addEventListener('click', function(e) {
    // Verificar se o clique foi em algum elemento do modal
    const modal = document.getElementById('kmAlertModal');
    if (!modal || !modal.classList.contains('show')) {
        return; // Modal não está aberto
    }
    
    // Botão "Sim"
    if (e.target && (e.target.id === 'kmAlertConfirmBtn' || e.target.closest('#kmAlertConfirmBtn'))) {
        e.preventDefault();
        e.stopPropagation();
        closeKmAlertModal();
        return false;
    }
    
    // Botão "Não"
    if (e.target && (e.target.id === 'kmAlertCancelBtn' || e.target.closest('#kmAlertCancelBtn'))) {
        e.preventDefault();
        e.stopPropagation();
        clearKmChegada();
        closeKmAlertModal();
        return false;
    }
    
    // Botão fechar (X)
    if (e.target && (e.target.id === 'kmAlertCloseBtn' || e.target.closest('#kmAlertCloseBtn'))) {
        e.preventDefault();
        e.stopPropagation();
        closeKmAlertModal();
        return false;
    }
    
    // Clicar fora do modal (no overlay)
    if (e.target && e.target.id === 'kmAlertModal') {
        e.preventDefault();
        e.stopPropagation();
        closeKmAlertModal();
        return false;
    }
}, true); // Usar capture phase para garantir que seja executado primeiro

// ==================== CARREGAR DOCUMENTO ====================
let extractedData = null;

// Função auxiliar para exibir mensagens (compatível com displayMessage existente)
function showProcessMessage(message, type = 'info') {
    try {
        if (typeof displayMessage === 'function') {
            displayMessage(message, type);
        } else {
            const registerMessage = document.getElementById('registerMessage');
            if (registerMessage) {
                registerMessage.textContent = message;
                registerMessage.className = `message ${type}`;
                setTimeout(() => {
                    registerMessage.textContent = '';
                    registerMessage.className = 'message';
                }, 5000);
            } else {
                console.log(message);
            }
        }
    } catch (e) {
        console.log(message);
    }
}

// Função para processar documento automaticamente
async function processDocumentFile(file) {
    if (!file) {
        console.error('Nenhum arquivo fornecido');
        return;
    }
    
    console.log('Iniciando processamento do arquivo:', file.name, file.type);
    
    // Mostrar mensagem de processamento
    showProcessMessage('Processando documento...', 'info');
    
    try {
        let text = '';
        
        // Se for arquivo de texto, ler diretamente
        if (file.type === 'text/plain' || file.name.endsWith('.txt')) {
            text = await file.text();
        } else if (file.type.startsWith('image/')) {
            // Para imagens, usar OCR
            const imageUrl = URL.createObjectURL(file);
            
            // Usar Tesseract.js para OCR
            const { data: { text: ocrText } } = await Tesseract.recognize(
                imageUrl,
                'por', // Português
                {
                    logger: m => {
                        if (m.status === 'recognizing text') {
                            // Atualizar progresso se necessário
                        }
                    }
                }
            );
            
            text = ocrText;
            URL.revokeObjectURL(imageUrl);
        } else {
            showProcessMessage('Formato de arquivo não suportado. Use JPG, PNG ou TXT.', 'error');
            return;
        }
        
        // Extrair dados do texto
        extractedData = extractFormDataFromText(text);
        
        console.log('Dados extraídos:', extractedData);
        console.log('Número de campos extraídos:', extractedData ? Object.keys(extractedData).length : 0);
        
        // Mostrar modal com dados extraídos (sempre mostrar, mesmo se vazio)
        console.log('Chamando showExtractedDataModal...');
        if (extractedData && Object.keys(extractedData).length > 0) {
            showExtractedDataModal(extractedData);
        } else {
            console.log('Nenhum dado extraído do documento - mostrando modal vazio');
            showExtractedDataModal({});
            showProcessMessage('Nenhum dado foi extraído do documento. Verifique se o documento está legível e contém os campos do formulário de saída de ambulância.', 'error');
        }
        
    } catch (error) {
        console.error('Erro ao processar documento:', error);
        displayMessage('Erro ao processar documento: ' + error.message, 'error');
    }
}

// Event listener para o botão de carregar documento usando event delegation
document.addEventListener('click', function(e) {
    // Verificar se o clique foi no botão de carregar documento ou em seu ícone
    if (e.target && (e.target.id === 'loadDocumentBtn' || e.target.closest('#loadDocumentBtn'))) {
        e.preventDefault();
        e.stopPropagation();
        const fileInput = document.getElementById('documentFileInput');
        if (fileInput) {
            fileInput.click();
        }
    }
});

// Função para inicializar o event listener do fileInput
function initFileInputListener() {
    const fileInput = document.getElementById('documentFileInput');
    if (fileInput) {
        // Remover event listeners anteriores se existirem
        const newInput = fileInput.cloneNode(true);
        fileInput.parentNode.replaceChild(newInput, fileInput);
        
        // Adicionar event listener ao novo input
        newInput.addEventListener('change', async function(e) {
            if (e.target.files && e.target.files.length > 0) {
                console.log('Arquivo selecionado:', e.target.files[0].name);
                await processDocumentFile(e.target.files[0]);
                // Limpar o input para permitir selecionar o mesmo arquivo novamente
                e.target.value = '';
            }
        });
        return true;
    }
    return false;
}

// Tentar inicializar imediatamente
if (!initFileInputListener()) {
    // Se não encontrou, tentar após DOMContentLoaded
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(initFileInputListener, 100);
        });
    } else {
        // DOM já está pronto, tentar após um delay
        setTimeout(initFileInputListener, 100);
    }
    
    // Também tentar após um delay maior como fallback
    setTimeout(initFileInputListener, 1000);
}




// Função para extrair dados do texto do formulário
function extractFormDataFromText(text) {
    const data = {};
    
    // Dividir texto em linhas para processamento mais preciso
    const lines = text.split(/\n|\r\n?/).map(line => line.trim()).filter(line => line.length > 0);
    const fullText = text;
    
    // Função auxiliar para limpar valor extraído
    function cleanExtractedValue(value) {
        if (!value) return null;
        
        let cleaned = value.trim();
        
        // Remover "Não informado" e variações
        if (cleaned.toLowerCase().includes('não informado') || 
            cleaned.toLowerCase().includes('nao informado') ||
            cleaned.toLowerCase().includes('n/a') ||
            cleaned.toLowerCase() === 'na' ||
            cleaned.length < 2) {
            return null;
        }
        
        // Remover caracteres especiais no início/fim
        cleaned = cleaned.replace(/^[:\-\s]+|[:\-\s]+$/g, '');
        
        return cleaned.length > 0 ? cleaned : null;
    }
    
    // Função auxiliar para encontrar valor após label (múltiplas estratégias)
    function findValueAfterLabel(labelPattern, text, maxLength = 50) {
        // Estratégia 1: Busca direta com regex
        const regex = new RegExp(labelPattern + '[\\s:]+([^\\n\\r]{1,' + maxLength + '})', 'i');
        let match = text.match(regex);
        if (match && match[1]) {
            const value = match[1].trim().replace(/\s+/g, ' ');
            const cleaned = cleanExtractedValue(value);
            if (cleaned) return cleaned;
        }
        
        // Estratégia 2: Busca por linhas (label e valor em linhas adjacentes)
        const lines = text.split(/\n|\r\n?/).map(line => line.trim());
        for (let i = 0; i < lines.length; i++) {
            const lineLower = lines[i].toLowerCase();
            if (new RegExp(labelPattern, 'i').test(lineLower)) {
                // Verificar se o valor está na mesma linha
                const sameLineMatch = lines[i].match(new RegExp(labelPattern + '[\\s:]+(.+)', 'i'));
                if (sameLineMatch && sameLineMatch[1]) {
                    const cleaned = cleanExtractedValue(sameLineMatch[1]);
                    if (cleaned) return cleaned;
                }
                // Verificar linha seguinte
                if (i + 1 < lines.length && lines[i + 1].trim()) {
                    const cleaned = cleanExtractedValue(lines[i + 1].trim());
                    if (cleaned && !cleaned.toLowerCase().includes('não informado')) {
                        return cleaned;
                    }
                }
            }
        }
        
        return null;
    }
    
    // Extrair Data do Pedido (formato: DD/MM/YY ou DD/MM/YYYY)
    const dataPedidoPatterns = [
        /data\s+do\s+pedido[:\s]+(\d{1,2}\/\d{1,2}\/\d{2,4})/i,
        /data.*pedido[:\s]+(\d{1,2}\/\d{1,2}\/\d{2,4})/i
    ];
    for (const pattern of dataPedidoPatterns) {
        const match = fullText.match(pattern);
        if (match && match[1]) {
            data.dataPedido = convertDateToISO(match[1]);
            break;
        }
    }
    
    // Extrair Hora do Pedido (formato: HH:MM)
    const horaPedidoPatterns = [
        /hora\s+do\s+pedido[:\s]+(\d{1,2}:\d{2})/i,
        /hora.*pedido[:\s]+(\d{1,2}:\d{2})/i
    ];
    for (const pattern of horaPedidoPatterns) {
        const match = fullText.match(pattern);
        if (match && match[1]) {
            data.horaPedido = match[1];
            break;
        }
    }
    
    // Extrair Setor (pode aparecer como "Setor Solicitante" ou "Setor")
    const setorValue = findValueAfterLabel('setor\\s+solicitante|setor\\s+\\(hnmd\\)|setor', fullText, 50);
    if (setorValue) {
        data.setor = setorValue;
    }
    
    // Extrair Ramal
    const ramalValue = findValueAfterLabel('ramal', fullText, 20);
    if (ramalValue) {
        // Extrair apenas números
        const numbers = ramalValue.match(/\d+/);
        if (numbers) {
            data.ramal = numbers[0];
        }
    }
    
    // Extrair Cidade
    const cidadeValue = findValueAfterLabel('cidade', fullText, 50);
    if (cidadeValue) {
        data.cidade = cidadeValue;
    }
    
    // Extrair Bairro
    const bairroValue = findValueAfterLabel('bairro', fullText, 50);
    if (bairroValue) {
        data.bairro = bairroValue;
    }
    
    // Extrair Objetivo da Saída
    const objetivoValue = findValueAfterLabel('objetivo\\s+da\\s+saída|objetivo', fullText, 50);
    if (objetivoValue) {
        data.objetivo = objetivoValue;
    }
    
    // Extrair Hospital de Destino
    const hospitalValue = findValueAfterLabel('hospital\\s+de\\s+destino|hospital', fullText, 50);
    if (hospitalValue) {
        data.hospital = hospitalValue;
    }
    
    // Extrair Responsável
    const responsavelValue = findValueAfterLabel('responsável|responsavel', fullText, 50);
    if (responsavelValue) {
        data.responsavel = responsavelValue;
    }
    
    // Extrair Nº de Passageiros
    const passageirosPatterns = [
        /nº\s+de\s+passageiros[:\s]+(\d+)/i,
        /número\s+de\s+passageiros[:\s]+(\d+)/i,
        /passageiros[:\s]+(\d+)/i,
        /num.*passageiros[:\s]+(\d+)/i
    ];
    for (const pattern of passageirosPatterns) {
        const match = fullText.match(pattern);
        if (match && match[1]) {
            data.numPassageiros = match[1];
            break;
        }
    }
    
    // Extrair Data da Saída (formato: DD/MM/YY ou DD/MM/YYYY)
    const dataSaidaPatterns = [
        /data\s+da\s+saída[:\s]+(\d{1,2}\/\d{1,2}\/\d{2,4})/i,
        /data.*saída[:\s]+(\d{1,2}\/\d{1,2}\/\d{2,4})/i,
        /saída[:\s]+(\d{1,2}\/\d{1,2}\/\d{2,4})/i
    ];
    for (const pattern of dataSaidaPatterns) {
        const match = fullText.match(pattern);
        if (match && match[1]) {
            // Verificar se não é a data do pedido
            const matchPedido = fullText.match(/data\s+do\s+pedido[:\s]+(\d{1,2}\/\d{1,2}\/\d{2,4})/i);
            if (!matchPedido || matchPedido[1] !== match[1]) {
                data.dataSaida = convertDateToISO(match[1]);
                break;
            }
        }
    }
    
    // Extrair Hora da Saída (formato: HH:MM)
    const horaSaidaPatterns = [
        /hora\s+da\s+saída[:\s]+(\d{1,2}:\d{2})/i,
        /hora.*saída[:\s]+(\d{1,2}:\d{2})/i,
        /saída[:\s]+.*?(\d{1,2}:\d{2})/i
    ];
    for (const pattern of horaSaidaPatterns) {
        const match = fullText.match(pattern);
        if (match && match[1]) {
            // Verificar se não é a hora do pedido
            const matchPedido = fullText.match(/hora\s+do\s+pedido[:\s]+(\d{1,2}:\d{2})/i);
            if (!matchPedido || matchPedido[1] !== match[1]) {
                data.horaSaida = match[1];
                break;
            }
        }
    }
    
    // Extrair Hora de Chegada
    const horaChegadaPatterns = [
        /hora\s+de\s+chegada[:\s]+(\d{1,2}:\d{2})/i,
        /hora.*chegada[:\s]+(\d{1,2}:\d{2})/i,
        /chegada[:\s]+.*?(\d{1,2}:\d{2})/i
    ];
    for (const pattern of horaChegadaPatterns) {
        const match = fullText.match(pattern);
        if (match && match[1]) {
            data.horaChegada = match[1];
            break;
        }
    }
    
    // Extrair OM (Organização Militar)
    const omValue = findValueAfterLabel('om|organização\s+militar|organizacao\s+militar', fullText, 50);
    if (omValue) {
        data.om = omValue;
    }
    
    // Extrair Viatura (placa)
    const viaturaPatterns = [
        /viatura[:\s]+([A-Z]{3}[-]?\d{4}|[A-Z]{3}\d{1}[A-Z]\d{2})/i,
        /placa[:\s]+([A-Z]{3}[-]?\d{4}|[A-Z]{3}\d{1}[A-Z]\d{2})/i,
        /viatura[:\s]+([A-Z0-9-]{7,8})/i
    ];
    for (const pattern of viaturaPatterns) {
        const match = fullText.match(pattern);
        if (match && match[1]) {
            data.viatura = match[1].toUpperCase().replace(/\s+/g, '');
            break;
        }
    }
    
    // Extrair Motorista
    const motoristaValue = findValueAfterLabel('motorista|condutor', fullText, 50);
    if (motoristaValue) {
        data.motorista = motoristaValue;
    }
    
    // Extrair KM Saída
    const kmSaidaPatterns = [
        /km\s+saída[:\s]+([\d.]+)/i,
        /km\s+de\s+saída[:\s]+([\d.]+)/i,
        /quilometragem\s+saída[:\s]+([\d.]+)/i,
        /km.*saída[:\s]+([\d.]+)/i
    ];
    for (const pattern of kmSaidaPatterns) {
        const match = fullText.match(pattern);
        if (match && match[1]) {
            data.kmSaida = match[1].replace(/\./g, '');
            break;
        }
    }
    
    // Extrair KM Chegada
    const kmChegadaPatterns = [
        /km\s+chegada[:\s]+([\d.]+)/i,
        /km\s+de\s+chegada[:\s]+([\d.]+)/i,
        /quilometragem\s+chegada[:\s]+([\d.]+)/i,
        /km.*chegada[:\s]+([\d.]+)/i
    ];
    for (const pattern of kmChegadaPatterns) {
        const match = fullText.match(pattern);
        if (match && match[1]) {
            data.kmChegada = match[1].replace(/\./g, '');
            break;
        }
    }
    
    // Tentar extrair dados usando análise de linhas (para formulários estruturados)
    lines.forEach((line, index) => {
        const lineLower = line.toLowerCase();
        
        // Buscar padrões em linhas específicas
        if (lineLower.includes('data') && lineLower.includes('pedido')) {
            const dateMatch = line.match(/(\d{1,2}\/\d{1,2}\/\d{2,4})/);
            if (dateMatch && !data.dataPedido) {
                data.dataPedido = convertDateToISO(dateMatch[1]);
            }
        }
        
        if (lineLower.includes('hora') && lineLower.includes('pedido')) {
            const timeMatch = line.match(/(\d{1,2}:\d{2})/);
            if (timeMatch && !data.horaPedido) {
                data.horaPedido = timeMatch[1];
            }
        }
        
        if (lineLower.includes('setor') && !data.setor) {
            const setorMatch = line.match(/setor[:\s]+(.+)/i);
            if (setorMatch && setorMatch[1]) {
                const cleaned = cleanExtractedValue(setorMatch[1]);
                if (cleaned) data.setor = cleaned;
            }
        }
        
        if (lineLower.includes('cidade') && !data.cidade) {
            const cidadeMatch = line.match(/cidade[:\s]+(.+)/i);
            if (cidadeMatch && cidadeMatch[1]) {
                const cleaned = cleanExtractedValue(cidadeMatch[1]);
                if (cleaned) data.cidade = cleaned;
            }
        }
        
        if (lineLower.includes('bairro') && !data.bairro) {
            const bairroMatch = line.match(/bairro[:\s]+(.+)/i);
            if (bairroMatch && bairroMatch[1]) {
                const cleaned = cleanExtractedValue(bairroMatch[1]);
                if (cleaned) data.bairro = cleaned;
            }
        }
    });
    
    console.log('Dados extraídos completos:', data);
    return data;
}

// Função para converter data DD/MM/YY ou DD/MM/YYYY para YYYY-MM-DD
function convertDateToISO(dateStr) {
    if (!dateStr) return '';
    
    const parts = dateStr.split('/');
    if (parts.length !== 3) return '';
    
    let day = parts[0].padStart(2, '0');
    let month = parts[1].padStart(2, '0');
    let year = parts[2];
    
    // Se ano tem 2 dígitos, assumir 20XX
    if (year.length === 2) {
        year = '20' + year;
    }
    
    return `${year}-${month}-${day}`;
}


// Função para preencher formulário com dados extraídos
function fillFormWithExtractedData() {
    console.log('Preenchendo formulário com dados:', extractedData);
    
    if (!extractedData) {
        console.error('Nenhum dado extraído disponível');
        alert('Nenhum dado extraído. Por favor, processe o documento primeiro.');
        return;
    }
    
    try {
        // Preencher campos
        if (extractedData.dataPedido) {
            const dataPedidoInput = document.getElementById('registerDataPedido');
            if (dataPedidoInput) dataPedidoInput.value = extractedData.dataPedido;
        }
        
        if (extractedData.horaPedido) {
            const horaPedidoInput = document.getElementById('registerHoraPedido');
            if (horaPedidoInput) horaPedidoInput.value = extractedData.horaPedido;
        }
        
        if (extractedData.setor) {
            const setorInput = document.getElementById('registerSetor');
            if (setorInput) setorInput.value = extractedData.setor;
        }
        
        if (extractedData.ramal) {
            const ramalInput = document.getElementById('registerRamal');
            if (ramalInput) ramalInput.value = extractedData.ramal;
        }
        
        if (extractedData.cidade) {
            const cidadeSelect = document.getElementById('registerCidade');
            const cidadeInput = document.getElementById('registerCidadeInput');
            
            // Verificar se cidade está na lista (busca case-insensitive e parcial)
            if (cidadeSelect) {
                const options = Array.from(cidadeSelect.options);
                const cidadeLower = extractedData.cidade.toLowerCase();
                const foundOption = options.find(opt => 
                    opt.value.toLowerCase() === cidadeLower ||
                    opt.value.toLowerCase().includes(cidadeLower) ||
                    cidadeLower.includes(opt.value.toLowerCase())
                );
                
                if (foundOption) {
                    cidadeSelect.value = foundOption.value;
                    cidadeSelect.dispatchEvent(new Event('change', { bubbles: true }));
                } else if (cidadeInput) {
                    // Se não encontrou, usar campo de texto manual
                    cidadeSelect.style.display = 'none';
                    cidadeInput.style.display = 'block';
                    cidadeInput.value = extractedData.cidade;
                }
            }
        }
        
        if (extractedData.bairro) {
            // Aguardar um pouco para cidade ser processada
            setTimeout(() => {
                const bairroSelect = document.getElementById('registerBairro');
                const bairroInput = document.getElementById('registerBairroInput');
                
                if (bairroSelect && !bairroSelect.disabled) {
                    const options = Array.from(bairroSelect.options);
                    const bairroLower = extractedData.bairro.toLowerCase();
                    const foundOption = options.find(opt => 
                        opt.value.toLowerCase() === bairroLower ||
                        opt.value.toLowerCase().includes(bairroLower) ||
                        bairroLower.includes(opt.value.toLowerCase())
                    );
                    
                    if (foundOption) {
                        bairroSelect.value = foundOption.value;
                    } else if (bairroInput) {
                        bairroSelect.style.display = 'none';
                        bairroInput.style.display = 'block';
                        bairroInput.value = extractedData.bairro;
                    }
                } else if (bairroInput) {
                    bairroInput.value = extractedData.bairro;
                }
            }, 800);
        }
        
        if (extractedData.objetivo) {
            const objetivoSelect = document.getElementById('registerObjetivoSelect');
            const objetivoInput = document.getElementById('registerObjetivo');
            const objetivoLower = extractedData.objetivo.toLowerCase();
            
            // Verificar se é "Inter Hospitalar" ou variações
            if (objetivoSelect && (objetivoLower.includes('inter hospitalar') || 
                                   objetivoLower.includes('inter-hospitalar') ||
                                   objetivoLower.includes('interhospitalar'))) {
                objetivoSelect.value = 'Inter Hospitalar';
                objetivoSelect.dispatchEvent(new Event('change', { bubbles: true }));
                
                // Preencher hospital se disponível
                if (extractedData.hospital) {
                    setTimeout(() => {
                        const hospitalInput = document.getElementById('registerHospital');
                        if (hospitalInput) {
                            hospitalInput.value = extractedData.hospital;
                        }
                    }, 500);
                }
            } else if (objetivoInput) {
                objetivoInput.value = extractedData.objetivo;
            }
        }
        
        if (extractedData.responsavel) {
            const responsavelInput = document.getElementById('registerResponsavelPedido');
            if (responsavelInput) responsavelInput.value = extractedData.responsavel;
        }
        
        if (extractedData.numPassageiros) {
            const passageirosInput = document.getElementById('registerNumPassageiros');
            if (passageirosInput) passageirosInput.value = extractedData.numPassageiros;
        }
        
        if (extractedData.dataSaida) {
            const dataSaidaInput = document.getElementById('registerDataSaida');
            if (dataSaidaInput) dataSaidaInput.value = extractedData.dataSaida;
        }
        
        if (extractedData.horaSaida) {
            const horaSaidaInput = document.getElementById('registerHoraSaida');
            if (horaSaidaInput) horaSaidaInput.value = extractedData.horaSaida;
        }
        
        if (extractedData.horaChegada) {
            const horaChegadaInput = document.getElementById('registerChegada');
            if (horaChegadaInput) horaChegadaInput.value = extractedData.horaChegada;
        }
        
        if (extractedData.om) {
            const omInput = document.getElementById('registerOM');
            if (omInput) omInput.value = extractedData.om;
        }
        
        if (extractedData.viatura) {
            const viaturaSelect = document.getElementById('registerViatura');
            if (viaturaSelect) {
                const options = Array.from(viaturaSelect.options);
                const foundOption = options.find(opt => 
                    opt.value.toUpperCase().replace(/\s+/g, '') === extractedData.viatura.toUpperCase().replace(/\s+/g, '')
                );
                if (foundOption) {
                    viaturaSelect.value = foundOption.value;
                    viaturaSelect.dispatchEvent(new Event('change', { bubbles: true }));
                }
            }
        }
        
        if (extractedData.motorista) {
            const motoristaSelect = document.getElementById('registerMotorista');
            if (motoristaSelect) {
                const options = Array.from(motoristaSelect.options);
                const motoristaLower = extractedData.motorista.toLowerCase();
                const foundOption = options.find(opt => 
                    opt.value.toLowerCase().includes(motoristaLower) ||
                    motoristaLower.includes(opt.value.toLowerCase())
                );
                if (foundOption) {
                    motoristaSelect.value = foundOption.value;
                }
            }
        }
        
        if (extractedData.kmSaida) {
            const kmSaidaInput = document.getElementById('registerKmSaida');
            if (kmSaidaInput) {
                // Formatar KM
                const kmFormatted = extractedData.kmSaida.replace(/\D/g, '').replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.');
                kmSaidaInput.value = kmFormatted;
            }
        }
        
        if (extractedData.kmChegada) {
            const kmChegadaInput = document.getElementById('registerKmChegada');
            if (kmChegadaInput) {
                // Formatar KM
                const kmFormatted = extractedData.kmChegada.replace(/\D/g, '').replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.');
                kmChegadaInput.value = kmFormatted;
            }
        }
        
        // Mostrar mensagem de sucesso
        if (typeof displayMessage === 'function') {
            displayMessage('Dados carregados com sucesso! Verifique e complete os campos restantes.', 'success');
        }
        
    } catch (error) {
        console.error('Erro ao preencher formulário:', error);
        displayMessage('Erro ao preencher formulário: ' + error.message, 'error');
    }
}

// Função para exibir modal com dados extraídos
function showExtractedDataModal(data) {
    console.log('showExtractedDataModal chamada com dados:', data);
    const modal = document.getElementById('extractedDataModal');
    const dataList = document.getElementById('extractedDataList');
    
    console.log('Modal encontrado:', modal);
    console.log('DataList encontrado:', dataList);
    
    if (!modal) {
        console.error('Modal não encontrado!');
        return;
    }
    
    if (!dataList) {
        console.error('DataList não encontrado!');
        return;
    }
    
    // Mapear os campos para nomes amigáveis
    const fieldLabels = {
        dataPedido: 'Data do Pedido',
        horaPedido: 'Hora do Pedido',
        dataSaida: 'Data da Saída',
        horaSaida: 'Hora da Saída',
        horaChegada: 'Hora de Chegada',
        setor: 'Setor',
        ramal: 'Ramal',
        cidade: 'Cidade',
        bairro: 'Bairro',
        objetivo: 'Objetivo da Saída',
        hospital: 'Hospital de Destino',
        responsavel: 'Responsável',
        numPassageiros: 'Nº de Passageiros',
        om: 'OM (Organização Militar)',
        viatura: 'Viatura (Placa)',
        motorista: 'Motorista',
        kmSaida: 'KM Saída',
        kmChegada: 'KM Chegada'
    };
    
    // Limpar lista anterior
    dataList.innerHTML = '';
    
    // Adicionar cada campo extraído
    Object.keys(data).forEach(key => {
        if (data[key]) {
            const item = document.createElement('div');
            item.className = 'extracted-data-item';
            item.innerHTML = `
                <span class="extracted-data-label">${fieldLabels[key] || key}:</span>
                <span class="extracted-data-value">${data[key]}</span>
            `;
            dataList.appendChild(item);
        }
    });
    
    // Se não houver dados, mostrar mensagem
    if (dataList.children.length === 0) {
        dataList.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">Nenhum dado foi extraído do documento. Verifique se o documento está legível e contém os campos do formulário de saída de ambulância.</p>';
    }
    
    // Mostrar modal
    console.log('Adicionando classe show ao modal');
    modal.style.display = 'flex'; // Forçar display flex
    modal.classList.add('show');
    console.log('Modal deve estar visível agora. Classes do modal:', modal.className);
    console.log('Display do modal:', window.getComputedStyle(modal).display);
}

// Função para fechar modal de dados extraídos
function closeExtractedDataModal() {
    const modal = document.getElementById('extractedDataModal');
    if (modal) {
        modal.classList.remove('show');
    }
}

// Event listeners para o modal de dados extraídos
document.addEventListener('DOMContentLoaded', function() {
    const loadBtn = document.getElementById('loadExtractedDataBtn');
    const cancelBtn = document.getElementById('cancelExtractedDataBtn');
    const closeBtn = document.getElementById('extractedDataCloseBtn');
    const modal = document.getElementById('extractedDataModal');
    
    if (loadBtn) {
        loadBtn.addEventListener('click', function() {
            if (extractedData) {
                fillFormWithExtractedData();
                closeExtractedDataModal();
            }
        });
    }
    
    if (cancelBtn) {
        cancelBtn.addEventListener('click', closeExtractedDataModal);
    }
    
    if (closeBtn) {
        closeBtn.addEventListener('click', closeExtractedDataModal);
    }
    
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeExtractedDataModal();
            }
        });
    }
});

</script>

<!-- Modal de Alerta de Quilometragem -->
<div id="kmAlertModal" class="km-alert-modal">
    <div class="km-alert-modal-content">
        <span id="kmAlertCloseBtn" class="close-button">&times;</span>
        <h3>⚠️ Alerta de Quilometragem</h3>
        <p id="kmAlertMessage"></p>
        <div class="km-alert-modal-buttons">
            <button id="kmAlertConfirmBtn" class="km-alert-confirm-btn">Sim</button>
            <button id="kmAlertCancelBtn" class="km-alert-cancel-btn">Não</button>
        </div>
    </div>
</div>

<div id="limiteSaidasModal">
    <div class="limite-saidas-modal-content">
        <h3>Limite de Saídas</h3>
        <p>Limite de Saídas Excedido para esse horário.</p>
        <button type="button" class="limite-saidas-ok" id="limiteSaidasModalOk">OK</button>
    </div>
</div>

<!-- Input de arquivo oculto para carregar documento -->
<input type="file" id="documentFileInput" accept="image/*,.txt" style="display: none;">

<!-- Modal de Dados Extraídos -->
<div id="extractedDataModal" class="extracted-data-modal">
    <div class="extracted-data-modal-content">
        <span id="extractedDataCloseBtn" class="close-button">&times;</span>
        <h3>📄 Dados Extraídos do Documento</h3>
        <div id="extractedDataList" class="extracted-data-list">
            <!-- Os dados serão inseridos aqui -->
        </div>
        <div class="extracted-data-buttons">
            <button id="loadExtractedDataBtn" class="extracted-data-btn extracted-data-load-btn">Carregar Dados</button>
            <button id="cancelExtractedDataBtn" class="extracted-data-btn extracted-data-cancel-btn">Cancelar</button>
        </div>
    </div>
</div>

<script>
(function() {
 function normalizeText(text) {
  if (!text) return '';
  return String(text).toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/[^\w\s]/g, '').replace(/\s+/g, ' ').trim();
 }

 var lastVoiceFocusedField = null;

 function buildLabelToFieldMap() {
  var form = document.getElementById('registerFormContent');
  if (!form) return {};
  var map = {};
  var groups = form.querySelectorAll('.form-group');
  for (var i = 0; i < groups.length; i++) {
   var label = groups[i].querySelector('label');
   if (!label) continue;
   var forId = label.getAttribute('for');
   var el = forId ? document.getElementById(forId) : null;
   if (!el) el = groups[i].querySelector('select, input[type="text"], input[type="number"], input[type="date"], input[type="time"]');
   if (!el) continue;
   var key = normalizeText(label.textContent);
   if (key) map[key] = el;
   var shortKey = key.split(/\s+/).filter(function(w) { return w.length > 1; }).join(' ');
   if (shortKey && shortKey !== key) map[shortKey] = el;
  }
  return map;
 }

 function focusField(el) {
  if (!el) return;
  lastVoiceFocusedField = el;
  el.focus();
  if (el.tagName === 'SELECT') {
   el.click();
   var optsCount = el.options ? el.options.length : 0;
   if (optsCount > 1) {
    var showSize = Math.min(Math.max(2, optsCount), 10);
    el.size = showSize;
    var onBlur = function() {
     el.size = 1;
     el.removeEventListener('blur', onBlur);
    };
    el.addEventListener('blur', onBlur, { once: true });
   }
  }
 }

 function parseSpokenDate(spokenValue) {
  if (!spokenValue) return null;
  var s = String(spokenValue).trim();
  var n = normalizeText(s);
  if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
  var meses = { janeiro: 1, fevereiro: 2, marco: 3, março: 3, abril: 4, maio: 5, junho: 6, julho: 7, agosto: 8, setembro: 9, outubro: 10, novembro: 11, dezembro: 12 };
  var matchSlash = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/);
  if (matchSlash) {
   var d = parseInt(matchSlash[1], 10);
   var m = parseInt(matchSlash[2], 10);
   var y = parseInt(matchSlash[3], 10);
   if (y < 100) y += 2000;
   if (d >= 1 && d <= 31 && m >= 1 && m <= 12) {
    var pad = function(x) { return (x < 10 ? '0' : '') + x; };
    return y + '-' + pad(m) + '-' + pad(d);
   }
  }
  for (var mesNome in meses) {
   var idx = n.indexOf(mesNome);
   if (idx === -1) continue;
   var mes = meses[mesNome];
   var nums = n.replace(/[^\d]/g, ' ').trim().split(/\s+/);
   var dia = 1, ano = new Date().getFullYear();
   if (nums.length >= 1) dia = parseInt(nums[0], 10);
   if (nums.length >= 2) ano = parseInt(nums[1], 10);
   if (ano < 100) ano += 2000;
   if (dia >= 1 && dia <= 31 && ano >= 1900 && ano <= 2100) {
    var pad = function(x) { return (x < 10 ? '0' : '') + x; };
    return ano + '-' + pad(mes) + '-' + pad(dia);
   }
  }
  var onlyDigits = n.replace(/\D/g, '');
  if (onlyDigits.length === 8) {
   var d = parseInt(onlyDigits.slice(0, 2), 10);
   var m = parseInt(onlyDigits.slice(2, 4), 10);
   var y = parseInt(onlyDigits.slice(4, 8), 10);
   if (d >= 1 && d <= 31 && m >= 1 && m <= 12) {
    var pad = function(x) { return (x < 10 ? '0' : '') + x; };
    return y + '-' + pad(m) + '-' + pad(d);
   }
  }
  var parts = n.replace(/\s+/g, ' ').split(' ').filter(function(p) { return /^\d+$/.test(p); });
  if (parts.length >= 3) {
   var d = parseInt(parts[0], 10);
   var m = parseInt(parts[1], 10);
   var y = parseInt(parts[2], 10);
   if (y < 100) y += 2000;
   if (d >= 1 && d <= 31 && m >= 1 && m <= 12 && y >= 1900 && y <= 2100) {
    var pad = function(x) { return (x < 10 ? '0' : '') + x; };
    return y + '-' + pad(m) + '-' + pad(d);
   }
  }
  return null;
 }

 function parseSpokenNumber(spokenValue) {
  if (!spokenValue) return null;
  var s = String(spokenValue).trim();
  var n = normalizeText(s);
  var onlyDigits = n.replace(/\D/g, '');
  if (onlyDigits.length > 0) {
   var num = parseInt(onlyDigits, 10);
   if (!isNaN(num) && num >= 0) return num;
  }
  var palavras = { zero: 0, um: 1, uma: 1, dois: 2, duas: 2, tres: 3, quatro: 4, cinco: 5, seis: 6, sete: 7, oito: 8, nove: 9, dez: 10, onze: 11, doze: 12, treze: 13, catorze: 14, quatorze: 14, quinze: 15, dezesseis: 16, dezessete: 17, dezoito: 18, dezenove: 19, vinte: 20, trinta: 30, quarenta: 40, cinquenta: 50, sessenta: 60, setenta: 70, oitenta: 80, noventa: 90, cem: 100 };
  var parts = n.split(/\s+e\s+|\s+/);
  var num = 0;
  for (var i = 0; i < parts.length; i++) {
   var p = parts[i].trim();
   if (p && palavras[p] !== undefined) num += palavras[p];
  }
  if (num > 0) return num;
  if (n.indexOf('zero') !== -1) return 0;
  return null;
 }

 function parseSpokenTime(spokenValue) {
  if (!spokenValue) return null;
  var s = String(spokenValue).trim();
  if (/^\d{1,2}:\d{2}$/.test(s)) {
   var parts = s.split(':');
   var h = parseInt(parts[0], 10);
   var m = parseInt(parts[1], 10);
   if (h >= 0 && h <= 23 && m >= 0 && m <= 59) {
    var pad = function(x) { return (x < 10 ? '0' : '') + x; };
    return pad(h) + ':' + pad(m);
   }
  }
  var t = s.replace(/\D/g, '');
  if (t.length === 0) return null;
  var pad = function(x) { return (x < 10 ? '0' : '') + x; };
  if (t.length === 1) {
   var h = parseInt(t, 10);
   if (h >= 0 && h <= 9) return pad(h) + ':00';
  }
  if (t.length === 2) {
   var h = parseInt(t, 10);
   if (h >= 0 && h <= 23) return pad(h) + ':00';
  }
  if (t.length === 3) {
   var h = parseInt(t.slice(0, 1), 10);
   var m = parseInt(t.slice(1, 3), 10);
   if (h >= 0 && h <= 9 && m >= 0 && m <= 59) return pad(h) + ':' + pad(m);
  }
  if (t.length >= 4) {
   var h = parseInt(t.slice(0, 2), 10);
   var m = parseInt(t.slice(2, 4), 10);
   if (h >= 0 && h <= 23 && m >= 0 && m <= 59) return pad(h) + ':' + pad(m);
  }
  return null;
 }

 function fillField(el, spokenValue) {
  if (!el) return;
  var norm = spokenValue;
  if (el.tagName === 'SELECT') {
   var opts = el.options;
   var isViatura = el.id === 'registerViatura';
   var normPlaca = '';
   if (isViatura && norm) {
    normPlaca = norm.replace(/\s/g, '').replace(/-/g, '').replace(/[^\w]/g, '').toLowerCase();
   }
   for (var j = 0; j < opts.length; j++) {
    var opt = opts[j];
    if (!opt.value) continue;
    var optNorm = normalizeText(opt.textContent || opt.value);
    var match = optNorm === norm || optNorm.indexOf(norm) !== -1 || norm.indexOf(optNorm) !== -1;
    if (isViatura && normPlaca) {
     var optPlaca = (opt.value || '').replace(/\s/g, '').replace(/-/g, '').replace(/[^\w]/g, '').toLowerCase();
     var optTextPlaca = (opt.textContent || '').split('(')[0].trim().replace(/\s/g, '').replace(/-/g, '').replace(/[^\w]/g, '').toLowerCase();
     if (optPlaca === normPlaca || optTextPlaca === normPlaca ||
         optPlaca.indexOf(normPlaca) !== -1 || normPlaca.indexOf(optPlaca) !== -1 ||
         (normPlaca.length >= 4 && (optPlaca.indexOf(normPlaca) !== -1 || normPlaca.indexOf(optPlaca) !== -1))) match = true;
    }
    if (match) {
     el.selectedIndex = j;
     el.value = opt.value;
     opt.selected = true;
     if (el.size > 1) el.size = 1;
     el.dispatchEvent(new Event('input', { bubbles: true }));
     el.dispatchEvent(new Event('change', { bubbles: true }));
     if (isViatura) {
      var inoperante = (opt.textContent || '').indexOf('Inoperante') !== -1 || (opt.style && opt.style.color === 'red');
      if (inoperante && window.parent) {
       try { window.parent.postMessage({ type: 'speak', text: 'Viatura Solicitada Inoperante' }, '*'); } catch (err) {}
      }
     }
     return true;
    }
   }
   return false;
  }
  if (el.type === 'number') {
   var num = parseSpokenNumber(spokenValue);
   if (num !== null && !isNaN(num) && num >= 0) {
    el.value = num;
    el.dispatchEvent(new Event('input', { bubbles: true }));
    el.dispatchEvent(new Event('change', { bubbles: true }));
    return true;
   }
   return false;
  }
  if (el.type === 'date') {
   var dateStr = parseSpokenDate(spokenValue);
   if (dateStr) {
    el.value = dateStr;
    el.dispatchEvent(new Event('input', { bubbles: true }));
    el.dispatchEvent(new Event('change', { bubbles: true }));
    return true;
   }
   return false;
  }
  if (el.type === 'time') {
   var timeStr = parseSpokenTime(spokenValue);
   if (timeStr) {
    el.value = timeStr;
    el.dispatchEvent(new Event('input', { bubbles: true }));
    el.dispatchEvent(new Event('change', { bubbles: true }));
    return true;
   }
  }
  if (el.type === 'text') {
   el.value = spokenValue;
   el.dispatchEvent(new Event('input', { bubbles: true }));
   return true;
  }
  return false;
 }

 window.addEventListener('message', function(event) {
  if (!event.data || event.data.type !== 'highlightField' || !event.data.fieldName) return;
  var registerForm = document.getElementById('registerFormContent');
  if (!registerForm || !registerForm.classList.contains('active')) return;
  var fieldName = normalizeText(event.data.fieldName);
  var labelMap = buildLabelToFieldMap();

  var tipoSaidaSelect = document.getElementById('registerTipoSaida');
  if (tipoSaidaSelect && (fieldName === 'administrativa' || fieldName === 'ambulancia')) {
   var valueToSet = fieldName === 'administrativa' ? 'Administrativa' : 'Ambulância';
   if (Array.prototype.find.call(tipoSaidaSelect.options, function(opt) { return opt.value === valueToSet; })) {
    tipoSaidaSelect.value = valueToSet;
    tipoSaidaSelect.dispatchEvent(new Event('change', { bubbles: true }));
   }
   return;
  }

  for (var key in labelMap) {
   if (key === fieldName || key.indexOf(fieldName) !== -1 || fieldName.indexOf(key) !== -1) {
    focusField(labelMap[key]);
    return;
   }
  }

  if (lastVoiceFocusedField && fillField(lastVoiceFocusedField, fieldName)) {
   lastVoiceFocusedField = null;
   return;
  }
  var viaturaSelect = document.getElementById('registerViatura');
  if (viaturaSelect && fillField(viaturaSelect, fieldName)) return;
  var selects = registerForm.querySelectorAll('select');
  for (var s = 0; s < selects.length; s++) {
   if (fillField(selects[s], fieldName)) return;
  }
 });
})();
</script>

</body>
</html>