<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Registro de Manuten√ß√µes - Sistema Integrado</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<script src="theme-listener.js"></script>
<style>
:root {
--primary-blue: #4a69bd;
--secondary-blue: #6c88c9;
--gray: #dcdcdc;
--dark-gray: #333d47;
--white: #ffffff;
--light-gray-bg: #f9f9f9;
--tab-inactive-bg: #e9ecef;
--tab-active-bg: var(--white);
--tab-border: 1px solid #dee2e6;
--delete-red: #dc3545;
--success-green: #28a745;
--warning-orange: #ffa500;
--light-blue-bg: #eaf0ff;
}
* { box-sizing: border-box; }
body { font-family: 'Arial', sans-serif; margin: 0; padding: 0; background-color: var(--light-gray-bg); color: var(--dark-gray); font-weight: 500; min-height: 100vh; }
.container { max-width: 1200px; margin: 0 auto; padding: 20px; }
.tabs { display: flex; border-bottom: 2px solid var(--primary-blue); margin-bottom: 20px; background-color: var(--white); border-radius: 8px 8px 0 0; overflow: hidden; }
.tabs a { text-decoration: none; color: inherit; flex: 1; display: flex; }
.tab-button { background-color: var(--tab-inactive-bg); color: var(--dark-gray); border: none; padding: 15px 25px; cursor: pointer; font-size: 16px; font-weight: bold; transition: all 0.3s ease; flex: 1; display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; }
.tab-button:hover:not(.active) { background-color: #e2e6ea; }
.tab-button.active { background-color: var(--primary-blue); color: var(--white); }
.tab-content { display: none; background-color: var(--white); padding: 30px; border-radius: 0 0 8px 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
.tab-content.active { display: block; }
.page-title { font-size: 28px; color: var(--primary-blue); text-align: center; font-weight: bold; margin: 0 0 30px 0; display: flex; align-items: center; justify-content: center; gap: 10px; }
.cadastro-form { background-color: var(--light-blue-bg); border: 2px solid var(--primary-blue); border-radius: 12px; padding: 20px; display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; }
.form-group { display: flex; flex-direction: column; gap: 8px; }
.form-group label { font-weight: bold; color: var(--dark-gray); }
.form-group select, .form-group input, .form-group textarea { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--gray); font-size: 16px; }
.form-group textarea { resize: vertical; min-height: 100px; }
.btn { background-color: var(--primary-blue); color: var(--white); border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; transition: all 0.3s ease; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
.btn:hover { background-color: var(--secondary-blue); }
.btn-success { background-color: var(--success-green); }
.btn-success:hover { background-color: #218838; }
.btn-warning { background-color: var(--warning-orange); }
.btn-warning:hover { background-color: #e0a800; }
.btn-danger { background-color: var(--delete-red); }
.btn-danger:hover { background-color: #c82333; }
.table-container { overflow-x: auto; border: 2px solid var(--primary-blue); border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); background-color: var(--white); margin-top: 20px; }
.data-table { width: 100%; border-collapse: collapse; text-align: left; }
.data-table th, .data-table td { border: 1px solid var(--tab-border); padding: 12px; }
.data-table th { background-color: var(--primary-blue); color: var(--white); font-weight: bold; text-transform: uppercase; font-size: 12px; }
.data-table tbody tr:nth-child(even) { background-color: #f8f9fa; }
.data-table tbody tr:hover { background-color: #e9ecef; }
.action-buttons { display: flex; gap: 5px; }
.action-buttons button { padding: 6px 12px; font-size: 14px; }
.status-badge { display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold; }
.status-badge.ativo { background-color: var(--warning-orange); color: var(--white); }
.status-badge.finalizado { background-color: var(--success-green); color: var(--white); }
.hidden { display: none !important; }
.modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); justify-content: center; align-items: center; }
.modal.show { display: flex; }
.modal-content { background-color: var(--white); padding: 30px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3); width: 95%; max-width: 1400px; max-height: 95vh; overflow-y: auto; display: flex; flex-direction: column; }
.modal-content h3 { color: var(--primary-blue); margin-bottom: 20px; font-size: 24px; text-align: center; border-bottom: 2px solid var(--primary-blue); padding-bottom: 15px; }
.modal-buttons { display: flex; justify-content: center; gap: 20px; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--gray); }
.empty-state { text-align: center; padding: 40px; color: #888; }
.empty-state i { font-size: 48px; margin-bottom: 15px; color: var(--gray); }
.filter-container select:focus, .filter-container input:focus { outline: none; border-color: var(--primary-blue); box-shadow: 0 0 0 3px rgba(74, 105, 189, 0.1); }
.filter-container select:hover, .filter-container input:hover { border-color: var(--secondary-blue); }
</style>
</head>
<body>
<div class="container">
<div class="tabs">
<a href="vistoriar.html"><button class="tab-button"><i class="fas fa-car"></i> Vistoriar Viatura</button></a>
<a href="historico.html"><button class="tab-button"><i class="fas fa-history"></i> Hist√≥rico</button></a>
<a href="situacao.html"><button class="tab-button"><i class="fas fa-info-circle"></i> Situa√ß√£o</button></a>
<a href="responsabilidades.html"><button class="tab-button"><i class="fas fa-users"></i> Responsabilidades</button></a>
<a href="vtr-oficina.html"><button class="tab-button active"><i class="fas fa-tools"></i> Registro de Manuten√ß√µes</button></a>
</div>
<div id="vtr-oficina" class="tab-content active">
<h1 class="page-title"><i class="fas fa-tools"></i> Registro de Manuten√ß√µes</h1>

<!-- Formul√°rio de Cadastro -->
<div class="cadastro-form">
<h2 style="color: var(--primary-blue); margin-top: 0;"><i class="fas fa-plus-circle"></i> Registrar Viatura na Oficina</h2>
<div class="form-group">
<label for="viaturaSelect"><i class="fas fa-car"></i> Viatura:</label>
<select id="viaturaSelect" required>
<option value="">-- Selecione a Viatura --</option>
</select>
</div>
<div class="form-group">
<label for="dataSaida"><i class="fas fa-calendar-alt"></i> Data de Sa√≠da:</label>
<input type="date" id="dataSaida" required>
</div>
<div class="form-group">
<label for="dataRetorno"><i class="fas fa-calendar-check"></i> Data de Retorno:</label>
<input type="date" id="dataRetorno">
<small style="color: #666; margin-top: 5px;">Preencha a data de retorno para finalizar o registro</small>
</div>
<div class="form-group">
<label for="descricao"><i class="fas fa-file-alt"></i> Descri√ß√£o do Servi√ßo:</label>
<textarea id="descricao" placeholder="Descreva o que a viatura foi fazer na oficina..." required></textarea>
</div>
<div style="display: flex; gap: 10px; margin-top: 10px;">
<button id="btnSalvar" class="btn btn-success"><i class="fas fa-save"></i> Salvar Registro</button>
<button id="btnLimpar" class="btn"><i class="fas fa-eraser"></i> Limpar Formul√°rio</button>
</div>
</div>

<!-- Bot√µes de a√ß√£o -->
<div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
<button id="btnVerFinalizados" class="btn btn-warning"><i class="fas fa-check-circle"></i> Ver Registros Finalizados</button>
<button id="btnEstatisticas" class="btn" style="background-color: var(--primary-blue);"><i class="fas fa-chart-bar"></i> Estat√≠sticas</button>
</div>

<!-- Tabela de Registros Ativos -->
<div class="table-container">
<h3 style="padding: 15px; margin: 0; background-color: var(--primary-blue); color: var(--white); border-radius: 12px 12px 0 0;">
<i class="fas fa-list"></i> Viaturas na Oficina (Ativas)
</h3>
<table class="data-table">
<thead>
<tr>
<th>Viatura</th>
<th>Data de Sa√≠da</th>
<th>Data de Retorno</th>
<th>Descri√ß√£o</th>
<th>Status</th>
<th>A√ß√µes</th>
</tr>
</thead>
<tbody id="tabelaAtivos">
</tbody>
</table>
<div id="emptyAtivos" class="empty-state hidden">
<i class="fas fa-inbox"></i>
<p>Nenhuma viatura registrada na oficina no momento.</p>
</div>
</div>
</div>
</div>

<!-- Modal de Estat√≠sticas -->
<div id="modalEstatisticas" class="modal">
<div class="modal-content" style="max-width: 1200px;">
<h3><i class="fas fa-chart-bar"></i> Estat√≠sticas de Manuten√ß√µes</h3>
<div id="conteudoEstatisticas" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
<!-- Estat√≠sticas ser√£o inseridas aqui via JavaScript -->
</div>
<div class="modal-buttons">
<button id="btnFecharEstatisticas" class="btn btn-danger"><i class="fas fa-times"></i> Fechar</button>
</div>
</div>
</div>

<!-- Modal de Registros Finalizados -->
<div id="modalFinalizados" class="modal">
<div class="modal-content">
<h3><i class="fas fa-check-circle"></i> Registros Finalizados</h3>

<!-- Filtros -->
<div class="filter-container" style="margin-bottom: 25px; padding: 20px; background: linear-gradient(135deg, var(--light-gray-bg) 0%, #f0f4f8 100%); border-radius: 12px; border: 2px solid var(--primary-blue); box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
<h4 style="margin: 0 0 20px 0; color: var(--primary-blue); font-size: 18px; display: flex; align-items: center; gap: 10px;">
<i class="fas fa-filter"></i> Filtros de Busca
</h4>
<!-- Campo de Busca por Descri√ß√£o -->
<div style="background-color: var(--white); padding: 15px; border-radius: 8px; border: 1px solid var(--gray); box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 20px;">
<h5 style="margin: 0 0 15px 0; color: var(--dark-gray); font-size: 14px; font-weight: bold; display: flex; align-items: center; gap: 8px;">
<i class="fas fa-search" style="color: var(--primary-blue);"></i> Buscar na Descri√ß√£o
</h5>
<div style="position: relative;">
<input type="text" id="filtroDescricao" placeholder="Digite uma palavra para buscar na descri√ß√£o..." style="width: 100%; padding: 12px 45px 12px 15px; border-radius: 8px; border: 2px solid var(--gray); font-size: 14px; background-color: var(--white); transition: all 0.3s; box-sizing: border-box;">
<i class="fas fa-search" style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: var(--primary-blue); pointer-events: none;"></i>
</div>
<small style="display: block; margin-top: 8px; color: #666; font-size: 12px;">
<i class="fas fa-info-circle"></i> A busca √© feita em todas as descri√ß√µes. A palavra encontrada ser√° destacada em negrito.
</small>
</div>
<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px;">
<!-- Grupo 1: Filtros de Data -->
<div style="background-color: var(--white); padding: 15px; border-radius: 8px; border: 1px solid var(--gray); box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
<h5 style="margin: 0 0 15px 0; color: var(--dark-gray); font-size: 14px; font-weight: bold; display: flex; align-items: center; gap: 8px;">
<i class="fas fa-calendar-alt" style="color: var(--primary-blue);"></i> Filtros por Data
</h5>
<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
<div class="form-group" style="margin: 0;">
<label for="filtroAno" style="font-size: 13px; margin-bottom: 8px; font-weight: 600; color: var(--dark-gray); display: block;">
<i class="fas fa-calendar" style="color: var(--primary-blue); margin-right: 5px;"></i> Ano
</label>
<select id="filtroAno" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--gray); font-size: 14px; background-color: var(--white); transition: border-color 0.3s;">
<option value="">Todos os anos</option>
</select>
</div>
<div class="form-group" style="margin: 0;">
<label for="filtroMes" style="font-size: 13px; margin-bottom: 8px; font-weight: 600; color: var(--dark-gray); display: block;">
<i class="fas fa-calendar-alt" style="color: var(--primary-blue); margin-right: 5px;"></i> M√™s
</label>
<select id="filtroMes" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--gray); font-size: 14px; background-color: var(--white); transition: border-color 0.3s;">
<option value="">Todos os meses</option>
<option value="01">Janeiro</option>
<option value="02">Fevereiro</option>
<option value="03">Mar√ßo</option>
<option value="04">Abril</option>
<option value="05">Maio</option>
<option value="06">Junho</option>
<option value="07">Julho</option>
<option value="08">Agosto</option>
<option value="09">Setembro</option>
<option value="10">Outubro</option>
<option value="11">Novembro</option>
<option value="12">Dezembro</option>
</select>
</div>
<div class="form-group" style="margin: 0;">
<label for="filtroData" style="font-size: 13px; margin-bottom: 8px; font-weight: 600; color: var(--dark-gray); display: block;">
<i class="fas fa-calendar-day" style="color: var(--primary-blue); margin-right: 5px;"></i> Data Espec√≠fica
</label>
<input type="date" id="filtroData" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--gray); font-size: 14px; background-color: var(--white); transition: border-color 0.3s;">
</div>
</div>
</div>
<!-- Grupo 2: Filtro de Viatura -->
<div style="background-color: var(--white); padding: 15px; border-radius: 8px; border: 1px solid var(--gray); box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
<h5 style="margin: 0 0 15px 0; color: var(--dark-gray); font-size: 14px; font-weight: bold; display: flex; align-items: center; gap: 8px;">
<i class="fas fa-car" style="color: var(--primary-blue);"></i> Filtro por Viatura
</h5>
<div class="form-group" style="margin: 0;">
<label for="filtroViatura" style="font-size: 13px; margin-bottom: 8px; font-weight: 600; color: var(--dark-gray); display: block;">
<i class="fas fa-car" style="color: var(--primary-blue); margin-right: 5px;"></i> Selecione a Viatura
</label>
<select id="filtroViatura" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--gray); font-size: 14px; background-color: var(--white); transition: border-color 0.3s;">
<option value="">Todas as viaturas</option>
</select>
</div>
</div>
</div>
<div style="display: flex; gap: 10px; justify-content: flex-end; padding-top: 15px; border-top: 1px solid var(--gray);">
<button id="btnLimparFiltros" class="btn" style="padding: 10px 20px; font-size: 14px; background-color: var(--warning-orange);">
<i class="fas fa-eraser"></i> Limpar Todos os Filtros
</button>
</div>
</div>

<div class="table-container" style="border: 2px solid var(--primary-blue); box-shadow: 0 4px 12px rgba(0,0,0,0.1); flex: 1; min-height: 400px; overflow: auto;">
<table class="data-table">
<thead>
<tr>
<th style="min-width: 120px;">Viatura</th>
<th style="min-width: 130px;">Data de Sa√≠da</th>
<th style="min-width: 130px;">Data de Retorno</th>
<th style="min-width: 300px;">Descri√ß√£o</th>
<th style="min-width: 120px;">Status</th>
<th style="min-width: 100px;">A√ß√µes</th>
</tr>
</thead>
<tbody id="tabelaFinalizados">
</tbody>
</table>
<div id="emptyFinalizados" class="empty-state hidden">
<i class="fas fa-check"></i>
<p>Nenhum registro finalizado encontrado.</p>
</div>
</div>
<div class="modal-buttons">
<button id="btnFecharModal" class="btn btn-danger"><i class="fas fa-times"></i> Fechar</button>
</div>
</div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
let registrosOficina = [];
const STORAGE_KEY = 'vtr_oficina_registros';
const DB_NAME = 'SOT_VTR_Oficina';
const DB_VERSION = 1;
const STORE_NAME = 'registros';
let db = null;

// ========== INDEXEDDB HELPERS ==========

// Inicializar IndexedDB
function initDB() {
return new Promise((resolve, reject) => {
const request = indexedDB.open(DB_NAME, DB_VERSION);

request.onerror = () => {
console.error('[IndexedDB] Erro ao abrir banco de dados:', request.error);
reject(request.error);
};

request.onsuccess = () => {
db = request.result;
console.log('[IndexedDB] Banco de dados aberto com sucesso');
resolve(db);
};

request.onupgradeneeded = (event) => {
const db = event.target.result;
if (!db.objectStoreNames.contains(STORE_NAME)) {
const objectStore = db.createObjectStore(STORE_NAME, { keyPath: 'id' });
objectStore.createIndex('viatura', 'viatura', { unique: false });
objectStore.createIndex('dataSaida', 'dataSaida', { unique: false });
objectStore.createIndex('dataRetorno', 'dataRetorno', { unique: false });
console.log('[IndexedDB] Object store criado');
}
};
});
}

// Migrar dados do localStorage para IndexedDB
async function migrarDadosLocalStorage() {
try {
const stored = localStorage.getItem(STORAGE_KEY);
if (stored) {
const dados = JSON.parse(stored);
if (dados && dados.length > 0) {
console.log(`[IndexedDB] Migrando ${dados.length} registros do localStorage para IndexedDB`);
await salvarTodosRegistros(dados);
// Remover do localStorage ap√≥s migra√ß√£o bem-sucedida
localStorage.removeItem(STORAGE_KEY);
console.log('[IndexedDB] Migra√ß√£o conclu√≠da com sucesso');
return dados;
}
}
} catch (e) {
console.error('[IndexedDB] Erro na migra√ß√£o:', e);
}
return [];
}

// Salvar todos os registros de uma vez
async function salvarTodosRegistros(registros) {
return new Promise((resolve, reject) => {
if (!db) {
reject(new Error('Banco de dados n√£o inicializado'));
return;
}

const transaction = db.transaction([STORE_NAME], 'readwrite');
const store = transaction.objectStore(STORE_NAME);

// Limpar store antes de adicionar
const clearRequest = store.clear();
clearRequest.onsuccess = () => {
let adicionados = 0;
let erros = 0;

registros.forEach((registro, index) => {
const request = store.add(registro);
request.onsuccess = () => {
adicionados++;
if (adicionados + erros === registros.length) {
resolve(adicionados);
}
};
request.onerror = () => {
erros++;
console.error(`[IndexedDB] Erro ao adicionar registro ${index}:`, request.error);
if (adicionados + erros === registros.length) {
resolve(adicionados);
}
};
});
};

clearRequest.onerror = () => {
reject(clearRequest.error);
};
});
}

// Carregar todos os registros
async function carregarTodosRegistros() {
return new Promise((resolve, reject) => {
if (!db) {
resolve([]);
return;
}

const transaction = db.transaction([STORE_NAME], 'readonly');
const store = transaction.objectStore(STORE_NAME);
const request = store.getAll();

request.onsuccess = () => {
resolve(request.result || []);
};

request.onerror = () => {
console.error('[IndexedDB] Erro ao carregar registros:', request.error);
reject(request.error);
};
});
}

// Salvar um registro
async function salvarRegistro(registro) {
return new Promise((resolve, reject) => {
if (!db) {
reject(new Error('Banco de dados n√£o inicializado'));
return;
}

const transaction = db.transaction([STORE_NAME], 'readwrite');
const store = transaction.objectStore(STORE_NAME);
const request = store.put(registro);

request.onsuccess = () => {
resolve(request.result);
};

request.onerror = () => {
reject(request.error);
};
});
}

// Deletar um registro
async function deletarRegistro(id) {
return new Promise((resolve, reject) => {
if (!db) {
reject(new Error('Banco de dados n√£o inicializado'));
return;
}

const transaction = db.transaction([STORE_NAME], 'readwrite');
const store = transaction.objectStore(STORE_NAME);
const request = store.delete(String(id));

request.onsuccess = () => {
resolve();
};

request.onerror = () => {
reject(request.error);
};
});
}

// Salvar todos os registros atuais
async function salvarTodosRegistrosAtuais() {
if (registrosOficina.length === 0) {
return;
}
return await salvarTodosRegistros(registrosOficina);
}

// Elementos do formul√°rio
const viaturaSelect = document.getElementById('viaturaSelect');
const dataSaida = document.getElementById('dataSaida');
const dataRetorno = document.getElementById('dataRetorno');
const descricao = document.getElementById('descricao');
const btnSalvar = document.getElementById('btnSalvar');
const btnLimpar = document.getElementById('btnLimpar');
const btnVerFinalizados = document.getElementById('btnVerFinalizados');
const tabelaAtivos = document.getElementById('tabelaAtivos');
const tabelaFinalizados = document.getElementById('tabelaFinalizados');
const modalFinalizados = document.getElementById('modalFinalizados');
const btnFecharModal = document.getElementById('btnFecharModal');
const emptyAtivos = document.getElementById('emptyAtivos');
const emptyFinalizados = document.getElementById('emptyFinalizados');

// Carregar viaturas dispon√≠veis
function carregarViaturas() {
try {
// Preservar o valor selecionado antes de recarregar
const valorSelecionado = viaturaSelect.value;

const viaturas = JSON.parse(localStorage.getItem('viaturasCadastradas')) || [];
const motoristasVistoria = JSON.parse(localStorage.getItem('motoristasVistoria')) || [];
const todasViaturas = new Set();

// Adicionar viaturas do cadastro
viaturas.forEach(v => {
if (v.placa) todasViaturas.add(v.placa);
});

// Adicionar viaturas dos motoristas
motoristasVistoria.forEach(m => {
if (m.viaturas && Array.isArray(m.viaturas)) {
m.viaturas.forEach(placa => todasViaturas.add(placa));
}
});

viaturaSelect.innerHTML = '<option value="">-- Selecione a Viatura --</option>';
Array.from(todasViaturas).sort().forEach(placa => {
const option = document.createElement('option');
option.value = placa;
option.textContent = placa;
viaturaSelect.appendChild(option);
});

// Restaurar o valor selecionado se ainda existir na lista
if (valorSelecionado && todasViaturas.has(valorSelecionado)) {
viaturaSelect.value = valorSelecionado;
}
} catch (e) {
console.error('Erro ao carregar viaturas:', e);
}
}

// Carregar dados do IndexedDB
async function loadData() {
try {
// Inicializar IndexedDB se ainda n√£o foi inicializado
if (!db) {
await initDB();
// Tentar migrar dados do localStorage na primeira vez
await migrarDadosLocalStorage();
}

// Carregar todos os registros
registrosOficina = await carregarTodosRegistros();
console.log(`[VTR Oficina] Carregados ${registrosOficina.length} registros do IndexedDB`);
// Verificar se h√° registros finalizados
const finalizados = registrosOficina.filter(r => isFinalizado(r));
console.log(`[VTR Oficina] ${finalizados.length} registros finalizados encontrados`);
// Limpar registros antigos ao carregar
limparRegistrosAntigos();
const antesLimpeza = registrosOficina.length;
if (registrosOficina.length < antesLimpeza) {
await saveData(); // Salvar ap√≥s limpeza
}
} catch (e) {
console.error('Erro ao carregar dados:', e);
registrosOficina = [];
}
}

// Limpar registros antigos automaticamente (mais de 2 anos)
function limparRegistrosAntigos() {
const doisAnosAtras = new Date();
doisAnosAtras.setFullYear(doisAnosAtras.getFullYear() - 2);
const dataLimite = doisAnosAtras.toISOString().split('T')[0];

const antes = registrosOficina.length;
registrosOficina = registrosOficina.filter(r => {
// Manter registros ativos (sem data de retorno)
if (!r.dataRetorno || r.dataRetorno.trim() === '') {
return true;
}
// Para registros finalizados, verificar se a data de retorno √© recente
const dataRetorno = r.dataRetorno;
return dataRetorno >= dataLimite;
});

const removidos = antes - registrosOficina.length;
if (removidos > 0) {
console.log(`[VTR Oficina] ${removidos} registros antigos removidos automaticamente`);
}
}

// Verificar tamanho estimado dos dados
function estimarTamanhoDados() {
const jsonString = JSON.stringify(registrosOficina);
return new Blob([jsonString]).size; // Tamanho em bytes
}

// Salvar dados no IndexedDB
async function saveData() {
try {
// Limpar registros antigos antes de salvar
limparRegistrosAntigos();

// Inicializar IndexedDB se ainda n√£o foi inicializado
if (!db) {
await initDB();
}

// Tentar salvar
const dadosJson = JSON.stringify(registrosOficina);
const tamanho = new Blob([dadosJson]).size;
const tamanhoMB = (tamanho / (1024 * 1024)).toFixed(2);

console.log(`[VTR Oficina] Tentando salvar ${registrosOficina.length} registros (${tamanhoMB} MB)`);

await salvarTodosRegistrosAtuais();
console.log(`[VTR Oficina] ${registrosOficina.length} registros salvos no IndexedDB`);
// Verificar se h√° registros finalizados
const finalizados = registrosOficina.filter(r => isFinalizado(r));
console.log(`[VTR Oficina] ${finalizados.length} registros finalizados salvos`);
} catch (e) {
console.error('Erro ao salvar dados:', e);
// Se ainda houver erro, tentar limpeza de emerg√™ncia
if (e.name === 'QuotaExceededError' || e.name === 'UnknownError') {
// Tentar limpar mais registros antigos (mais de 1 ano)
const umAnoAtras = new Date();
umAnoAtras.setFullYear(umAnoAtras.getFullYear() - 1);
const dataLimite = umAnoAtras.toISOString().split('T')[0];

const antes = registrosOficina.length;
registrosOficina = registrosOficina.filter(r => {
if (!r.dataRetorno || r.dataRetorno.trim() === '') {
return true;
}
const dataRetorno = r.dataRetorno;
return dataRetorno >= dataLimite;
});

const removidos = antes - registrosOficina.length;
console.log(`[VTR Oficina] Limpeza de emerg√™ncia: ${removidos} registros removidos`);

// Tentar salvar novamente
try {
await salvarTodosRegistrosAtuais();
console.log(`[VTR Oficina] Dados salvos ap√≥s limpeza de emerg√™ncia`);
if (removidos > 0) {
alert(`O banco de dados estava cheio. ${removidos} registros antigos foram removidos automaticamente para liberar espa√ßo.`);
}
} catch (e2) {
console.error('Erro ao salvar ap√≥s limpeza:', e2);
alert('ERRO: N√£o foi poss√≠vel salvar os dados.\n\nPor favor, exclua alguns registros antigos manualmente.');
}
} else {
alert('Erro ao salvar dados. Verifique o console para mais detalhes.');
}
}
}

// Verificar se registro est√° finalizado
function isFinalizado(registro) {
return registro.dataRetorno && registro.dataRetorno.trim() !== '';
}

// Renderizar tabela de registros ativos
function renderTabelaAtivos() {
const ativos = registrosOficina.filter(r => !isFinalizado(r));
tabelaAtivos.innerHTML = '';

if (ativos.length === 0) {
tabelaAtivos.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #888;">Nenhuma viatura registrada na oficina no momento.</td></tr>';
emptyAtivos.classList.remove('hidden');
} else {
emptyAtivos.classList.add('hidden');
ativos.forEach((registro, index) => {
const row = document.createElement('tr');
row.innerHTML = `
<td><strong>${registro.viatura}</strong></td>
<td>${formatarData(registro.dataSaida)}</td>
<td>${registro.dataRetorno ? formatarData(registro.dataRetorno) : '<span style="color: #888;">Pendente</span>'}</td>
<td>${registro.descricao || '-'}</td>
<td><span class="status-badge ativo">ATIVO</span></td>
<td class="action-buttons">
<button class="btn btn-success btn-editar" data-id="${String(registro.id).replace(/"/g, '&quot;')}" title="Editar"><i class="fas fa-edit"></i></button>
<button class="btn btn-danger btn-excluir" data-id="${String(registro.id).replace(/"/g, '&quot;')}" title="Excluir"><i class="fas fa-trash"></i></button>
</td>
`;
tabelaAtivos.appendChild(row);
});

// Adicionar event listeners aos bot√µes
tabelaAtivos.querySelectorAll('.btn-editar').forEach(btn => {
btn.addEventListener('click', (e) => {
const id = e.currentTarget.getAttribute('data-id');
editarRegistro(id);
});
});

tabelaAtivos.querySelectorAll('.btn-excluir').forEach(btn => {
btn.addEventListener('click', (e) => {
const id = e.currentTarget.getAttribute('data-id');
excluirRegistro(id);
});
});
}
}

// Fun√ß√£o para destacar palavra em negrito
function destacarPalavra(texto, palavra) {
if (!palavra || palavra.trim() === '') {
return texto || '-';
}
if (!texto) return '-';
const regex = new RegExp(`(${palavra.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
return texto.replace(regex, '<strong style="background-color: #fff3cd; padding: 2px 4px; border-radius: 3px;">$1</strong>');
}

// Renderizar tabela de registros finalizados
function renderTabelaFinalizados() {
// Obter valores dos filtros
const filtroAno = document.getElementById('filtroAno')?.value || '';
const filtroMes = document.getElementById('filtroMes')?.value || '';
const filtroData = document.getElementById('filtroData')?.value || '';
const filtroViatura = document.getElementById('filtroViatura')?.value || '';
const filtroDescricao = document.getElementById('filtroDescricao')?.value.trim() || '';

// Filtrar registros finalizados
let finalizados = registrosOficina.filter(r => isFinalizado(r));

// Aplicar filtros
if (filtroAno) {
finalizados = finalizados.filter(r => {
const anoRetorno = r.dataRetorno ? r.dataRetorno.split('-')[0] : '';
return anoRetorno === filtroAno;
});
}

if (filtroMes) {
finalizados = finalizados.filter(r => {
const mesRetorno = r.dataRetorno ? r.dataRetorno.split('-')[1] : '';
return mesRetorno === filtroMes;
});
}

if (filtroData) {
finalizados = finalizados.filter(r => r.dataRetorno === filtroData);
}

if (filtroViatura) {
finalizados = finalizados.filter(r => r.viatura === filtroViatura);
}

if (filtroDescricao) {
const palavraBusca = filtroDescricao.toLowerCase();
finalizados = finalizados.filter(r => {
const descricao = (r.descricao || '').toLowerCase();
return descricao.includes(palavraBusca);
});
}

// Ordenar por data de retorno (mais recente primeiro)
finalizados.sort((a, b) => {
const dataA = new Date(b.dataRetorno);
const dataB = new Date(a.dataRetorno);
return dataA - dataB;
});

tabelaFinalizados.innerHTML = '';

if (finalizados.length === 0) {
tabelaFinalizados.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #888;">Nenhum registro finalizado encontrado com os filtros aplicados.</td></tr>';
emptyFinalizados.classList.remove('hidden');
} else {
emptyFinalizados.classList.add('hidden');
finalizados.forEach(registro => {
const row = document.createElement('tr');
// Destacar palavra na descri√ß√£o se houver busca
const descricaoFormatada = filtroDescricao ? destacarPalavra(registro.descricao, filtroDescricao) : (registro.descricao || '-');
row.innerHTML = `
<td><strong>${registro.viatura}</strong></td>
<td>${formatarData(registro.dataSaida)}</td>
<td>${formatarData(registro.dataRetorno)}</td>
<td style="word-wrap: break-word; max-width: 400px;">${descricaoFormatada}</td>
<td><span class="status-badge finalizado">FINALIZADO</span></td>
<td class="action-buttons">
<button class="btn btn-danger btn-excluir-finalizado" data-id="${String(registro.id).replace(/"/g, '&quot;')}" title="Excluir"><i class="fas fa-trash"></i></button>
</td>
`;
tabelaFinalizados.appendChild(row);
});

// Adicionar event listeners aos bot√µes de excluir na tabela de finalizados
tabelaFinalizados.querySelectorAll('.btn-excluir-finalizado').forEach(btn => {
btn.addEventListener('click', (e) => {
const id = e.currentTarget.getAttribute('data-id');
excluirRegistro(id);
});
});
}
}

// Carregar anos dispon√≠veis nos registros finalizados
function carregarAnosFiltro() {
const anos = new Set();
registrosOficina.filter(r => isFinalizado(r)).forEach(r => {
if (r.dataRetorno) {
const ano = r.dataRetorno.split('-')[0];
anos.add(ano);
}
});

const filtroAno = document.getElementById('filtroAno');
if (filtroAno) {
const anoAtual = filtroAno.value;
filtroAno.innerHTML = '<option value="">Todos os anos</option>';
Array.from(anos).sort((a, b) => b.localeCompare(a)).forEach(ano => {
const option = document.createElement('option');
option.value = ano;
option.textContent = ano;
filtroAno.appendChild(option);
});
if (anoAtual && anos.has(anoAtual)) {
filtroAno.value = anoAtual;
}
}
}

// Carregar viaturas no filtro
function carregarViaturasFiltro() {
const viaturas = new Set();
registrosOficina.filter(r => isFinalizado(r)).forEach(r => {
if (r.viatura) {
viaturas.add(r.viatura);
}
});

const filtroViatura = document.getElementById('filtroViatura');
if (filtroViatura) {
const viaturaAtual = filtroViatura.value;
filtroViatura.innerHTML = '<option value="">Todas as viaturas</option>';
Array.from(viaturas).sort().forEach(placa => {
const option = document.createElement('option');
option.value = placa;
option.textContent = placa;
filtroViatura.appendChild(option);
});
if (viaturaAtual && viaturas.has(viaturaAtual)) {
filtroViatura.value = viaturaAtual;
}
}
}

// Formatar data
function formatarData(dataString) {
if (!dataString) return '-';
const [ano, mes, dia] = dataString.split('-');
return `${dia}/${mes}/${ano}`;
}

// Gerar ID √∫nico
function gerarId() {
// Usar timestamp + n√∫mero aleat√≥rio para garantir unicidade
return Date.now() + '_' + Math.random().toString(36).substr(2, 9);
}

// Salvar registro
btnSalvar.addEventListener('click', async () => {
const viatura = viaturaSelect.value.trim();
const dataSaidaValue = dataSaida.value;
const dataRetornoValue = dataRetorno.value.trim();
const descricaoValue = descricao.value.trim();

if (!viatura || !dataSaidaValue || !descricaoValue) {
alert('Por favor, preencha todos os campos obrigat√≥rios.');
return;
}

// Validar data de retorno
if (dataRetornoValue && new Date(dataRetornoValue) < new Date(dataSaidaValue)) {
alert('A data de retorno n√£o pode ser anterior √† data de sa√≠da.');
return;
}

// Verificar se j√° existe registro ativo para esta viatura
const existeAtivo = registrosOficina.some(r => 
r.viatura === viatura && 
!isFinalizado(r) && 
r.id !== window.registroEditando
);

if (existeAtivo && !window.registroEditando) {
if (!confirm(`J√° existe um registro ativo para a viatura ${viatura}. Deseja continuar mesmo assim?`)) {
return;
}
}

const registro = {
id: window.registroEditando || gerarId(),
viatura: viatura,
dataSaida: dataSaidaValue,
dataRetorno: dataRetornoValue,
descricao: descricaoValue,
dataCriacao: window.registroEditando ? 
(registrosOficina.find(r => r.id === window.registroEditando)?.dataCriacao || new Date().toISOString()) :
new Date().toISOString(),
dataAtualizacao: new Date().toISOString()
};

if (window.registroEditando) {
const index = registrosOficina.findIndex(r => String(r.id) === String(window.registroEditando));
if (index !== -1) {
registrosOficina[index] = registro;
console.log(`[VTR Oficina] Registro ${window.registroEditando} atualizado`);
} else {
console.warn(`[VTR Oficina] Registro ${window.registroEditando} n√£o encontrado para edi√ß√£o, adicionando como novo`);
registrosOficina.push(registro);
}
window.registroEditando = null;
} else {
registrosOficina.push(registro);
console.log(`[VTR Oficina] Novo registro criado com ID: ${registro.id}`);
}

await saveData();
renderTabelaAtivos();
// Se o registro foi finalizado, atualizar filtros
if (dataRetornoValue && dataRetornoValue.trim() !== '') {
carregarAnosFiltro();
carregarViaturasFiltro();
}
limparFormulario();
alert('Registro salvo com sucesso!');
});

// Limpar formul√°rio
function limparFormulario() {
viaturaSelect.value = '';
dataSaida.value = '';
dataRetorno.value = '';
descricao.value = '';
window.registroEditando = null;
}

btnLimpar.addEventListener('click', limparFormulario);

// Editar registro
function editarRegistro(id) {
console.log(`[VTR Oficina] Tentando editar registro com ID: ${id} (tipo: ${typeof id})`);
console.log(`[VTR Oficina] Total de registros: ${registrosOficina.length}`);
console.log(`[VTR Oficina] IDs dispon√≠veis:`, registrosOficina.map(r => ({ id: r.id, tipo: typeof r.id })));

const registro = registrosOficina.find(r => String(r.id) === String(id));
if (!registro) {
console.warn(`[VTR Oficina] Registro ${id} n√£o encontrado para edi√ß√£o`);
alert('Registro n√£o encontrado.');
return;
}

console.log(`[VTR Oficina] Editando registro ${id}:`, registro);
viaturaSelect.value = registro.viatura;
dataSaida.value = registro.dataSaida;
dataRetorno.value = registro.dataRetorno || '';
descricao.value = registro.descricao || '';
window.registroEditando = id;

// Scroll para o formul√°rio
document.querySelector('.cadastro-form').scrollIntoView({ behavior: 'smooth' });
}

// Tornar fun√ß√£o acess√≠vel globalmente
window.editarRegistro = editarRegistro;

// Excluir registro
async function excluirRegistro(id) {
if (!confirm('Tem certeza que deseja excluir este registro?')) return;

try {
// Deletar do IndexedDB
await deletarRegistro(id);

// Remover da lista local
const antes = registrosOficina.length;
registrosOficina = registrosOficina.filter(r => String(r.id) !== String(id));
const depois = registrosOficina.length;
console.log(`[VTR Oficina] Registro ${id} exclu√≠do. Antes: ${antes}, Depois: ${depois}`);

renderTabelaAtivos();
carregarAnosFiltro();
carregarViaturasFiltro();
renderTabelaFinalizados();
alert('Registro exclu√≠do com sucesso!');
} catch (e) {
console.error('Erro ao excluir registro:', e);
alert('Erro ao excluir registro. Verifique o console para mais detalhes.');
}
}

// Tornar fun√ß√£o acess√≠vel globalmente
window.excluirRegistro = excluirRegistro;

// Fun√ß√£o para calcular e exibir estat√≠sticas
function calcularEstatisticas() {
const total = registrosOficina.length;
const ativos = registrosOficina.filter(r => !isFinalizado(r)).length;
const finalizados = registrosOficina.filter(r => isFinalizado(r)).length;

// Estat√≠sticas por viatura
const porViatura = {};
registrosOficina.forEach(r => {
if (!porViatura[r.viatura]) {
porViatura[r.viatura] = { total: 0, ativos: 0, finalizados: 0 };
}
porViatura[r.viatura].total++;
if (isFinalizado(r)) {
porViatura[r.viatura].finalizados++;
} else {
porViatura[r.viatura].ativos++;
}
});

// Top 5 viaturas com mais manuten√ß√µes
const topViaturas = Object.entries(porViatura)
.sort((a, b) => b[1].total - a[1].total)
.slice(0, 5);

// Estat√≠sticas por m√™s (√∫ltimos 12 meses)
const porMes = {};
const hoje = new Date();
for (let i = 0; i < 12; i++) {
const data = new Date(hoje.getFullYear(), hoje.getMonth() - i, 1);
const chave = `${data.getFullYear()}-${String(data.getMonth() + 1).padStart(2, '0')}`;
porMes[chave] = { total: 0, finalizados: 0 };
}

registrosOficina.forEach(r => {
if (r.dataSaida) {
const [ano, mes] = r.dataSaida.split('-');
const chave = `${ano}-${mes}`;
if (porMes[chave]) {
porMes[chave].total++;
if (isFinalizado(r)) {
porMes[chave].finalizados++;
}
}
}
});

// Tempo m√©dio de manuten√ß√£o (dias)
let tempoTotal = 0;
let contadorTempo = 0;
registrosOficina.filter(r => isFinalizado(r)).forEach(r => {
if (r.dataSaida && r.dataRetorno) {
const saida = new Date(r.dataSaida);
const retorno = new Date(r.dataRetorno);
const dias = Math.ceil((retorno - saida) / (1000 * 60 * 60 * 24));
if (dias > 0) {
tempoTotal += dias;
contadorTempo++;
}
}
});
const tempoMedio = contadorTempo > 0 ? Math.round(tempoTotal / contadorTempo) : 0;

// Viaturas atualmente na oficina
const viaturasNaOficina = registrosOficina.filter(r => !isFinalizado(r)).map(r => r.viatura);

// Manuten√ß√µes este m√™s
const mesAtual = `${hoje.getFullYear()}-${String(hoje.getMonth() + 1).padStart(2, '0')}`;
const manutencoesEsteMes = porMes[mesAtual]?.total || 0;

// Manuten√ß√µes este ano
const anoAtual = hoje.getFullYear();
const manutencoesEsteAno = registrosOficina.filter(r => {
if (r.dataSaida) {
const ano = parseInt(r.dataSaida.split('-')[0]);
return ano === anoAtual;
}
return false;
}).length;

return {
total,
ativos,
finalizados,
porViatura,
topViaturas,
porMes,
tempoMedio,
viaturasNaOficina,
manutencoesEsteMes,
manutencoesEsteAno
};
}

// Renderizar estat√≠sticas no modal
function renderEstatisticas() {
const stats = calcularEstatisticas();
const conteudo = document.getElementById('conteudoEstatisticas');
conteudo.innerHTML = '';

// Card 1: Resumo Geral
const cardResumo = document.createElement('div');
cardResumo.style.cssText = 'background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-blue) 100%); color: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);';
cardResumo.innerHTML = `
<h4 style="margin: 0 0 15px 0; font-size: 18px;"><i class="fas fa-chart-pie"></i> Resumo Geral</h4>
<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
<div>
<div style="font-size: 32px; font-weight: bold;">${stats.total}</div>
<div style="font-size: 14px; opacity: 0.9;">Total de Registros</div>
</div>
<div>
<div style="font-size: 32px; font-weight: bold;">${stats.ativos}</div>
<div style="font-size: 14px; opacity: 0.9;">Em Manuten√ß√£o</div>
</div>
<div>
<div style="font-size: 32px; font-weight: bold;">${stats.finalizados}</div>
<div style="font-size: 14px; opacity: 0.9;">Finalizadas</div>
</div>
<div>
<div style="font-size: 32px; font-weight: bold;">${stats.tempoMedio}</div>
<div style="font-size: 14px; opacity: 0.9;">Dias M√©dios</div>
</div>
</div>
`;
conteudo.appendChild(cardResumo);

// Card 2: Este M√™s/Ano
const cardPeriodo = document.createElement('div');
cardPeriodo.style.cssText = 'background: var(--white); padding: 20px; border-radius: 12px; border: 2px solid var(--primary-blue); box-shadow: 0 4px 12px rgba(0,0,0,0.1);';
cardPeriodo.innerHTML = `
<h4 style="margin: 0 0 15px 0; color: var(--primary-blue); font-size: 18px;"><i class="fas fa-calendar-alt"></i> Per√≠odo Atual</h4>
<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
<div style="text-align: center; padding: 15px; background: var(--light-gray-bg); border-radius: 8px;">
<div style="font-size: 28px; font-weight: bold; color: var(--primary-blue);">${stats.manutencoesEsteMes}</div>
<div style="font-size: 14px; color: var(--dark-gray);">Este M√™s</div>
</div>
<div style="text-align: center; padding: 15px; background: var(--light-gray-bg); border-radius: 8px;">
<div style="font-size: 28px; font-weight: bold; color: var(--primary-blue);">${stats.manutencoesEsteAno}</div>
<div style="font-size: 14px; color: var(--dark-gray);">Este Ano</div>
</div>
</div>
`;
conteudo.appendChild(cardPeriodo);

// Card 3: Top 5 Viaturas
const cardTopViaturas = document.createElement('div');
cardTopViaturas.style.cssText = 'background: var(--white); padding: 20px; border-radius: 12px; border: 2px solid var(--primary-blue); box-shadow: 0 4px 12px rgba(0,0,0,0.1);';
let topViaturasHtml = '<h4 style="margin: 0 0 15px 0; color: var(--primary-blue); font-size: 18px;"><i class="fas fa-trophy"></i> Top 5 Viaturas</h4>';
if (stats.topViaturas.length > 0) {
topViaturasHtml += '<div style="display: flex; flex-direction: column; gap: 10px;">';
stats.topViaturas.forEach(([viatura, dados], index) => {
const medalha = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : 'üèÖ';
topViaturasHtml += `
<div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--light-gray-bg); border-radius: 8px;">
<div>
<span style="font-size: 20px; margin-right: 10px;">${medalha}</span>
<strong>${viatura}</strong>
</div>
<div style="text-align: right;">
<div style="font-size: 18px; font-weight: bold; color: var(--primary-blue);">${dados.total}</div>
<small style="color: #666;">${dados.ativos} ativas, ${dados.finalizados} finalizadas</small>
</div>
</div>
`;
});
topViaturasHtml += '</div>';
} else {
topViaturasHtml += '<p style="color: #888; text-align: center;">Nenhuma viatura com manuten√ß√µes registradas.</p>';
}
cardTopViaturas.innerHTML = topViaturasHtml;
conteudo.appendChild(cardTopViaturas);

// Card 4: Viaturas na Oficina
const cardNaOficina = document.createElement('div');
cardNaOficina.style.cssText = 'background: var(--white); padding: 20px; border-radius: 12px; border: 2px solid var(--warning-orange); box-shadow: 0 4px 12px rgba(0,0,0,0.1);';
let naOficinaHtml = `<h4 style="margin: 0 0 15px 0; color: var(--warning-orange); font-size: 18px;"><i class="fas fa-wrench"></i> Viaturas na Oficina (${stats.viaturasNaOficina.length})</h4>`;
if (stats.viaturasNaOficina.length > 0) {
naOficinaHtml += '<div style="display: flex; flex-wrap: wrap; gap: 10px;">';
stats.viaturasNaOficina.forEach(viatura => {
naOficinaHtml += `<span style="padding: 8px 15px; background: var(--warning-orange); color: white; border-radius: 20px; font-weight: bold;">${viatura}</span>`;
});
naOficinaHtml += '</div>';
} else {
naOficinaHtml += '<p style="color: var(--success-green); text-align: center; font-weight: bold;">‚úì Nenhuma viatura na oficina no momento</p>';
}
cardNaOficina.innerHTML = naOficinaHtml;
conteudo.appendChild(cardNaOficina);

// Card 5: Manuten√ß√µes por M√™s (√∫ltimos 6 meses)
const cardPorMes = document.createElement('div');
cardPorMes.style.cssText = 'background: var(--white); padding: 20px; border-radius: 12px; border: 2px solid var(--primary-blue); box-shadow: 0 4px 12px rgba(0,0,0,0.1); grid-column: 1 / -1;';
const mesesNomes = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
let porMesHtml = '<h4 style="margin: 0 0 15px 0; color: var(--primary-blue); font-size: 18px;"><i class="fas fa-chart-line"></i> Manuten√ß√µes por M√™s (√öltimos 6 Meses)</h4>';
porMesHtml += '<div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px;">';
const mesesOrdenados = Object.entries(stats.porMes).sort((a, b) => b[0].localeCompare(a[0])).slice(0, 6);
mesesOrdenados.forEach(([chave, dados]) => {
const [ano, mes] = chave.split('-');
const nomeMes = mesesNomes[parseInt(mes) - 1];
porMesHtml += `
<div style="text-align: center; padding: 15px; background: var(--light-gray-bg); border-radius: 8px;">
<div style="font-size: 24px; font-weight: bold; color: var(--primary-blue);">${dados.total}</div>
<div style="font-size: 12px; color: var(--dark-gray);">${nomeMes}/${ano.slice(-2)}</div>
<small style="color: #666;">${dados.finalizados} finalizadas</small>
</div>
`;
});
porMesHtml += '</div>';
cardPorMes.innerHTML = porMesHtml;
conteudo.appendChild(cardPorMes);
}

// Abrir modal de estat√≠sticas
const btnEstatisticas = document.getElementById('btnEstatisticas');
const modalEstatisticas = document.getElementById('modalEstatisticas');
const btnFecharEstatisticas = document.getElementById('btnFecharEstatisticas');

if (btnEstatisticas) {
btnEstatisticas.addEventListener('click', async () => {
await loadData();
renderEstatisticas();
modalEstatisticas.classList.add('show');
});
}

if (btnFecharEstatisticas) {
btnFecharEstatisticas.addEventListener('click', () => {
modalEstatisticas.classList.remove('show');
});
}

if (modalEstatisticas) {
modalEstatisticas.addEventListener('click', (e) => {
if (e.target === modalEstatisticas) {
modalEstatisticas.classList.remove('show');
}
});
}

// Abrir modal de finalizados
btnVerFinalizados.addEventListener('click', async () => {
// Recarregar dados antes de abrir o modal para garantir que est√° atualizado
await loadData();
carregarAnosFiltro();
carregarViaturasFiltro();
renderTabelaFinalizados();
modalFinalizados.classList.add('show');
});


// Fechar modal
btnFecharModal.addEventListener('click', () => {
modalFinalizados.classList.remove('show');
});

// Fechar modal ao clicar fora
modalFinalizados.addEventListener('click', (e) => {
if (e.target === modalFinalizados) {
modalFinalizados.classList.remove('show');
}
});

// Event listeners para filtros
const filtroAno = document.getElementById('filtroAno');
const filtroMes = document.getElementById('filtroMes');
const filtroData = document.getElementById('filtroData');
const filtroViatura = document.getElementById('filtroViatura');
const filtroDescricao = document.getElementById('filtroDescricao');
const btnLimparFiltros = document.getElementById('btnLimparFiltros');

if (filtroAno) {
filtroAno.addEventListener('change', () => {
renderTabelaFinalizados();
});
}

if (filtroMes) {
filtroMes.addEventListener('change', () => {
renderTabelaFinalizados();
});
}

if (filtroData) {
filtroData.addEventListener('change', () => {
renderTabelaFinalizados();
});
}

if (filtroViatura) {
filtroViatura.addEventListener('change', () => {
renderTabelaFinalizados();
});
}

// Event listener para busca na descri√ß√£o (busca em tempo real)
if (filtroDescricao) {
filtroDescricao.addEventListener('input', () => {
renderTabelaFinalizados();
});
// Tamb√©m funciona com Enter
filtroDescricao.addEventListener('keypress', (e) => {
if (e.key === 'Enter') {
e.preventDefault();
renderTabelaFinalizados();
}
});
}

// Limpar filtros
if (btnLimparFiltros) {
btnLimparFiltros.addEventListener('click', () => {
if (filtroAno) filtroAno.value = '';
if (filtroMes) filtroMes.value = '';
if (filtroData) filtroData.value = '';
if (filtroViatura) filtroViatura.value = '';
if (filtroDescricao) filtroDescricao.value = '';
renderTabelaFinalizados();
});
}

// Listener para data de retorno - marcar como finalizado automaticamente
dataRetorno.addEventListener('change', () => {
if (dataRetorno.value && dataRetorno.value.trim() !== '') {
// Valida√ß√£o j√° feita no bot√£o salvar
}
});

// Inicializa√ß√£o
carregarViaturas();
(async () => {
await loadData();
renderTabelaAtivos();
})();

// Atualizar lista de viaturas periodicamente
setInterval(carregarViaturas, 5000);
});
</script>

<script>
// Notifica o SOT5 sobre atividade do usu√°rio para resetar o cron√¥metro de inatividade
const userActivityEvents = ['mousemove', 'mousedown', 'keypress', 'scroll', 'touchstart'];
function notifyParentOfActivity() {
window.parent.postMessage({ type: 'user_activity' }, '*');
}
userActivityEvents.forEach(eventName => {
document.addEventListener(eventName, notifyParentOfActivity, { passive: true });
});
</script>
</body>
</html>

