<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Vistoria de Viaturas - Sistema Integrado</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.21/jspdf.plugin.autotable.min.js"></script>
<script src="theme-listener.js"></script>
<style>
:root {
--primary-blue: #4a69bd;
--secondary-blue: #6c88c9;
--gray: #dcdcdc;
--dark-gray: #333d47;
--white: #ffffff;
--light-gray-bg: #f9f9f9;
--tab-inactive-bg: #e9ecef;
--tab-active-bg: var(--white);
--tab-border: 1px solid #dee2e6;
--delete-red: #dc3545;
--success-green: #28a745;
--darker-green: #218838;
--warning-red: #dc3545;
--warning-orange: #ffa500;
--light-blue-bg: #eaf0ff;
--pdf-button-gray: #6c757d;
--pdf-button-hover: #5a6268;
 --tab-text-color: var(--dark-gray);
 --tab-text-color-active: var(--white);
 --tab-text-color-hover: var(--tab-text-color);
 --tab-hover-bg: #dcdcdc;
 --tab-border-color: #ccc;
 --tab-border-color-active: var(--primary-blue);
}
* { box-sizing: border-box; }
body { font-family: 'Arial', sans-serif; margin: 0; padding: 0; background-color: var(--light-gray-bg); color: var(--dark-gray); font-weight: 500; min-height: 100vh; }
.container { max-width: 1200px; margin: 0 auto; padding: 20px; }
.tabs { display: flex; border-bottom: 2px solid var(--primary-blue); margin-bottom: 20px; background-color: var(--white); border-radius: 8px 8px 0 0; overflow: hidden; }
.tabs a { text-decoration: none; color: inherit; flex: 1; display: flex; }
.tab-button { background-color: var(--tab-inactive-bg); color: var(--tab-text-color); border: none; padding: 15px 25px; cursor: pointer; font-size: 16px; font-weight: bold; transition: all 0.3s ease; flex: 1; display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; }
.tab-button:hover:not(.active) { background-color: var(--tab-hover-bg); color: var(--tab-text-color-hover); }
.tab-button.active { background-color: var(--primary-blue); color: #ffffff !important; }
.tab-button.active i { color: #ffffff !important; }
.tab-content { display: none; background-color: var(--white); padding: 30px; border-radius: 0 0 8px 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
.tab-content.active { display: block; }
.page-title { font-size: 28px; color: var(--primary-blue); text-align: center; font-weight: bold; margin: 0 0 30px 0; display: flex; align-items: center; justify-content: center; gap: 10px; }
.hidden { display: none !important; }
.cadastro-form { background-color: var(--light-blue-bg); border: 2px solid var(--primary-blue); border-radius: 12px; padding: 20px; display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; }
.calendar-header { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid var(--tab-border); background-color: var(--primary-blue); color: var(--white); border-radius: 10px 10px 0 0; }
.calendar-header button { background: none; border: none; color: var(--white); font-size: 20px; cursor: pointer; transition: all 0.3s ease; }
.calendar-header h3 { margin: 0; font-size: 18px; }
.calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; padding: 10px; }
.calendar-day, .calendar-weekday { text-align: center; padding: 12px 0; height: 40px; display: flex; justify-content: center; align-items: center; font-weight: bold; border-radius: 8px; transition: background-color 0.2s, transform 0.2s; }
.calendar-weekday { color: var(--primary-blue); font-size: 14px; cursor: default; }
.calendar-day { background-color: var(--light-gray-bg); cursor: pointer; color: var(--dark-gray); }
.calendar-day:hover { background-color: var(--gray); transform: translateY(-2px); }
.calendar-day.today { border: 2px solid var(--primary-blue); box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); font-weight: bold; }
.calendar-day.daily-goal-met { background-color: var(--success-green); color: var(--white); }
.calendar-day.daily-goal-missed { background-color: var(--warning-orange); }
.calendar-day.daily-goal-not-met { background-color: var(--delete-red); color: var(--white); }
.calendar-legend { display: flex; justify-content: center; align-items: center; flex-wrap: wrap; gap: 20px; margin-top: 20px; padding: 10px; background-color: var(--light-gray-bg); border-radius: 8px; }
.legend-item { display: flex; align-items: center; gap: 8px; font-size: 14px; }
.legend-color { width: 20px; height: 20px; border-radius: 50%; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
.legend-color.green { background-color: var(--success-green); }
.legend-color.orange { background-color: var(--warning-orange); }
.legend-color.red { background-color: var(--delete-red); }
.checklist-form { display: flex; flex-direction: column; gap: 20px; }
.check-item { background-color: var(--white); padding: 15px; border-radius: 8px; border: 1px solid var(--tab-border); box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); }
.check-item-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
.check-item-header label { font-weight: bold; color: var(--primary-blue); }
.check-options { display: flex; gap: 15px; align-items: center; }
.annotation-textarea { width: 100%; padding: 8px; border: 1px solid var(--gray); border-radius: 4px; resize: vertical; margin-top: 10px; }
.modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); justify-content: center; align-items: center; }
.modal.show { display: flex; }
.modal-content { background-color: var(--white); padding: 40px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3); width: 90%; max-width: 550px; text-align: center; animation: modalSlideIn 0.3s ease; }
@keyframes modalSlideIn { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
.modal-content h3 { color: var(--primary-blue); margin-bottom: 25px; font-size: 20px; }
.modal-buttons { display: flex; justify-content: center; gap: 20px; margin-top: 25px; }
.btn { background-color: var(--primary-blue); color: var(--white); border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; transition: background-color 0.3s ease; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
.btn:hover { background-color: var(--secondary-blue); }
.btn-success { background-color: var(--success-green); }
.btn-danger { background-color: var(--delete-red); }
.btn-warning { background-color: var(--warning-orange); }
.btn.vehicle-btn.inspected { background-color: var(--success-green); border: 1px solid var(--darker-green); }
.btn.vehicle-btn.inspected:hover { background-color: var(--darker-green); }
.vehicle-actions { display: flex; gap: 5px; align-items: center; }
.pdf-btn { padding: 10px 12px; background-color: var(--pdf-button-gray); }
.pdf-btn:hover { background-color: var(--pdf-button-hover); }
.admin-form-container { display: flex; flex-direction: column; gap: 15px; text-align: left; }
.admin-form-container label { font-weight: bold; color: var(--dark-gray); margin-bottom: -10px; }
.admin-form-container select, .admin-form-container input { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--gray); font-size: 16px; }

/* Modal Relat√≥rio Preenchido - Estilo moderno */
#filledReportModal .modal-content {
  max-width: 560px;
  padding: 0;
  border-radius: 20px;
  overflow: hidden;
  box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
  text-align: left;
  border: 1px solid rgba(74, 105, 189, 0.15);
}
#filledReportModal .filled-report-header {
  background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-blue) 100%);
  color: var(--white);
  padding: 24px 28px;
}
#filledReportModal .filled-report-header h3 {
  margin: 0;
  font-size: 1.35rem;
  font-weight: 700;
  letter-spacing: -0.02em;
  display: flex;
  align-items: center;
  gap: 12px;
  color: inherit;
}
#filledReportModal .filled-report-header h3 i {
  opacity: 0.95;
  font-size: 1.25rem;
}
#filledReportModal .filled-report-subtitle {
  margin: 8px 0 0 0;
  font-size: 0.9rem;
  font-weight: 400;
  opacity: 0.9;
  letter-spacing: 0.01em;
}
#filledReportModal .filled-report-body {
  padding: 24px 28px 20px;
  background-color: var(--white);
}
#filledReportModal .filled-report-select-all {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 14px 18px;
  background-color: var(--light-gray-bg);
  border-radius: 12px;
  margin-bottom: 16px;
  cursor: pointer;
  border: 1px solid var(--gray);
  transition: background-color 0.2s ease, border-color 0.2s ease;
}
#filledReportModal .filled-report-select-all:hover {
  background-color: #eef1f5;
  border-color: var(--secondary-blue);
}
#filledReportModal .filled-report-select-all input[type="checkbox"] {
  width: 20px;
  height: 20px;
  accent-color: var(--primary-blue);
  cursor: pointer;
}
#filledReportModal .filled-report-select-all span {
  font-size: 0.95rem;
  font-weight: 600;
  color: var(--dark-gray);
  letter-spacing: 0.01em;
}
#filledReportModal #filledVehiclesList {
  max-height: 320px;
  overflow-y: auto;
  padding: 4px;
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 10px;
  background: var(--white);
  border-radius: 12px;
  border: 1px solid var(--gray);
  scrollbar-width: thin;
  scrollbar-color: var(--primary-blue) var(--light-gray-bg);
}
#filledReportModal #filledVehiclesList::-webkit-scrollbar {
  width: 8px;
}
#filledReportModal #filledVehiclesList::-webkit-scrollbar-track {
  background: var(--light-gray-bg);
  border-radius: 4px;
}
#filledReportModal #filledVehiclesList::-webkit-scrollbar-thumb {
  background: var(--secondary-blue);
  border-radius: 4px;
}
#filledReportModal .filled-vehicle-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 14px 16px;
  cursor: pointer;
  background: var(--white);
  border: 1px solid var(--gray);
  border-radius: 10px;
  transition: background-color 0.2s, border-color 0.2s, box-shadow 0.2s;
  box-shadow: 0 1px 3px rgba(0,0,0,0.04);
}
#filledReportModal .filled-vehicle-item:hover {
  background-color: var(--light-blue-bg);
  border-color: var(--secondary-blue);
  box-shadow: 0 2px 8px rgba(74, 105, 189, 0.12);
}
#filledReportModal .filled-vehicle-item input[type="checkbox"] {
  width: 18px;
  height: 18px;
  accent-color: var(--primary-blue);
  cursor: pointer;
  flex-shrink: 0;
}
#filledReportModal .filled-vehicle-item .filled-vehicle-plate {
  font-size: 0.95rem;
  font-weight: 600;
  color: var(--dark-gray);
  letter-spacing: 0.02em;
  display: flex;
  align-items: center;
  gap: 8px;
}
#filledReportModal .filled-vehicle-item .filled-vehicle-plate i {
  color: var(--primary-blue);
  font-size: 0.9rem;
}
#filledReportModal .filled-report-footer {
  padding: 20px 28px 24px;
  background-color: var(--light-gray-bg);
  border-top: 1px solid var(--gray);
  display: flex;
  justify-content: flex-end;
  gap: 12px;
}
#filledReportModal .filled-report-footer .btn {
  padding: 12px 24px;
  border-radius: 10px;
  font-size: 0.95rem;
  font-weight: 600;
  letter-spacing: 0.02em;
}

/* Modal Impress√£o em Massa - Estilo moderno */
#batchPrintModal .modal-content {
  max-width: 560px;
  padding: 0;
  border-radius: 20px;
  overflow: hidden;
  box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
  text-align: left;
  border: 1px solid rgba(74, 105, 189, 0.15);
}
#batchPrintModal .batch-report-header {
  background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-blue) 100%);
  color: var(--white);
  padding: 24px 28px;
}
#batchPrintModal .batch-report-header h3 {
  margin: 0;
  font-size: 1.35rem;
  font-weight: 700;
  letter-spacing: -0.02em;
  display: flex;
  align-items: center;
  gap: 12px;
  color: inherit;
}
#batchPrintModal .batch-report-header h3 i {
  opacity: 0.95;
  font-size: 1.25rem;
}
#batchPrintModal .batch-report-subtitle {
  margin: 8px 0 0 0;
  font-size: 0.9rem;
  font-weight: 400;
  opacity: 0.9;
  letter-spacing: 0.01em;
}
#batchPrintModal .batch-report-body {
  padding: 24px 28px 20px;
  background-color: var(--white);
}
#batchPrintModal .batch-period-section label {
  display: block;
  font-size: 0.875rem;
  font-weight: 600;
  color: var(--dark-gray);
  margin-bottom: 6px;
  letter-spacing: 0.01em;
}
#batchPrintModal .batch-period-row {
  display: flex;
  gap: 12px;
  margin-bottom: 16px;
}
#batchPrintModal .batch-period-row > div {
  flex: 1;
}
#batchPrintModal .batch-period-row input[type="date"] {
  width: 100%;
  padding: 12px 14px;
  border: 1px solid var(--gray);
  border-radius: 10px;
  font-size: 0.95rem;
  background: var(--white);
}
#batchPrintModal #loadBatchDatesBtn {
  width: 100%;
  padding: 14px 20px;
  border-radius: 10px;
  font-weight: 600;
  letter-spacing: 0.02em;
  margin-bottom: 20px;
}
#batchPrintModal .batch-dates-list-wrap {
  border: 1px solid var(--gray);
  border-radius: 12px;
  overflow: hidden;
  background: var(--light-gray-bg);
}
#batchPrintModal .batch-select-all-wrap {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 14px 18px;
  background: var(--white);
  border-bottom: 1px solid var(--gray);
  cursor: pointer;
  transition: background-color 0.2s ease;
}
#batchPrintModal .batch-select-all-wrap:hover {
  background-color: var(--light-gray-bg);
}
#batchPrintModal .batch-select-all-wrap input[type="checkbox"] {
  width: 20px;
  height: 20px;
  accent-color: var(--primary-blue);
  cursor: pointer;
}
#batchPrintModal .batch-select-all-wrap span {
  font-size: 0.95rem;
  font-weight: 600;
  color: var(--dark-gray);
  letter-spacing: 0.01em;
}
#batchPrintModal .batch-dates-list-wrap {
  padding: 0;
}
#batchPrintModal .batch-dates-scroll {
  max-height: 300px;
  overflow-y: auto;
  padding: 12px;
  scrollbar-width: thin;
  scrollbar-color: var(--primary-blue) var(--light-gray-bg);
}
#batchPrintModal .batch-dates-scroll::-webkit-scrollbar {
  width: 8px;
}
#batchPrintModal .batch-dates-scroll::-webkit-scrollbar-track {
  background: var(--light-gray-bg);
  border-radius: 4px;
}
#batchPrintModal .batch-dates-scroll::-webkit-scrollbar-thumb {
  background: var(--secondary-blue);
  border-radius: 4px;
}
#batchPrintModal .batch-date-group {
  margin-bottom: 14px;
  padding: 14px 16px;
  background: var(--white);
  border-radius: 10px;
  border: 1px solid rgba(255, 165, 0, 0.35);
  box-shadow: 0 1px 3px rgba(0,0,0,0.04);
}
#batchPrintModal .batch-date-group:last-child {
  margin-bottom: 0;
}
#batchPrintModal .batch-date-header {
  font-weight: 700;
  margin-bottom: 12px;
  color: var(--warning-orange);
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 0.95rem;
  letter-spacing: 0.02em;
}
#batchPrintModal .batch-inspection-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 10px 12px;
  cursor: pointer;
  border-radius: 8px;
  transition: background-color 0.2s, border-color 0.2s;
  border: 1px solid transparent;
  margin-bottom: 4px;
}
#batchPrintModal .batch-inspection-item:last-child {
  margin-bottom: 0;
}
#batchPrintModal .batch-inspection-item:hover {
  background-color: var(--light-blue-bg);
}
#batchPrintModal .batch-inspection-item input[type="checkbox"] {
  width: 18px;
  height: 18px;
  accent-color: var(--primary-blue);
  cursor: pointer;
  flex-shrink: 0;
}
#batchPrintModal .batch-inspection-item .batch-inspection-label {
  font-size: 0.9rem;
  color: var(--dark-gray);
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
}
#batchPrintModal .batch-inspection-item .batch-inspection-label i {
  color: var(--primary-blue);
}
#batchPrintModal .batch-inspection-item .batch-inspection-label strong {
  font-weight: 600;
}
#batchPrintModal .batch-inspection-item .batch-inspection-badge {
  color: var(--warning-orange);
  font-size: 0.75rem;
  font-weight: 500;
  margin-left: 2px;
}
#batchPrintModal #batchSummary {
  margin-top: 16px;
  padding: 16px 18px;
  background: var(--light-blue-bg);
  border-radius: 12px;
  border: 1px solid rgba(74, 105, 189, 0.2);
}
#batchPrintModal #batchSummary p {
  margin: 0;
  font-size: 0.95rem;
  font-weight: 600;
  color: var(--dark-gray);
  letter-spacing: 0.01em;
}
#batchPrintModal #batchSummary #totalPdfsCount {
  color: var(--primary-blue);
  font-weight: 700;
}
#batchPrintModal .batch-report-footer {
  padding: 20px 28px 24px;
  background-color: var(--light-gray-bg);
  border-top: 1px solid var(--gray);
  display: flex;
  justify-content: flex-end;
  flex-wrap: wrap;
  gap: 12px;
}
#batchPrintModal .batch-report-footer .btn {
  padding: 12px 24px;
  border-radius: 10px;
  font-size: 0.95rem;
  font-weight: 600;
  letter-spacing: 0.02em;
}
</style>
</head>
<body>
<div class="container">
<div class="tabs">
<a href="vistoriar.html"><button class="tab-button active"><i class="fas fa-car"></i> Vistoriar Viatura</button></a>
<a href="historico.html"><button class="tab-button"><i class="fas fa-history"></i> Hist√≥rico</button></a>
<a href="situacao.html"><button class="tab-button"><i class="fas fa-info-circle"></i> Situa√ß√£o</button></a>
<a href="responsabilidades.html"><button class="tab-button"><i class="fas fa-users"></i> Responsabilidades</button></a>
<a href="vtr-oficina.html"><button class="tab-button"><i class="fas fa-tools"></i> Registro de Manuten√ß√µes</button></a>
</div>
<div id="scheduling" class="tab-content active">
<h1 class="page-title"><i class="fas fa-car"></i> Vistoriar Viatura</h1>
<div id="initialFormContainer" class="cadastro-form">
<div id="calendarContainer" class="cadastro-form" style="border:none; padding: 0; margin-bottom: 0;">
<div class="calendar-header">
<button id="prevMonthBtn"><i class="fas fa-chevron-left"></i></button>
<h3 id="monthYear"></h3>
<button id="nextMonthBtn"><i class="fas fa-chevron-right"></i></button>
</div>
<div class="calendar-grid"></div>
</div>
<div class="calendar-legend">
<div class="legend-item"><div class="legend-color green"></div><span>Todas Vistoriadas</span></div>
<div class="legend-item"><div class="legend-color orange"></div><span>Vistorias Pendentes</span></div>
<div class="legend-item"><div class="legend-color red"></div><span>Nenhuma Vistoria</span></div>
</div>
<div style="text-align: center; margin-top: 15px; border-top: 2px solid var(--primary-blue); padding-top: 15px; display: flex; gap: 10px; justify-content: center;">
<button id="adminInspectionBtn" class="btn"><i class="fas fa-user-shield"></i> Vistoria Administrativa</button>
<button id="batchPrintBtn" class="btn" style="background-color: var(--pdf-button-gray);"><i class="fas fa-print"></i> Impress√£o em Massa</button>
</div>
</div>
<div id="checklistContainer" class="checklist-container hidden cadastro-form">
<div class="checklist-form-header">
<h3 id="checklistTitle" style="text-align:center; color: var(--primary-blue); width:100%;"></h3>
</div>
<div id="checklistForm" class="checklist-form"></div>
<div style="text-align: center; margin-top: 20px; display: flex; justify-content: center; gap: 10px;">
<button id="saveInspectionBtn" class="btn btn-success"><i class="fas fa-save"></i> Salvar</button>
<button id="printInspectionBtn" class="btn" style="background-color: var(--pdf-button-gray);"><i class="fas fa-print"></i> Imprimir</button>
<button id="cancelInspectionBtn" class="btn btn-danger"><i class="fas fa-times"></i> Cancelar</button>
</div>
</div>
</div>
</div>
<div id="driverSelectionModal" class="modal">
<div class="modal-content">
<h3 id="driverSelectionModalTitle"></h3>
<div id="driverSelectionModalContent" style="max-height: 400px; overflow-y: auto;"></div>
<div class="modal-buttons">
<button id="closeDriverSelectionModal" class="btn btn-danger"><i class="fas fa-times"></i> Fechar</button>
</div>
</div>
</div>
<div id="typeSelectionModal" class="modal">
<div class="modal-content">
<h3>Tipo de Vistoria</h3>
<div class="modal-buttons">
<button id="abordoBtn" class="btn btn-success"><i class="fas fa-car"></i> A Bordo</button>
<button id="workshopBtn" class="btn btn-warning"><i class="fas fa-tools"></i> Oficina</button>
<button id="destacadaBtn" class="btn" style="background-color: #6c757d;"><i class="fas fa-flag"></i> Destacada</button>
</div>
</div>
</div>
<div id="adminSelectionModal" class="modal">
<div class="modal-content">
<h3>Vistoria Administrativa</h3>
<div class="admin-form-container">
<label for="adminDriverSelect">Selecione o Motorista:</label>
<select id="adminDriverSelect"></select>
<label for="adminVehicleSelect">Selecione a Viatura:</label>
<select id="adminVehicleSelect"></select>
<label for="adminDateSelect">Data da Vistoria:</label>
<input type="date" id="adminDateSelect">
</div>
<div class="modal-buttons">
<button id="startAdminInspectionBtn" class="btn btn-success"><i class="fas fa-play"></i> Iniciar Vistoria</button>
<button id="generateAdminPdfBtn" class="btn pdf-btn"><i class="fas fa-file-pdf"></i> Gerar PDF</button>
<button id="closeAdminSelectionModal" class="btn btn-danger"><i class="fas fa-times"></i> Fechar</button>
</div>
</div>
</div>
<div id="destacadaLocationModal" class="modal">
<div class="modal-content">
<h3><i class="fas fa-flag"></i> Viatura Destacada</h3>
<div class="admin-form-container">
<label for="destacadaLocationInput">Informe o Local de Destaque:</label>
<input type="text" id="destacadaLocationInput" placeholder="Ex: Opera√ß√£o Centro, Apoio Evento, etc." style="width: 100%;">
</div>
<div class="modal-buttons">
<button id="confirmDestacadaBtn" class="btn btn-success"><i class="fas fa-check"></i> Confirmar</button>
<button id="cancelDestacadaBtn" class="btn btn-danger"><i class="fas fa-times"></i> Cancelar</button>
</div>
</div>
</div>
<div id="batchPrintModal" class="modal">
<div class="modal-content">
<header class="batch-report-header">
<h3><i class="fas fa-print"></i> Impress√£o em massa</h3>
<p class="batch-report-subtitle">Gere PDFs em branco das vistorias n√£o realizadas no per√≠odo.</p>
</header>
<div class="batch-report-body">
<section class="batch-period-section">
<label>Selecione o per√≠odo</label>
<div class="batch-period-row">
<div>
<label for="batchStartDate">Data inicial</label>
<input type="date" id="batchStartDate">
</div>
<div>
<label for="batchEndDate">Data final</label>
<input type="date" id="batchEndDate">
</div>
</div>
<button id="loadBatchDatesBtn" class="btn">
<i class="fas fa-search"></i> Buscar vistorias n√£o realizadas
</button>
</section>
<div id="batchDatesList" class="batch-dates-list-wrap" style="display: none;">
<label class="batch-select-all-wrap">
<input type="checkbox" id="selectAllDates">
<span>Selecionar todas as datas</span>
</label>
<div class="batch-dates-scroll">
<div id="datesCheckboxContainer"></div>
</div>
</div>
<div id="batchSummary" style="display: none;">
<p>Total de PDFs a gerar: <span id="totalPdfsCount">0</span></p>
</div>
</div>
<footer class="batch-report-footer">
<button id="closeBatchPrintModal" class="btn btn-danger"><i class="fas fa-times"></i> Fechar</button>
<button id="openFilledReportBtn" class="btn" style="background-color: var(--secondary-blue);"><i class="fas fa-file-pdf"></i> Imprimir relat√≥rio preenchido</button>
<button id="generateBatchPdfsBtn" class="btn btn-success" style="display: none;"><i class="fas fa-print"></i> Imprimir selecionados</button>
</footer>
</div>
</div>
<div id="filledReportModal" class="modal">
<div class="modal-content">
<header class="filled-report-header">
<h3><i class="fas fa-file-pdf"></i> Relat√≥rio preenchido</h3>
<p class="filled-report-subtitle">Selecione as viaturas para gerar o PDF com as vistorias j√° realizadas.</p>
</header>
<div class="filled-report-body">
<label class="filled-report-select-all">
<input type="checkbox" id="selectAllFilledVehicles">
<span>Selecionar todas as viaturas</span>
</label>
<div id="filledVehiclesList"></div>
</div>
<footer class="filled-report-footer">
<button id="closeFilledReportModal" class="btn btn-danger"><i class="fas fa-times"></i> Fechar</button>
<button id="printFilledReportBtn" class="btn btn-success"><i class="fas fa-print"></i> Imprimir</button>
</footer>
</div>
</div>
<script>
document.addEventListener('DOMContentLoaded', () => {
let inspectionDrivers = [], inspections = [], currentInspection = {}, currentDate = new Date(), selectedDateForVistoria = null;
// Elementos da UI principal
const initialFormContainer = document.getElementById('initialFormContainer'), calendarContainer = document.getElementById('calendarContainer'), monthYearHeader = document.getElementById('monthYear'), calendarGrid = document.querySelector('.calendar-grid'), prevMonthBtn = document.getElementById('prevMonthBtn'), nextMonthBtn = document.getElementById('nextMonthBtn'), checklistContainer = document.getElementById('checklistContainer'), checklistTitle = document.getElementById('checklistTitle'), checklistForm = document.getElementById('checklistForm'), saveInspectionBtn = document.getElementById('saveInspectionBtn'), printInspectionBtn = document.getElementById('printInspectionBtn'), cancelInspectionBtn = document.getElementById('cancelInspectionBtn');
// Elementos dos Modais
const typeSelectionModal = document.getElementById('typeSelectionModal'), driverSelectionModal = document.getElementById('driverSelectionModal'), abordoBtn = document.getElementById('abordoBtn'), workshopBtn = document.getElementById('workshopBtn'), destacadaBtn = document.getElementById('destacadaBtn'), closeDriverSelectionModal = document.getElementById('closeDriverSelectionModal');
// Elementos do Modal de Destacada
const destacadaLocationModal = document.getElementById('destacadaLocationModal'), destacadaLocationInput = document.getElementById('destacadaLocationInput'), confirmDestacadaBtn = document.getElementById('confirmDestacadaBtn'), cancelDestacadaBtn = document.getElementById('cancelDestacadaBtn');
// Elementos da NOVA funcionalidade (Vistoria Administrativa)
const adminInspectionBtn = document.getElementById('adminInspectionBtn'), adminSelectionModal = document.getElementById('adminSelectionModal'), adminDriverSelect = document.getElementById('adminDriverSelect'), adminVehicleSelect = document.getElementById('adminVehicleSelect'), adminDateSelect = document.getElementById('adminDateSelect'), startAdminInspectionBtn = document.getElementById('startAdminInspectionBtn'), generateAdminPdfBtn = document.getElementById('generateAdminPdfBtn'), closeAdminSelectionModal = document.getElementById('closeAdminSelectionModal');
const PDF_CHECKLIST_ITEMS = [ 
{ label: "N√≠vel do √ìleo, √Ågua, Flu√≠dos de Freio e Dire√ß√£o" }, 
{ label: "Calibragem e estado dos Pneus" }, 
{ label: "El√©trica e Luzes" }, 
{ label: "Sirene (Luzes e Som)" }, 
{ label: "Documenta√ß√£o" }, 
{ label: "Tri√¢ngulo, Macaco e Chave de Roda" }, 
{ label: "Limpeza Interna e Externa" }, 
{ label: "Lanternagem Geral" }, 
{ label: "Outros" } 
];

// NOVA FUN√á√ÉO: Salva a lista de itens de vistoria no localStorage
function saveChecklistItemsToLocalStorage() {
try {
const itemNames = PDF_CHECKLIST_ITEMS.map(item => item.label);
localStorage.setItem('itensVistoria', JSON.stringify(itemNames));
console.log('Lista de itens de vistoria salva no localStorage:', itemNames);
} catch (e) {
console.error('Erro ao salvar itens de vistoria:', e);
}
}

function renderCalendar() {
const year = currentDate.getFullYear();
const month = currentDate.getMonth();
const monthNames = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
monthYearHeader.textContent = `${monthNames[month]} de ${year}`;
calendarGrid.innerHTML = ``;
["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "S√°b"].forEach(day => {
const weekdayEl = document.createElement('span');
weekdayEl.className = 'calendar-weekday';
weekdayEl.textContent = day;
calendarGrid.appendChild(weekdayEl);
});
const firstDayOfMonth = new Date(year, month, 1).getDay();
const daysInMonth = new Date(year, month + 1, 0).getDate();
for (let i = 0; i < firstDayOfMonth; i++) {
calendarGrid.appendChild(document.createElement('div'));
}
for (let day = 1; day <= daysInMonth; day++) {
const dayCell = document.createElement('div');
dayCell.classList.add('calendar-day');
dayCell.textContent = day;
const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
dayCell.setAttribute('data-date', dateString);
if (new Date(year, month, day).toDateString() === new Date().toDateString()) {
dayCell.classList.add('today');
}
const driversOnDuty = getDriversOnDutyForDate(dateString);
const totalRequiredInspections = driversOnDuty.reduce((sum, driver) => sum + (driver.viaturas ? driver.viaturas.length : 0), 0);
if (totalRequiredInspections > 0) {
const inspectionsOnDay = inspections.filter(i => i.data === dateString && i.tipo !== 'administrativa');
const completedInspectionsCount = inspectionsOnDay.length;
if (completedInspectionsCount >= totalRequiredInspections) {
dayCell.classList.add('daily-goal-met');
} else if (completedInspectionsCount > 0) {
dayCell.classList.add('daily-goal-missed');
} else {
dayCell.classList.add('daily-goal-not-met');
}
}
calendarGrid.appendChild(dayCell);
}
}

function onCalendarDayClick(selectedDate) {
selectedDateForVistoria = selectedDate;
const driversOnDuty = getDriversOnDutyForDate(selectedDate);
const modalContent = document.getElementById('driverSelectionModalContent');
const modalTitle = document.getElementById('driverSelectionModalTitle');
modalContent.innerHTML = '';
modalTitle.textContent = `Servi√ßo do dia: ${formatDate(selectedDate)}`;
if (driversOnDuty.length === 0) {
modalContent.innerHTML = '<p>Nenhum motorista na escala para esta data.</p>';
} else {
driversOnDuty.forEach(driver => {
const driverContainer = document.createElement('div');
driverContainer.style.cssText = "margin-bottom: 15px; padding: 10px; border-bottom: 1px solid #ddd; text-align: left;";
let vehiclesHtml = '<p style="font-size: 14px; margin-top: 5px; color: #777;">Nenhuma viatura associada.</p>';
if (driver.viaturas && driver.viaturas.length > 0) {
vehiclesHtml = driver.viaturas.map(placa => {
const isInspected = inspections.some(insp => insp.placa === placa && insp.data === selectedDate);
const inspectButton = isInspected ?
`<button class="btn vehicle-btn inspected" data-driver="${driver.nome}" data-vehicle="${placa}" title="Vistoriada">${placa}</button>` :
`<button class="btn vehicle-btn" style="background-color: var(--secondary-blue);" data-driver="${driver.nome}" data-vehicle="${placa}">${placa}</button>`;
const pdfButton = `<button class="btn pdf-btn" data-driver="${driver.nome}" data-vehicle="${placa}" title="Gerar PDF em branco"><i class="fas fa-file-pdf"></i></button>`;
return `<div class="vehicle-actions">${inspectButton}${pdfButton}</div>`;
}).join('');
}
driverContainer.innerHTML = `<h4><i class="fas fa-user"></i> ${driver.nome}</h4><div style="display: flex; flex-direction: column; gap: 10px; justify-content: flex-start; margin-top: 10px;">${vehiclesHtml}</div>`;
modalContent.appendChild(driverContainer);
});
}
driverSelectionModal.classList.add('show');
document.querySelectorAll('.vehicle-btn').forEach(button => {
button.addEventListener('click', (e) => {
const startInspectionFlow = () => {
const btn = e.currentTarget;
currentInspection = { motorista: btn.dataset.driver, placa: btn.dataset.vehicle, data: selectedDateForVistoria, tipo: 'regular' };
driverSelectionModal.classList.remove('show');
typeSelectionModal.classList.add('show');
};
if (e.currentTarget.classList.contains('inspected')) {
if (confirm("Esta viatura j√° foi vistoriada.\nDeseja vistoriar novamente?\n\n(A vistoria anterior ser√° substitu√≠da)")) {
startInspectionFlow();
}
} else {
startInspectionFlow();
}
});
});
document.querySelectorAll('.pdf-btn').forEach(button => {
button.addEventListener('click', (e) => {
const btn = e.currentTarget;
generateInspectionPdf(btn.dataset.driver, btn.dataset.vehicle, selectedDateForVistoria);
});
});
}

function initiateInspection() {
initialFormContainer.classList.add('hidden');
checklistContainer.classList.remove('hidden');
checklistTitle.textContent = `Vistoria da Viatura ${currentInspection.placa}`;
checklistForm.innerHTML = '';
const pendingIssues = getPendingIssues(currentInspection.placa);
let formHtml = '';
PDF_CHECKLIST_ITEMS.forEach((item, index) => {
const pendingNote = pendingIssues.get(item.label);
const isOkChecked = pendingNote ? '' : 'checked';
const isAnotacaoChecked = pendingNote ? 'checked' : '';
const textareaClass = pendingNote ? 'annotation-textarea' : 'annotation-textarea hidden';
const textareaValue = pendingNote ? pendingNote : '';
formHtml += `<div class="check-item"><div class="check-item-header"><label><i class="fas fa-check-circle"></i> ${item.label}</label></div><div class="check-options"><input type="radio" id="item-${index}-ok" name="item-${index}" value="ok" ${isOkChecked}><label for="item-${index}-ok" style="margin-right: 15px;">OK</label><input type="radio" id="item-${index}-anotacao" name="item-${index}" value="anotacao" ${isAnotacaoChecked}><label for="item-${index}-anotacao">Anota√ß√£o</label></div><textarea id="anotacao-text-${index}" class="${textareaClass}" placeholder="Detalhes da anota√ß√£o">${textareaValue}</textarea></div>`;
});
checklistForm.innerHTML = formHtml;
checklistForm.querySelectorAll('input[type="radio"]').forEach(radio => {
radio.addEventListener('change', (e) => {
const textarea = e.target.closest('.check-item').querySelector('.annotation-textarea');
textarea.classList.toggle('hidden', e.target.value !== 'anotacao');
});
});

function printInspectionForm() {
    const printWindow = window.open('', '_blank', 'width=900,height=700');
    if (!printWindow) {
        alert('N√£o foi poss√≠vel abrir a janela de impress√£o.');
        return;
    }
    const title = checklistTitle ? checklistTitle.textContent : 'Vistoria';
    const content = checklistForm ? checklistForm.innerHTML : '';
    printWindow.document.write(`
        <html>
            <head>
                <title>${title}</title>
                <style>
                    body { font-family: Arial, sans-serif; padding: 20px; color: #333; }
                    h2 { text-align: center; color: #4a69bd; margin-bottom: 20px; }
                    .check-item { border: 1px solid #ddd; border-radius: 8px; padding: 12px; margin-bottom: 12px; }
                    .check-item-header { font-weight: bold; margin-bottom: 8px; }
                    .check-options { margin-bottom: 6px; }
                    .annotation-textarea { width: 100%; min-height: 60px; border: 1px solid #ccc; border-radius: 6px; padding: 8px; }
                    input[type="radio"] { margin-right: 6px; }
                </style>
            </head>
            <body>
                <h2>${title}</h2>
                ${content}
            </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.focus();
    printWindow.onload = () => {
        printWindow.print();
    };
}
}

function generateInspectionPdf(driverName, vehiclePlate, dateString) {
if (!driverName || !vehiclePlate || !dateString) {
alert("Selecione motorista, viatura e data para gerar o PDF.");
return;
}
const { jsPDF } = window.jspdf;
const doc = new jsPDF();
doc.setFont("helvetica", "bold");
doc.setFontSize(16);
doc.text("Vistoria de Viaturas", 105, 20, { align: 'center' });
doc.setFont("helvetica", "normal");
doc.setFontSize(12);
const headerY = 35;
doc.text(`Data: ${formatDate(dateString)}`, 15, headerY);
doc.text(`Viatura: ${vehiclePlate}`, 75, headerY);
doc.text(`Motorista: ${driverName}`, 135, headerY);
let y = 55;
doc.setFont("helvetica", "bold");
doc.setFontSize(11);
doc.text("Marcar se a viatura estiver na OFICINA:", 15, y);
doc.setFont("helvetica", "normal");
doc.text("( ) SIM", 100, y);
doc.setLineWidth(0.2);
doc.line(15, y + 10, 195, y + 10);
y += 20;
PDF_CHECKLIST_ITEMS.forEach(item => {
doc.setFontSize(11);
doc.text(`${item.label}:`, 15, y);
let checkboxText = "( ) OK ( ) Altera√ß√£o";
if (item.label.includes("Sirene")) {
checkboxText += " ( ) N√£o se Aplica";
}
doc.text(checkboxText, 100, y);
doc.setLineWidth(0.2);
doc.line(15, y + 10, 195, y + 10);
y += 20;
});
const signatureY = 260;
doc.setLineWidth(0.5);
doc.line(75, signatureY, 135, signatureY);
doc.setFont("helvetica", "normal");
doc.text(driverName, 105, signatureY + 8, { align: 'center' });
const observationY = signatureY + 20;
doc.setFont("helvetica", "bold");
doc.setFontSize(10);
doc.text("Observa√ß√£o:", 15, observationY);
doc.setFont("helvetica", "normal");
doc.setFontSize(9);
const observationText = "Os itens descritos que se enquadrem fora do primeiro escal√£o, s√£o meramente informativos, n√£o responsabilizando o vistoriador por poss√≠veis intercorr√™ncias";
const splitText = doc.splitTextToSize(observationText, 180);
doc.text(splitText, 15, observationY + 6);
doc.save(`vistoria_${vehiclePlate}_${dateString}.pdf`);
}

function printInspectionPdf(driverName, vehiclePlate, dateString) {
if (!driverName || !vehiclePlate || !dateString) {
alert("Selecione motorista, viatura e data para imprimir.");
return;
}
const { jsPDF } = window.jspdf;
const doc = new jsPDF();
doc.setFont("helvetica", "bold");
doc.setFontSize(16);
doc.text("Vistoria de Viaturas", 105, 20, { align: 'center' });
doc.setFont("helvetica", "normal");
doc.setFontSize(12);
const headerY = 35;
doc.text(`Data: ${formatDate(dateString)}`, 15, headerY);
doc.text(`Viatura: ${vehiclePlate}`, 75, headerY);
doc.text(`Motorista: ${driverName}`, 135, headerY);
let y = 55;
doc.setFont("helvetica", "bold");
doc.setFontSize(11);
doc.text("Marcar se a viatura estiver na OFICINA:", 15, y);
doc.setFont("helvetica", "normal");
doc.text("( ) SIM", 100, y);
doc.setLineWidth(0.2);
doc.line(15, y + 10, 195, y + 10);
y += 20;
PDF_CHECKLIST_ITEMS.forEach(item => {
doc.setFontSize(11);
doc.text(`${item.label}:`, 15, y);
let checkboxText = "( ) OK ( ) Altera√ß√£o";
if (item.label.includes("Sirene")) {
checkboxText += " ( ) N√£o se Aplica";
}
doc.text(checkboxText, 100, y);
doc.setLineWidth(0.2);
doc.line(15, y + 10, 195, y + 10);
y += 20;
});
const signatureY = 260;
doc.setLineWidth(0.5);
doc.line(75, signatureY, 135, signatureY);
doc.setFont("helvetica", "normal");
doc.text(driverName, 105, signatureY + 8, { align: 'center' });
const observationY = signatureY + 20;
doc.setFont("helvetica", "bold");
doc.setFontSize(10);
doc.text("Observa√ß√£o:", 15, observationY);
doc.setFont("helvetica", "normal");
doc.setFontSize(9);
const observationText = "Os itens descritos que se enquadrem fora do primeiro escal√£o, s√£o meramente informativos, n√£o responsabilizando o vistoriador por poss√≠veis intercorr√™ncias";
const splitText = doc.splitTextToSize(observationText, 180);
doc.text(splitText, 15, observationY + 6);

// Adicionar p√°gina com situa√ß√£o da viatura
addSituationPageToPdf(doc, vehiclePlate);

// Fazer download do PDF
doc.save(`vistoria_${vehiclePlate}_${dateString}.pdf`);
}

function printBatchInspections(inspectionsList) {
if (!inspectionsList || inspectionsList.length === 0) {
alert("Nenhuma vistoria selecionada.");
return;
}

console.log('üñ®Ô∏è === INICIANDO IMPRESS√ÉO EM MASSA ===');
console.log('Total de vistorias selecionadas:', inspectionsList.length);

const { jsPDF } = window.jspdf;
const doc = new jsPDF();
let isFirstPage = true;

// Carregar dados de impress√£o da aba Situa√ß√£o
const imprimirItems = loadImprimirItems();
console.log('üìã Configura√ß√µes de impress√£o carregadas:', imprimirItems);
console.log('üìä Total de configura√ß√µes:', Object.keys(imprimirItems).length);

inspectionsList.forEach((inspection, index) => {
const { driver, vehicle, date } = inspection;

// Adicionar nova p√°gina para cada vistoria (exceto a primeira)
if (!isFirstPage) {
doc.addPage();
} else {
isFirstPage = false;
}

// Cabe√ßalho
doc.setFont("helvetica", "bold");
doc.setFontSize(16);
doc.text("Vistoria de Viaturas", 105, 20, { align: 'center' });
doc.setFont("helvetica", "normal");
doc.setFontSize(12);
const headerY = 35;
doc.text(`Data: ${formatDate(date)}`, 15, headerY);
doc.text(`Viatura: ${vehicle}`, 75, headerY);
doc.text(`Motorista: ${driver}`, 135, headerY);

// Oficina
let y = 55;
doc.setFont("helvetica", "bold");
doc.setFontSize(11);
doc.text("Marcar se a viatura estiver na OFICINA:", 15, y);
doc.setFont("helvetica", "normal");
doc.text("( ) SIM", 100, y);
doc.setLineWidth(0.2);
doc.line(15, y + 10, 195, y + 10);
y += 20;

// Itens do checklist
PDF_CHECKLIST_ITEMS.forEach(item => {
doc.setFontSize(11);
doc.text(`${item.label}:`, 15, y);
let checkboxText = "( ) OK ( ) Altera√ß√£o";
if (item.label.includes("Sirene")) {
checkboxText += " ( ) N√£o se Aplica";
}
doc.text(checkboxText, 100, y);
doc.setLineWidth(0.2);
doc.line(15, y + 10, 195, y + 10);
y += 20;
});

// Assinatura
const signatureY = 260;
doc.setLineWidth(0.5);
doc.line(75, signatureY, 135, signatureY);
doc.setFont("helvetica", "normal");
doc.text(driver, 105, signatureY + 8, { align: 'center' });

// Observa√ß√£o
const observationY = signatureY + 20;
doc.setFont("helvetica", "bold");
doc.setFontSize(10);
doc.text("Observa√ß√£o:", 15, observationY);
doc.setFont("helvetica", "normal");
doc.setFontSize(9);
const observationText = "Os itens descritos que se enquadrem fora do primeiro escal√£o, s√£o meramente informativos, n√£o responsabilizando o vistoriador por poss√≠veis intercorr√™ncias";
const splitText = doc.splitTextToSize(observationText, 180);
doc.text(splitText, 15, observationY + 6);

// Adicionar p√°gina com situa√ß√£o da viatura (com filtro de impress√£o)
console.log(`\nüìÑ Processando viatura ${index + 1}/${inspectionsList.length}: ${vehicle}`);
addSituationPageToPdfWithFilter(doc, vehicle, imprimirItems);
});

// Fazer download do PDF em lote
const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
console.log('\n‚úÖ PDF gerado com sucesso!');
console.log('üñ®Ô∏è === FIM DA IMPRESS√ÉO EM MASSA ===\n');
doc.save(`vistorias_lote_${timestamp}.pdf`);
}

function saveWorkshopInspection() {
const { placa, data } = currentInspection;
inspections = inspections.filter(insp => !(insp.placa === placa && insp.data === data));
const workshopResult = { item: "Status da Viatura", status: "OFICINA", nota: "OFICINA", resolvido: false };
inspections.push({
id: `insp_${Date.now()}`,
...currentInspection,
status: 'OFICINA',
resultados: [workshopResult]
});
refreshUIAndData();
alert(`Viatura ${placa} registrada como "Em Oficina".`);
}

function saveDestacadaInspection(localDestaque) {
const { placa, data, motorista } = currentInspection;
inspections = inspections.filter(insp => !(insp.placa === placa && insp.data === data));
const notaDestacada = localDestaque ? `Viatura Destacada - Local: ${localDestaque}` : "Viatura Destacada - N√£o sofreu vistoria";
const destacadaResult = { item: "Status da Viatura", status: "DESTACADA", nota: notaDestacada, resolvido: false };
inspections.push({
id: `insp_${Date.now()}`,
...currentInspection,
status: 'DESTACADA',
localDestaque: localDestaque || '',
resultados: [destacadaResult]
});
refreshUIAndData();
const mensagem = localDestaque ? 
`Viatura ${placa} registrada como "Destacada".\nLocal: ${localDestaque}\nA viatura n√£o sofreu vistoria.` :
`Viatura ${placa} registrada como "Destacada".\nA viatura n√£o sofreu vistoria.`;
alert(mensagem);
}

function formatDate(d) { if (!d) return ''; const [y, m, day] = d.split('-'); return `${day}/${m}/${y}`; }

function getVehicleSituation(vehiclePlate) {
// NOVA L√ìGICA: Usar a mesma abordagem da aba Situa√ß√£o
// Pega apenas a √∫ltima vistoria da viatura
const vehicleInspections = inspections
.filter(insp => insp.placa === vehiclePlate && insp.status !== 'OFICINA')
.sort((a, b) => new Date(b.data) - new Date(a.data));

const lastInspection = vehicleInspections.length > 0 ? vehicleInspections[0] : null;
const pendingIssues = [];

// Se houver √∫ltima vistoria, pegar apenas os problemas pendentes dela
if (lastInspection && lastInspection.resultados) {
lastInspection.resultados.forEach(result => {
if (result.nota && result.nota.trim() !== '' && result.resolvido === false) {
pendingIssues.push({
item: result.item,
nota: result.nota,
data: lastInspection.data,
status: result.status,
placa: lastInspection.placa,
motorista: lastInspection.motorista
});
}
});
}

console.log(`üìä Situa√ß√£o da viatura ${vehiclePlate}:`);
console.log(`   √öltima vistoria: ${lastInspection ? lastInspection.data : 'Nenhuma'}`);
console.log(`   Problemas pendentes (total): ${pendingIssues.length}`);

return {
placa: vehiclePlate,
pendingIssues: pendingIssues,
lastInspection: lastInspection
};
}

function loadImprimirItems() {
try {
return JSON.parse(localStorage.getItem('imprimirItems') || '{}');
} catch (e) {
console.error('Erro ao carregar itens para impress√£o:', e);
return {};
}
}

function addSituationPageToPdfWithFilter(doc, vehiclePlate, imprimirItems) {
// Adicionar nova p√°gina para situa√ß√£o
doc.addPage();

const situation = getVehicleSituation(vehiclePlate);

console.log('=== DEBUG IMPRESS√ÉO ===');
console.log('Viatura:', vehiclePlate);
console.log('Total de problemas pendentes:', situation.pendingIssues.length);
console.log('Configura√ß√£o de impress√£o completa:', imprimirItems);
console.log('Total de configura√ß√µes:', Object.keys(imprimirItems).length);

// Filtrar apenas problemas marcados para impress√£o
const printableIssues = situation.pendingIssues.filter(issue => {
// Usar a placa do issue se dispon√≠vel, sen√£o usar vehiclePlate
const placa = issue.placa || vehiclePlate;
const uniqueId = `${placa}_${issue.item}_${issue.nota}`.replace(/\s/g, '_').replace(/[^\w-]/g, '');
const configValue = imprimirItems[uniqueId];
// L√ìGICA CORRETA: S√≥ imprime se estiver explicitamente marcado como true
const shouldPrint = configValue === true;
console.log(`\nüìå Item: ${issue.item}`);
console.log(`   Placa: ${placa}`);
console.log(`   Nota: ${issue.nota.substring(0, 40)}...`);
console.log(`   Data: ${issue.data}`);
console.log(`   UniqueId: ${uniqueId}`);
console.log(`   Config: ${configValue} | Imprimir: ${shouldPrint}`);
return shouldPrint;
});

console.log('Total de problemas para imprimir:', printableIssues.length);
console.log('=======================');

// Cabe√ßalho
doc.setFont("helvetica", "bold");
doc.setFontSize(16);
doc.text("Situa\u00e7\u00e3o Atual da Viatura", 105, 20, { align: 'center' });

doc.setFont("helvetica", "normal");
doc.setFontSize(12);
doc.text(`Viatura: ${vehiclePlate}`, 105, 35, { align: 'center' });

let y = 50;

// √öltima vistoria
if (situation.lastInspection) {
doc.setFont("helvetica", "bold");
doc.setFontSize(11);
doc.text(`\u00daltima Vistoria: ${formatDate(situation.lastInspection.data)}`, 15, y);
y += 10;
}

y += 5;
doc.setLineWidth(0.5);
doc.line(15, y, 195, y);
y += 15;

// Problemas pendentes
doc.setFont("helvetica", "bold");
doc.setFontSize(14);
doc.text("Problemas Pendentes:", 15, y);
y += 10;

if (printableIssues.length === 0) {
doc.setFont("helvetica", "normal");
doc.setFontSize(11);
doc.setTextColor(40, 167, 69); // Verde
doc.text("\u2713 Nenhum problema pendente", 15, y);
doc.setTextColor(0, 0, 0); // Voltar para preto
y += 10;
} else {
doc.setFont("helvetica", "normal");
doc.setFontSize(10);

printableIssues.forEach((issue, index) => {
if (y > 270) {
// Se estiver perto do fim da p√°gina, adicionar nova p√°gina
doc.addPage();
y = 20;
}

// Item
doc.setFont("helvetica", "bold");
doc.setTextColor(220, 53, 69); // Vermelho
doc.text(`${index + 1}. ${issue.item}`, 15, y);
y += 7;

// Nota/Descri√ß√£o
doc.setFont("helvetica", "normal");
doc.setTextColor(0, 0, 0);
const notaLines = doc.splitTextToSize(`   ${issue.nota}`, 175);
doc.text(notaLines, 15, y);
y += (notaLines.length * 5) + 3;

// Data
doc.setFont("helvetica", "italic");
doc.setFontSize(9);
doc.setTextColor(100, 100, 100);
doc.text(`   Registrado em: ${formatDate(issue.data)}`, 15, y);
doc.setTextColor(0, 0, 0);
doc.setFontSize(10);
y += 10;
});
}

// Rodap√©
if (y < 260) {
y = 270;
}
doc.setLineWidth(0.3);
doc.line(15, y, 195, y);
y += 7;
doc.setFont("helvetica", "italic");
doc.setFontSize(9);
doc.setTextColor(100, 100, 100);
doc.text("Este documento apresenta a situa\u00e7\u00e3o atual da viatura com base nas vistorias registradas.", 105, y, { align: 'center' });
doc.setTextColor(0, 0, 0);
}

function addSituationPageToPdf(doc, vehiclePlate) {
// Vers√£o wrapper que carrega os dados de impress√£o e chama a fun√ß√£o com filtro
const imprimirItems = loadImprimirItems();
addSituationPageToPdfWithFilter(doc, vehiclePlate, imprimirItems);
}

function loadData() {
inspectionDrivers = JSON.parse(localStorage.getItem('motoristasVistoria') || '[]');
inspections = JSON.parse(localStorage.getItem('vistorias') || '[]');
}

function saveData() { localStorage.setItem('vistorias', JSON.stringify(inspections)); }

function refreshUIAndData() { saveData(); loadData(); checklistContainer.classList.add('hidden'); initialFormContainer.classList.remove('hidden'); renderCalendar(); }

function getPendingIssues(placa) {
const pending = new Map();
const vehicleInspections = inspections.filter(insp => insp.placa === placa).sort((a, b) => new Date(a.data) - new Date(b.data));
for (const inspection of vehicleInspections) {
if (inspection.resultados) {
for (const result of inspection.resultados) {
if (result.nota && !result.resolvido) {
pending.set(result.item, result.nota);
} else if (result.nota === null || result.resolvido) {
pending.delete(result.item);
}
}
}
}
return pending;
}

function getDriversOnDutyForDate(date) {
const [year, month, day] = date.split('-'), escalaKey = `${year}-${month}`, dayOfMonth = parseInt(day, 10);
try {
const escalaData = JSON.parse(localStorage.getItem(escalaKey) || '{}');
if (!escalaData.members) return [];
const driversOnDutyNames = [];
escalaData.members.forEach(memberRow => {
if (memberRow[dayOfMonth] && memberRow[dayOfMonth].toUpperCase() === 'S') driversOnDutyNames.push(memberRow[0]);
});
return inspectionDrivers.filter(driver => driversOnDutyNames.includes(driver.nome));
} catch (e) { console.error("Erro na escala:", e); return []; }
}

prevMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); });
nextMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); });
calendarGrid.addEventListener('click', (event) => { const day = event.target.closest('.calendar-day'); if(day) onCalendarDayClick(day.getAttribute('data-date')); });
abordoBtn.addEventListener('click', () => { typeSelectionModal.classList.remove('show'); initiateInspection(); });
workshopBtn.addEventListener('click', () => { typeSelectionModal.classList.remove('show'); saveWorkshopInspection(); });
destacadaBtn.addEventListener('click', () => { 
typeSelectionModal.classList.remove('show'); 
destacadaLocationInput.value = '';
destacadaLocationInput.focus();
destacadaLocationModal.classList.add('show');
});

confirmDestacadaBtn.addEventListener('click', () => {
const localDestaque = destacadaLocationInput.value.trim();
if (!localDestaque) {
if (!confirm('Nenhum local foi informado.\n\nDeseja continuar sem informar o local de destaque?')) {
return;
}
}
destacadaLocationModal.classList.remove('show');
saveDestacadaInspection(localDestaque);
});

cancelDestacadaBtn.addEventListener('click', () => {
destacadaLocationModal.classList.remove('show');
typeSelectionModal.classList.add('show');
});
closeDriverSelectionModal.addEventListener('click', () => driverSelectionModal.classList.remove('show'));

saveInspectionBtn.addEventListener('click', () => {
const { placa, data } = currentInspection;
const newInspectionResults = [];
PDF_CHECKLIST_ITEMS.forEach((item, index) => {
const radioAnotacao = document.getElementById(`item-${index}-anotacao`);
const textarea = document.getElementById(`anotacao-text-${index}`);
if (radioAnotacao.checked && textarea.value.trim() !== '') {
newInspectionResults.push({ item: item.label, status: 'Anota√ß√£o', nota: textarea.value.trim(), resolvido: false });
} else {
newInspectionResults.push({ item: item.label, status: 'OK', nota: null, resolvido: true });
}
});

if (printInspectionBtn) {
    printInspectionBtn.addEventListener('click', (e) => {
        e.preventDefault();
        printInspectionForm();
    });
}
newInspectionResults.forEach(currentResult => {
if (currentResult.resolvido) {
inspections.forEach(pastInspection => {
if (pastInspection.placa === placa && pastInspection.resultados) {
pastInspection.resultados.forEach(pastResult => {
if (pastResult.item === currentResult.item && !pastResult.resolvido) {
pastResult.resolvido = true;
}
});
}
});
}
});
inspections = inspections.filter(insp => !(insp.placa === placa && insp.data === data));
const newInspection = {
id: `insp_${Date.now()}`,
...currentInspection,
status: 'CONCLUIDA',
resultados: newInspectionResults
};
inspections.push(newInspection);
refreshUIAndData();
alert('Vistoria salva com sucesso!');
});

cancelInspectionBtn.addEventListener('click', () => { if (confirm('Cancelar e descartar altera√ß√µes?')) { refreshUIAndData(); } });

adminInspectionBtn.addEventListener('click', () => {
adminDriverSelect.innerHTML = '<option value="">-- Selecione --</option>';
inspectionDrivers.forEach(driver => {
adminDriverSelect.innerHTML += `<option value="${driver.nome}">${driver.nome}</option>`;
});
const allVehicles = new Set(inspectionDrivers.flatMap(d => d.viaturas || []));
adminVehicleSelect.innerHTML = '<option value="">-- Selecione --</option>';
allVehicles.forEach(placa => {
adminVehicleSelect.innerHTML += `<option value="${placa}">${placa}</option>`;
});
adminDateSelect.value = new Date().toISOString().split('T')[0];
adminSelectionModal.classList.add('show');
});

startAdminInspectionBtn.addEventListener('click', () => {
const motorista = adminDriverSelect.value;
const placa = adminVehicleSelect.value;
const data = adminDateSelect.value;
if (!motorista || !placa || !data) {
alert('Por favor, preencha todos os campos.');
return;
}
currentInspection = { motorista, placa, data, tipo: 'administrativa' };
adminSelectionModal.classList.remove('show');
typeSelectionModal.classList.add('show');
});

generateAdminPdfBtn.addEventListener('click', () => {
generateInspectionPdf(adminDriverSelect.value, adminVehicleSelect.value, adminDateSelect.value);
});

closeAdminSelectionModal.addEventListener('click', () => adminSelectionModal.classList.remove('show'));

// NOVA FUNCIONALIDADE: Impress√£o em Massa
const batchPrintBtn = document.getElementById('batchPrintBtn');
const batchPrintModal = document.getElementById('batchPrintModal');
const closeBatchPrintModal = document.getElementById('closeBatchPrintModal');
const batchStartDate = document.getElementById('batchStartDate');
const batchEndDate = document.getElementById('batchEndDate');
const loadBatchDatesBtn = document.getElementById('loadBatchDatesBtn');
const batchDatesList = document.getElementById('batchDatesList');
const datesCheckboxContainer = document.getElementById('datesCheckboxContainer');
const selectAllDates = document.getElementById('selectAllDates');
const generateBatchPdfsBtn = document.getElementById('generateBatchPdfsBtn');
const totalPdfsCount = document.getElementById('totalPdfsCount');
const batchSummary = document.getElementById('batchSummary');
const openFilledReportBtn = document.getElementById('openFilledReportBtn');
const filledReportModal = document.getElementById('filledReportModal');
const filledVehiclesList = document.getElementById('filledVehiclesList');
const selectAllFilledVehicles = document.getElementById('selectAllFilledVehicles');
const printFilledReportBtn = document.getElementById('printFilledReportBtn');
const closeFilledReportModal = document.getElementById('closeFilledReportModal');

let selectedInspectionsForBatch = [];

function getAllVehiclesForFilledReport() {
const fromDrivers = inspectionDrivers.flatMap(d => d.viaturas || []);
const fromInspections = inspections.map(i => i.placa).filter(Boolean);
return Array.from(new Set([...fromDrivers, ...fromInspections])).sort();
}

function getLatestInspectionByPlate(plate) {
return inspections
    .filter(insp => insp.placa === plate && insp.status !== 'OFICINA')
    .sort((a, b) => new Date(b.data) - new Date(a.data))[0];
}

function addFilledInspectionPage(doc, inspection) {
doc.setFont("helvetica", "bold");
doc.setFontSize(16);
doc.text("Vistoria de Viaturas", 105, 20, { align: 'center' });
doc.setFont("helvetica", "normal");
doc.setFontSize(12);
const headerY = 35;
doc.text(`Data: ${formatDate(inspection.data)}`, 15, headerY);
doc.text(`Viatura: ${inspection.placa}`, 75, headerY);
doc.text(`Motorista: ${inspection.motorista || '---'}`, 135, headerY);
let y = 55;
doc.setFont("helvetica", "bold");
doc.setFontSize(11);
doc.text("Marcar se a viatura estiver na OFICINA:", 15, y);
doc.setFont("helvetica", "normal");
doc.text(inspection.status === 'OFICINA' ? "(X) SIM" : "( ) SIM", 100, y);
doc.setLineWidth(0.2);
doc.line(15, y + 10, 195, y + 10);
y += 20;

PDF_CHECKLIST_ITEMS.forEach((item, index) => {
const result = inspection.resultados?.find(r => r.item === item.label);
const isAnotacao = result && result.status === 'Anota√ß√£o';
doc.setFontSize(11);
doc.setFont("helvetica", "bold");
doc.text(`${item.label}:`, 15, y);
doc.setFont("helvetica", "normal");
let checkboxText = isAnotacao ? "( ) OK (X) Altera√ß√£o" : "(X) OK ( ) Altera√ß√£o";
if (item.label.includes("Sirene")) {
checkboxText += " ( ) N√£o se Aplica";
}
doc.text(checkboxText, 125, y);
y += 7;
if (isAnotacao) {
doc.setFontSize(9);
const noteLines = doc.splitTextToSize(`Observa√ß√£o: ${result.nota || 'Anota√ß√£o'}`, 180);
doc.text(noteLines, 15, y);
y += noteLines.length * 4 + 6;
} else {
doc.setLineWidth(0.2);
doc.line(15, y + 3, 195, y + 3);
y += 14;
}
if (y > 240 && index < PDF_CHECKLIST_ITEMS.length - 1) {
doc.addPage();
y = 20;
}
});
}

function addBlankInspectionPage(doc, plate) {
const today = new Date().toISOString().split('T')[0];
doc.setFont("helvetica", "bold");
doc.setFontSize(16);
doc.text("Vistoria de Viaturas", 105, 20, { align: 'center' });
doc.setFont("helvetica", "normal");
doc.setFontSize(12);
const headerY = 35;
doc.text(`Data: ${formatDate(today)}`, 15, headerY);
doc.text(`Viatura: ${plate}`, 75, headerY);
doc.text(`Motorista: ---`, 135, headerY);
let y = 55;
doc.setFont("helvetica", "bold");
doc.setFontSize(11);
doc.text("Marcar se a viatura estiver na OFICINA:", 15, y);
doc.setFont("helvetica", "normal");
doc.text("( ) SIM", 100, y);
doc.setLineWidth(0.2);
doc.line(15, y + 10, 195, y + 10);
y += 20;
PDF_CHECKLIST_ITEMS.forEach(item => {
doc.setFontSize(11);
doc.setFont("helvetica", "bold");
doc.text(`${item.label}:`, 15, y);
doc.setFont("helvetica", "normal");
let checkboxText = "( ) OK ( ) Altera√ß√£o";
if (item.label.includes("Sirene")) {
checkboxText += " ( ) N√£o se Aplica";
}
doc.text(checkboxText, 100, y);
doc.setLineWidth(0.2);
doc.line(15, y + 10, 195, y + 10);
y += 20;
});
}

function printFilledInspections(plates) {
if (!plates || plates.length === 0) {
alert('Selecione pelo menos uma viatura.');
return;
}
const { jsPDF } = window.jspdf;
const doc = new jsPDF();
let hasPage = false;
plates.forEach((plate) => {
const inspection = getLatestInspectionByPlate(plate);
if (!inspection || !inspection.resultados || inspection.resultados.length === 0) return;
if (hasPage) doc.addPage();
addFilledInspectionPage(doc, inspection);
hasPage = true;
});
if (!hasPage) {
alert('Nenhuma vistoria preenchida encontrada para as viaturas selecionadas.');
return;
}
const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
doc.save(`vistorias_preenchidas_${timestamp}.pdf`);
}

batchPrintBtn.addEventListener('click', () => {
const today = new Date().toISOString().split('T')[0];
batchStartDate.value = today;
batchEndDate.value = today;
batchDatesList.style.display = 'none';
batchSummary.style.display = 'none';
generateBatchPdfsBtn.style.display = 'none';
if (openFilledReportBtn) openFilledReportBtn.style.display = '';
datesCheckboxContainer.innerHTML = '';
selectedInspectionsForBatch = [];
batchPrintModal.classList.add('show');
});

closeBatchPrintModal.addEventListener('click', () => {
batchPrintModal.classList.remove('show');
});

loadBatchDatesBtn.addEventListener('click', () => {
const startDate = batchStartDate.value;
const endDate = batchEndDate.value;

if (!startDate || !endDate) {
alert('Por favor, selecione as datas inicial e final.');
return;
}

if (new Date(startDate) > new Date(endDate)) {
alert('A data inicial n√£o pode ser posterior √† data final.');
return;
}

// Buscar todas as vistorias N√ÉO REALIZADAS no per√≠odo
const uninspectedByDate = {};
let totalUninspected = 0;

// Iterar por cada data no per√≠odo
const currentDate = new Date(startDate);
const finalDate = new Date(endDate);

while (currentDate <= finalDate) {
const dateString = currentDate.toISOString().split('T')[0];
const driversOnDuty = getDriversOnDutyForDate(dateString);

if (driversOnDuty.length > 0) {
driversOnDuty.forEach(driver => {
if (driver.viaturas && driver.viaturas.length > 0) {
driver.viaturas.forEach(placa => {
// Verificar se esta viatura N√ÉO foi vistoriada nesta data
const wasInspected = inspections.some(insp => 
insp.placa === placa && insp.data === dateString
);

if (!wasInspected) {
if (!uninspectedByDate[dateString]) {
uninspectedByDate[dateString] = [];
}
uninspectedByDate[dateString].push({
motorista: driver.nome,
placa: placa,
data: dateString
});
totalUninspected++;
}
});
}
});
}

currentDate.setDate(currentDate.getDate() + 1);
}

if (totalUninspected === 0) {
alert('Nenhuma vistoria pendente encontrada no per√≠odo selecionado.\n\nTodas as viaturas foram vistoriadas ou n√£o h√° motoristas escalados.');
batchDatesList.style.display = 'none';
batchSummary.style.display = 'none';
generateBatchPdfsBtn.style.display = 'none';
return;
}

// Renderizar checkboxes
datesCheckboxContainer.innerHTML = '';
const sortedDates = Object.keys(uninspectedByDate).sort();

sortedDates.forEach(date => {
const dateUninspected = uninspectedByDate[date];
const dateDiv = document.createElement('div');
dateDiv.className = 'batch-date-group';

const dateHeader = document.createElement('div');
dateHeader.className = 'batch-date-header';
dateHeader.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${formatDate(date)} (${dateUninspected.length} n√£o vistoriada${dateUninspected.length > 1 ? 's' : ''})`;
dateDiv.appendChild(dateHeader);

dateUninspected.forEach(item => {
const inspDiv = document.createElement('label');
inspDiv.className = 'batch-inspection-item';

const checkbox = document.createElement('input');
checkbox.type = 'checkbox';
checkbox.className = 'batch-inspection-checkbox';
checkbox.dataset.driver = item.motorista;
checkbox.dataset.vehicle = item.placa;
checkbox.dataset.date = item.data;

const label = document.createElement('span');
label.className = 'batch-inspection-label';
label.innerHTML = `<i class="fas fa-car"></i> <strong>${item.placa}</strong> ‚Äì ${item.motorista} <span class="batch-inspection-badge">(PDF em branco)</span>`;

inspDiv.appendChild(checkbox);
inspDiv.appendChild(label);
dateDiv.appendChild(inspDiv);
});

datesCheckboxContainer.appendChild(dateDiv);
});

batchDatesList.style.display = 'block';
batchSummary.style.display = 'block';
generateBatchPdfsBtn.style.display = 'inline-flex';
if (openFilledReportBtn) openFilledReportBtn.style.display = 'none';
updateBatchSummary();

// Event listeners para checkboxes
document.querySelectorAll('.batch-inspection-checkbox').forEach(cb => {
cb.addEventListener('change', updateBatchSummary);
});
});

selectAllDates.addEventListener('change', (e) => {
const checkboxes = document.querySelectorAll('.batch-inspection-checkbox');
checkboxes.forEach(cb => cb.checked = e.target.checked);
updateBatchSummary();
});

function updateBatchSummary() {
const checkedBoxes = document.querySelectorAll('.batch-inspection-checkbox:checked');
selectedInspectionsForBatch = Array.from(checkedBoxes).map(cb => ({
driver: cb.dataset.driver,
vehicle: cb.dataset.vehicle,
date: cb.dataset.date
}));
totalPdfsCount.textContent = selectedInspectionsForBatch.length;
}

generateBatchPdfsBtn.addEventListener('click', () => {
if (selectedInspectionsForBatch.length === 0) {
alert('Selecione pelo menos uma vistoria para imprimir.');
return;
}

const confirmMsg = `Voc\u00ea est\u00e1 prestes a gerar um \u00fanico PDF com ${selectedInspectionsForBatch.length} vistoria(s).\n\nO documento abrir\u00e1 automaticamente para impress\u00e3o.\n\nDeseja continuar?`;
if (!confirm(confirmMsg)) return;

generateBatchPdfsBtn.disabled = true;
generateBatchPdfsBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Gerando PDF...';

try {
printBatchInspections(selectedInspectionsForBatch);
alert(`PDF com ${selectedInspectionsForBatch.length} vistoria(s) gerado com sucesso!\n\nO documento foi aberto em uma nova aba.`);
} catch (error) {
console.error('Erro ao gerar PDF:', error);
alert(`Erro ao gerar PDF: ${error.message}`);
}

generateBatchPdfsBtn.disabled = false;
generateBatchPdfsBtn.innerHTML = '<i class="fas fa-print"></i> Imprimir Selecionados';
batchPrintModal.classList.remove('show');
});

if (openFilledReportBtn && filledReportModal) {
openFilledReportBtn.addEventListener('click', () => {
filledVehiclesList.innerHTML = '';
const vehicles = getAllVehiclesForFilledReport();
vehicles.forEach(plate => {
const label = document.createElement('label');
label.className = 'filled-vehicle-item';
const checkbox = document.createElement('input');
checkbox.type = 'checkbox';
checkbox.className = 'filled-vehicle-checkbox';
checkbox.value = plate;
const text = document.createElement('span');
text.className = 'filled-vehicle-plate';
text.innerHTML = `<i class="fas fa-car"></i> ${plate}`;
label.appendChild(checkbox);
label.appendChild(text);
filledVehiclesList.appendChild(label);
});
if (selectAllFilledVehicles) {
selectAllFilledVehicles.checked = false;
}
filledReportModal.classList.add('show');
});
}

if (selectAllFilledVehicles) {
selectAllFilledVehicles.addEventListener('change', (e) => {
const checkboxes = document.querySelectorAll('.filled-vehicle-checkbox');
checkboxes.forEach(cb => cb.checked = e.target.checked);
});
}

if (printFilledReportBtn) {
printFilledReportBtn.addEventListener('click', () => {
const selected = Array.from(document.querySelectorAll('.filled-vehicle-checkbox:checked')).map(cb => cb.value);
printFilledInspections(selected);
filledReportModal.classList.remove('show');
});
}

if (closeFilledReportModal) {
closeFilledReportModal.addEventListener('click', () => filledReportModal.classList.remove('show'));
}

// INICIALIZA√á√ÉO COM CORRE√á√ÉO
(function initializeApp() {
loadData();
saveChecklistItemsToLocalStorage(); // NOVA LINHA: Salva itens no localStorage
renderCalendar();
})();
});
</script>

<script>
    // Notifica o SOT5 sobre atividade do usu√°rio para resetar o cron√¥metro de inatividade
    const userActivityEvents = ['mousemove', 'mousedown', 'keypress', 'scroll', 'touchstart'];
    function notifyParentOfActivity() {
        window.parent.postMessage({ type: 'user_activity' }, '*');
    }
    userActivityEvents.forEach(eventName => {
        document.addEventListener(eventName, notifyParentOfActivity, { passive: true });
    });
</script>
</body>
</html>
</html>








