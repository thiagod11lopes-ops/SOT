<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatório Diário de Viaturas</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* Variáveis e Configurações Gerais */
        :root {
            --cor-cabecalho: #007bff; /* Azul para cabeçalhos de divisão */
            --cor-fundo-titulo: #e2f0d9; /* Verde claro para títulos de seção */
            --cor-borda: black;
            --cor-operando: green;
            --cor-inoperante: red;
            --cor-destacada: orange;
        }

        /* Estilização Base */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
        }

        #conteudo-pdf {
            width: 210mm; /* Largura A4 padrão */
            margin: 0 auto;
            padding: 10mm;
            background-color: white;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
        }

        /* Cabeçalho */
        .cabecalho {
            text-align: center;
            font-size: 10pt;
            margin-bottom: 10px;
        }
        .cabecalho h1 { margin: 0; font-size: 11pt; }
        .cabecalho h2 { margin: 0; font-size: 10pt; font-weight: normal; }
        .cabecalho h3 { 
            margin: 5px 0 10px; 
            font-size: 10pt; 
            font-weight: bold; 
            background-color: var(--cor-fundo-titulo);
            border: 1px solid var(--cor-borda);
            padding: 4px 0;
        }

        /* Tabelas */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
            font-size: 9pt;
        }
        
        th, td {
            border: 1px solid var(--cor-borda);
            padding: 4px;
            text-align: center;
        }

        thead th {
            background-color: var(--cor-fundo-titulo);
            font-weight: bold;
        }
        
        /* Tabela de Resumo Superior */
        #tabela-resumo-superior th, #tabela-resumo-superior td {
            width: 10%;
            padding: 2px 4px;
        }
        
        #tabela-resumo-superior .tipo-celula {
            text-align: left;
            font-weight: bold;
            width: 20%;
        }

        /* Tabela de Detalhes */
        .titulo-secao-detalhe {
            font-weight: bold;
            text-align: left;
            background-color: var(--cor-fundo-titulo);
            padding: 4px;
            border: 1px solid var(--cor-borda);
            border-bottom: none;
            margin-top: 15px;
        }
        
        #tabela-viaturas-ambulancias th:nth-child(1) { width: 30px; } /* # */
        #tabela-viaturas-ambulancias th:nth-child(2) { width: 80px; } /* Tipo */
        #tabela-viaturas-ambulancias th:nth-child(3) { width: 70px; } /* Placa */
        #tabela-viaturas-ambulancias th:nth-child(4) { width: 50px; } /* Ano */
        #tabela-viaturas-ambulancias th:nth-child(5) { width: 80px; } /* Situação */
        #tabela-viaturas-ambulancias th:nth-child(6) { width: 70px; } /* Vida útil */
        #tabela-viaturas-ambulancias th:nth-child(7) { width: 100px; } /* Especificação */
        #tabela-viaturas-ambulancias th:nth-child(8) { width: 35%; } /* Observação */
        #tabela-viaturas-ambulancias th:nth-child(9) { width: 50px; } /* Ação */
        
        #tabela-viaturas-administrativas th:nth-child(1) { width: 30px; } /* # */
        #tabela-viaturas-administrativas th:nth-child(2) { width: 80px; } /* Tipo */
        #tabela-viaturas-administrativas th:nth-child(3) { width: 70px; } /* Placa */
        #tabela-viaturas-administrativas th:nth-child(4) { width: 50px; } /* Ano */
        #tabela-viaturas-administrativas th:nth-child(5) { width: 80px; } /* Situação */
        #tabela-viaturas-administrativas th:nth-child(6) { width: 70px; } /* Vida útil */
        #tabela-viaturas-administrativas th:nth-child(7) { width: 50%; } /* Observação */
        #tabela-viaturas-administrativas th:nth-child(8) { width: 50px; } /* Ação */
        
        /* Estilos para redimensionamento de colunas */
        /* .resizable {
            position: relative;
        }
        
        .resizable::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            width: 5px;
            cursor: col-resize;
            background-color: transparent;
        }
        
        .resizable:hover::after {
            background-color: rgba(0, 123, 255, 0.3);
        } */
        
        /* Estilos de Status na Tabela Detalhada */
        .status-operando { color: var(--cor-operando); font-weight: bold; }
        .status-inoperante { color: var(--cor-inoperante); font-weight: bold; }
        .status-destacada { color: var(--cor-destacada); font-weight: bold; }
        
        /* Inputs para Edição */
        input[type="text"], input[type="date"], select {
            border: none;
            padding: 0;
            outline: none;
            box-sizing: border-box;
            width: 100%;
        }
        
        input[type="number"] {
            border: none;
            padding: 0;
            outline: none;
            box-sizing: border-box;
            width: 100%;
            -webkit-appearance: textfield; /* Remove aparência number */
            -moz-appearance: textfield;
        }
        
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        /* Inputs dentro das células para parecerem texto normal no PDF */
        #tabela-resumo-superior input, 
        #tabela-viaturas input,
        #tabela-viaturas select {
            border: none;
            padding: 0;
            margin: 0;
            box-sizing: border-box;
            text-align: center;
        }
        
        #tabela-viaturas td:first-child input,
        #tabela-viaturas td:last-child input {
            text-align: left;
        }

        /* Estilo da assinatura */
        .assinatura {
            text-align: center;
            margin-top: 40px;
            font-size: 10pt;
        }
        .assinatura p { margin: 2px 0; }

        /* Botões de Ação Principal */
        #botoes-acao {
            text-align: center;
            margin-top: 20px;
            padding-bottom: 20px;
        }
        #botoes-acao button {
            padding: 8px 15px;
            font-size: 14px;
            cursor: pointer;
            margin: 0 10px;
            background-color: var(--cor-cabecalho);
            color: white;
            border: none;
            border-radius: 4px;
        }

        /* Estilos de Ação (Remover Viatura) */
        .acao button {
            background-color: red;
            color: white;
            border: none;
            padding: 3px 6px;
            cursor: pointer;
            font-size: 10px;
            border-radius: 3px;
        }

        /* Estilos específicos para a impressão (PDF) */
        @media print {
            #botoes-acao, .acao {
                display: none !important; 
            }
            
            #conteudo-pdf {
                box-shadow: none;
                border: none;
                padding: 0;
                margin: 0;
            }

            input, select {
                border: none !important;
                background: transparent !important;
                /* Remove setas e aparências de formulário no PDF */
                -webkit-appearance: none;
                -moz-appearance: none;
                appearance: none;
            }
            
            input[type=number]::-webkit-inner-spin-button, 
            input[type=number]::-webkit-outer-spin-button { 
                -webkit-appearance: none;
                margin: 0;
            }
            
            /* Garante que o texto de status seja visível no PDF sem o select */
            #tabela-viaturas td select[name="status"] {
                color: inherit !important;
                font-weight: bold !important;
            }
        }
    </style>
</head>
<body>

    <div id="conteudo-pdf">
        <div class="cabecalho">
            <h1>MARINHA DO BRASIL</h1>
            <h2>HOSPITAL NAVAL MARCÍLIO DIAS</h2>
            <h2>DIVISÃO DE TRANSPORTE</h2>
            <h3>RELATÓRIO DIÁRIO DE VIATURAS DE 
                <input type="date" id="data" onchange="atualizarDiaSemana(this.value)" style="width: 120px; display: inline-block; text-align: center;"> 
                (<input type="text" id="dia-semana" readonly style="width: 80px; display: inline-block; text-align: center; font-weight: bold;">)
            </h3>
        </div>

        <table id="tabela-resumo-superior">
            <thead>
                <tr>
                    <th rowspan="2" style="width: 15%;">TIPO</th>
                    <th rowspan="2">EFETIVO</th>
                    <th colspan="3">SITUAÇÃO GERAL DAS VIATURAS DOTADAS NO HNMD</th>
                    <th colspan="2">OUTROS</th>
                </tr>
                <tr>
                    <th>OPERANDO</th>
                    <th>INOPERANTE</th>
                    <th>DESTACADA</th>
                    <th>UTI MÓVEL</th>
                    <th>USB</th>
                </tr>
            </thead>
            <tbody>
                <tr id="linha-resumo-ambulancias">
                    <td class="tipo-celula" style="text-align: left;">AMBULÂNCIA(S)</td>
                    <td><input type="number" id="efetivo-amb" value="10" min="0" oninput="calcularTotalResumo()" style="width: 30px;"></td>
                    <td><input type="text" id="resumo-operante-amb" value="0" readonly></td>
                    <td><input type="text" id="resumo-inoperante-amb" value="0" readonly></td>
                    <td><input type="text" id="resumo-destacada-amb" value="0" readonly></td>
                    <td><input type="number" id="resumo-uti" value="5" min="0" style="width: 30px;"></td>
                    <td><input type="number" id="resumo-usb" value="4" min="0" style="width: 30px;"></td>
                </tr>
                <tr id="linha-resumo-adm">
                    <td class="tipo-celula" style="text-align: left;">ADMINISTRATIVA</td>
                    <td><input type="number" id="efetivo-adm" value="14" min="0" oninput="calcularTotalResumo()" style="width: 30px;"></td>
                    <td><input type="text" id="resumo-operante-adm" value="0" readonly></td>
                    <td><input type="text" id="resumo-inoperante-adm" value="0" readonly></td>
                    <td><input type="text" id="resumo-destacada-adm" value="0" readonly></td>
                    <td colspan="2"></td>
                </tr>
                <tr style="font-weight: bold;">
                    <td class="tipo-celula" style="text-align: left;">TOTAL</td>
                    <td><input type="text" id="efetivo-total" value="24" readonly></td>
                    <td><input type="text" id="resumo-operante-total" value="0" readonly></td>
                    <td><input type="text" id="resumo-inoperante-total" value="0" readonly></td>
                    <td><input type="text" id="resumo-destacada-total" value="0" readonly></td>
                    <td colspan="2"></td>
                </tr>
            </tbody>
        </table>

        <div class="titulo-secao-detalhe">AMBULÂNCIAS:</div>
        <table id="tabela-viaturas-ambulancias">
            <thead>
                <tr>
                    <th style="width: 30px;">#</th>
                    <th>TIPO</th>
                    <th style="width: 70px;">PLACA</th>
                    <th style="width: 50px;">ANO</th>
                    <th style="width: 80px;">SITUAÇÃO</th>
                    <th style="width: 70px;">VIDA ÚTIL</th>
                    <th style="width: 100px;">ESPECIFICAÇÃO</th>
                    <th style="width: 35%;">OBSERVAÇÃO</th>
                    <th style="width: 50px;">AÇÃO</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
        <div style="text-align: center; margin-top: 5px;">
            <button onclick="adicionarViatura('ambulancias')">+ Adicionar Ambulância</button>
        </div>

        <div class="titulo-secao-detalhe" style="margin-top: 15px;">ADMINISTRATIVAS:</div>
        <table id="tabela-viaturas-administrativas">
            <thead>
                <tr>
                    <th style="width: 30px;">#</th>
                    <th>TIPO</th>
                    <th style="width: 70px;">PLACA</th>
                    <th style="width: 50px;">ANO</th>
                    <th style="width: 80px;">SITUAÇÃO</th>
                    <th style="width: 70px;">VIDA ÚTIL</th>
                    <th colspan="2">OBSERVAÇÃO</th> <th style="width: 50px;">AÇÃO</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
        <div style="text-align: center; margin-top: 5px;">
            <button onclick="adicionarViatura('administrativas')">+ Adicionar Administrativa</button>
        </div>

        <div class="assinatura">
            <p>_____________________________________</p>
            <p>2° Thiago Lopes</p>
            <p>Divisão de Transporte</p>
        </div>

    </div>

    <div id="botoes-acao">
        <button onclick="gerarPDF()">Gerar PDF</button>
    </div>

    <script>
        let contagemLinhasAmb = 0; 
        let contagemLinhasAdm = 0; 
        
        document.addEventListener('DOMContentLoaded', () => {
            // Inicializa a data e dia da semana atuais
            const dataInput = document.getElementById('data');
            const today = new Date();
            const formattedDate = today.toISOString().split('T')[0];
            
            dataInput.value = formattedDate;
            atualizarDiaSemana(formattedDate);
            
            // Pré-popula com dados da planilha de exemplo
            popularDadosIniciais();
            
            // Adiciona auto-resize nos inputs
            adicionarAutoResize();
            
            // Recalcula o resumo
            calcularTotalResumo();
        });

        // Auto-resize das colunas baseado no conteúdo
        function adicionarAutoResize() {
            // Para cada input e select, adiciona oninput/change para ajustar width baseado no texto
            document.querySelectorAll('input[type="text"], input[type="number"], select').forEach(element => {
                element.addEventListener('input', () => ajustarLarguraElement(element));
                element.addEventListener('change', () => ajustarLarguraElement(element)); // Para selects
                // Ajusta inicial
                ajustarLarguraElement(element);
            });
        }
        
        function ajustarLarguraElement(element) {
            // Calcula largura baseada no comprimento do texto (aproximado, mas melhorado)
            const text = element.value || element.textContent || '';
            const minWidth = 40; // mínimo
            const charWidth = 10; // largura aproximada por caractere (aumentado)
            const calculatedWidth = Math.max(minWidth, text.length * charWidth);
            element.style.width = calculatedWidth + 'px';
        }

        // Preenche as tabelas com os dados da imagem (opcional, mas recomendado)
        function popularDadosIniciais() {
            const dadosAmb = [
                {tipo: 'DUCATO', placa: 'KPH-9E52', ano: 2012, situacao: 'Operando', vidaUtil: 2020, espec: 'UTI MÓVEL', obs: 'Maca.'},
                {tipo: 'DUCATO', placa: 'KPH-9E53', ano: 2012, situacao: 'Operando', vidaUtil: 2020, espec: 'UTI NEO', obs: 'Vazamento no Exaustor'},
                {tipo: 'DUCATO', placa: 'KPH-9E54', ano: 2012, situacao: 'Destacada', vidaUtil: 2020, espec: 'USB', obs: 'DST NOV/25 (IJSM)/Maca Inop.'},
                {tipo: 'SPRINTER', placa: 'KVZ-8O89', ano: 2012, situacao: 'Inoperante', vidaUtil: 2020, espec: 'USB', obs: 'Inversor RUIM'},
                {tipo: 'SPRINTER', placa: 'KVZ-8O91', ano: 2012, situacao: 'Inoperante', vidaUtil: 2020, espec: 'USB', obs: 'Fumacando'},
                {tipo: 'SPRINTER', placa: 'KPK-4H03', ano: 2012, situacao: 'Destacada', vidaUtil: 2020, espec: 'UTI MÓVEL', obs: 'DST ESM/Sem estepe.'},
                {tipo: 'SPRINTER', placa: 'RIV-9I01', ano: 2021, situacao: 'Operando', vidaUtil: 2029, espec: 'UTI MÓVEL', obs: 'Sem restrição.'},
                {tipo: 'SPRINTER', placa: 'RKK-9I27', ano: 2021, situacao: 'Operando', vidaUtil: 2029, espec: 'UTI MÓVEL', obs: 'Sensor de frenagem avariado.'},
                {tipo: 'MASTER', placa: 'TTD-1A38', ano: 2024, situacao: 'Operando', vidaUtil: 2032, espec: 'UTI MÓVEL', obs: 'Sem restrição.'},
                {tipo: 'MASTER', placa: 'TTP-2G26', ano: 2025, situacao: 'Operando', vidaUtil: 2033, espec: 'USB', obs: 'Sem restrição.'}
            ];
            
            const dadosAdm = [
                {tipo: 'CLIO', placa: 'KRQ-0G70', ano: 2007, situacao: 'Operando', vidaUtil: 2014, obs: 'Ar Condicionado ruim.'},
                {tipo: 'DUCATO', placa: 'LPE-2A05', ano: 2008, situacao: 'Operando', vidaUtil: 2015, obs: 'Sem restrição.'},
                {tipo: 'DUCATO', placa: 'LPE-4G44', ano: 2008, situacao: 'Destacada', vidaUtil: 2015, obs: 'Emprestada a ESM até dia 29/10/25. Sem restrição.'},
                {tipo: 'DUCATO', placa: 'KZV-6G41', ano: 2006, situacao: 'Operando', vidaUtil: 2013, obs: 'Sem restrição.'},
                {tipo: 'CAMINHÃO', placa: 'LKL-8D08', ano: 2007, situacao: 'Operando', vidaUtil: 2019, obs: 'Sem restrição.'},
                {tipo: 'CAMINHÃO', placa: 'KVZ-7A70', ano: 2012, situacao: 'Operando', vidaUtil: 2024, obs: 'Sem restrição.'},
                {tipo: 'HONDA CIVIC', placa: 'KZT-1560', ano: 2005, situacao: 'Operando', vidaUtil: 2013, obs: 'Sem restrição.'},
                {tipo: 'SANTANA', placa: 'LNC-1A94', ano: 2000, situacao: 'Inoperante', vidaUtil: 2008, obs: 'Processo de LVAO.'},
                {tipo: 'DOBLÓ', placa: 'NVT-8G55', ano: 2011, situacao: 'Operando', vidaUtil: 2018, obs: 'Sem restrição.'},
                {tipo: 'DOBLÓ', placa: 'KPG-9A79', ano: 2012, situacao: 'Operando', vidaUtil: 2019, obs: 'Sem restrição.'},
                {tipo: 'DOBLÓ', placa: 'LQS-1F32', ano: 2012, situacao: 'Inoperante', vidaUtil: 2019, obs: 'Oficina'},
                {tipo: 'COROLLA', placa: 'LTI-2281', ano: 2017, situacao: 'Operando', vidaUtil: 2024, obs: 'Sem restrição.'},
                {tipo: 'FORD KA', placa: 'RJN-4I27', ano: 2020, situacao: 'Operando', vidaUtil: 2027, obs: 'Sem restrição.'},
                {tipo: 'PEUGEOT 408', placa: 'LSE-3253', ano: 2016, situacao: 'Operando', vidaUtil: 2023, obs: 'Sem restrição.'}
            ];

            dadosAmb.forEach(item => adicionarViatura('ambulancias', item));
            dadosAdm.forEach(item => adicionarViatura('administrativas', item));
        }

        function atualizarDiaSemana(dataString) {
            const diaSemanaInput = document.getElementById('dia-semana');
            if (!dataString) {
                diaSemanaInput.value = '';
                return;
            }

            const data = new Date(dataString.replace(/-/g, '/')); 
            const dias = ['Domingo', 'Segunda-feira', 'Terça-feira', 'Quarta-feira', 'Quinta-feira', 'Sexta-feira', 'Sábado'];
            const diaIndex = data.getDay();
            
            diaSemanaInput.value = dias[diaIndex];
        }

        // Adiciona uma nova linha na tabela de viaturas
        function adicionarViatura(tipoViatura, dadosIniciais = {}) {
            const tbody = document.getElementById(`tabela-viaturas-${tipoViatura}`).querySelector('tbody');
            
            let contador;
            if (tipoViatura === 'ambulancias') {
                contagemLinhasAmb++;
                contador = contagemLinhasAmb;
            } else {
                contagemLinhasAdm++;
                contador = contagemLinhasAdm;
            }

            const novaLinha = document.createElement('tr');
            novaLinha.id = `linha-${tipoViatura}-${contador}`;
            novaLinha.setAttribute('data-tipo', tipoViatura);
            
            const statusOptions = ['Operando', 'Inoperante', 'Destacada', 'Reserva', 'Manutencao'];
            const statusValue = dadosIniciais.situacao || 'Operando';
            const statusSelect = statusOptions.map(opt => 
                `<option value="${opt}" ${opt === statusValue ? 'selected' : ''}>${opt}</option>` 
            ).join('');

            if (tipoViatura === 'ambulancias') {
                // Estrutura para Ambulâncias
                novaLinha.innerHTML = `
                    <td><input type="text" name="num" value="${contador}" readonly style="width: 20px;"></td>
                    <td><input type="text" name="tipo" value="${dadosIniciais.tipo || ''}" style="width: 80px;"></td>
                    <td><input type="text" name="placa" value="${dadosIniciais.placa || ''}"></td>
                    <td><input type="number" name="ano" value="${dadosIniciais.ano || ''}" min="1990"></td>
                    <td>
                        <select name="status" onchange="atualizarStatusDisplay(this); calcularTotalResumo()">
                            ${statusSelect}
                        </select>
                    </td>
                    <td><input type="number" name="vida-util" value="${dadosIniciais.vidaUtil || ''}" min="2000"></td>
                    <td><input type="text" name="especificacao" value="${dadosIniciais.espec || ''}"></td>
                    <td><input type="text" name="observacao" value="${dadosIniciais.obs || ''}"></td>
                    <td class="acao"><button onclick="removerViatura(${contador}, '${tipoViatura}')">Remover</button></td>
                `;
            } else {
                // Estrutura para Administrativas (sem coluna ESPECIFICAÇÃO, OBSERVAÇÃO ocupa 2 colunas)
                 novaLinha.innerHTML = `
                    <td><input type="text" name="num" value="${contador}" readonly style="width: 20px;"></td>
                    <td><input type="text" name="tipo" value="${dadosIniciais.tipo || ''}" style="width: 80px;"></td>
                    <td><input type="text" name="placa" value="${dadosIniciais.placa || ''}"></td>
                    <td><input type="number" name="ano" value="${dadosIniciais.ano || ''}" min="1990"></td>
                    <td>
                        <select name="status" onchange="atualizarStatusDisplay(this); calcularTotalResumo()">
                            ${statusSelect}
                        </select>
                    </td>
                    <td><input type="number" name="vida-util" value="${dadosIniciais.vidaUtil || ''}" min="2000"></td>
                    <td colspan="2"><input type="text" name="observacao" value="${dadosIniciais.obs || ''}"></td>
                    <td class="acao"><button onclick="removerViatura(${contador}, '${tipoViatura}')">Remover</button></td>
                `;
            }
            
            tbody.appendChild(novaLinha);
            atualizarStatusDisplay(novaLinha.querySelector('select[name="status"]'));
            calcularTotalResumo();
        }
        
        // Aplica o estilo de cor baseado no status
        function atualizarStatusDisplay(selectElement) {
            const status = selectElement.value;
            const cell = selectElement.parentNode;
            
            cell.className = ''; // Limpa classes anteriores
            
            if (status === 'Operando') {
                cell.classList.add('status-operando');
            } else if (status === 'Inoperante') {
                cell.classList.add('status-inoperante');
            } else if (status === 'Destacada') {
                cell.classList.add('status-destacada');
            }
            
            // O texto do select é automaticamente negrito pelo CSS global da célula, mas a cor é aplicada aqui
        }

        function removerViatura(contador, tipoViatura) {
            const linha = document.getElementById(`linha-${tipoViatura}-${contador}`);
            if (linha) {
                linha.remove();
                reorganizarTabela(tipoViatura);
                calcularTotalResumo();
            }
        }
        
        function reorganizarTabela(tipoViatura) {
            const tabelaId = `tabela-viaturas-${tipoViatura}`;
            const linhas = document.querySelectorAll(`#${tabelaId} tbody tr`);
            
            let novoContador = 0;
            linhas.forEach((linha) => {
                novoContador++;
                linha.id = `linha-${tipoViatura}-${novoContador}`;
                
                // Atualiza o número da linha
                const inputNum = linha.querySelector('input[name="num"]');
                inputNum.value = novoContador;
                
                // Atualiza o botão de remoção
                linha.querySelector('.acao button').setAttribute('onclick', `removerViatura(${novoContador}, '${tipoViatura}')`);
            });
            
            // Atualiza o contador global
            if (tipoViatura === 'ambulancias') {
                contagemLinhasAmb = novoContador;
            } else {
                contagemLinhasAdm = novoContador;
            }
        }

        // Calcula o total de viaturas por status e atualiza a tabela de resumo
        function calcularTotalResumo() {
            let contagens = {
                'ambulancias': { 'Operando': 0, 'Inoperante': 0, 'Destacada': 0 },
                'administrativas': { 'Operando': 0, 'Inoperante': 0, 'Destacada': 0 }
            };

            // 1. Contagem Detalhada
            document.querySelectorAll('#tabela-viaturas-ambulancias tbody select[name="status"]').forEach(select => {
                const status = select.value;
                if (contagens['ambulancias'].hasOwnProperty(status)) {
                    contagens['ambulancias'][status]++;
                }
            });
            
            document.querySelectorAll('#tabela-viaturas-administrativas tbody select[name="status"]').forEach(select => {
                const status = select.value;
                if (contagens['administrativas'].hasOwnProperty(status)) {
                    contagens['administrativas'][status]++;
                }
            });

            // 2. Atualiza Linhas de Resumo
            
            // Ambulâncias
            document.getElementById('resumo-operante-amb').value = contagens['ambulancias']['Operando'];
            document.getElementById('resumo-inoperante-amb').value = contagens['ambulancias']['Inoperante'];
            document.getElementById('resumo-destacada-amb').value = contagens['ambulancias']['Destacada'];
            
            // Administrativas
            document.getElementById('resumo-operante-adm').value = contagens['administrativas']['Operando'];
            document.getElementById('resumo-inoperante-adm').value = contagens['administrativas']['Inoperante'];
            document.getElementById('resumo-destacada-adm').value = contagens['administrativas']['Destacada'];
            
            // 3. Calcula Totais
            const efetivoAmb = parseInt(document.getElementById('efetivo-amb').value) || 0;
            const efetivoAdm = parseInt(document.getElementById('efetivo-adm').value) || 0;
            
            const totalOperando = contagens['ambulancias']['Operando'] + contagens['administrativas']['Operando'];
            const totalInoperante = contagens['ambulancias']['Inoperante'] + contagens['administrativas']['Inoperante'];
            const totalDestacada = contagens['ambulancias']['Destacada'] + contagens['administrativas']['Destacada'];
            
            // 4. Atualiza Linha Total
            document.getElementById('efetivo-total').value = efetivoAmb + efetivoAdm;
            document.getElementById('resumo-operante-total').value = totalOperando;
            document.getElementById('resumo-inoperante-total').value = totalInoperante;
            document.getElementById('resumo-destacada-total').value = totalDestacada;
        }


        // Função para gerar PDF usando jsPDF e html2canvas
        async function gerarPDF() {
            const { jsPDF } = window.jspdf;
            const elemento = document.getElementById('conteudo-pdf'); 
            
            // 1. Ajuste temporário para o PDF: remove o 'colspan' para o html2canvas renderizar corretamente
            const obsAdm = document.querySelectorAll('#tabela-viaturas-administrativas tbody td[colspan="2"]');
            obsAdm.forEach(td => {
                 td.setAttribute('data-colspan', '2'); // Guarda o valor
                 td.removeAttribute('colspan'); // Remove para o render
            });
            
            // 2. Renderiza o conteúdo como um canvas (imagem)
            const canvas = await html2canvas(elemento, {
                scale: 2, 
                useCORS: true, 
                logging: false, 
                allowTaint: true 
            });

            // 3. Restaura o 'colspan'
            obsAdm.forEach(td => {
                 td.setAttribute('colspan', td.getAttribute('data-colspan'));
                 td.removeAttribute('data-colspan');
            });


            const imgData = canvas.toDataURL('image/png');
            const pdf = new jsPDF('p', 'mm', 'a4'); 
            
            const pdfWidth = 210; 
            const pdfHeight = 297; 
            
            const imgHeight = canvas.height * pdfWidth / canvas.width;
            let heightLeft = imgHeight;
            let position = 0;
            
            pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight);
            heightLeft -= pdfHeight;

            // Lida com múltiplas páginas
            while (heightLeft >= -1) {
                position = heightLeft - imgHeight;
                pdf.addPage();
                pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight);
                heightLeft -= pdfHeight;
            }

            // Salva o arquivo com um nome baseado na data
            const data = document.getElementById('data').value || 'SemData';
            pdf.save(`Relatorio_Viaturas_${data}.pdf`);
        }
    </script>
</body>
</html>
