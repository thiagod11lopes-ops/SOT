<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuração de Disponibilidade - Administrador</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="api-service.js"></script>
    <script src="data-service.js"></script>
    <style>
        :root {
            --primary-blue: #4a69bd;
            --secondary-blue: #6c88c9;
            --gray: #dcdcdc;
            --dark-gray: #333d47;
            --white: #ffffff;
            --light-gray-bg: #f9f9f9;
            --success-green: #28a745;
            --warning-orange: #ffc107;
            --error-red: #dc3545;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: transparent;
            min-height: 100vh;
            padding: 0;
            margin: 0;
            color: var(--dark-gray);
        }

        .container {
            max-width: 100%;
            margin: 0;
            background: var(--white);
            border-radius: 0;
            box-shadow: none;
            overflow: hidden;
            min-height: calc(100vh - 120px);
        }

        header {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-blue) 100%);
            color: var(--white);
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .back-link {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            text-decoration: none;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.3s;
        }

        .back-link:hover {
            background: rgba(255,255,255,0.3);
        }

        header h1 {
            font-size: 32px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        header h1 i {
            font-size: 36px;
        }

        header p {
            font-size: 16px;
            opacity: 0.9;
        }

        main {
            padding: 40px;
        }

        .section {
            margin-bottom: 40px;
        }

        .section h2 {
            font-size: 24px;
            color: var(--primary-blue);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--gray);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .message {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 500;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .message.hidden {
            display: none;
        }

        .config-form {
            background: var(--light-gray-bg);
            padding: 30px;
            border-radius: 12px;
            border: 1px solid var(--gray);
            margin-bottom: 30px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: bold;
            margin-bottom: 8px;
            color: var(--dark-gray);
            font-size: 14px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--gray);
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(74, 105, 189, 0.1);
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-blue) 100%);
            color: var(--white);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, var(--secondary-blue) 0%, var(--primary-blue) 100%);
        }

        .btn-success {
            background: var(--success-green);
            color: var(--white);
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: var(--error-red);
            color: var(--white);
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-secondary {
            background: var(--gray);
            color: var(--dark-gray);
        }

        .disponibilidades-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--white);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .disponibilidades-table thead {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-blue) 100%);
            color: var(--white);
        }

        .disponibilidades-table th,
        .disponibilidades-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--gray);
        }

        .disponibilidades-table th {
            font-weight: 600;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 0.5px;
        }

        .disponibilidades-table tbody tr:hover {
            background: var(--light-gray-bg);
        }

        .disponibilidades-table tbody tr:last-child td {
            border-bottom: none;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge.success {
            background: #d4edda;
            color: #155724;
        }

        .badge.warning {
            background: #fff3cd;
            color: #856404;
        }

        .badge.danger {
            background: #f8d7da;
            color: #721c24;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state i {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 14px;
        }

        .help-text {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--light-gray-bg);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--gray);
            text-align: center;
        }

        .stat-card h3 {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
            color: var(--primary-blue);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            overflow-y: auto;
            padding: 20px;
        }

        .modal.active {
            display: flex;
            align-items: flex-start;
            justify-content: center;
        }

        .modal-content {
            background-color: var(--white);
            padding: 30px;
            border-radius: 12px;
            width: 100%;
            max-width: 800px;
            margin: 20px auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--gray);
        }

        .modal-header h3 {
            margin: 0;
            color: var(--primary-blue);
            font-size: 24px;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 28px;
            color: #999;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .close-modal:hover {
            background: #f0f0f0;
            color: var(--error-red);
        }

        .dados-agendamento {
            background: var(--light-gray-bg);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
        }

        .dados-agendamento h4 {
            margin: 0 0 15px 0;
            color: var(--dark-gray);
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .dados-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .dado-item {
            display: flex;
            flex-direction: column;
        }

        .dado-item.full-width {
            grid-column: 1 / -1;
        }

        .dado-item label {
            font-size: 12px;
            color: #666;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .dado-item span {
            font-size: 14px;
            color: var(--dark-gray);
            font-weight: 500;
            word-wrap: break-word;
        }

        .dado-item span strong {
            color: var(--primary-blue);
        }

        .formulario-completar {
            margin-top: 25px;
        }

        .formulario-completar h4 {
            margin: 0 0 20px 0;
            color: var(--primary-blue);
            font-size: 18px;
        }

        .badge.pendente {
            background: #fff3cd;
            color: #856404;
        }

        .badge.confirmado {
            background: #d4edda;
            color: #155724;
        }

        .badge.cancelado {
            background: #f8d7da;
            color: #721c24;
        }

        /* Estilos para Calendário de Disponibilidades - Design Moderno */
        .calendario-disponibilidades {
            background: linear-gradient(to bottom, #ffffff, #f8f9fa);
            border-radius: 20px;
            padding: 40px;
            margin-top: 40px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            border: 1px solid rgba(74, 105, 189, 0.1);
        }

        .calendario-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid var(--primary-blue);
        }

        .calendario-header h3 {
            margin: 0;
            color: var(--primary-blue);
            font-size: 28px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .calendario-header h3 i {
            font-size: 32px;
        }

        .calendario-nav {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .btn-cal-nav {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-blue) 100%);
            color: var(--white);
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(74, 105, 189, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 45px;
            height: 45px;
        }

        .btn-cal-nav:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(74, 105, 189, 0.4);
        }

        .btn-cal-nav:active {
            transform: translateY(0);
        }

        #calendarioMesAno {
            text-align: center;
            margin-bottom: 30px;
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-blue);
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 15px;
            background: linear-gradient(135deg, rgba(74, 105, 189, 0.1) 0%, rgba(108, 136, 201, 0.1) 100%);
            border-radius: 12px;
        }

        .calendario-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }

        .calendario-dia-nome {
            text-align: center;
            font-weight: 700;
            color: var(--primary-blue);
            padding: 15px 10px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
            background: linear-gradient(135deg, rgba(74, 105, 189, 0.1) 0%, rgba(108, 136, 201, 0.05) 100%);
            border-radius: 10px;
        }

        .calendario-dia {
            background: var(--white);
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 12px;
            min-height: 140px;
            display: flex;
            flex-direction: column;
            position: relative;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .calendario-dia:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
            border-color: var(--primary-blue);
        }

        .calendario-dia.outro-mes {
            opacity: 0.3;
            background: #f8f9fa;
            cursor: not-allowed;
        }

        .calendario-dia.outro-mes:hover {
            transform: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border-color: #e9ecef;
        }

        .calendario-dia-numero {
            font-weight: 700;
            font-size: 16px;
            margin-bottom: 10px;
            text-align: center;
            color: var(--dark-gray);
            padding: 4px 8px;
            border-radius: 6px;
            background: rgba(74, 105, 189, 0.05);
            align-self: center;
            min-width: 30px;
        }

        .calendario-periodo {
            flex: 1;
            border-radius: 8px;
            padding: 10px 8px;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .calendario-periodo::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }

        .calendario-periodo:hover::before {
            left: 100%;
        }

        .calendario-periodo:last-child {
            margin-bottom: 0;
        }

        .calendario-periodo.livre {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border: 2px solid #dee2e6;
            color: #6c757d;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
        }

        .calendario-periodo.livre:hover {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-color: #adb5bd;
            transform: scale(1.02);
        }

        .calendario-periodo.disponivel {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            border: 2px solid #28a745;
            color: #155724;
            box-shadow: 0 3px 10px rgba(40, 167, 69, 0.2);
        }

        .calendario-periodo.disponivel:hover {
            background: linear-gradient(135deg, #c3e6cb 0%, #b1dfbb 100%);
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }

        .calendario-periodo.ocupado {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: 2px solid #ffc107;
            color: #856404;
            box-shadow: 0 3px 10px rgba(255, 193, 7, 0.2);
        }

        .calendario-periodo.ocupado:hover {
            background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(255, 193, 7, 0.3);
        }

        .calendario-separador {
            height: 2px;
            margin: 6px 0;
            background: linear-gradient(to right, transparent, #dee2e6, transparent);
            border-radius: 2px;
        }

        .calendario-legenda {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-top: 35px;
            padding-top: 30px;
            border-top: 3px solid #e9ecef;
            flex-wrap: wrap;
            background: linear-gradient(to bottom, transparent, rgba(74, 105, 189, 0.02));
            padding-bottom: 20px;
            border-radius: 0 0 20px 20px;
        }

        .legenda-item {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 15px;
            font-weight: 600;
            padding: 10px 20px;
            background: var(--white);
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }

        .legenda-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }

        .legenda-cor {
            width: 35px;
            height: 35px;
            border-radius: 8px;
            border: 3px solid;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }

        .legenda-cor.livre {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-color: #dee2e6;
        }

        .legenda-cor.disponivel {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            border-color: #28a745;
        }

        .legenda-cor.ocupado {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border-color: #ffc107;
        }

        /* Estilos para Sub-Abas */
        .sub-tabs-container {
            margin-bottom: 30px;
            border-bottom: 2px solid var(--gray);
        }

        .sub-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 0;
            padding: 0;
        }

        .sub-tab-button {
            background: transparent;
            border: none;
            padding: 12px 24px;
            font-size: 15px;
            font-weight: 600;
            color: var(--dark-gray);
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
            top: 2px;
        }

        .sub-tab-button:hover {
            color: var(--primary-blue);
            background: rgba(74, 105, 189, 0.05);
        }

        .sub-tab-button.active {
            color: var(--primary-blue);
            border-bottom-color: var(--primary-blue);
            background: rgba(74, 105, 189, 0.1);
        }

        .sub-tab-button i {
            font-size: 16px;
        }

        .sub-tab-content {
            display: none;
        }

        .sub-tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 768px) {
            .sub-tabs {
                flex-direction: column;
            }

            .sub-tab-button {
                width: 100%;
                justify-content: flex-start;
                border-bottom: 2px solid var(--gray);
                border-left: 3px solid transparent;
            }

            .sub-tab-button.active {
                border-left-color: var(--primary-blue);
                border-bottom-color: var(--gray);
            }
            .form-row {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                flex-direction: column;
            }

            main {
                padding: 20px;
            }

            .modal-content {
                padding: 20px;
                margin: 10px;
            }

            .dados-grid {
                grid-template-columns: 1fr;
            }

            .calendario-disponibilidades {
                padding: 20px;
            }

            .calendario-header {
                flex-direction: column;
                gap: 20px;
                align-items: flex-start;
            }

            .calendario-grid {
                grid-template-columns: repeat(7, 1fr);
                gap: 8px;
            }

            .calendario-dia {
                min-height: 110px;
                padding: 8px;
            }

            .calendario-periodo {
                font-size: 10px;
                padding: 8px 4px;
            }

            .calendario-legenda {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }

            .legenda-item {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container" style="margin: 0; border-radius: 0; box-shadow: none; min-height: calc(100vh - 120px);">
        <header style="border-radius: 0;">
            <h1>
                <i class="fas fa-calendar-alt"></i>
                Configuração de Disponibilidade e Gestão de Agendamentos
            </h1>
            <p>Configure vagas disponíveis e gerencie agendamentos pendentes e confirmados</p>
        </header>

        <main>
            <div id="messageContainer"></div>

            <div class="stats-grid" id="statsGrid"></div>

            <!-- Sub-Abas -->
            <div class="sub-tabs-container">
                <div class="sub-tabs">
                    <button class="sub-tab-button active" data-sub-tab="adicionar-editar">
                        <i class="fas fa-plus-circle"></i>
                        Adicionar/Editar Disponibilidade
                    </button>
                    <button class="sub-tab-button" data-sub-tab="configuradas">
                        <i class="fas fa-list"></i>
                        Disponibilidades Configuradas
                    </button>
                    <button class="sub-tab-button" data-sub-tab="pendentes">
                        <i class="fas fa-tasks"></i>
                        Agendamentos Pendentes
                    </button>
                    <button class="sub-tab-button" data-sub-tab="confirmados">
                        <i class="fas fa-check-circle"></i>
                        Agendamentos Confirmados
                    </button>
                    <button class="sub-tab-button" data-sub-tab="rapidas">
                        <i class="fas fa-magic"></i>
                        Configurações Rápidas
                    </button>
                </div>
            </div>

            <!-- Conteúdo das Sub-Abas -->
            
            <!-- Sub-Aba: Adicionar/Editar Disponibilidade -->
            <div id="sub-tab-adicionar-editar" class="sub-tab-content active">
                <section class="section">
                    <h2><i class="fas fa-plus-circle"></i> Adicionar/Editar Disponibilidade</h2>
                <form id="configForm" class="config-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label>
                                <i class="fas fa-calendar-alt"></i>
                                Data <span style="color: var(--error-red);">*</span>
                            </label>
                            <input type="date" id="inputData" required>
                            <span class="help-text">Data para configurar disponibilidade</span>
                        </div>

                        <div class="form-group">
                            <label>
                                <i class="fas fa-sun"></i>
                                Período <span style="color: var(--error-red);">*</span>
                            </label>
                            <select id="inputPeriodo" required>
                                <option value="">-- Selecione o Período --</option>
                                <option value="Manhã">Manhã (07:00 - 11:00)</option>
                                <option value="Tarde">Tarde (12:00 - 15:00)</option>
                            </select>
                            <span class="help-text">Período do dia</span>
                        </div>

                        <div class="form-group">
                            <label>
                                <i class="fas fa-hashtag"></i>
                                Quantidade de Vagas <span style="color: var(--error-red);">*</span>
                            </label>
                            <input type="number" id="inputVagas" min="1" max="100" required placeholder="Ex: 5">
                            <span class="help-text">Quantas viaturas podem ser agendadas neste período</span>
                        </div>
                    </div>

                    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i>
                            Salvar Configuração
                        </button>
                        <button type="button" class="btn btn-secondary" id="btnLimpar">
                            <i class="fas fa-eraser"></i>
                            Limpar
                        </button>
                    </div>
                </form>

                <!-- Calendário de Disponibilidades -->
                <div class="calendario-disponibilidades">
                    <div class="calendario-header">
                        <h3><i class="fas fa-calendar-alt"></i> Calendário de Disponibilidades</h3>
                        <div class="calendario-nav">
                            <button class="btn-cal-nav" id="prevMonthBtn">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <button class="btn-cal-nav" id="nextMonthBtn">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                    <div id="calendarioMesAno" style="text-align: center; margin-bottom: 20px; font-size: 18px; font-weight: 600; color: var(--primary-blue);"></div>
                    <div class="calendario-grid" id="calendarioGrid">
                        <!-- Calendário será gerado aqui -->
                    </div>
                    <div class="calendario-legenda">
                        <div class="legenda-item">
                            <div class="legenda-cor livre"></div>
                            <span>Livre (sem configuração)</span>
                        </div>
                        <div class="legenda-item">
                            <div class="legenda-cor disponivel"></div>
                            <span>Disponível (há vagas livres)</span>
                        </div>
                        <div class="legenda-item">
                            <div class="legenda-cor ocupado"></div>
                            <span>Ocupado (todas vagas ocupadas)</span>
                        </div>
                    </div>
                </div>
                </section>
            </div>

            <!-- Sub-Aba: Disponibilidades Configuradas -->
            <div id="sub-tab-configuradas" class="sub-tab-content">
                <section class="section">
                    <h2><i class="fas fa-list"></i> Disponibilidades Configuradas</h2>
                <div style="overflow-x: auto;">
                    <table class="disponibilidades-table">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Período</th>
                                <th>Vagas Configuradas</th>
                                <th>Vagas Ocupadas</th>
                                <th>Vagas Disponíveis</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="disponibilidadesTableBody">
                            <tr>
                                <td colspan="7">
                                    <div class="empty-state">
                                        <i class="fas fa-inbox"></i>
                                        <p>Nenhuma disponibilidade configurada</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                </section>
            </div>

            <!-- Sub-Aba: Agendamentos Pendentes -->
            <div id="sub-tab-pendentes" class="sub-tab-content">
                <section class="section">
                    <h2><i class="fas fa-tasks"></i> Agendamentos Pendentes</h2>
                <p style="color: #666; margin-bottom: 20px;">
                    Agendamentos que aguardam atribuição de viatura e motorista. Clique em "Completar" para preencher os dados e confirmar.
                </p>
                <div style="overflow-x: auto;">
                    <table class="disponibilidades-table">
                        <thead>
                            <tr>
                                <th>Data/Hora</th>
                                <th>Tipo de Viatura</th>
                                <th>Destino</th>
                                <th>Responsável</th>
                                <th>Setor/Ramal</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="agendamentosPendentesBody">
                            <tr>
                                <td colspan="7">
                                    <div class="empty-state">
                                        <i class="fas fa-inbox"></i>
                                        <p>Nenhum agendamento pendente</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                </section>
            </div>

            <!-- Sub-Aba: Agendamentos Confirmados -->
            <div id="sub-tab-confirmados" class="sub-tab-content">
                <section class="section">
                    <h2><i class="fas fa-check-circle"></i> Agendamentos Confirmados</h2>
                <div style="overflow-x: auto;">
                    <table class="disponibilidades-table">
                        <thead>
                            <tr>
                                <th>Data/Hora</th>
                                <th>Tipo Viatura</th>
                                <th>Viatura</th>
                                <th>Motorista</th>
                                <th>Destino</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="agendamentosConfirmadosBody">
                            <tr>
                                <td colspan="7">
                                    <div class="empty-state">
                                        <i class="fas fa-inbox"></i>
                                        <p>Nenhum agendamento confirmado</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                </section>
            </div>

            <!-- Sub-Aba: Configurações Rápidas -->
            <div id="sub-tab-rapidas" class="sub-tab-content">
                <section class="section">
                    <h2><i class="fas fa-magic"></i> Configuração Rápida</h2>
                <div class="config-form">
                    <p style="margin-bottom: 20px; color: #666;">
                        Configure disponibilidades padrão para um período. Esta ferramenta cria múltiplas configurações automaticamente.
                    </p>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Data Inicial</label>
                            <input type="date" id="dataInicial">
                        </div>
                        <div class="form-group">
                            <label>Data Final</label>
                            <input type="date" id="dataFinal">
                        </div>
                        <div class="form-group">
                            <label>Períodos</label>
                            <select id="periodosRapidos" multiple style="height: 80px;">
                                <option value="Manhã">Manhã (07:00 - 11:00)</option>
                                <option value="Tarde">Tarde (12:00 - 15:00)</option>
                            </select>
                            <span class="help-text">Selecione os períodos (mantenha Ctrl pressionado para múltiplos)</span>
                        </div>
                        <div class="form-group">
                            <label>Vagas por Período</label>
                            <input type="number" id="vagasRapidas" min="1" max="100" placeholder="Ex: 3">
                        </div>
                    </div>
                    <button type="button" class="btn btn-success" id="btnConfigRapida">
                        <i class="fas fa-bolt"></i>
                        Criar Configurações em Lote
                    </button>
                </div>
                </section>
            </div>

        </main>
    </div>

    <!-- Modal de Aviso - Vagas Insuficientes -->
    <div id="modalAvisoVagas" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3><i class="fas fa-exclamation-triangle"></i> Aviso - Não é possível reduzir vagas</h3>
                <button class="close-modal" onclick="fecharModalAvisoVagas()">&times;</button>
            </div>
            <div style="padding: 20px 0;">
                <p style="margin-bottom: 20px; line-height: 1.8; color: var(--dark-gray);">
                    <strong>Não é possível reduzir o número de vagas configuradas para um valor menor que o número de vagas ocupadas.</strong>
                </p>
                <div style="background: #fff3cd; border-left: 4px solid var(--warning-orange); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <p style="margin: 0; color: #856404; font-weight: 600;">
                        <i class="fas fa-info-circle"></i> Detalhes:
                    </p>
                    <ul style="margin: 10px 0 0 20px; color: #856404;">
                        <li><strong>Vagas Ocupadas:</strong> <span id="avisoVagasOcupadas"></span></li>
                        <li><strong>Vagas Solicitadas:</strong> <span id="avisoVagasSolicitadas"></span></li>
                    </ul>
                </div>
                <p style="color: #666; font-size: 14px; margin-bottom: 0;">
                    Você deve manter pelo menos <strong id="avisoMinVagas"></strong> vagas configuradas, ou cancelar/realizar alguns agendamentos antes de reduzir.
                </p>
            </div>
            <div style="display: flex; gap: 15px; margin-top: 25px; justify-content: flex-end;">
                <button type="button" class="btn btn-primary" onclick="fecharModalAvisoVagas()">
                    <i class="fas fa-check"></i>
                    Entendi
                </button>
            </div>
        </div>
    </div>

    <!-- Modal para Editar Disponibilidade -->
    <div id="modalEditarDisponibilidade" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-edit"></i> Editar Disponibilidade</h3>
                <button class="close-modal" onclick="fecharModalEditar()">&times;</button>
            </div>

            <form id="formEditarDisponibilidade" class="config-form">
                <div class="form-row">
                    <div class="form-group">
                        <label>
                            <i class="fas fa-calendar-alt"></i>
                            Data <span style="color: var(--error-red);">*</span>
                        </label>
                        <input type="date" id="modalEditData" required>
                        <span class="help-text">Data da disponibilidade</span>
                    </div>

                    <div class="form-group">
                        <label>
                            <i class="fas fa-sun"></i>
                            Período <span style="color: var(--error-red);">*</span>
                        </label>
                        <select id="modalEditPeriodo" required>
                            <option value="">-- Selecione o Período --</option>
                            <option value="Manhã">Manhã (07:00 - 11:00)</option>
                            <option value="Tarde">Tarde (12:00 - 15:00)</option>
                        </select>
                        <span class="help-text">Período do dia</span>
                    </div>

                    <div class="form-group">
                        <label>
                            <i class="fas fa-hashtag"></i>
                            Quantidade de Vagas <span style="color: var(--error-red);">*</span>
                        </label>
                        <input type="number" id="modalEditVagas" min="1" max="100" required>
                        <span class="help-text">Número de vagas disponíveis neste período</span>
                    </div>
                </div>

                <div style="display: flex; gap: 15px; margin-top: 25px; flex-wrap: wrap;">
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save"></i>
                        Salvar Alterações
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="fecharModalEditar()">
                        <i class="fas fa-times"></i>
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Completar/Confirmar Agendamento -->
    <div id="modalCompletar" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-edit"></i> Completar Agendamento</h3>
                <button class="close-modal" onclick="fecharModal()">&times;</button>
            </div>

            <div id="dadosAgendamentoContainer" class="dados-agendamento">
                <!-- Dados do agendamento serão preenchidos aqui -->
            </div>

            <form id="formCompletar" class="formulario-completar">
                <h4><i class="fas fa-tasks"></i> Atribuir Viatura e Motorista</h4>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>
                            <i class="fas fa-car-side"></i>
                            Viatura <span style="color: var(--error-red);">*</span>
                        </label>
                        <select id="modalViatura" required>
                            <option value="">-- Selecione a Viatura --</option>
                        </select>
                        <span class="help-text">Viatura que será utilizada</span>
                    </div>

                    <div class="form-group">
                        <label>
                            <i class="fas fa-user-tie"></i>
                            Motorista <span style="color: var(--error-red);">*</span>
                        </label>
                        <select id="modalMotorista" required>
                            <option value="">-- Selecione o Motorista --</option>
                        </select>
                        <span class="help-text">Motorista responsável</span>
                    </div>
                </div>

                <div style="display: flex; gap: 15px; margin-top: 25px; flex-wrap: wrap;">
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-check-circle"></i>
                        Confirmar Saída
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="fecharModal()">
                        <i class="fas fa-times"></i>
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const configForm = document.getElementById('configForm');
        const inputData = document.getElementById('inputData');
        const inputPeriodo = document.getElementById('inputPeriodo');
        const inputVagas = document.getElementById('inputVagas');
        const disponibilidadesTableBody = document.getElementById('disponibilidadesTableBody');
        const messageContainer = document.getElementById('messageContainer');
        const btnLimpar = document.getElementById('btnLimpar');
        const btnConfigRapida = document.getElementById('btnConfigRapida');
        const statsGrid = document.getElementById('statsGrid');
        const agendamentosPendentesBody = document.getElementById('agendamentosPendentesBody');
        const agendamentosConfirmadosBody = document.getElementById('agendamentosConfirmadosBody');
        const modalCompletar = document.getElementById('modalCompletar');
        const formCompletar = document.getElementById('formCompletar');
        const modalViatura = document.getElementById('modalViatura');
        const modalMotorista = document.getElementById('modalMotorista');
        const dadosAgendamentoContainer = document.getElementById('dadosAgendamentoContainer');
        const modalEditarDisponibilidade = document.getElementById('modalEditarDisponibilidade');
        const formEditarDisponibilidade = document.getElementById('formEditarDisponibilidade');
        const modalEditData = document.getElementById('modalEditData');
        const modalEditPeriodo = document.getElementById('modalEditPeriodo');
        const modalEditVagas = document.getElementById('modalEditVagas');
        const modalAvisoVagas = document.getElementById('modalAvisoVagas');
        let editingKey = null;
        let agendamentoAtual = null;
        let viaturas = [];
        let motoristas = [];

        const horariosManha = ['07:00', '08:00', '09:00', '10:00', '11:00'];
        const horariosTarde = ['12:00', '13:00', '14:00', '15:00'];

        // Definir data mínima como hoje
        const today = new Date().toISOString().split('T')[0];
        inputData.setAttribute('min', today);
        document.getElementById('dataInicial').setAttribute('min', today);
        document.getElementById('dataFinal').setAttribute('min', today);

        // Navegação entre Sub-Abas
        function changeSubTab(subTabId) {
            // Remover classe active de todos os botões e conteúdos
            document.querySelectorAll('.sub-tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelectorAll('.sub-tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // Adicionar classe active ao botão e conteúdo selecionados
            const button = document.querySelector(`[data-sub-tab="${subTabId}"]`);
            const content = document.getElementById(`sub-tab-${subTabId}`);
            
            if (button) button.classList.add('active');
            if (content) content.classList.add('active');
        }

        // Adicionar event listeners aos botões de sub-abas
        document.querySelectorAll('.sub-tab-button').forEach(button => {
            button.addEventListener('click', function() {
                const subTabId = this.getAttribute('data-sub-tab');
                changeSubTab(subTabId);
                
                // Recarregar dados específicos quando cada sub-aba for clicada
                switch(subTabId) {
                    case 'configuradas':
                        loadDisponibilidades();
                        break;
                    case 'pendentes':
                        loadAgendamentosPendentes();
                        break;
                    case 'confirmados':
                        loadAgendamentosConfirmados();
                        break;
                    // Para 'adicionar-editar' e 'rapidas', não precisa recarregar
                }
            });
        });

        // Função para mostrar mensagem
        function showMessage(text, type = 'info') {
            const message = document.createElement('div');
            message.className = `message ${type}`;
            
            const icon = type === 'success' ? 'fa-check-circle' : 
                        type === 'error' ? 'fa-exclamation-circle' : 
                        'fa-info-circle';
            
            message.innerHTML = `
                <i class="fas ${icon}"></i>
                <span>${text}</span>
            `;
            
            messageContainer.innerHTML = '';
            messageContainer.appendChild(message);
            
            setTimeout(() => {
                message.style.opacity = '0';
                setTimeout(() => message.remove(), 300);
            }, 5000);
        }

        // Função para carregar disponibilidades
        function loadDisponibilidades() {
            try {
                const stored = localStorage.getItem('disponibilidadeViaturas');
                const disponibilidades = stored ? JSON.parse(stored) : {};
                
                // Carregar agendamentos para calcular vagas ocupadas
                const saidas = JSON.parse(localStorage.getItem('saidasAdministrativas') || '[]');
                
                const keys = Object.keys(disponibilidades).sort();
                
                disponibilidadesTableBody.innerHTML = '';
                
                if (keys.length === 0) {
                    disponibilidadesTableBody.innerHTML = `
                        <tr>
                            <td colspan="7">
                                <div class="empty-state">
                                    <i class="fas fa-inbox"></i>
                                    <p>Nenhuma disponibilidade configurada</p>
                                </div>
                            </td>
                        </tr>
                    `;
                } else {
                    keys.forEach(key => {
                        const [data, periodo] = key.split('_');
                        const disponibilidade = disponibilidades[key];
                        const vagasConfiguradas = disponibilidade.vagas || 0;
                        
                        // Determinar horários do período
                        const horariosPeriodo = periodo === 'Manhã' ? horariosManha : horariosTarde;
                        
                        // Contar agendamentos para este período
                        const saidasNoPeriodo = saidas.filter(s => {
                            const saidaData = s.dataSaida || s.data || '';
                            const saidaHora = s.horaSaida || s.hora || s.horario || '';
                            return saidaData === data && horariosPeriodo.includes(saidaHora) && !s.realizada;
                        });
                        
                        const vagasOcupadas = saidasNoPeriodo.length;
                        const vagasDisponiveis = Math.max(0, vagasConfiguradas - vagasOcupadas);
                        
                        let statusBadge = '';
                        if (vagasDisponiveis === 0) {
                            statusBadge = '<span class="badge danger">Esgotado</span>';
                        } else if (vagasDisponiveis <= 2) {
                            statusBadge = '<span class="badge warning">Limitado</span>';
                        } else {
                            statusBadge = '<span class="badge success">Disponível</span>';
                        }
                        
                        const periodoDisplay = periodo === 'Manhã' ? 'Manhã (07:00 - 11:00)' : 'Tarde (12:00 - 15:00)';
                        
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${formatDate(data)}</td>
                            <td>${periodoDisplay}</td>
                            <td><strong>${vagasConfiguradas}</strong></td>
                            <td>${vagasOcupadas}</td>
                            <td><strong>${vagasDisponiveis}</strong></td>
                            <td>${statusBadge}</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-primary btn-small" onclick="editDisponibilidade('${key}')">
                                        <i class="fas fa-edit"></i> Editar
                                    </button>
                                    <button class="btn btn-danger btn-small" onclick="deleteDisponibilidade('${key}')">
                                        <i class="fas fa-trash"></i> Excluir
                                    </button>
                                </div>
                            </td>
                        `;
                        disponibilidadesTableBody.appendChild(tr);
                    });
                }
                
                // Atualizar estatísticas
                updateStats(disponibilidades, saidas, horariosManha, horariosTarde);
            } catch (error) {
                console.error('Erro ao carregar disponibilidades:', error);
                showMessage('Erro ao carregar disponibilidades.', 'error');
            }
        }

        // Função para atualizar estatísticas
        function updateStats(disponibilidades, saidas, horariosManha, horariosTarde) {
            const totalConfiguradas = Object.keys(disponibilidades).length;
            let totalVagas = 0;
            let totalOcupadas = 0;
            
            Object.entries(disponibilidades).forEach(([key, config]) => {
                const [data, periodo] = key.split('_');
                const vagasConfiguradas = config.vagas || 0;
                totalVagas += vagasConfiguradas;
                
                const horariosPeriodo = periodo === 'Manhã' ? horariosManha : horariosTarde;
                const saidasNoPeriodo = saidas.filter(s => {
                    const saidaData = s.dataSaida || s.data || '';
                    const saidaHora = s.horaSaida || s.hora || s.horario || '';
                    return saidaData === data && horariosPeriodo.includes(saidaHora) && !s.realizada;
                });
                
                totalOcupadas += saidasNoPeriodo.length;
            });
            
            const totalDisponiveis = Math.max(0, totalVagas - totalOcupadas);
            
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <h3>Períodos Configurados</h3>
                    <div class="value">${totalConfiguradas}</div>
                </div>
                <div class="stat-card">
                    <h3>Total de Vagas</h3>
                    <div class="value">${totalVagas}</div>
                </div>
                <div class="stat-card">
                    <h3>Vagas Ocupadas</h3>
                    <div class="value">${totalOcupadas}</div>
                </div>
                <div class="stat-card">
                    <h3>Vagas Disponíveis</h3>
                    <div class="value">${totalDisponiveis}</div>
                </div>
            `;
        }

        // Função para formatar data
        function formatDate(dateString) {
            const date = new Date(dateString + 'T00:00:00');
            return date.toLocaleDateString('pt-BR');
        }

        // Função para editar disponibilidade
        window.editDisponibilidade = function(key) {
            const disponibilidades = JSON.parse(localStorage.getItem('disponibilidadeViaturas') || '{}');
            const disponibilidade = disponibilidades[key];
            
            if (disponibilidade) {
                const [data, periodo] = key.split('_');
                editingKey = key;
                
                // Preencher campos do modal
                modalEditData.value = data;
                modalEditPeriodo.value = periodo;
                modalEditVagas.value = disponibilidade.vagas || 1;
                
                // Definir data mínima
                modalEditData.setAttribute('min', today);
                
                // Abrir modal
                modalEditarDisponibilidade.classList.add('active');
            }
        };

        // Função para fechar modal de edição
        window.fecharModalEditar = function() {
            modalEditarDisponibilidade.classList.remove('active');
            formEditarDisponibilidade.reset();
            editingKey = null;
        };

        // Função para fechar modal de aviso de vagas
        window.fecharModalAvisoVagas = function() {
            modalAvisoVagas.classList.remove('active');
        };

        // Salvar edição no modal
        formEditarDisponibilidade.addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!editingKey) {
                showMessage('Erro: Chave de edição não encontrada.', 'error');
                return;
            }
            
            const data = modalEditData.value;
            const periodo = modalEditPeriodo.value;
            const vagas = parseInt(modalEditVagas.value);
            
            if (!data || !periodo || !vagas || vagas < 1) {
                showMessage('Por favor, preencha todos os campos corretamente.', 'error');
                return;
            }
            
            try {
                // Verificar vagas ocupadas antes de salvar
                const saidas = JSON.parse(localStorage.getItem('saidasAdministrativas') || '[]');
                const horariosPeriodo = periodo === 'Manhã' ? horariosManha : horariosTarde;
                
                // Contar agendamentos para este período (mesma lógica de loadDisponibilidades)
                const saidasNoPeriodo = saidas.filter(s => {
                    const saidaData = s.dataSaida || s.data || '';
                    const saidaHora = s.horaSaida || s.hora || s.horario || '';
                    return saidaData === data && horariosPeriodo.includes(saidaHora) && !s.realizada;
                });
                
                const vagasOcupadas = saidasNoPeriodo.length;
                
                // Validar se as novas vagas são suficientes
                if (vagas < vagasOcupadas) {
                    // Fechar modal de edição primeiro
                    fecharModalEditar();
                    
                    // Preencher dados do modal de aviso
                    document.getElementById('avisoVagasOcupadas').textContent = vagasOcupadas;
                    document.getElementById('avisoVagasSolicitadas').textContent = vagas;
                    document.getElementById('avisoMinVagas').textContent = vagasOcupadas;
                    
                    // Mostrar modal de aviso
                    setTimeout(() => {
                        modalAvisoVagas.classList.add('active');
                    }, 300); // Pequeno delay para transição suave
                    
                    return; // Impedir salvamento
                }
                
                const disponibilidades = JSON.parse(localStorage.getItem('disponibilidadeViaturas') || '{}');
                const newKey = `${data}_${periodo}`;
                
                // Se a chave mudou (data ou período), remover a antiga
                if (editingKey !== newKey) {
                    delete disponibilidades[editingKey];
                }
                
                // Atualizar ou criar nova disponibilidade
                disponibilidades[newKey] = {
                    data: data,
                    periodo: periodo,
                    vagas: vagas,
                    dataAtualizacao: new Date().toISOString()
                };
                
                localStorage.setItem('disponibilidadeViaturas', JSON.stringify(disponibilidades));
                
                loadDisponibilidades();
                gerarCalendario(); // Atualizar calendário
                showMessage('Disponibilidade atualizada com sucesso!', 'success');
                
                // Fechar modal
                fecharModalEditar();
                
            } catch (error) {
                console.error('Erro ao atualizar disponibilidade:', error);
                showMessage('Erro ao atualizar disponibilidade.', 'error');
            }
        });

        // Fechar modal de edição ao clicar fora
        modalEditarDisponibilidade.addEventListener('click', function(e) {
            if (e.target === modalEditarDisponibilidade) {
                fecharModalEditar();
            }
        });

        // Fechar modal de edição com ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                if (modalEditarDisponibilidade.classList.contains('active')) {
                    fecharModalEditar();
                } else if (modalAvisoVagas.classList.contains('active')) {
                    fecharModalAvisoVagas();
                }
            }
        });

        // Fechar modal de aviso ao clicar fora
        modalAvisoVagas.addEventListener('click', function(e) {
            if (e.target === modalAvisoVagas) {
                fecharModalAvisoVagas();
            }
        });

        // Função para excluir disponibilidade
        window.deleteDisponibilidade = function(key) {
            if (!confirm('Tem certeza que deseja excluir esta disponibilidade?')) {
                return;
            }
            
            try {
                const disponibilidades = JSON.parse(localStorage.getItem('disponibilidadeViaturas') || '{}');
                delete disponibilidades[key];
                localStorage.setItem('disponibilidadeViaturas', JSON.stringify(disponibilidades));
                
                loadDisponibilidades();
                gerarCalendario(); // Atualizar calendário
                showMessage('Disponibilidade excluída com sucesso!', 'success');
            } catch (error) {
                console.error('Erro ao excluir disponibilidade:', error);
                showMessage('Erro ao excluir disponibilidade.', 'error');
            }
        };

        // Salvar configuração
        configForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const data = inputData.value;
            const periodo = inputPeriodo.value;
            const vagas = parseInt(inputVagas.value);
            
            if (!data || !periodo || !vagas || vagas < 1) {
                showMessage('Por favor, preencha todos os campos corretamente.', 'error');
                return;
            }
            
            try {
                const disponibilidades = JSON.parse(localStorage.getItem('disponibilidadeViaturas') || '{}');
                const key = `${data}_${periodo}`;
                
                disponibilidades[key] = {
                    data: data,
                    periodo: periodo,
                    vagas: vagas,
                    dataAtualizacao: new Date().toISOString()
                };
                
                localStorage.setItem('disponibilidadeViaturas', JSON.stringify(disponibilidades));
                
                loadDisponibilidades();
                
                if (editingKey && editingKey === key) {
                    showMessage('Disponibilidade atualizada com sucesso!', 'success');
                } else {
                    showMessage('Disponibilidade configurada com sucesso!', 'success');
                }
                
                // Limpar formulário
                editingKey = null;
                configForm.reset();
                inputData.setAttribute('min', today);
                
            } catch (error) {
                console.error('Erro ao salvar disponibilidade:', error);
                showMessage('Erro ao salvar disponibilidade.', 'error');
            }
        });

        // Limpar formulário
        btnLimpar.addEventListener('click', function() {
            configForm.reset();
            editingKey = null;
            inputData.setAttribute('min', today);
            showMessage('Formulário limpo.', 'info');
        });

        // Configuração rápida
        btnConfigRapida.addEventListener('click', function() {
            const dataInicial = document.getElementById('dataInicial').value;
            const dataFinal = document.getElementById('dataFinal').value;
            const periodosSelect = document.getElementById('periodosRapidos');
            const periodosSelecionados = Array.from(periodosSelect.selectedOptions).map(opt => opt.value);
            const vagas = parseInt(document.getElementById('vagasRapidas').value);
            
            if (!dataInicial || !dataFinal || periodosSelecionados.length === 0 || !vagas || vagas < 1) {
                showMessage('Por favor, preencha todos os campos da configuração rápida.', 'error');
                return;
            }
            
            const dataIni = new Date(dataInicial + 'T00:00:00');
            const dataFim = new Date(dataFinal + 'T00:00:00');
            
            if (dataFim < dataIni) {
                showMessage('A data final deve ser posterior à data inicial.', 'error');
                return;
            }
            
            try {
                const disponibilidades = JSON.parse(localStorage.getItem('disponibilidadeViaturas') || '{}');
                let criadas = 0;
                
                const currentDate = new Date(dataIni);
                while (currentDate <= dataFim) {
                    const dataStr = currentDate.toISOString().split('T')[0];
                    
                    periodosSelecionados.forEach(periodo => {
                        const key = `${dataStr}_${periodo}`;
                        disponibilidades[key] = {
                            data: dataStr,
                            periodo: periodo,
                            vagas: vagas,
                            dataAtualizacao: new Date().toISOString(),
                            criadoViaLote: true
                        };
                        criadas++;
                    });
                    
                    currentDate.setDate(currentDate.getDate() + 1);
                }
                
                localStorage.setItem('disponibilidadeViaturas', JSON.stringify(disponibilidades));
                
                loadDisponibilidades();
                showMessage(`${criadas} configurações criadas com sucesso!`, 'success');
                gerarCalendario(); // Atualizar calendário
                
                // Limpar formulário rápido
                document.getElementById('dataInicial').value = '';
                document.getElementById('dataFinal').value = '';
                periodosSelect.selectedIndex = -1;
                document.getElementById('vagasRapidas').value = '';
                
            } catch (error) {
                console.error('Erro ao criar configurações em lote:', error);
                showMessage('Erro ao criar configurações.', 'error');
            }
        });

        // Atualizar quando houver mudanças no localStorage (de outras abas)
        window.addEventListener('storage', function(e) {
            if (e.key === 'disponibilidadeViaturas' || e.key === 'saidasAdministrativas') {
                loadDisponibilidades();
                loadAgendamentosPendentes();
                gerarCalendario(); // Atualizar calendário
            }
        });

        // Ouvir mensagens do sistema principal (SOT5)
        window.addEventListener('message', function(event) {
            // Atualizar dados quando solicitado
            if (event.data?.type === 'refresh_all_data') {
                setTimeout(() => {
                    loadDisponibilidades();
                    loadAgendamentosPendentes();
                    loadAgendamentosConfirmados();
                    loadViaturasEMotoristas();
                    gerarCalendario(); // Atualizar calendário
                }, 100);
            }
            // Aplicar tema quando alterado
            if (event.data?.type === 'apply_theme') {
                const { themeVariables, themeId } = event.data;
                if (themeVariables) {
                    Object.entries(themeVariables).forEach(([key, value]) => {
                        if (typeof key === 'string' && key.startsWith('--')) {
                            document.documentElement.style.setProperty(key, value);
                        }
                    });
                }
                if (themeId && document.body) {
                    document.body.dataset.theme = themeId;
                }
            }
            // Listener para bloqueio/desbloqueio do sistema
            if (event.data?.type === 'lock_state_change') {
                const { locked } = event.data;
                // Se sistema bloqueado, desabilitar ações administrativas
                document.querySelectorAll('.btn-primary, .btn-success, .btn-danger').forEach(btn => {
                    if (locked) {
                        btn.disabled = true;
                        btn.style.opacity = '0.5';
                        btn.style.cursor = 'not-allowed';
                    } else {
                        btn.disabled = false;
                        btn.style.opacity = '1';
                        btn.style.cursor = 'pointer';
                    }
                });
            }
        });

        // Carregar viaturas e motoristas
        async function loadViaturasEMotoristas() {
            try {
                // Aguardar um pouco para garantir que dataService foi carregado
                if (typeof dataService !== 'undefined') {
                    // Aguardar verificação da API
                    await dataService.waitForAPICheck();
                    viaturas = await dataService.getViaturas();
                    motoristas = await dataService.getMotoristas();
                } else {
                    const storedViaturas = localStorage.getItem('viaturasCadastradas');
                    const storedMotoristas = localStorage.getItem('motoristasCadastrados');
                    viaturas = storedViaturas ? JSON.parse(storedViaturas) : [];
                    motoristas = storedMotoristas ? JSON.parse(storedMotoristas) : [];
                }
                viaturas = Array.isArray(viaturas) ? viaturas.filter(v => v && (v.placa || v.identificacao || v.nome)) : [];
                motoristas = Array.isArray(motoristas) ? motoristas.filter(m => m && (m.nome || m.nomeCompleto)) : [];
                
                if (viaturas.length === 0) {
                    console.warn('Nenhuma viatura cadastrada no sistema.');
                }
                if (motoristas.length === 0) {
                    console.warn('Nenhum motorista cadastrado no sistema.');
                }
            } catch (error) {
                console.error('Erro ao carregar viaturas e motoristas:', error);
                // Fallback para localStorage
                try {
                    const storedViaturas = localStorage.getItem('viaturasCadastradas');
                    const storedMotoristas = localStorage.getItem('motoristasCadastrados');
                    viaturas = storedViaturas ? JSON.parse(storedViaturas) : [];
                    motoristas = storedMotoristas ? JSON.parse(storedMotoristas) : [];
                    viaturas = Array.isArray(viaturas) ? viaturas.filter(v => v && (v.placa || v.identificacao || v.nome)) : [];
                    motoristas = Array.isArray(motoristas) ? motoristas.filter(m => m && (m.nome || m.nomeCompleto)) : [];
                } catch (e) {
                    viaturas = [];
                    motoristas = [];
                }
            }
        }

        // Carregar agendamentos pendentes
        async function loadAgendamentosPendentes() {
            try {
                let todasSaidas = [];
                if (typeof dataService !== 'undefined') {
                    todasSaidas = await dataService.getSaidasAdministrativas();
                } else {
                    todasSaidas = JSON.parse(localStorage.getItem('saidasAdministrativas') || '[]');
                }

                // Filtrar agendamentos pendentes: feitos via frontend sem viatura/motorista OU sem status de confirmação
                const pendentes = todasSaidas.filter(s => {
                    // Não incluir saídas já realizadas
                    if (s.realizada) return false;
                    
                    // Não incluir canceladas
                    if (s.statusConfirmacao === 'cancelado') return false;
                    
                    // Agendamentos via frontend que não estão confirmados
                    if (s.agendadoViaFrontend) {
                        return s.statusConfirmacao !== 'confirmado';
                    }
                    
                    // Saídas antigas (não via frontend) que não têm viatura/motorista completos
                    const temViatura = s.viatura && s.viatura.trim() !== '';
                    const temMotorista = s.motorista && s.motorista.trim() !== '';
                    return !temViatura || !temMotorista;
                });

                agendamentosPendentesBody.innerHTML = '';

                if (pendentes.length === 0) {
                    agendamentosPendentesBody.innerHTML = `
                        <tr>
                            <td colspan="7">
                                <div class="empty-state">
                                    <i class="fas fa-check-circle"></i>
                                    <p>Nenhum agendamento pendente</p>
                                </div>
                            </td>
                        </tr>
                    `;
                } else {
                    pendentes.sort((a, b) => {
                        const dataA = new Date(`${a.dataSaida || a.data}T${a.horaSaida || a.hora || '00:00'}`);
                        const dataB = new Date(`${b.dataSaida || b.data}T${b.horaSaida || b.hora || '00:00'}`);
                        return dataA - dataB;
                    });

                    pendentes.forEach(agendamento => {
                        const tr = document.createElement('tr');
                        const dataHora = agendamento.dataSaida || agendamento.data || 'N/A';
                        const hora = agendamento.horaSaida || agendamento.hora || agendamento.horario || 'N/A';
                        const tipoViatura = agendamento.tipoViatura || 'Não especificado';
                        const destino = `${agendamento.cidade || ''} - ${agendamento.bairro || ''}`.trim() || 'N/A';
                        const responsavel = agendamento.responsavelPedido || 'Não informado';
                        const setorRamal = `${agendamento.setor || ''}${agendamento.ramal ? ' / ' + agendamento.ramal : ''}`.trim() || 'Não informado';

                        tr.innerHTML = `
                            <td>${formatDate(dataHora)}<br><small style="color: #666;">${hora}</small></td>
                            <td><strong>${tipoViatura}</strong></td>
                            <td>${destino}</td>
                            <td>${responsavel}</td>
                            <td>${setorRamal}</td>
                            <td><span class="badge pendente">Pendente</span></td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-primary btn-small" onclick="abrirModalCompletar('${agendamento.id}')">
                                        <i class="fas fa-edit"></i> Completar
                                    </button>
                                </div>
                            </td>
                        `;
                        agendamentosPendentesBody.appendChild(tr);
                    });
                }
            } catch (error) {
                console.error('Erro ao carregar agendamentos pendentes:', error);
                agendamentosPendentesBody.innerHTML = `
                    <tr>
                        <td colspan="7">
                            <div class="empty-state">
                                <i class="fas fa-exclamation-triangle"></i>
                                <p>Erro ao carregar agendamentos</p>
                            </div>
                        </td>
                    </tr>
                `;
            }
        }

        // Carregar agendamentos confirmados
        async function loadAgendamentosConfirmados() {
            try {
                let todasSaidas = [];
                if (typeof dataService !== 'undefined') {
                    todasSaidas = await dataService.getSaidasAdministrativas();
                } else {
                    todasSaidas = JSON.parse(localStorage.getItem('saidasAdministrativas') || '[]');
                }

                const confirmados = todasSaidas.filter(s => {
                    const temViatura = s.viatura && s.viatura.trim() !== '';
                    const temMotorista = s.motorista && s.motorista.trim() !== '';
                    const estaConfirmado = s.statusConfirmacao === 'confirmado';
                    return (temViatura && temMotorista && estaConfirmado) || (!s.agendadoViaFrontend && temViatura && temMotorista);
                });

                agendamentosConfirmadosBody.innerHTML = '';

                if (confirmados.length === 0) {
                    agendamentosConfirmadosBody.innerHTML = `
                        <tr>
                            <td colspan="7">
                                <div class="empty-state">
                                    <i class="fas fa-inbox"></i>
                                    <p>Nenhum agendamento confirmado</p>
                                </div>
                            </td>
                        </tr>
                    `;
                } else {
                    confirmados.sort((a, b) => {
                        const dataA = new Date(`${a.dataSaida || a.data}T${a.horaSaida || a.hora || '00:00'}`);
                        const dataB = new Date(`${b.dataSaida || b.data}T${b.horaSaida || b.hora || '00:00'}`);
                        return dataB - dataA; // Mais recentes primeiro
                    });

                    confirmados.forEach(agendamento => {
                        const tr = document.createElement('tr');
                        const dataHora = agendamento.dataSaida || agendamento.data || 'N/A';
                        const hora = agendamento.horaSaida || agendamento.hora || agendamento.horario || 'N/A';
                        const tipoViatura = agendamento.tipoViatura || 'Não especificado';
                        const viatura = agendamento.viatura || 'N/A';
                        const motorista = agendamento.motorista || 'N/A';
                        const destino = `${agendamento.cidade || ''} - ${agendamento.bairro || ''}`.trim() || 'N/A';
                        const dataConfirmacao = agendamento.dataConfirmacao ? 
                            new Date(agendamento.dataConfirmacao).toLocaleDateString('pt-BR') : '';

                        tr.innerHTML = `
                            <td>${formatDate(dataHora)}<br><small style="color: #666;">${hora}</small></td>
                            <td>${tipoViatura}</td>
                            <td><strong style="color: var(--primary-blue);">${viatura}</strong></td>
                            <td><strong style="color: var(--primary-blue);">${motorista}</strong></td>
                            <td>${destino}</td>
                            <td>
                                <span class="badge confirmado">Confirmado</span>
                                ${dataConfirmacao ? `<br><small style="color: #666; font-size: 11px;">Confirmado em ${dataConfirmacao}</small>` : ''}
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-primary btn-small" onclick="visualizarAgendamento('${agendamento.id}')">
                                        <i class="fas fa-eye"></i> Ver Detalhes
                                    </button>
                                </div>
                            </td>
                        `;
                        agendamentosConfirmadosBody.appendChild(tr);
                    });
                }
            } catch (error) {
                console.error('Erro ao carregar agendamentos confirmados:', error);
            }
        }

        // Abrir modal para completar agendamento
        window.abrirModalCompletar = async function(agendamentoId) {
            try {
                let todasSaidas = [];
                if (typeof dataService !== 'undefined') {
                    todasSaidas = await dataService.getSaidasAdministrativas();
                } else {
                    todasSaidas = JSON.parse(localStorage.getItem('saidasAdministrativas') || '[]');
                }

                agendamentoAtual = todasSaidas.find(s => s.id === agendamentoId);

                if (!agendamentoAtual) {
                    showMessage('Agendamento não encontrado.', 'error');
                    return;
                }

                // Preencher dados do agendamento
                const dataHora = agendamentoAtual.dataSaida || agendamentoAtual.data || 'N/A';
                const hora = agendamentoAtual.horaSaida || agendamentoAtual.hora || agendamentoAtual.horario || 'N/A';
                const tipoViatura = agendamentoAtual.tipoViatura || 'Não especificado';
                const destino = `${agendamentoAtual.cidade || ''} - ${agendamentoAtual.bairro || ''}`.trim() || 'N/A';
                const objetivo = agendamentoAtual.objetivo || 'Não informado';
                const responsavel = agendamentoAtual.responsavelPedido || 'Não informado';
                const setor = agendamentoAtual.setor || 'Não informado';
                const ramal = agendamentoAtual.ramal || 'Não informado';
                const numPassageiros = agendamentoAtual.numPassageiros || 1;
                const observacoes = agendamentoAtual.observacoes || '';

                const confirmacaoInfo = agendamentoAtual.statusConfirmacao === 'confirmado' && (agendamentoAtual.dataConfirmacao || agendamentoAtual.confirmadoPor) ? `
                    <div class="dado-item full-width" style="margin-top: 15px; padding-top: 15px; border-top: 2px solid var(--success-green); background: #f0f9f4; padding: 15px; border-radius: 6px;">
                        <label style="color: var(--success-green);"><i class="fas fa-check-circle"></i> Informações de Confirmação</label>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 10px;">
                            ${agendamentoAtual.dataConfirmacao ? `
                            <div>
                                <label style="font-size: 11px;">Data da Confirmação</label>
                                <span style="font-weight: 600;">${new Date(agendamentoAtual.dataConfirmacao).toLocaleDateString('pt-BR')} às ${new Date(agendamentoAtual.dataConfirmacao).toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'})}</span>
                            </div>
                            ` : ''}
                            ${agendamentoAtual.confirmadoPor ? `
                            <div>
                                <label style="font-size: 11px;">Confirmado Por</label>
                                <span style="font-weight: 600;">${agendamentoAtual.confirmadoPor}</span>
                            </div>
                            ` : ''}
                            ${agendamentoAtual.viatura ? `
                            <div>
                                <label style="font-size: 11px;">Viatura Atribuída</label>
                                <span style="font-weight: 600; color: var(--primary-blue);">${agendamentoAtual.viatura}</span>
                            </div>
                            ` : ''}
                            ${agendamentoAtual.motorista ? `
                            <div>
                                <label style="font-size: 11px;">Motorista Atribuído</label>
                                <span style="font-weight: 600; color: var(--primary-blue);">${agendamentoAtual.motorista}</span>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                ` : '';

                dadosAgendamentoContainer.innerHTML = `
                    <h4><i class="fas fa-info-circle"></i> Dados do Pedido de Agendamento</h4>
                    <div class="dados-grid">
                        <div class="dado-item">
                            <label>Data/Hora</label>
                            <span>${formatDate(dataHora)} às ${hora}</span>
                        </div>
                        <div class="dado-item">
                            <label>Tipo de Viatura</label>
                            <span><strong>${tipoViatura}</strong></span>
                        </div>
                        <div class="dado-item">
                            <label>Destino</label>
                            <span>${destino}</span>
                        </div>
                        <div class="dado-item">
                            <label>Objetivo/Motivo</label>
                            <span>${objetivo}</span>
                        </div>
                        <div class="dado-item">
                            <label>Responsável</label>
                            <span>${responsavel}</span>
                        </div>
                        <div class="dado-item">
                            <label>Setor/Ramal</label>
                            <span>${setor}${ramal !== 'Não informado' ? ' / ' + ramal : ''}</span>
                        </div>
                        <div class="dado-item">
                            <label>Passageiros</label>
                            <span>${numPassageiros}</span>
                        </div>
                        ${observacoes ? `
                        <div class="dado-item full-width">
                            <label>Observações do Solicitante</label>
                            <span>${observacoes}</span>
                        </div>
                        ` : ''}
                        ${confirmacaoInfo}
                    </div>
                `;

                // Filtrar viaturas por tipo
                const viaturasFiltradas = viaturas.filter(v => {
                    const placa = (v.placa || v.identificacao || '').toLowerCase();
                    const tipoViaturaLower = tipoViatura.toLowerCase();
                    
                    // Filtrar por tipo (lógica básica - pode ser melhorada)
                    if (tipoViaturaLower.includes('carro')) {
                        return !placa.includes('van') && !placa.includes('caminhão') && !placa.includes('caminhao');
                    } else if (tipoViaturaLower.includes('van')) {
                        return placa.includes('van') || placa.includes('v ');
                    } else if (tipoViaturaLower.includes('caminhão') || tipoViaturaLower.includes('caminhao')) {
                        return placa.includes('caminhão') || placa.includes('caminhao') || placa.includes('cmh');
                    }
                    return true; // Se não conseguir identificar, mostra todas
                });

                // Carregar viaturas no select
                modalViatura.innerHTML = '<option value="">-- Selecione a Viatura --</option>';
                (viaturasFiltradas.length > 0 ? viaturasFiltradas : viaturas).forEach(viatura => {
                    const option = document.createElement('option');
                    const identificacao = viatura.placa || viatura.identificacao || viatura.nome || 'Sem identificação';
                    option.value = identificacao;
                    option.textContent = identificacao;
                    if (agendamentoAtual.viatura === identificacao) {
                        option.selected = true;
                    }
                    modalViatura.appendChild(option);
                });

                // Carregar motoristas no select
                modalMotorista.innerHTML = '<option value="">-- Selecione o Motorista --</option>';
                motoristas.forEach(motorista => {
                    const option = document.createElement('option');
                    const nome = motorista.nome || motorista.nomeCompleto || 'Sem nome';
                    option.value = nome;
                    option.textContent = nome;
                    if (agendamentoAtual.motorista === nome) {
                        option.selected = true;
                    }
                    modalMotorista.appendChild(option);
                });

                // Reabilitar campos ao abrir modal (caso tenha sido desabilitado anteriormente)
                modalViatura.disabled = false;
                modalMotorista.disabled = false;
                const submitBtn = formCompletar.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.style.display = 'inline-flex';
                    submitBtn.innerHTML = '<i class="fas fa-check-circle"></i> Confirmar Saída';
                }
                const modalHeader = document.querySelector('.modal-header h3');
                if (modalHeader) {
                    modalHeader.innerHTML = '<i class="fas fa-edit"></i> Completar Agendamento';
                }

                // Abrir modal
                modalCompletar.classList.add('active');
            } catch (error) {
                console.error('Erro ao abrir modal:', error);
                showMessage('Erro ao carregar dados do agendamento.', 'error');
            }
        };

        // Fechar modal
        window.fecharModal = function() {
            modalCompletar.classList.remove('active');
            formCompletar.reset();
            agendamentoAtual = null;
            // Reabilitar campos ao fechar
            modalViatura.disabled = false;
            modalMotorista.disabled = false;
            const submitBtn = formCompletar.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.style.display = 'inline-flex';
                submitBtn.innerHTML = '<i class="fas fa-check-circle"></i> Confirmar Saída';
            }
            // Restaurar título do modal
            const modalHeader = document.querySelector('.modal-header h3');
            if (modalHeader) {
                modalHeader.innerHTML = '<i class="fas fa-edit"></i> Completar Agendamento';
            }
        };

        // Visualizar agendamento confirmado
        window.visualizarAgendamento = async function(agendamentoId) {
            await abrirModalCompletar(agendamentoId);
            // Desabilitar campos para visualização apenas
            setTimeout(() => {
                modalViatura.disabled = true;
                modalMotorista.disabled = true;
                const submitBtn = formCompletar.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.style.display = 'none';
                    submitBtn.innerHTML = '<i class="fas fa-eye"></i> Visualizando';
                }
                // Adicionar indicador visual de modo visualização
                const modalHeader = document.querySelector('.modal-header h3');
                if (modalHeader) {
                    modalHeader.innerHTML = '<i class="fas fa-eye"></i> Visualizar Agendamento Confirmado';
                }
            }, 100);
        };

        // Salvar e confirmar agendamento
        formCompletar.addEventListener('submit', async function(e) {
            e.preventDefault();

            if (!agendamentoAtual) {
                showMessage('Nenhum agendamento selecionado.', 'error');
                return;
            }

            const viatura = modalViatura.value;
            const motorista = modalMotorista.value;

            if (!viatura || !motorista) {
                showMessage('Por favor, selecione a viatura e o motorista.', 'error');
                return;
            }

            try {
                // Atualizar agendamento
                let todasSaidas = [];
                if (typeof dataService !== 'undefined') {
                    todasSaidas = await dataService.getSaidasAdministrativas();
                } else {
                    todasSaidas = JSON.parse(localStorage.getItem('saidasAdministrativas') || '[]');
                }

                const index = todasSaidas.findIndex(s => s.id === agendamentoAtual.id);
                if (index === -1) {
                    showMessage('Agendamento não encontrado na lista.', 'error');
                    return;
                }

                // Atualizar dados do agendamento
                todasSaidas[index] = {
                    ...todasSaidas[index],
                    viatura: viatura,
                    motorista: motorista,
                    statusConfirmacao: 'confirmado',
                    dataConfirmacao: new Date().toISOString(),
                    confirmadoPor: 'Administrador' // Pode ser melhorado com nome do usuário logado
                };

                // Salvar todas as saídas atualizadas
                localStorage.setItem('saidasAdministrativas', JSON.stringify(todasSaidas));
                
                // Se usar API, tentar sincronizar
                if (typeof dataService !== 'undefined' && dataService.apiAvailable) {
                    try {
                        await dataService.saveSaidaAdministrativa(todasSaidas[index]);
                    } catch (error) {
                        console.warn('Erro ao sincronizar com API, dados salvos apenas localmente:', error);
                    }
                }

                const nomeResponsavel = agendamentoAtual.responsavelPedido || 'o solicitante';
                showMessage(`✅ Agendamento confirmado com sucesso! A viatura ${viatura} e o motorista ${motorista} foram atribuídos. ${nomeResponsavel} será notificado.`, 'success');
                
                // Aguardar um pouco para mostrar a mensagem antes de fechar
                setTimeout(() => {
                    fecharModal();
                    
                    // Recarregar tabelas
                    loadAgendamentosPendentes();
                    loadAgendamentosConfirmados();
                    loadDisponibilidades();
                    
                    // Notificar outros componentes (se estiverem abertos)
                    window.parent.postMessage({ type: 'agendamento_confirmado', id: agendamentoAtual.id, data: todasSaidas[index] }, '*');
                    window.postMessage({ type: 'agendamento_confirmado', id: agendamentoAtual.id, data: todasSaidas[index] }, '*');
                }, 1500);
                
            } catch (error) {
                console.error('Erro ao confirmar agendamento:', error);
                showMessage('Erro ao confirmar agendamento.', 'error');
            }
        });

        // Fechar modal ao clicar fora
        modalCompletar.addEventListener('click', function(e) {
            if (e.target === modalCompletar) {
                fecharModal();
            }
        });

        // Fechar modal com ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && modalCompletar.classList.contains('active')) {
                fecharModal();
            }
        });

        // Calendário de Disponibilidades
        let calendarioMesAtual = new Date().getMonth();
        let calendarioAnoAtual = new Date().getFullYear();
        const calendarioGrid = document.getElementById('calendarioGrid');
        const calendarioMesAno = document.getElementById('calendarioMesAno');
        const prevMonthBtn = document.getElementById('prevMonthBtn');
        const nextMonthBtn = document.getElementById('nextMonthBtn');

        // Função para obter status do período (livre, disponivel, ocupado)
        function getStatusPeriodo(data, periodo, disponibilidades, saidas) {
            const key = `${data}_${periodo}`;
            const disponibilidade = disponibilidades[key];
            
            // Se não há configuração
            if (!disponibilidade || !disponibilidade.vagas) {
                return 'livre';
            }
            
            // Calcular vagas ocupadas
            const horariosPeriodo = periodo === 'Manhã' ? horariosManha : horariosTarde;
            const saidasNoPeriodo = saidas.filter(s => {
                const saidaData = s.dataSaida || s.data || '';
                const saidaHora = s.horaSaida || s.hora || s.horario || '';
                return saidaData === data && horariosPeriodo.includes(saidaHora) && !s.realizada;
            });
            
            const vagasOcupadas = saidasNoPeriodo.length;
            const vagasConfiguradas = disponibilidade.vagas || 0;
            const vagasDisponiveis = vagasConfiguradas - vagasOcupadas;
            
            if (vagasDisponiveis <= 0) {
                return 'ocupado';
            } else {
                return 'disponivel';
            }
        }

        // Função para gerar calendário
        function gerarCalendario() {
            const disponibilidades = JSON.parse(localStorage.getItem('disponibilidadeViaturas') || '{}');
            const saidas = JSON.parse(localStorage.getItem('saidasAdministrativas') || '[]');
            
            const firstDay = new Date(calendarioAnoAtual, calendarioMesAtual, 1);
            const lastDay = new Date(calendarioAnoAtual, calendarioMesAtual + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();
            
            // Nomes dos meses e dias
            const meses = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            const diasSemana = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
            
            // Atualizar título
            calendarioMesAno.textContent = `${meses[calendarioMesAtual]} ${calendarioAnoAtual}`;
            
            // Criar grid
            calendarioGrid.innerHTML = '';
            
            // Cabeçalho dos dias da semana
            diasSemana.forEach(dia => {
                const diaNome = document.createElement('div');
                diaNome.className = 'calendario-dia-nome';
                diaNome.textContent = dia;
                calendarioGrid.appendChild(diaNome);
            });
            
            // Espaços vazios antes do primeiro dia
            for (let i = 0; i < startingDayOfWeek; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendario-dia outro-mes';
                calendarioGrid.appendChild(emptyDay);
            }
            
            // Dias do mês
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${calendarioAnoAtual}-${String(calendarioMesAtual + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const diaElement = document.createElement('div');
                diaElement.className = 'calendario-dia';
                
                const diaNumero = document.createElement('div');
                diaNumero.className = 'calendario-dia-numero';
                diaNumero.textContent = day;
                diaElement.appendChild(diaNumero);
                
                // Período Manhã
                const periodoManha = document.createElement('div');
                periodoManha.className = 'calendario-periodo';
                const statusManha = getStatusPeriodo(dateStr, 'Manhã', disponibilidades, saidas);
                periodoManha.classList.add(statusManha);
                periodoManha.textContent = 'Manhã';
                periodoManha.title = `Manhã: ${statusManha === 'livre' ? 'Livre' : statusManha === 'disponivel' ? 'Disponível' : 'Ocupado'}`;
                diaElement.appendChild(periodoManha);
                
                // Separador visual
                const separador = document.createElement('div');
                separador.className = 'calendario-separador';
                diaElement.appendChild(separador);
                
                // Período Tarde
                const periodoTarde = document.createElement('div');
                periodoTarde.className = 'calendario-periodo';
                const statusTarde = getStatusPeriodo(dateStr, 'Tarde', disponibilidades, saidas);
                periodoTarde.classList.add(statusTarde);
                periodoTarde.textContent = 'Tarde';
                periodoTarde.title = `Tarde: ${statusTarde === 'livre' ? 'Livre' : statusTarde === 'disponivel' ? 'Disponível' : 'Ocupado'}`;
                diaElement.appendChild(periodoTarde);
                
                calendarioGrid.appendChild(diaElement);
            }
        }

        // Navegação do calendário
        if (prevMonthBtn) {
            prevMonthBtn.addEventListener('click', function() {
                calendarioMesAtual--;
                if (calendarioMesAtual < 0) {
                    calendarioMesAtual = 11;
                    calendarioAnoAtual--;
                }
                gerarCalendario();
            });
        }

        if (nextMonthBtn) {
            nextMonthBtn.addEventListener('click', function() {
                calendarioMesAtual++;
                if (calendarioMesAtual > 11) {
                    calendarioMesAtual = 0;
                    calendarioAnoAtual++;
                }
                gerarCalendario();
            });
        }

        // Inicializar
        async function init() {
            await loadViaturasEMotoristas();
            loadDisponibilidades();
            await loadAgendamentosPendentes();
            await loadAgendamentosConfirmados();
            gerarCalendario(); // Gerar calendário na inicialização
        }

        // Iniciar quando o DOM estiver pronto
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
        
        // Recarregar periodicamente para atualizar estatísticas
        setInterval(() => {
            loadDisponibilidades();
            loadAgendamentosPendentes();
            loadAgendamentosConfirmados();
        }, 30000); // A cada 30 segundos
    </script>
</body>
</html>
